<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baghoor Oil Traders - Complete Professional System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 450px;
            width: 100%;
        }
        .login-box h1 { text-align: center; color: #667eea; margin-bottom: 10px; font-size: 2.2em; }
        .login-box p { text-align: center; color: #718096; margin-bottom: 30px; font-size: 0.95em; }
        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .role-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        .role-btn:hover { border-color: #667eea; background: #f7fafc; }
        .role-btn.active { border-color: #667eea; background: #667eea; color: white; }
        
        .quick-entry {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 20px;
        }
        .quick-entry h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .quick-btn {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        .quick-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #667eea;
        }
        .header h1 { color: #1a202c; font-size: 1.8em; font-weight: 700; }
        .company-tagline { display: block; font-size: 0.4em; color: #667eea; font-weight: 600; margin-top: 5px; text-transform: uppercase; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .user-info {
            background: #ebf4ff;
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .user-role { font-size: 0.8em; color: #667eea; margin-top: 2px; }
        .role-admin { color: #f56565; }
        .role-manager { color: #ed8936; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-info { background: #4299e1; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-secondary { background: #a0aec0; color: white; }
        .btn-purple { background: #805ad5; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 11px; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-bottom: 25px; }
        .stat-card {
            background: white;
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: all 0.3s;
            border-left: 4px solid;
        }
        .stat-card:nth-child(1) { border-left-color: #667eea; }
        .stat-card:nth-child(2) { border-left-color: #48bb78; }
        .stat-card:nth-child(3) { border-left-color: #ed8936; }
        .stat-card:nth-child(4) { border-left-color: #4299e1; }
        .stat-card:nth-child(5) { border-left-color: #f56565; }
        .stat-card:nth-child(6) { border-left-color: #9f7aea; }
        .stat-card:nth-child(7) { border-left-color: #38b2ac; }
        .stat-card:nth-child(8) { border-left-color: #f687b3; }
        .stat-card:nth-child(9) { border-left-color: #805ad5; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #718096; font-size: 0.8em; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .stat-card .value { font-size: 1.8em; font-weight: 700; margin-bottom: 6px; }
        .stat-card:nth-child(1) .value { color: #667eea; }
        .stat-card:nth-child(2) .value { color: #48bb78; }
        .stat-card:nth-child(3) .value { color: #ed8936; }
        .stat-card:nth-child(4) .value { color: #4299e1; }
        .stat-card:nth-child(5) .value { color: #f56565; }
        .stat-card:nth-child(6) .value { color: #9f7aea; }
        .stat-card:nth-child(7) .value { color: #38b2ac; }
        .stat-card:nth-child(8) .value { color: #f687b3; }
        .stat-card:nth-child(9) .value { color: #805ad5; }
        
        .card { background: white; padding: 22px; border-radius: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); margin-bottom: 20px; }
        .card h2 { color: #1a202c; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; font-weight: 700; font-size: 1.3em; display: flex; justify-content: space-between; align-items: center; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: #4a5568; font-weight: 600; font-size: 0.85em; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            background: #f7fafc;
        }
        .form-group textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f7fafc; border-radius: 8px; margin-bottom: 10px; }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .checkbox-group label { margin: 0; font-weight: 600; color: #2d3748; cursor: pointer; }
        
        .table-container { overflow-x: auto; margin-top: 12px; border-radius: 10px; border: 1px solid #e2e8f0; max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #667eea; color: white; position: sticky; top: 0; z-index: 10; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.85em; }
        th { font-weight: 700; text-transform: uppercase; }
        tbody tr:hover { background: #f7fafc; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: white;
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .modal-header h2 { color: #667eea; margin: 0; }
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        .close-btn:hover { color: #f56565; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification.success { background: #48bb78; color: white; }
        .notification.error { background: #f56565; color: white; }
        .notification.warning { background: #ed8936; color: white; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 13px;
        }
        .tab:hover { color: #667eea; background: #f7fafc; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .profit-loss-section { margin-top: 20px; }
        .profit-loss-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.95em;
        }
        .profit-loss-item.total {
            background: #f7fafc;
            font-size: 1.1em;
            font-weight: 700;
            border-bottom: none;
            margin-top: 10px;
        }
        
        #rateChangePreview {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #667eea;
        }
        
        .balance-positive { color: #48bb78; }
        .balance-negative { color: #f56565; }
        
        .ledger-entry { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .ledger-debit { border-left: 4px solid #f56565; }
        .ledger-credit { border-left: 4px solid #48bb78; }
        
        .stock-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            margin-right: 5px;
        }
        .stock-pmg { background: #667eea; color: white; }
        .stock-hsd { background: #ed8936; color: white; }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; }
            .header-actions { width: 100%; justify-content: center; }
            .ledger-entry { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-container">
    <div class="login-box">
        <h1>üõ¢Ô∏è Baghoor Oil Traders</h1>
        <p>Complete Professional Accounting System</p>
        
        <div class="role-selector">
            <button class="role-btn active" onclick="selectRole('admin')">Admin</button>
            <button class="role-btn" onclick="selectRole('manager')">Manager</button>
            <button class="role-btn" onclick="selectRole('accountant')">Accountant</button>
        </div>
        
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Login</button>
        </form>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display: none;">
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div>
                <h1>
                    üõ¢Ô∏è Baghoor Oil Traders
                    <span class="company-tagline">Complete Professional Accounting System</span>
                </h1>
            </div>
            <div class="header-actions">
                <div class="user-info">
                    <span id="userDisplay"></span>
                    <span class="user-role" id="userRoleDisplay"></span>
                </div>
                <button class="btn btn-warning" onclick="openModal('backupModal')">üíæ Backup</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- QUICK ENTRY SECTION -->
        <div class="quick-entry">
            <h3>‚ö° Quick Actions</h3>
            <div class="quick-grid">
                <button class="quick-btn" onclick="openModal('customerModal')">‚ûï Add Customer</button>
                <button class="quick-btn" onclick="openModal('supplierModal')">‚ûï Add Supplier</button>
                <button class="quick-btn" onclick="openModal('saleModal')">üí∞ Record Sale</button>
                <button class="quick-btn" onclick="openModal('purchaseModal')">üõí Record Purchase</button>
                <button class="quick-btn" onclick="openModal('paymentModal')">üí≥ Record Payment</button>
                <button class="quick-btn" onclick="openModal('customerTransferModal')">üîÑ Customer Transfer</button>
                <button class="quick-btn" onclick="openModal('expenseModal')">üí∏ Add Expense</button>
                <button class="quick-btn" onclick="openModal('bankTransModal')">üè¶ Bank Transaction</button>
                <button class="quick-btn" onclick="openModal('vehicleModal')">üöõ Add Vehicle</button>
                <button class="quick-btn" onclick="openModal('govRateModal')">üìä Gov Rate Change</button>
            </div>
        </div>

        <!-- DASHBOARD STATS -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Total Customers</h3>
                <div class="value" id="totalCustomers">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Suppliers</h3>
                <div class="value" id="totalSuppliers">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Vehicles</h3>
                <div class="value" id="totalVehicles">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Banks</h3>
                <div class="value" id="totalBanks">0</div>
            </div>
            <div class="stat-card">
                <h3>Receivables</h3>
                <div class="value" id="totalReceivables">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Payables</h3>
                <div class="value" id="totalPayables">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Bank Balance</h3>
                <div class="value" id="totalBankBalance">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Total Expenses</h3>
                <div class="value" id="totalExpenses">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Total Stock</h3>
                <div class="value" id="totalStock">0 KL</div>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('customers')">üë• Customers</button>
            <button class="tab" onclick="switchTab('suppliers')">üè≠ Suppliers</button>
            <button class="tab" onclick="switchTab('transactions')">üí≥ Transactions</button>
            <button class="tab" onclick="switchTab('payments')">üí∞ Payments</button>
            <button class="tab" onclick="switchTab('expenses')">üí∏ Expenses</button>
            <button class="tab" onclick="switchTab('banks')">üè¶ Banks</button>
            <button class="tab" onclick="switchTab('vehicles')">üöõ Vehicles</button>
            <button class="tab" onclick="switchTab('ledger')">üìí Ledger</button>
            <button class="tab" onclick="switchTab('reports')">üìä Reports</button>
        </div>

        <!-- CUSTOMERS TAB -->
        <div id="customers-tab" class="tab-content active">
            <div class="card">
                <h2>
                    Customers Management
                    <button class="btn btn-primary" onclick="openModal('customerModal')">Add Customer</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>CNIC</th>
                                <th>PMG Rate</th>
                                <th>HSD Rate</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SUPPLIERS TAB -->
        <div id="suppliers-tab" class="tab-content">
            <div class="card">
                <h2>
                    Suppliers Management
                    <button class="btn btn-primary" onclick="openModal('supplierModal')">Add Supplier</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>CNIC</th>
                                <th>PMG Rate</th>
                                <th>HSD Rate</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRANSACTIONS TAB -->
        <div id="transactions-tab" class="tab-content">
            <div class="card">
                <h2>
                    Transaction History
                    <div>
                        <button class="btn btn-success" onclick="openModal('saleModal')">Add Sale</button>
                        <button class="btn btn-warning" onclick="openModal('purchaseModal')">Add Purchase</button>
                    </div>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Party</th>
                                <th>Fuel</th>
                                <th>Quantity</th>
                                <th>Rate</th>
                                <th>Amount</th>
                                <th>Vehicle</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAYMENTS TAB -->
        <div id="payments-tab" class="tab-content">
            <div class="card">
                <h2>
                    Payment History
                    <button class="btn btn-success" onclick="openModal('paymentModal')">Record Payment</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Party</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Bank</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- EXPENSES TAB -->
        <div id="expenses-tab" class="tab-content">
            <div class="card">
                <h2>
                    Expenses Management
                    <button class="btn btn-danger" onclick="openModal('expenseModal')">Add Expense</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Paid From</th>
                                <th>Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BANKS TAB -->
        <div id="banks-tab" class="tab-content">
            <div class="card">
                <h2>
                    Bank Accounts & Transactions
                    <div>
                        <button class="btn btn-primary" onclick="openModal('bankModal')">Add Bank</button>
                        <button class="btn btn-success" onclick="openModal('bankTransModal')">Bank Transaction</button>
                    </div>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bank Name</th>
                                <th>Account Number</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="banksBody"></tbody>
                    </table>
                </div>
                <h3 style="margin-top: 20px; color: #667eea;">Recent Bank Transactions</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bank</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Balance After</th>
                            </tr>
                        </thead>
                        <tbody id="bankTransactionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VEHICLES TAB -->
        <div id="vehicles-tab" class="tab-content">
            <div class="card">
                <h2>
                    Vehicle Management & Stock
                    <button class="btn btn-primary" onclick="openModal('vehicleModal')">Add Vehicle</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle Number</th>
                                <th>Driver</th>
                                <th>Contact</th>
                                <th>PMG Stock</th>
                                <th>HSD Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehiclesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- LEDGER TAB (NEW) -->
        <div id="ledger-tab" class="tab-content">
            <div class="card">
                <h2>
                    Daily Ledger (Debit/Credit)
                    <div>
                        <button class="btn btn-info" onclick="generateLedger()">üìí Generate Today's Ledger</button>
                        <button class="btn btn-success" onclick="checkBalance()">‚öñÔ∏è Check Balance</button>
                    </div>
                </h2>
                <div id="ledgerOutput"></div>
            </div>
        </div>

        <!-- REPORTS TAB -->
        <div id="reports-tab" class="tab-content">
            <div class="card">
                <h2>Reports & Analytics</h2>
                
                <!-- General Reports -->
                <h3 style="color: #667eea; margin-bottom: 10px;">üìä General Reports</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px;">
                    <button class="btn btn-info" onclick="generateProfitLossReport()">üìä Profit & Loss</button>
                    <button class="btn btn-success" onclick="generateMonthlyReport()">üìÖ Monthly Report</button>
                    <button class="btn btn-warning" onclick="generateVehicleProfitReport()">üöõ All Vehicles Profit</button>
                    <button class="btn btn-purple" onclick="generateStockReport()">üì¶ Stock Report</button>
                    <button class="btn btn-danger" onclick="generateExpenseReport()">üí∏ Expense Report</button>
                    <button class="btn btn-primary" onclick="generateAllPartiesReport()">üìã All Parties Balance</button>
                </div>
                
                <!-- Customer-wise Ledger -->
                <h3 style="color: #667eea; margin-bottom: 10px; margin-top: 25px;">üë§ Customer-wise Ledger Report</h3>
                <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Select Customer</label>
                            <select id="customerReportSelect">
                                <option value="">Choose Customer</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>From Date</label>
                            <input type="date" id="customerReportFromDate">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>To Date</label>
                            <input type="date" id="customerReportToDate">
                        </div>
                        <button class="btn btn-success" onclick="generateCustomerLedgerReport()">Generate Report</button>
                        <button class="btn btn-primary" onclick="exportCustomerLedgerPDF()">Export PDF</button>
                    </div>
                </div>
                
                <!-- Vehicle-wise Profit -->
                <h3 style="color: #667eea; margin-bottom: 10px;">üöõ Individual Vehicle Report</h3>
                <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Select Vehicle</label>
                            <select id="vehicleReportSelect">
                                <option value="">Choose Vehicle</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>From Date</label>
                            <input type="date" id="vehicleReportFromDate">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>To Date</label>
                            <input type="date" id="vehicleReportToDate">
                        </div>
                        <button class="btn btn-success" onclick="generateSingleVehicleReport()">Generate Report</button>
                        <button class="btn btn-primary" onclick="exportSingleVehiclePDF()">Export PDF</button>
                    </div>
                </div>
                
                <!-- Export Options -->
                <h3 style="color: #667eea; margin-bottom: 10px;">üíæ Export Options</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="exportVehicleProfitPDF()">üìÑ Export All Vehicles PDF</button>
                    <button class="btn btn-secondary" onclick="exportAllDataExcel()">üì• Export All Data Excel</button>
                    <button class="btn btn-info" onclick="exportAllPartiesPDF()">üìÑ Export All Parties PDF</button>
                </div>
                
                <div id="reportOutput"></div>
            </div>
        </div>
    </div>
</div>

<!-- ALL MODALS -->

<!-- CUSTOMER MODAL -->
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Customer</h2>
            <button class="close-btn" onclick="closeModal('customerModal')">&times;</button>
        </div>
        <form onsubmit="saveCustomer(event)">
            <input type="hidden" id="customerId">
            <div class="form-group">
                <label>Customer Name *</label>
                <input type="text" id="customerName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="text" id="customerContact">
                </div>
                <div class="form-group">
                    <label>CNIC</label>
                    <input type="text" id="customerCnic" placeholder="12345-1234567-1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>PMG Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="customerPmgRate" required>
                </div>
                <div class="form-group">
                    <label>HSD Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="customerHsdRate" required>
                </div>
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="customerAddress"></textarea>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="customerNotes"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Save Customer</button>
        </form>
    </div>
</div>

<!-- SUPPLIER MODAL -->
<div id="supplierModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Supplier</h2>
            <button class="close-btn" onclick="closeModal('supplierModal')">&times;</button>
        </div>
        <form onsubmit="saveSupplier(event)">
            <input type="hidden" id="supplierId">
            <div class="form-group">
                <label>Supplier Name *</label>
                <input type="text" id="supplierName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="text" id="supplierContact">
                </div>
                <div class="form-group">
                    <label>CNIC</label>
                    <input type="text" id="supplierCnic" placeholder="12345-1234567-1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>PMG Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="supplierPmgRate" required>
                </div>
                <div class="form-group">
                    <label>HSD Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="supplierHsdRate" required>
                </div>
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="supplierAddress"></textarea>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="supplierNotes"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Save Supplier</button>
        </form>
    </div>
</div>

<!-- SALE MODAL -->
<div id="saleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Sale</h2>
            <button class="close-btn" onclick="closeModal('saleModal')">&times;</button>
        </div>
        <form onsubmit="saveSale(event)">
            <div class="form-group">
                <label>Customer *</label>
                <select id="saleCustomerId" required>
                    <option value="">Select Customer</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Fuel Type *</label>
                    <select id="saleFuelType" onchange="updateSaleRate()" required>
                        <option value="">Select Fuel</option>
                        <option value="PMG">PMG (Petrol)</option>
                        <option value="HSD">HSD (Diesel)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vehicle *</label>
                    <select id="saleVehicleId" required>
                        <option value="">Select Vehicle</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity (Liters) *</label>
                    <input type="number" step="0.01" id="saleQuantity" oninput="calculateSaleAmount()" required>
                </div>
                <div class="form-group">
                    <label>Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="saleRate" oninput="calculateSaleAmount()" required>
                </div>
            </div>
            <div class="form-group">
                <label>Total Amount</label>
                <input type="number" step="0.01" id="saleAmount" readonly>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="saleDate" required>
            </div>
            <button type="submit" class="btn btn-success">Save Sale</button>
        </form>
    </div>
</div>

<!-- PURCHASE MODAL -->
<div id="purchaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Purchase</h2>
            <button class="close-btn" onclick="closeModal('purchaseModal')">&times;</button>
        </div>
        <form onsubmit="savePurchase(event)">
            <div class="form-group">
                <label>Supplier *</label>
                <select id="purchaseSupplierId" required>
                    <option value="">Select Supplier</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Fuel Type *</label>
                    <select id="purchaseFuelType" onchange="updatePurchaseRate()" required>
                        <option value="">Select Fuel</option>
                        <option value="PMG">PMG (Petrol)</option>
                        <option value="HSD">HSD (Diesel)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vehicle *</label>
                    <select id="purchaseVehicleId" required>
                        <option value="">Select Vehicle</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity (Liters) *</label>
                    <input type="number" step="0.01" id="purchaseQuantity" oninput="calculatePurchaseAmount()" required>
                </div>
                <div class="form-group">
                    <label>Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="purchaseRate" oninput="calculatePurchaseAmount()" required>
                </div>
            </div>
            <div class="form-group">
                <label>Total Amount</label>
                <input type="number" step="0.01" id="purchaseAmount" readonly>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="purchaseDate" required>
            </div>
            <button type="submit" class="btn btn-success">Save Purchase</button>
        </form>
    </div>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üí≥ Record Payment</h2>
            <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
        </div>
        <form onsubmit="savePayment(event)">
            <div class="form-group">
                <label>Payment Type *</label>
                <select id="paymentType" onchange="updatePaymentParties()" required>
                    <option value="">Select Type</option>
                    <option value="received">Payment Received (from Customer)</option>
                    <option value="paid">Payment Made (to Supplier)</option>
                </select>
            </div>
            <div class="form-group">
                <label id="paymentPartyLabel">Party *</label>
                <select id="paymentPartyId" required>
                    <option value="">Select Party</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="paymentAmount" required>
            </div>
            <div class="form-group">
                <label>Payment Method *</label>
                <select id="paymentMethod" onchange="toggleBankField()" required>
                    <option value="cash">Cash</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group" id="paymentBankGroup" style="display: none;">
                <label>Bank Account</label>
                <select id="paymentBankId">
                    <option value="">Select Bank</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="paymentDate" required>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="paymentNotes" placeholder="Reference number, cheque number, etc."></textarea>
            </div>
            <button type="submit" class="btn btn-success">Record Payment</button>
        </form>
    </div>
</div>

<!-- CUSTOMER TRANSFER MODAL (NEW) -->
<div id="customerTransferModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîÑ Customer to Customer Transfer</h2>
            <button class="close-btn" onclick="closeModal('customerTransferModal')">&times;</button>
        </div>
        <form onsubmit="saveCustomerTransfer(event)">
            <div class="form-group">
                <label>Paying Customer (Debit) *</label>
                <select id="transferFromCustomerId" required>
                    <option value="">Select Customer</option>
                </select>
                <small style="color: #718096;">This customer's balance will increase (debit)</small>
            </div>
            <div class="form-group">
                <label>Receiving Customer (Credit) *</label>
                <select id="transferToCustomerId" required>
                    <option value="">Select Customer</option>
                </select>
                <small style="color: #718096;">This customer's balance will decrease (credit)</small>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="transferAmount" required>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="transferDate" required>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="transferNotes" placeholder="Reason for transfer"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Record Transfer</button>
        </form>
    </div>
</div>

<!-- EXPENSE MODAL (UPDATED) -->
<div id="expenseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üí∏ Add Expense</h2>
            <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
        </div>
        <form onsubmit="saveExpense(event)">
            <input type="hidden" id="expenseId">
            <div class="form-group">
                <label>Category *</label>
                <select id="expenseCategory" required>
                    <option value="">Select Category</option>
                    <option value="Fuel">Fuel</option>
                    <option value="Salaries">Salaries</option>
                    <option value="Rent">Rent</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Vehicle Maintenance">Vehicle Maintenance</option>
                    <option value="Office Supplies">Office Supplies</option>
                    <option value="Transport">Transport</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Insurance">Insurance</option>
                    <option value="Taxes">Taxes</option>
                    <option value="Miscellaneous">Miscellaneous</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="expenseDescription" required placeholder="Details about the expense"></textarea>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="expenseAmount" required>
            </div>
            <div class="form-group">
                <label>Paid From *</label>
                <select id="expenseSource" onchange="toggleExpenseSourceField()" required>
                    <option value="bank">Bank Account</option>
                    <option value="customer">Customer Account</option>
                    <option value="cash">Cash</option>
                </select>
            </div>
            <div class="form-group" id="expenseBankGroup">
                <label>Bank Account *</label>
                <select id="expenseBankId">
                    <option value="">Select Bank</option>
                </select>
            </div>
            <div class="form-group" id="expenseCustomerGroup" style="display: none;">
                <label>Customer *</label>
                <select id="expenseCustomerId">
                    <option value="">Select Customer</option>
                </select>
                <small style="color: #718096;">Customer's balance will decrease</small>
            </div>
            <div class="form-group">
                <label>Payment Method *</label>
                <select id="expenseMethod" required>
                    <option value="cash">Cash</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="expenseDate" required>
            </div>
            <button type="submit" class="btn btn-danger">Save Expense</button>
        </form>
    </div>
</div>

<!-- BANK TRANSACTION MODAL -->
<div id="bankTransModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üè¶ Bank Transaction</h2>
            <button class="close-btn" onclick="closeModal('bankTransModal')">&times;</button>
        </div>
        <form onsubmit="saveBankTransaction(event)">
            <div class="form-group">
                <label>Bank Account *</label>
                <select id="bankTransBankId" required>
                    <option value="">Select Bank</option>
                </select>
            </div>
            <div class="form-group">
                <label>Transaction Type *</label>
                <select id="bankTransType" required>
                    <option value="deposit">Deposit (Money In)</option>
                    <option value="withdrawal">Withdrawal (Money Out)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="bankTransAmount" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="bankTransDescription" placeholder="Purpose of transaction"></textarea>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="bankTransDate" required>
            </div>
            <button type="submit" class="btn btn-success">Save Transaction</button>
        </form>
    </div>
</div>

<!-- VEHICLE MODAL -->
<div id="vehicleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Vehicle</h2>
            <button class="close-btn" onclick="closeModal('vehicleModal')">&times;</button>
        </div>
        <form onsubmit="saveVehicle(event)">
            <input type="hidden" id="vehicleId">
            <div class="form-group">
                <label>Vehicle Number *</label>
                <input type="text" id="vehicleNumber" required placeholder="ABC-123">
            </div>
            <div class="form-group">
                <label>Driver Name *</label>
                <input type="text" id="vehicleDriver" required>
            </div>
            <div class="form-group">
                <label>Driver Contact</label>
                <input type="text" id="vehicleContact">
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="vehicleStatus">
                    <option value="Active">Active</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Inactive">Inactive</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success">Save Vehicle</button>
        </form>
    </div>
</div>

<!-- BANK MODAL -->
<div id="bankModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Bank Account</h2>
            <button class="close-btn" onclick="closeModal('bankModal')">&times;</button>
        </div>
        <form onsubmit="saveBank(event)">
            <input type="hidden" id="bankId">
            <div class="form-group">
                <label>Bank Name *</label>
                <input type="text" id="bankName" required placeholder="e.g., Meezan Bank">
            </div>
            <div class="form-group">
                <label>Account Number *</label>
                <input type="text" id="bankAccount" required>
            </div>
            <div class="form-group">
                <label>Opening Balance</label>
                <input type="number" step="0.01" id="bankBalance" value="0">
            </div>
            <button type="submit" class="btn btn-success">Save Bank</button>
        </form>
    </div>
</div>

<!-- GOVERNMENT RATE CHANGE MODAL -->
<div id="govRateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üèõÔ∏è Government Rate Change</h2>
            <button class="close-btn" onclick="closeModal('govRateModal')">&times;</button>
        </div>
        <form onsubmit="applyGovRateChange(event)">
            <div class="checkbox-group">
                <input type="checkbox" id="updatePmg" checked>
                <label for="updatePmg">Update PMG (Petrol) Rates</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="updateHsd" checked>
                <label for="updateHsd">Update HSD (Diesel) Rates</label>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Change Type</label>
                    <select id="changeType">
                        <option value="absolute">Absolute (Rs)</option>
                        <option value="percentage">Percentage (%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Direction</label>
                    <select id="changeSign">
                        <option value="1">Increase (+)</option>
                        <option value="-1">Decrease (-)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" step="0.0001" id="changeAmount" required>
            </div>
            <div class="form-group">
                <label>Apply To</label>
                <select id="changeScope">
                    <option value="all">All (Customers & Suppliers)</option>
                    <option value="customers">Customers Only</option>
                    <option value="suppliers">Suppliers Only</option>
                </select>
            </div>
            <button type="button" class="btn btn-info" onclick="previewGovRateChange()">Preview Changes</button>
            <div id="rateChangePreview" style="display: none;">
                <h3 style="color: #667eea; margin: 15px 0 10px 0;">Preview:</h3>
                <div id="previewContent"></div>
            </div>
            <button type="submit" class="btn btn-success" style="margin-top: 15px; width: 100%;">Apply Changes</button>
        </form>
    </div>
</div>

<!-- BACKUP MODAL -->
<div id="backupModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üíæ Backup & Restore</h2>
            <button class="close-btn" onclick="closeModal('backupModal')">&times;</button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <h3 style="color: #667eea; margin-bottom: 10px;">Create Backup</h3>
                <p style="color: #718096; margin-bottom: 10px;">Download all your data as a backup file</p>
                <button class="btn btn-success" onclick="createBackup()">Download Backup</button>
            </div>
            <hr style="border: 1px solid #e2e8f0;">
            <div>
                <h3 style="color: #667eea; margin-bottom: 10px;">Restore Backup</h3>
                <p style="color: #718096; margin-bottom: 10px;">Upload a backup file to restore your data</p>
                <input type="file" id="backupFile" accept=".json" style="margin-bottom: 10px;">
                <button class="btn btn-warning" onclick="restoreBackup()">Restore Backup</button>
            </div>
        </div>
    </div>
</div>

<script>
// DATA STORAGE
let customers = JSON.parse(localStorage.getItem('customers')) || [];
let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
let payments = JSON.parse(localStorage.getItem('payments')) || [];
let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
let customerTransfers = JSON.parse(localStorage.getItem('customerTransfers')) || [];
let vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];
let banks = JSON.parse(localStorage.getItem('banks')) || [];
let bankTransactions = JSON.parse(localStorage.getItem('bankTransactions')) || [];
let rateChangeLogs = JSON.parse(localStorage.getItem('rateChangeLogs')) || [];
let ledgerEntries = JSON.parse(localStorage.getItem('ledgerEntries')) || [];
let currentUser = '';
let currentRole = 'admin';
let selectedRole = 'admin';

// Initialize vehicle stocks if not exists
vehicles.forEach(v => {
    if (!v.stockPMG) v.stockPMG = 0;
    if (!v.stockHSD) v.stockHSD = 0;
});

// LOGIN SYSTEM
function selectRole(role) {
    selectedRole = role;
    document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (username && password) {
        currentUser = username;
        currentRole = selectedRole;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userDisplay').textContent = username;
        document.getElementById('userRoleDisplay').textContent = selectedRole.toUpperCase();
        document.getElementById('userRoleDisplay').className = `user-role role-${selectedRole}`;
        initApp();
        showNotification('Welcome ' + username + '! üéâ', 'success');
    } else {
        showNotification('Invalid credentials!', 'error');
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        currentUser = '';
        showNotification('Logged out successfully', 'success');
    }
}

// INITIALIZATION
function initApp() {
    updateDashboard();
    renderCustomers();
    renderSuppliers();
    renderTransactions();
    renderPayments();
    renderExpenses();
    renderVehicles();
    renderBanks();
    renderBankTransactions();
    populateDropdowns();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('saleDate').value = today;
    document.getElementById('purchaseDate').value = today;
    document.getElementById('paymentDate').value = today;
    document.getElementById('expenseDate').value = today;
    document.getElementById('bankTransDate').value = today;
    document.getElementById('transferDate').value = today;
    
    // Set default dates for report filters
    if (document.getElementById('customerReportToDate')) {
        document.getElementById('customerReportToDate').value = today;
    }
    if (document.getElementById('vehicleReportToDate')) {
        document.getElementById('vehicleReportToDate').value = today;
    }
}

function saveToStorage() {
    localStorage.setItem('customers', JSON.stringify(customers));
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
    localStorage.setItem('transactions', JSON.stringify(transactions));
    localStorage.setItem('payments', JSON.stringify(payments));
    localStorage.setItem('expenses', JSON.stringify(expenses));
    localStorage.setItem('customerTransfers', JSON.stringify(customerTransfers));
    localStorage.setItem('vehicles', JSON.stringify(vehicles));
    localStorage.setItem('banks', JSON.stringify(banks));
    localStorage.setItem('bankTransactions', JSON.stringify(bankTransactions));
    localStorage.setItem('rateChangeLogs', JSON.stringify(rateChangeLogs));
    localStorage.setItem('ledgerEntries', JSON.stringify(ledgerEntries));
}

// Add ledger entry function
function addLedgerEntry(type, description, debitAccount, debitAmount, creditAccount, creditAmount, date) {
    const entry = {
        id: 'ledger_' + Date.now(),
        type: type,
        description: description,
        debitAccount: debitAccount,
        debitAmount: debitAmount,
        creditAccount: creditAccount,
        creditAmount: creditAmount,
        date: date || new Date().toISOString().split('T')[0],
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    ledgerEntries.push(entry);
    saveToStorage();
}

// CUSTOMER FUNCTIONS
function saveCustomer(e) {
    e.preventDefault();
    
    const customer = {
        id: document.getElementById('customerId').value || 'cust_' + Date.now(),
        name: document.getElementById('customerName').value,
        contact: document.getElementById('customerContact').value,
        cnic: document.getElementById('customerCnic').value,
        pmgRate: parseFloat(document.getElementById('customerPmgRate').value).toFixed(4),
        hsdRate: parseFloat(document.getElementById('customerHsdRate').value).toFixed(4),
        address: document.getElementById('customerAddress').value,
        notes: document.getElementById('customerNotes').value,
        balance: 0,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = customers.findIndex(c => c.id === customer.id);
    if (existingIndex >= 0) {
        customer.balance = customers[existingIndex].balance;
        customers[existingIndex] = customer;
        showNotification('Customer updated! ‚úÖ', 'success');
    } else {
        customers.push(customer);
        showNotification('Customer added! ‚úÖ', 'success');
    }
    
    saveToStorage();
    renderCustomers();
    closeModal('customerModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderCustomers() {
    const tbody = document.getElementById('customersBody');
    tbody.innerHTML = '';
    
    customers.forEach(customer => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${customer.name}</strong></td>
            <td>${customer.contact || '-'}</td>
            <td>${customer.cnic || '-'}</td>
            <td>Rs. ${parseFloat(customer.pmgRate).toFixed(4)}</td>
            <td>Rs. ${parseFloat(customer.hsdRate).toFixed(4)}</td>
            <td class="${customer.balance >= 0 ? 'balance-positive' : 'balance-negative'}">Rs. ${customer.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick='editCustomer(${JSON.stringify(customer).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer.id}')">Delete</button>
            </td>
        `;
    });
}

function editCustomer(customer) {
    document.getElementById('customerId').value = customer.id;
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerContact').value = customer.contact || '';
    document.getElementById('customerCnic').value = customer.cnic || '';
    document.getElementById('customerPmgRate').value = customer.pmgRate;
    document.getElementById('customerHsdRate').value = customer.hsdRate;
    document.getElementById('customerAddress').value = customer.address || '';
    document.getElementById('customerNotes').value = customer.notes || '';
    openModal('customerModal');
}

function deleteCustomer(id) {
    if (confirm('Are you sure?')) {
        customers = customers.filter(c => c.id !== id);
        saveToStorage();
        renderCustomers();
        updateDashboard();
        populateDropdowns();
        showNotification('Customer deleted!', 'success');
    }
}

// SUPPLIER FUNCTIONS
function saveSupplier(e) {
    e.preventDefault();
    
    const supplier = {
        id: document.getElementById('supplierId').value || 'supp_' + Date.now(),
        name: document.getElementById('supplierName').value,
        contact: document.getElementById('supplierContact').value,
        cnic: document.getElementById('supplierCnic').value,
        pmgRate: parseFloat(document.getElementById('supplierPmgRate').value).toFixed(4),
        hsdRate: parseFloat(document.getElementById('supplierHsdRate').value).toFixed(4),
        address: document.getElementById('supplierAddress').value,
        notes: document.getElementById('supplierNotes').value,
        balance: 0,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = suppliers.findIndex(s => s.id === supplier.id);
    if (existingIndex >= 0) {
        supplier.balance = suppliers[existingIndex].balance;
        suppliers[existingIndex] = supplier;
        showNotification('Supplier updated! ‚úÖ', 'success');
    } else {
        suppliers.push(supplier);
        showNotification('Supplier added! ‚úÖ', 'success');
    }
    
    saveToStorage();
    renderSuppliers();
    closeModal('supplierModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderSuppliers() {
    const tbody = document.getElementById('suppliersBody');
    tbody.innerHTML = '';
    
    suppliers.forEach(supplier => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${supplier.name}</strong></td>
            <td>${supplier.contact || '-'}</td>
            <td>${supplier.cnic || '-'}</td>
            <td>Rs. ${parseFloat(supplier.pmgRate).toFixed(4)}</td>
            <td>Rs. ${parseFloat(supplier.hsdRate).toFixed(4)}</td>
            <td class="${supplier.balance >= 0 ? 'balance-positive' : 'balance-negative'}">Rs. ${supplier.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick='editSupplier(${JSON.stringify(supplier).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteSupplier('${supplier.id}')">Delete</button>
            </td>
        `;
    });
}

function editSupplier(supplier) {
    document.getElementById('supplierId').value = supplier.id;
    document.getElementById('supplierName').value = supplier.name;
    document.getElementById('supplierContact').value = supplier.contact || '';
    document.getElementById('supplierCnic').value = supplier.cnic || '';
    document.getElementById('supplierPmgRate').value = supplier.pmgRate;
    document.getElementById('supplierHsdRate').value = supplier.hsdRate;
    document.getElementById('supplierAddress').value = supplier.address || '';
    document.getElementById('supplierNotes').value = supplier.notes || '';
    openModal('supplierModal');
}

function deleteSupplier(id) {
    if (confirm('Are you sure?')) {
        suppliers = suppliers.filter(s => s.id !== id);
        saveToStorage();
        renderSuppliers();
        updateDashboard();
        populateDropdowns();
        showNotification('Supplier deleted!', 'success');
    }
}

// TRANSACTION FUNCTIONS
function saveSale(e) {
    e.preventDefault();
    
    const customerId = document.getElementById('saleCustomerId').value;
    const customer = customers.find(c => c.id === customerId);
    const fuelType = document.getElementById('saleFuelType').value;
    const quantity = parseFloat(document.getElementById('saleQuantity').value);
    const rate = parseFloat(document.getElementById('saleRate').value);
    const amount = parseFloat(document.getElementById('saleAmount').value);
    const vehicleId = document.getElementById('saleVehicleId').value;
    const vehicle = vehicles.find(v => v.id === vehicleId);
    const date = document.getElementById('saleDate').value;
    
    // Check if vehicle has enough stock
    if (fuelType === 'PMG' && vehicle.stockPMG < quantity/1000) {
        showNotification('Insufficient PMG stock in vehicle!', 'error');
        return;
    }
    if (fuelType === 'HSD' && vehicle.stockHSD < quantity/1000) {
        showNotification('Insufficient HSD stock in vehicle!', 'error');
        return;
    }
    
    const transaction = {
        id: 'trans_' + Date.now(),
        type: 'sale',
        partyId: customerId,
        partyName: customer.name,
        fuelType: fuelType,
        quantity: quantity,
        rate: rate,
        amount: amount,
        vehicleId: vehicleId,
        date: date,
        createdAt: new Date().toISOString()
    };
    
    transactions.push(transaction);
    customer.balance += amount;
    
    // Deduct from vehicle stock
    if (fuelType === 'PMG') {
        vehicle.stockPMG -= quantity / 1000; // Convert liters to KL
    } else {
        vehicle.stockHSD -= quantity / 1000;
    }
    
    // Ledger entry
    addLedgerEntry('sale', `Sale to ${customer.name} - ${fuelType}`, 
        `Customer: ${customer.name}`, amount, 'Sales Revenue', amount, date);
    
    saveToStorage();
    renderTransactions();
    renderCustomers();
    renderVehicles();
    closeModal('saleModal');
    updateDashboard();
    showNotification('Sale recorded! Stock updated! ‚úÖ', 'success');
    e.target.reset();
}

function savePurchase(e) {
    e.preventDefault();
    
    const supplierId = document.getElementById('purchaseSupplierId').value;
    const supplier = suppliers.find(s => s.id === supplierId);
    const fuelType = document.getElementById('purchaseFuelType').value;
    const quantity = parseFloat(document.getElementById('purchaseQuantity').value);
    const rate = parseFloat(document.getElementById('purchaseRate').value);
    const amount = parseFloat(document.getElementById('purchaseAmount').value);
    const vehicleId = document.getElementById('purchaseVehicleId').value;
    const vehicle = vehicles.find(v => v.id === vehicleId);
    const date = document.getElementById('purchaseDate').value;
    
    const transaction = {
        id: 'trans_' + Date.now(),
        type: 'purchase',
        partyId: supplierId,
        partyName: supplier.name,
        fuelType: fuelType,
        quantity: quantity,
        rate: rate,
        amount: amount,
        vehicleId: vehicleId,
        date: date,
        createdAt: new Date().toISOString()
    };
    
    transactions.push(transaction);
    supplier.balance += amount;
    
    // Add to vehicle stock
    if (fuelType === 'PMG') {
        vehicle.stockPMG += quantity / 1000; // Convert liters to KL
    } else {
        vehicle.stockHSD += quantity / 1000;
    }
    
    // Ledger entry
    addLedgerEntry('purchase', `Purchase from ${supplier.name} - ${fuelType}`, 
        'Inventory', amount, `Supplier: ${supplier.name}`, amount, date);
    
    saveToStorage();
    renderTransactions();
    renderSuppliers();
    renderVehicles();
    closeModal('purchaseModal');
    updateDashboard();
    showNotification('Purchase recorded! Stock updated! ‚úÖ', 'success');
    e.target.reset();
}

function renderTransactions() {
    const tbody = document.getElementById('transactionsBody');
    tbody.innerHTML = '';
    
    transactions.slice().reverse().forEach(trans => {
        const vehicle = vehicles.find(v => v.id === trans.vehicleId);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(trans.date).toLocaleDateString()}</td>
            <td><span style="background: ${trans.type === 'sale' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${trans.type.toUpperCase()}</span></td>
            <td>${trans.partyName}</td>
            <td>${trans.fuelType}</td>
            <td>${trans.quantity.toFixed(2)} L</td>
            <td>Rs. ${trans.rate.toFixed(4)}</td>
            <td style="font-weight: 700;">Rs. ${trans.amount.toFixed(2)}</td>
            <td>${vehicle ? vehicle.number : '-'}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteTransaction('${trans.id}', '${trans.type}', '${trans.partyId}', '${trans.vehicleId}', '${trans.fuelType}', ${trans.quantity}, ${trans.amount})">Delete</button>
            </td>
        `;
    });
}

function deleteTransaction(transId, type, partyId, vehicleId, fuelType, quantity, amount) {
    if (!confirm('Are you sure you want to delete this transaction? This will reverse all changes made by this transaction.')) {
        return;
    }
    
    // Find the transaction
    const transIndex = transactions.findIndex(t => t.id === transId);
    if (transIndex === -1) {
        showNotification('Transaction not found!', 'error');
        return;
    }
    
    const transaction = transactions[transIndex];
    
    // Reverse the effects based on transaction type
    if (type === 'sale') {
        // Find customer and reduce their balance
        const customer = customers.find(c => c.id === partyId);
        if (customer) {
            customer.balance -= amount;
        }
        
        // Add stock back to vehicle
        const vehicle = vehicles.find(v => v.id === vehicleId);
        if (vehicle) {
            if (fuelType === 'PMG') {
                vehicle.stockPMG += quantity / 1000; // Convert liters back to KL
            } else {
                vehicle.stockHSD += quantity / 1000;
            }
        }
    } else if (type === 'purchase') {
        // Find supplier and reduce their balance
        const supplier = suppliers.find(s => s.id === partyId);
        if (supplier) {
            supplier.balance -= amount;
        }
        
        // Remove stock from vehicle
        const vehicle = vehicles.find(v => v.id === vehicleId);
        if (vehicle) {
            if (fuelType === 'PMG') {
                vehicle.stockPMG -= quantity / 1000; // Convert liters to KL
            } else {
                vehicle.stockHSD -= quantity / 1000;
            }
        }
    }
    
    // Remove the transaction
    transactions.splice(transIndex, 1);
    
    // Save and refresh
    saveToStorage();
    renderTransactions();
    renderCustomers();
    renderSuppliers();
    renderVehicles();
    updateDashboard();
    showNotification('Transaction deleted successfully! ‚úÖ', 'success');
}

function updateSaleRate() {
    const customerId = document.getElementById('saleCustomerId').value;
    const fuelType = document.getElementById('saleFuelType').value;
    
    if (customerId && fuelType) {
        const customer = customers.find(c => c.id === customerId);
        const rate = fuelType === 'PMG' ? customer.pmgRate : customer.hsdRate;
        document.getElementById('saleRate').value = rate;
        calculateSaleAmount();
    }
}

function calculateSaleAmount() {
    const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
    const rate = parseFloat(document.getElementById('saleRate').value) || 0;
    document.getElementById('saleAmount').value = (quantity * rate).toFixed(2);
}

function updatePurchaseRate() {
    const supplierId = document.getElementById('purchaseSupplierId').value;
    const fuelType = document.getElementById('purchaseFuelType').value;
    
    if (supplierId && fuelType) {
        const supplier = suppliers.find(s => s.id === supplierId);
        const rate = fuelType === 'PMG' ? supplier.pmgRate : supplier.hsdRate;
        document.getElementById('purchaseRate').value = rate;
        calculatePurchaseAmount();
    }
}

function calculatePurchaseAmount() {
    const quantity = parseFloat(document.getElementById('purchaseQuantity').value) || 0;
    const rate = parseFloat(document.getElementById('purchaseRate').value) || 0;
    document.getElementById('purchaseAmount').value = (quantity * rate).toFixed(2);
}

// PAYMENT FUNCTIONS
function updatePaymentParties() {
    const type = document.getElementById('paymentType').value;
    const partySelect = document.getElementById('paymentPartyId');
    const label = document.getElementById('paymentPartyLabel');
    
    partySelect.innerHTML = '<option value="">Select Party</option>';
    
    if (type === 'received') {
        label.textContent = 'Customer *';
        customers.forEach(c => {
            partySelect.innerHTML += `<option value="${c.id}">${c.name} (Balance: Rs. ${c.balance.toFixed(2)})</option>`;
        });
    } else if (type === 'paid') {
        label.textContent = 'Supplier *';
        suppliers.forEach(s => {
            partySelect.innerHTML += `<option value="${s.id}">${s.name} (Balance: Rs. ${s.balance.toFixed(2)})</option>`;
        });
    }
}

function toggleBankField() {
    const method = document.getElementById('paymentMethod').value;
    const bankGroup = document.getElementById('paymentBankGroup');
    
    if (method === 'bank' || method === 'cheque') {
        bankGroup.style.display = 'block';
    } else {
        bankGroup.style.display = 'none';
    }
}

function savePayment(e) {
    e.preventDefault();
    
    const type = document.getElementById('paymentType').value;
    const partyId = document.getElementById('paymentPartyId').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const method = document.getElementById('paymentMethod').value;
    const bankId = document.getElementById('paymentBankId').value;
    const date = document.getElementById('paymentDate').value;
    const notes = document.getElementById('paymentNotes').value;
    
    let party, partyName;
    
    if (type === 'received') {
        party = customers.find(c => c.id === partyId);
        partyName = party.name;
        party.balance -= amount;
        
        // Ledger entry
        addLedgerEntry('payment_received', `Payment from ${partyName}`, 
            bankId ? 'Bank' : 'Cash', amount, `Customer: ${partyName}`, amount, date);
    } else {
        party = suppliers.find(s => s.id === partyId);
        partyName = party.name;
        party.balance -= amount;
        
        // Ledger entry
        addLedgerEntry('payment_made', `Payment to ${partyName}`, 
            `Supplier: ${partyName}`, amount, bankId ? 'Bank' : 'Cash', amount, date);
    }
    
    const payment = {
        id: 'pay_' + Date.now(),
        type: type,
        partyId: partyId,
        partyName: partyName,
        amount: amount,
        method: method,
        bankId: bankId,
        date: date,
        notes: notes,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    payments.push(payment);
    
    // Update bank balance
    if (bankId && (method === 'bank' || method === 'cheque')) {
        const bank = banks.find(b => b.id === bankId);
        if (type === 'received') {
            bank.balance += amount;
        } else {
            bank.balance -= amount;
        }
    }
    
    saveToStorage();
    renderPayments();
    renderCustomers();
    renderSuppliers();
    renderBanks();
    closeModal('paymentModal');
    updateDashboard();
    showNotification('Payment recorded! üí∞', 'success');
    e.target.reset();
}

function renderPayments() {
    const tbody = document.getElementById('paymentsBody');
    tbody.innerHTML = '';
    
    payments.slice().reverse().forEach(payment => {
        const bank = banks.find(b => b.id === payment.bankId);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(payment.date).toLocaleDateString()}</td>
            <td>${payment.partyName}</td>
            <td><span style="background: ${payment.type === 'received' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${payment.type === 'received' ? 'RECEIVED' : 'PAID'}</span></td>
            <td style="font-weight: 700;">Rs. ${payment.amount.toFixed(2)}</td>
            <td>${payment.method.toUpperCase()}</td>
            <td>${bank ? bank.name : '-'}</td>
            <td>${payment.notes || '-'}</td>
        `;
    });
}

// CUSTOMER TRANSFER FUNCTIONS (NEW)
function saveCustomerTransfer(e) {
    e.preventDefault();
    
    const fromId = document.getElementById('transferFromCustomerId').value;
    const toId = document.getElementById('transferToCustomerId').value;
    const amount = parseFloat(document.getElementById('transferAmount').value);
    const date = document.getElementById('transferDate').value;
    const notes = document.getElementById('transferNotes').value;
    
    if (fromId === toId) {
        showNotification('Cannot transfer to same customer!', 'error');
        return;
    }
    
    const fromCustomer = customers.find(c => c.id === fromId);
    const toCustomer = customers.find(c => c.id === toId);
    
    const transfer = {
        id: 'transfer_' + Date.now(),
        fromCustomerId: fromId,
        fromCustomerName: fromCustomer.name,
        toCustomerId: toId,
        toCustomerName: toCustomer.name,
        amount: amount,
        date: date,
        notes: notes,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    // Update balances
    fromCustomer.balance += amount; // Debit (paying customer's balance increases)
    toCustomer.balance -= amount;   // Credit (receiving customer's balance decreases)
    
    customerTransfers.push(transfer);
    
    // Ledger entry
    addLedgerEntry('customer_transfer', `Transfer: ${fromCustomer.name} paid for ${toCustomer.name}`, 
        `Customer: ${fromCustomer.name}`, amount, `Customer: ${toCustomer.name}`, amount, date);
    
    saveToStorage();
    renderCustomers();
    closeModal('customerTransferModal');
    updateDashboard();
    showNotification('Customer transfer recorded! üîÑ', 'success');
    e.target.reset();
}

// EXPENSE FUNCTIONS (UPDATED)
function toggleExpenseSourceField() {
    const source = document.getElementById('expenseSource').value;
    const bankGroup = document.getElementById('expenseBankGroup');
    const customerGroup = document.getElementById('expenseCustomerGroup');
    
    bankGroup.style.display = 'none';
    customerGroup.style.display = 'none';
    
    if (source === 'bank') {
        bankGroup.style.display = 'block';
    } else if (source === 'customer') {
        customerGroup.style.display = 'block';
    }
}

function saveExpense(e) {
    e.preventDefault();
    
    const expense = {
        id: document.getElementById('expenseId').value || 'exp_' + Date.now(),
        category: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        source: document.getElementById('expenseSource').value,
        bankId: document.getElementById('expenseBankId').value,
        customerId: document.getElementById('expenseCustomerId').value,
        method: document.getElementById('expenseMethod').value,
        date: document.getElementById('expenseDate').value,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = expenses.findIndex(e => e.id === expense.id);
    if (existingIndex >= 0) {
        expenses[existingIndex] = expense;
        showNotification('Expense updated! ‚úÖ', 'success');
    } else {
        expenses.push(expense);
        
        // Update balance based on source
        if (expense.source === 'bank' && expense.bankId) {
            const bank = banks.find(b => b.id === expense.bankId);
            if (bank) bank.balance -= expense.amount;
        } else if (expense.source === 'customer' && expense.customerId) {
            const customer = customers.find(c => c.id === expense.customerId);
            if (customer) customer.balance -= expense.amount;
        }
        
        // Ledger entry
        const sourceAccount = expense.source === 'bank' ? 'Bank' : 
                             expense.source === 'customer' ? 'Customer' : 'Cash';
        addLedgerEntry('expense', `Expense: ${expense.category} - ${expense.description}`, 
            expense.category, expense.amount, sourceAccount, expense.amount, expense.date);
        
        showNotification('Expense added! üí∏', 'success');
    }
    
    saveToStorage();
    renderExpenses();
    renderBanks();
    renderCustomers();
    closeModal('expenseModal');
    updateDashboard();
    e.target.reset();
}

function renderExpenses() {
    const tbody = document.getElementById('expensesBody');
    tbody.innerHTML = '';
    
    expenses.slice().reverse().forEach(expense => {
        let paidFrom = '';
        if (expense.source === 'bank' && expense.bankId) {
            const bank = banks.find(b => b.id === expense.bankId);
            paidFrom = bank ? bank.name : 'Bank';
        } else if (expense.source === 'customer' && expense.customerId) {
            const customer = customers.find(c => c.id === expense.customerId);
            paidFrom = customer ? customer.name : 'Customer';
        } else {
            paidFrom = 'Cash';
        }
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(expense.date).toLocaleDateString()}</td>
            <td><span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${expense.category}</span></td>
            <td>${expense.description}</td>
            <td style="color: #f56565; font-weight: 700;">Rs. ${expense.amount.toFixed(2)}</td>
            <td>${paidFrom}</td>
            <td>${expense.method.toUpperCase()}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteExpense('${expense.id}')">Delete</button>
            </td>
        `;
    });
}

function deleteExpense(id) {
    if (confirm('Are you sure?')) {
        expenses = expenses.filter(e => e.id !== id);
        saveToStorage();
        renderExpenses();
        updateDashboard();
        showNotification('Expense deleted!', 'success');
    }
}

// BANK FUNCTIONS
function saveBank(e) {
    e.preventDefault();
    
    const bank = {
        id: document.getElementById('bankId').value || 'bank_' + Date.now(),
        name: document.getElementById('bankName').value,
        accountNumber: document.getElementById('bankAccount').value,
        balance: parseFloat(document.getElementById('bankBalance').value),
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = banks.findIndex(b => b.id === bank.id);
    if (existingIndex >= 0) {
        banks[existingIndex] = bank;
        showNotification('Bank updated! ‚úÖ', 'success');
    } else {
        banks.push(bank);
        showNotification('Bank added! ‚úÖ', 'success');
    }
    
    saveToStorage();
    renderBanks();
    closeModal('bankModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderBanks() {
    const tbody = document.getElementById('banksBody');
    tbody.innerHTML = '';
    
    banks.forEach(bank => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${bank.name}</strong></td>
            <td>${bank.accountNumber}</td>
            <td class="${bank.balance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${bank.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick='editBank(${JSON.stringify(bank).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteBank('${bank.id}')">Delete</button>
            </td>
        `;
    });
}

function editBank(bank) {
    document.getElementById('bankId').value = bank.id;
    document.getElementById('bankName').value = bank.name;
    document.getElementById('bankAccount').value = bank.accountNumber;
    document.getElementById('bankBalance').value = bank.balance;
    openModal('bankModal');
}

function deleteBank(id) {
    if (confirm('Are you sure?')) {
        banks = banks.filter(b => b.id !== id);
        saveToStorage();
        renderBanks();
        updateDashboard();
        populateDropdowns();
        showNotification('Bank deleted!', 'success');
    }
}

// BANK TRANSACTION FUNCTIONS
function saveBankTransaction(e) {
    e.preventDefault();
    
    const bankId = document.getElementById('bankTransBankId').value;
    const type = document.getElementById('bankTransType').value;
    const amount = parseFloat(document.getElementById('bankTransAmount').value);
    const description = document.getElementById('bankTransDescription').value;
    const date = document.getElementById('bankTransDate').value;
    
    const bank = banks.find(b => b.id === bankId);
    
    if (type === 'deposit') {
        bank.balance += amount;
    } else {
        bank.balance -= amount;
    }
    
    const transaction = {
        id: 'banktrans_' + Date.now(),
        bankId: bankId,
        bankName: bank.name,
        type: type,
        amount: amount,
        description: description,
        date: date,
        balanceAfter: bank.balance,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    bankTransactions.push(transaction);
    
    // Ledger entry
    if (type === 'deposit') {
        addLedgerEntry('bank_deposit', description || 'Bank Deposit', 
            'Bank', amount, 'Cash/Revenue', amount, date);
    } else {
        addLedgerEntry('bank_withdrawal', description || 'Bank Withdrawal', 
            'Cash/Expense', amount, 'Bank', amount, date);
    }
    
    saveToStorage();
    renderBankTransactions();
    renderBanks();
    closeModal('bankTransModal');
    updateDashboard();
    showNotification('Bank transaction recorded! üè¶', 'success');
    e.target.reset();
}

function renderBankTransactions() {
    const tbody = document.getElementById('bankTransactionsBody');
    tbody.innerHTML = '';
    
    bankTransactions.slice().reverse().slice(0, 20).forEach(trans => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(trans.date).toLocaleDateString()}</td>
            <td>${trans.bankName}</td>
            <td><span style="background: ${trans.type === 'deposit' ? '#48bb78' : '#f56565'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${trans.type.toUpperCase()}</span></td>
            <td style="font-weight: 700;">Rs. ${trans.amount.toFixed(2)}</td>
            <td>${trans.description || '-'}</td>
            <td style="font-weight: 600;">Rs. ${trans.balanceAfter.toFixed(2)}</td>
        `;
    });
}

// VEHICLE FUNCTIONS
function saveVehicle(e) {
    e.preventDefault();
    
    const vehicle = {
        id: document.getElementById('vehicleId').value || 'veh_' + Date.now(),
        number: document.getElementById('vehicleNumber').value,
        driverName: document.getElementById('vehicleDriver').value,
        contact: document.getElementById('vehicleContact').value,
        status: document.getElementById('vehicleStatus').value,
        stockPMG: 0,
        stockHSD: 0,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = vehicles.findIndex(v => v.id === vehicle.id);
    if (existingIndex >= 0) {
        vehicle.stockPMG = vehicles[existingIndex].stockPMG;
        vehicle.stockHSD = vehicles[existingIndex].stockHSD;
        vehicles[existingIndex] = vehicle;
        showNotification('Vehicle updated! ‚úÖ', 'success');
    } else {
        vehicles.push(vehicle);
        showNotification('Vehicle added! ‚úÖ', 'success');
    }
    
    saveToStorage();
    renderVehicles();
    closeModal('vehicleModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderVehicles() {
    const tbody = document.getElementById('vehiclesBody');
    tbody.innerHTML = '';
    
    vehicles.forEach(vehicle => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${vehicle.number}</strong></td>
            <td>${vehicle.driverName}</td>
            <td>${vehicle.contact || '-'}</td>
            <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
            <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
            <td><span style="background: ${vehicle.status === 'Active' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${vehicle.status}</span></td>
            <td>
                <button class="btn btn-info btn-sm" onclick='editVehicle(${JSON.stringify(vehicle).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteVehicle('${vehicle.id}')">Delete</button>
            </td>
        `;
    });
}

function editVehicle(vehicle) {
    document.getElementById('vehicleId').value = vehicle.id;
    document.getElementById('vehicleNumber').value = vehicle.number;
    document.getElementById('vehicleDriver').value = vehicle.driverName;
    document.getElementById('vehicleContact').value = vehicle.contact || '';
    document.getElementById('vehicleStatus').value = vehicle.status;
    openModal('vehicleModal');
}

function deleteVehicle(id) {
    if (confirm('Are you sure?')) {
        vehicles = vehicles.filter(v => v.id !== id);
        saveToStorage();
        renderVehicles();
        updateDashboard();
        populateDropdowns();
        showNotification('Vehicle deleted!', 'success');
    }
}

// LEDGER FUNCTIONS (NEW)
function generateLedger() {
    let html = '<div class="card"><h2>üìí Customer Ledger</h2>';
    
    if (customers.length === 0) {
        html += '<p style="text-align: center; color: #718096; padding: 20px;">No customers found</p></div>';
        document.getElementById('ledgerOutput').innerHTML = html;
        return;
    }
    
    customers.forEach(customer => {
        // Get all transactions for this customer
        const customerSales = transactions.filter(t => t.partyId === customer.id && t.type === 'sale');
        const customerPayments = payments.filter(p => p.partyId === customer.id && p.type === 'received');
        
        // Calculate totals
        const totalSales = customerSales.reduce((sum, t) => sum + t.amount, 0);
        const totalPayments = customerPayments.reduce((sum, p) => sum + p.amount, 0);
        const balance = customer.balance;
        
        html += `
            <div style="border: 2px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; background: #f7fafc;">
                <h3 style="color: #667eea; margin-bottom: 10px; font-size: 1.2em;">
                    ${customer.name}
                    <span style="float: right; color: ${balance >= 0 ? '#48bb78' : '#f56565'}; font-size: 0.9em;">
                        Balance: Rs. ${balance.toFixed(2)}
                    </span>
                </h3>
                <p style="color: #718096; font-size: 0.9em; margin-bottom: 15px;">
                    Contact: ${customer.contact || 'N/A'} | CNIC: ${customer.cnic || 'N/A'}
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.8em;">Total Sales</div>
                        <div style="color: #48bb78; font-weight: 700; font-size: 1.2em;">Rs. ${totalSales.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.8em;">Total Payments</div>
                        <div style="color: #4299e1; font-weight: 700; font-size: 1.2em;">Rs. ${totalPayments.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.8em;">Outstanding</div>
                        <div style="color: ${balance >= 0 ? '#ed8936' : '#48bb78'}; font-weight: 700; font-size: 1.2em;">Rs. ${balance.toFixed(2)}</div>
                    </div>
                </div>
                
                ${customerSales.length > 0 || customerPayments.length > 0 ? `
                <table style="width: 100%; font-size: 0.85em; background: white; border-radius: 8px;">
                    <thead style="background: #667eea; color: white;">
                        <tr>
                            <th style="padding: 8px; text-align: left;">Date</th>
                            <th style="padding: 8px; text-align: left;">Type</th>
                            <th style="padding: 8px; text-align: left;">Details</th>
                            <th style="padding: 8px; text-align: right;">Debit (Sales)</th>
                            <th style="padding: 8px; text-align: right;">Credit (Payment)</th>
                        </tr>
                    </thead>
                    <tbody>
        ` : '<p style="text-align: center; color: #718096; padding: 10px;">No transactions yet</p>'}
        `;
        
        // Combine and sort all entries by date
        const allEntries = [
            ...customerSales.map(t => ({
                date: t.date,
                type: 'Sale',
                details: `${t.fuelType} - ${t.quantity.toFixed(2)} L @ Rs. ${t.rate.toFixed(4)}`,
                debit: t.amount,
                credit: 0
            })),
            ...customerPayments.map(p => ({
                date: p.date,
                type: 'Payment',
                details: `${p.method} - ${p.notes || 'Payment received'}`,
                debit: 0,
                credit: p.amount
            }))
        ].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        allEntries.slice(0, 10).forEach(entry => {
            html += `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 8px;">${new Date(entry.date).toLocaleDateString()}</td>
                    <td style="padding: 8px;">
                        <span style="background: ${entry.type === 'Sale' ? '#48bb78' : '#4299e1'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">
                            ${entry.type}
                        </span>
                    </td>
                    <td style="padding: 8px;">${entry.details}</td>
                    <td style="padding: 8px; text-align: right; color: #f56565; font-weight: 600;">
                        ${entry.debit > 0 ? 'Rs. ' + entry.debit.toFixed(2) : '-'}
                    </td>
                    <td style="padding: 8px; text-align: right; color: #48bb78; font-weight: 600;">
                        ${entry.credit > 0 ? 'Rs. ' + entry.credit.toFixed(2) : '-'}
                    </td>
                </tr>
            `;
        });
        
        if (customerSales.length > 0 || customerPayments.length > 0) {
            html += `
                    </tbody>
                </table>
                ${allEntries.length > 10 ? `<p style="text-align: center; color: #718096; margin-top: 10px; font-size: 0.85em;">Showing last 10 transactions</p>` : ''}
            `;
        }
        
        html += '</div>';
    });
    
    html += '</div>';
    document.getElementById('ledgerOutput').innerHTML = html;
    showNotification('Customer ledger generated! üìí', 'success');
}

function checkBalance() {
    const today = new Date().toISOString().split('T')[0];
    const todayEntries = ledgerEntries.filter(e => e.date === today);
    
    let totalDebits = 0;
    let totalCredits = 0;
    
    todayEntries.forEach(entry => {
        totalDebits += entry.debitAmount;
        totalCredits += entry.creditAmount;
    });
    
    const balanced = Math.abs(totalDebits - totalCredits) < 0.01;
    
    let html = `
        <div class="card">
            <h2>‚öñÔ∏è Balance Check for ${new Date().toLocaleDateString()}</h2>
            <div class="profit-loss-section">
                <div class="profit-loss-item">
                    <span>Total Debits</span>
                    <span style="color: #f56565; font-weight: 700;">Rs. ${totalDebits.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Credits</span>
                    <span style="color: #48bb78; font-weight: 700;">Rs. ${totalCredits.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item total">
                    <span>Difference</span>
                    <span style="color: ${balanced ? '#48bb78' : '#f56565'};">Rs. ${Math.abs(totalDebits - totalCredits).toFixed(2)}</span>
                </div>
                <div class="profit-loss-item" style="background: ${balanced ? '#48bb78' : '#f56565'}; color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <span style="font-size: 1.2em;">${balanced ? '‚úÖ Books are BALANCED!' : '‚ö†Ô∏è Books are NOT balanced!'}</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('ledgerOutput').innerHTML = html;
    
    if (balanced) {
        showNotification('Books are perfectly balanced! ‚úÖ', 'success');
    } else {
        showNotification('Warning: Books are not balanced! ‚ö†Ô∏è', 'warning');
    }
}

// GOV RATE CHANGE
function roundRate(rate) {
    return Math.round(rate * 10000) / 10000;
}

function previewGovRateChange() {
    const updatePmg = document.getElementById('updatePmg').checked;
    const updateHsd = document.getElementById('updateHsd').checked;
    const changeType = document.getElementById('changeType').value;
    const changeSign = parseInt(document.getElementById('changeSign').value);
    const changeAmount = parseFloat(document.getElementById('changeAmount').value);
    const scope = document.getElementById('changeScope').value;
    
    if (!updatePmg && !updateHsd) {
        showNotification('Select at least one fuel type!', 'error');
        return;
    }
    
    let affectedParties = [];
    if (scope === 'all' || scope === 'customers') affectedParties = affectedParties.concat(customers);
    if (scope === 'all' || scope === 'suppliers') affectedParties = affectedParties.concat(suppliers);
    
    let html = '<table style="width:100%; font-size:0.85em;"><thead><tr><th>Name</th><th>Old PMG</th><th>New PMG</th><th>Old HSD</th><th>New HSD</th></tr></thead><tbody>';
    
    affectedParties.slice(0, 5).forEach(party => {
        const oldPmg = parseFloat(party.pmgRate);
        const oldHsd = parseFloat(party.hsdRate);
        
        let newPmg, newHsd;
        if (changeType === 'absolute') {
            newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
            newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
        } else {
            newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
            newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
        }
        
        html += `
            <tr>
                <td><strong>${party.name}</strong></td>
                <td>Rs. ${oldPmg.toFixed(4)}</td>
                <td style="color:${newPmg > oldPmg ? '#48bb78' : newPmg < oldPmg ? '#f56565' : '#718096'};">Rs. ${newPmg.toFixed(4)}</td>
                <td>Rs. ${oldHsd.toFixed(4)}</td>
                <td style="color:${newHsd > oldHsd ? '#48bb78' : newHsd < oldHsd ? '#f56565' : '#718096'};">Rs. ${newHsd.toFixed(4)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    if (affectedParties.length > 5) {
        html += `<p style="text-align:center; margin-top:10px; color:#718096;">... and ${affectedParties.length - 5} more</p>`;
    }
    html += `<p style="text-align:center; margin-top:15px; font-weight:700; color:#667eea;">Total: ${affectedParties.length} parties</p>`;
    
    document.getElementById('previewContent').innerHTML = html;
    document.getElementById('rateChangePreview').style.display = 'block';
}

function applyGovRateChange(e) {
    e.preventDefault();
    
    const updatePmg = document.getElementById('updatePmg').checked;
    const updateHsd = document.getElementById('updateHsd').checked;
    const changeType = document.getElementById('changeType').value;
    const changeSign = parseInt(document.getElementById('changeSign').value);
    const changeAmount = parseFloat(document.getElementById('changeAmount').value);
    const scope = document.getElementById('changeScope').value;
    
    if (!updatePmg && !updateHsd) {
        showNotification('Select at least one fuel type!', 'error');
        return;
    }
    
    if (!confirm(`Apply rate change?\nType: ${changeType}\nAmount: ${changeSign > 0 ? '+' : ''}${changeAmount}\nScope: ${scope}`)) {
        return;
    }
    
    const logEntry = {
        id: 'log_' + Date.now(),
        updatePmg,
        updateHsd,
        changeType,
        changeSign,
        changeAmount,
        scope,
        appliedBy: currentUser,
        appliedAt: new Date().toISOString(),
        changes: []
    };
    
    if (scope === 'all' || scope === 'customers') {
        customers.forEach(customer => {
            const oldPmg = parseFloat(customer.pmgRate);
            const oldHsd = parseFloat(customer.hsdRate);
            
            let newPmg, newHsd;
            if (changeType === 'absolute') {
                newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
            } else {
                newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
            }
            
            logEntry.changes.push({
                partyId: customer.id,
                partyName: customer.name,
                partyType: 'customer',
                oldPmgRate: oldPmg,
                newPmgRate: newPmg,
                oldHsdRate: oldHsd,
                newHsdRate: newHsd
            });
            
            customer.pmgRate = newPmg.toFixed(4);
            customer.hsdRate = newHsd.toFixed(4);
        });
    }
    
    if (scope === 'all' || scope === 'suppliers') {
        suppliers.forEach(supplier => {
            const oldPmg = parseFloat(supplier.pmgRate);
            const oldHsd = parseFloat(supplier.hsdRate);
            
            let newPmg, newHsd;
            if (changeType === 'absolute') {
                newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
            } else {
                newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
            }
            
            logEntry.changes.push({
                partyId: supplier.id,
                partyName: supplier.name,
                partyType: 'supplier',
                oldPmgRate: oldPmg,
                newPmgRate: newPmg,
                oldHsdRate: oldHsd,
                newHsdRate: newHsd
            });
            
            supplier.pmgRate = newPmg.toFixed(4);
            supplier.hsdRate = newHsd.toFixed(4);
        });
    }
    
    rateChangeLogs.push(logEntry);
    saveToStorage();
    
    showNotification(`üéâ Rate change applied to ${logEntry.changes.length} parties!`, 'success');
    closeModal('govRateModal');
    renderCustomers();
    renderSuppliers();
    document.getElementById('rateChangePreview').style.display = 'none';
    document.getElementById('changeAmount').value = '';
}

// REPORT FUNCTIONS
function generateCustomerLedgerReport() {
    const customerId = document.getElementById('customerReportSelect').value;
    const fromDate = document.getElementById('customerReportFromDate').value;
    const toDate = document.getElementById('customerReportToDate').value;
    
    if (!customerId) {
        showNotification('Please select a customer!', 'error');
        return;
    }
    
    const customer = customers.find(c => c.id === customerId);
    if (!customer) {
        showNotification('Customer not found!', 'error');
        return;
    }
    
    // Filter transactions by date if dates are provided
    let customerSales = transactions.filter(t => t.partyId === customerId && t.type === 'sale');
    let customerPayments = payments.filter(p => p.partyId === customerId && p.type === 'received');
    
    if (fromDate) {
        customerSales = customerSales.filter(t => t.date >= fromDate);
        customerPayments = customerPayments.filter(p => p.date >= fromDate);
    }
    if (toDate) {
        customerSales = customerSales.filter(t => t.date <= toDate);
        customerPayments = customerPayments.filter(p => p.date <= toDate);
    }
    
    const totalSales = customerSales.reduce((sum, t) => sum + t.amount, 0);
    const totalPayments = customerPayments.reduce((sum, p) => sum + p.amount, 0);
    const balance = customer.balance;
    
    let html = `
        <div class="card">
            <h2>üìí Customer Ledger Report</h2>
            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">${customer.name}</h3>
                        <p style="margin: 5px 0;"><strong>Contact:</strong> ${customer.contact || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>CNIC:</strong> ${customer.cnic || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>Address:</strong> ${customer.address || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="margin: 5px 0;"><strong>PMG Rate:</strong> Rs. ${customer.pmgRate}</p>
                        <p style="margin: 5px 0;"><strong>HSD Rate:</strong> Rs. ${customer.hsdRate}</p>
                        <p style="margin: 5px 0;"><strong>Report Period:</strong> ${fromDate || 'Start'} to ${toDate || 'Today'}</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: #48bb78; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Total Sales</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${totalSales.toFixed(2)}</div>
                </div>
                <div style="background: #4299e1; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Total Payments</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${totalPayments.toFixed(2)}</div>
                </div>
                <div style="background: ${balance >= 0 ? '#ed8936' : '#48bb78'}; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Current Balance</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${balance.toFixed(2)}</div>
                </div>
            </div>
            
            ${customerSales.length > 0 || customerPayments.length > 0 ? `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Debit (Sales)</th>
                            <th>Credit (Payment)</th>
                            <th>Running Balance</th>
                        </tr>
                    </thead>
                    <tbody>
            ` : '<p style="text-align: center; color: #718096; padding: 20px;">No transactions in selected period</p>'}
    `;
    
    // Combine and sort all entries by date
    const allEntries = [
        ...customerSales.map(t => ({
            date: t.date,
            type: 'Sale',
            details: `${t.fuelType} - ${t.quantity.toFixed(2)} L @ Rs. ${t.rate.toFixed(4)}`,
            debit: t.amount,
            credit: 0
        })),
        ...customerPayments.map(p => ({
            date: p.date,
            type: 'Payment',
            details: `${p.method} - ${p.notes || 'Payment received'}`,
            debit: 0,
            credit: p.amount
        }))
    ].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    let runningBalance = 0;
    allEntries.forEach(entry => {
        runningBalance += entry.debit - entry.credit;
        html += `
            <tr>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td>
                    <span style="background: ${entry.type === 'Sale' ? '#48bb78' : '#4299e1'}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8em;">
                        ${entry.type}
                    </span>
                </td>
                <td>${entry.details}</td>
                <td style="color: #f56565; font-weight: 600;">
                    ${entry.debit > 0 ? 'Rs. ' + entry.debit.toFixed(2) : '-'}
                </td>
                <td style="color: #48bb78; font-weight: 600;">
                    ${entry.credit > 0 ? 'Rs. ' + entry.credit.toFixed(2) : '-'}
                </td>
                <td style="font-weight: 700; color: ${runningBalance >= 0 ? '#ed8936' : '#48bb78'};">
                    Rs. ${runningBalance.toFixed(2)}
                </td>
            </tr>
        `;
    });
    
    if (customerSales.length > 0 || customerPayments.length > 0) {
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    html += '</div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Customer ledger report generated! üìí', 'success');
}

function generateSingleVehicleReport() {
    const vehicleId = document.getElementById('vehicleReportSelect').value;
    const fromDate = document.getElementById('vehicleReportFromDate').value;
    const toDate = document.getElementById('vehicleReportToDate').value;
    
    if (!vehicleId) {
        showNotification('Please select a vehicle!', 'error');
        return;
    }
    
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
        showNotification('Vehicle not found!', 'error');
        return;
    }
    
    // Filter transactions by date if dates are provided
    let vehicleSales = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'sale');
    let vehiclePurchases = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'purchase');
    
    if (fromDate) {
        vehicleSales = vehicleSales.filter(t => t.date >= fromDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date >= fromDate);
    }
    if (toDate) {
        vehicleSales = vehicleSales.filter(t => t.date <= toDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date <= toDate);
    }
    
    const totalSales = vehicleSales.reduce((sum, t) => sum + t.amount, 0);
    const totalPurchases = vehiclePurchases.reduce((sum, t) => sum + t.amount, 0);
    const profit = totalSales - totalPurchases;
    
    // Calculate fuel-wise breakdown
    const pmgSales = vehicleSales.filter(t => t.fuelType === 'PMG').reduce((sum, t) => sum + t.amount, 0);
    const hsdSales = vehicleSales.filter(t => t.fuelType === 'HSD').reduce((sum, t) => sum + t.amount, 0);
    const pmgPurchases = vehiclePurchases.filter(t => t.fuelType === 'PMG').reduce((sum, t) => sum + t.amount, 0);
    const hsdPurchases = vehiclePurchases.filter(t => t.fuelType === 'HSD').reduce((sum, t) => sum + t.amount, 0);
    
    let html = `
        <div class="card">
            <h2>üöõ Vehicle Profit Report</h2>
            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">${vehicle.number}</h3>
                        <p style="margin: 5px 0;"><strong>Driver:</strong> ${vehicle.driverName}</p>
                        <p style="margin: 5px 0;"><strong>Contact:</strong> ${vehicle.contact || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: ${vehicle.status === 'Active' ? '#48bb78' : '#ed8936'};">${vehicle.status}</span></p>
                    </div>
                    <div>
                        <p style="margin: 5px 0;"><strong>Current PMG Stock:</strong> ${vehicle.stockPMG.toFixed(2)} KL</p>
                        <p style="margin: 5px 0;"><strong>Current HSD Stock:</strong> ${vehicle.stockHSD.toFixed(2)} KL</p>
                        <p style="margin: 5px 0;"><strong>Report Period:</strong> ${fromDate || 'Start'} to ${toDate || 'Today'}</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: #48bb78; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Total Sales</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${totalSales.toFixed(2)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${vehicleSales.length} transactions</div>
                </div>
                <div style="background: #ed8936; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Total Purchases</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${totalPurchases.toFixed(2)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${vehiclePurchases.length} transactions</div>
                </div>
                <div style="background: ${profit >= 0 ? '#667eea' : '#f56565'}; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Profit/Loss</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${profit.toFixed(2)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${profit >= 0 ? 'Profit ‚úÖ' : 'Loss ‚ö†Ô∏è'}</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">PMG (Petrol)</h4>
                    <p style="margin: 5px 0;"><strong>Sales:</strong> Rs. ${pmgSales.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Purchases:</strong> Rs. ${pmgPurchases.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Profit:</strong> <span style="color: ${(pmgSales - pmgPurchases) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700;">Rs. ${(pmgSales - pmgPurchases).toFixed(2)}</span></p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #ed8936;">
                    <h4 style="color: #ed8936; margin-bottom: 10px;">HSD (Diesel)</h4>
                    <p style="margin: 5px 0;"><strong>Sales:</strong> Rs. ${hsdSales.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Purchases:</strong> Rs. ${hsdPurchases.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Profit:</strong> <span style="color: ${(hsdSales - hsdPurchases) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700;">Rs. ${(hsdSales - hsdPurchases).toFixed(2)}</span></p>
                </div>
            </div>
            
            ${vehicleSales.length > 0 || vehiclePurchases.length > 0 ? `
            <h3 style="color: #667eea; margin-bottom: 10px;">Transaction Details</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Party</th>
                            <th>Fuel</th>
                            <th>Quantity (L)</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            ` : '<p style="text-align: center; color: #718096; padding: 20px;">No transactions in selected period</p>'}
    `;
    
    // Combine all transactions and sort by date
    const allTransactions = [...vehicleSales, ...vehiclePurchases].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    allTransactions.forEach(trans => {
        html += `
            <tr>
                <td>${new Date(trans.date).toLocaleDateString()}</td>
                <td>
                    <span style="background: ${trans.type === 'sale' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8em;">
                        ${trans.type.toUpperCase()}
                    </span>
                </td>
                <td>${trans.partyName}</td>
                <td><span style="background: ${trans.fuelType === 'PMG' ? '#667eea' : '#ed8936'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">${trans.fuelType}</span></td>
                <td>${trans.quantity.toFixed(2)}</td>
                <td>Rs. ${trans.rate.toFixed(4)}</td>
                <td style="font-weight: 700; color: ${trans.type === 'sale' ? '#48bb78' : '#ed8936'};">Rs. ${trans.amount.toFixed(2)}</td>
            </tr>
        `;
    });
    
    if (vehicleSales.length > 0 || vehiclePurchases.length > 0) {
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    html += '</div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Vehicle report generated! üöõ', 'success');
}

function generateAllPartiesReport() {
    let html = `
        <div class="card">
            <h2>üìã All Parties Balance Report</h2>
            <p style="color: #718096; margin-bottom: 20px;">Complete overview of all balances as of ${new Date().toLocaleDateString()}</p>
            
            <!-- Customers Section -->
            <h3 style="color: #48bb78; margin-top: 20px; margin-bottom: 10px;">üë• Customers (Receivables)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>PMG Rate</th>
                            <th>HSD Rate</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalReceivables = 0;
    customers.forEach(customer => {
        totalReceivables += customer.balance > 0 ? customer.balance : 0;
        html += `
            <tr>
                <td><strong>${customer.name}</strong></td>
                <td>${customer.contact || 'N/A'}</td>
                <td>Rs. ${customer.pmgRate}</td>
                <td>Rs. ${customer.hsdRate}</td>
                <td style="font-weight: 700; color: ${customer.balance > 0 ? '#ed8936' : '#48bb78'};">
                    Rs. ${customer.balance.toFixed(2)}
                </td>
                <td>
                    ${customer.balance > 0 ? '<span style="background: #ed8936; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">PENDING</span>' : '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">CLEAR</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #48bb78;">
                            <td colspan="4"><strong>TOTAL RECEIVABLES</strong></td>
                            <td style="color: #ed8936; font-size: 1.2em;">Rs. ${totalReceivables.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Suppliers Section -->
            <h3 style="color: #ed8936; margin-top: 30px; margin-bottom: 10px;">üè≠ Suppliers (Payables)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>PMG Rate</th>
                            <th>HSD Rate</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalPayables = 0;
    suppliers.forEach(supplier => {
        totalPayables += supplier.balance > 0 ? supplier.balance : 0;
        html += `
            <tr>
                <td><strong>${supplier.name}</strong></td>
                <td>${supplier.contact || 'N/A'}</td>
                <td>Rs. ${supplier.pmgRate}</td>
                <td>Rs. ${supplier.hsdRate}</td>
                <td style="font-weight: 700; color: ${supplier.balance > 0 ? '#f56565' : '#48bb78'};">
                    Rs. ${supplier.balance.toFixed(2)}
                </td>
                <td>
                    ${supplier.balance > 0 ? '<span style="background: #f56565; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">TO PAY</span>' : '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">CLEAR</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #ed8936;">
                            <td colspan="4"><strong>TOTAL PAYABLES</strong></td>
                            <td style="color: #f56565; font-size: 1.2em;">Rs. ${totalPayables.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Banks Section -->
            <h3 style="color: #4299e1; margin-top: 30px; margin-bottom: 10px;">üè¶ Bank Accounts</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Bank Name</th>
                            <th>Account Number</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalBankBalance = 0;
    banks.forEach(bank => {
        totalBankBalance += bank.balance;
        html += `
            <tr>
                <td><strong>${bank.name}</strong></td>
                <td>${bank.accountNumber}</td>
                <td style="font-weight: 700; color: ${bank.balance >= 0 ? '#48bb78' : '#f56565'};">
                    Rs. ${bank.balance.toFixed(2)}
                </td>
                <td>
                    ${bank.balance >= 0 ? '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">POSITIVE</span>' : '<span style="background: #f56565; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">NEGATIVE</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #4299e1;">
                            <td colspan="2"><strong>TOTAL BANK BALANCE</strong></td>
                            <td style="color: #4299e1; font-size: 1.2em;">Rs. ${totalBankBalance.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Vehicles Section -->
            <h3 style="color: #805ad5; margin-top: 30px; margin-bottom: 10px;">üöõ Vehicles & Stock</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Vehicle Number</th>
                            <th>Driver</th>
                            <th>PMG Stock (KL)</th>
                            <th>HSD Stock (KL)</th>
                            <th>Total Stock (KL)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalStock = 0;
    vehicles.forEach(vehicle => {
        const vehicleStock = vehicle.stockPMG + vehicle.stockHSD;
        totalStock += vehicleStock;
        html += `
            <tr>
                <td><strong>${vehicle.number}</strong></td>
                <td>${vehicle.driverName}</td>
                <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
                <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
                <td style="font-weight: 700;">${vehicleStock.toFixed(2)} KL</td>
                <td>
                    <span style="background: ${vehicle.status === 'Active' ? '#48bb78' : '#ed8936'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">${vehicle.status}</span>
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #805ad5;">
                            <td colspan="4"><strong>TOTAL STOCK</strong></td>
                            <td style="color: #805ad5; font-size: 1.2em;">${totalStock.toFixed(2)} KL</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Summary -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-top: 30px;">
                <h3 style="color: white; margin-bottom: 15px; text-align: center;">üìä Financial Summary</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Total Receivables</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalReceivables.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Total Payables</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalPayables.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Bank Balance</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalBankBalance.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Net Position</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${(totalReceivables - totalPayables + totalBankBalance).toFixed(2)}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('All parties report generated! üìã', 'success');
}

function generateProfitLossReport() {
    const totalSales = transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
    const totalPurchases = transactions.filter(t => t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
    const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
    const grossProfit = totalSales - totalPurchases;
    const netProfit = grossProfit - totalExpenses;
    
    const html = `
        <div class="card">
            <h2>üìä Profit & Loss Statement</h2>
            <div class="profit-loss-section">
                <div class="profit-loss-item">
                    <span>Total Sales</span>
                    <span style="color: #48bb78; font-weight: 600;">Rs. ${totalSales.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Purchases</span>
                    <span style="color: #f56565; font-weight: 600;">Rs. ${totalPurchases.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Gross Profit</span>
                    <span style="font-weight: 600;">Rs. ${grossProfit.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Expenses</span>
                    <span style="color: #ed8936; font-weight: 600;">Rs. ${totalExpenses.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item total">
                    <span>Net Profit</span>
                    <span style="color: ${netProfit >= 0 ? '#48bb78' : '#f56565'};">Rs. ${netProfit.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Profit & Loss generated!', 'success');
}

function generateMonthlyReport() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    const monthlyTransactions = transactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
    });
    
    const monthlyExpenses = expenses.filter(e => {
        const eDate = new Date(e.date);
        return eDate.getMonth() === currentMonth && eDate.getFullYear() === currentYear;
    }).reduce((sum, e) => sum + e.amount, 0);
    
    const monthlySales = monthlyTransactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
    const monthlyPurchases = monthlyTransactions.filter(t => t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
    const monthlyProfit = monthlySales - monthlyPurchases - monthlyExpenses;
    
    const html = `
        <div class="card">
            <h2>üìÖ Monthly Report - ${now.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
            <div class="profit-loss-section">
                <div class="profit-loss-item">
                    <span>Monthly Sales</span>
                    <span style="color: #48bb78; font-weight: 600;">Rs. ${monthlySales.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Monthly Purchases</span>
                    <span style="color: #f56565; font-weight: 600;">Rs. ${monthlyPurchases.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Monthly Expenses</span>
                    <span style="color: #ed8936; font-weight: 600;">Rs. ${monthlyExpenses.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Transactions</span>
                    <span style="font-weight: 600;">${monthlyTransactions.length}</span>
                </div>
                <div class="profit-loss-item total">
                    <span>Monthly Net Profit</span>
                    <span style="color: ${monthlyProfit >= 0 ? '#48bb78' : '#f56565'};">Rs. ${monthlyProfit.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Monthly report generated!', 'success');
}

function generateVehicleProfitReport() {
    let html = '<div class="card"><h2>üöõ Vehicle-wise Profit Analysis</h2><div class="table-container"><table><thead><tr><th>Vehicle</th><th>Driver</th><th>Total Sales</th><th>Total Purchases</th><th>Profit/Loss</th><th>PMG Stock</th><th>HSD Stock</th><th>Deliveries</th></tr></thead><tbody>';
    
    let totalSalesAll = 0;
    let totalPurchasesAll = 0;
    let totalProfitAll = 0;
    
    vehicles.forEach(vehicle => {
        // Calculate ACTUAL sales from this vehicle
        const vehicleSales = transactions.filter(t => t.vehicleId === vehicle.id && t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
        
        // Calculate ACTUAL purchases into this vehicle
        const vehiclePurchases = transactions.filter(t => t.vehicleId === vehicle.id && t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
        
        // Calculate REAL profit = Sales - Purchases
        const actualProfit = vehicleSales - vehiclePurchases;
        
        // Count deliveries
        const deliveryCount = transactions.filter(t => t.vehicleId === vehicle.id).length;
        
        totalSalesAll += vehicleSales;
        totalPurchasesAll += vehiclePurchases;
        totalProfitAll += actualProfit;
        
        html += `
            <tr>
                <td><strong>${vehicle.number}</strong></td>
                <td>${vehicle.driverName}</td>
                <td style="color: #48bb78; font-weight: 700;">Rs. ${vehicleSales.toFixed(2)}</td>
                <td style="color: #ed8936; font-weight: 700;">Rs. ${vehiclePurchases.toFixed(2)}</td>
                <td style="color: ${actualProfit >= 0 ? '#667eea' : '#f56565'}; font-weight: 700; font-size: 1.1em;">
                    Rs. ${actualProfit.toFixed(2)}
                    ${actualProfit >= 0 ? '‚úÖ' : '‚ö†Ô∏è'}
                </td>
                <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
                <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
                <td>${deliveryCount}</td>
            </tr>
        `;
    });
    
    // Add totals row
    html += `
        <tr style="background: #f7fafc; font-weight: 700; font-size: 1.1em; border-top: 3px solid #667eea;">
            <td colspan="2"><strong>TOTAL</strong></td>
            <td style="color: #48bb78;">Rs. ${totalSalesAll.toFixed(2)}</td>
            <td style="color: #ed8936;">Rs. ${totalPurchasesAll.toFixed(2)}</td>
            <td style="color: ${totalProfitAll >= 0 ? '#667eea' : '#f56565'}; font-size: 1.2em;">
                Rs. ${totalProfitAll.toFixed(2)}
                ${totalProfitAll >= 0 ? 'üéâ' : '‚ö†Ô∏è'}
            </td>
            <td colspan="3"></td>
        </tr>
    `;
    
    html += '</tbody></table></div>';
    
    // Add summary section
    html += `
        <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 10px; border-left: 4px solid #667eea;">
            <h3 style="color: #667eea; margin-bottom: 10px;">üìä Summary</h3>
            <p style="margin: 5px 0;"><strong>Total Sales:</strong> Rs. ${totalSalesAll.toFixed(2)}</p>
            <p style="margin: 5px 0;"><strong>Total Purchases:</strong> Rs. ${totalPurchasesAll.toFixed(2)}</p>
            <p style="margin: 5px 0;"><strong>Overall Profit:</strong> <span style="color: ${totalProfitAll >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700; font-size: 1.2em;">Rs. ${totalProfitAll.toFixed(2)}</span></p>
            <p style="margin: 5px 0; color: #718096; font-size: 0.9em;"><em>Note: This shows actual profit (Sales - Purchases) for each vehicle</em></p>
        </div>
    `;
    
    html += '</div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Vehicle profit report generated! üöõ', 'success');
}

function generateStockReport() {
    let totalPMG = 0;
    let totalHSD = 0;
    
    let html = '<div class="card"><h2>üì¶ Stock Report</h2><div class="table-container"><table><thead><tr><th>Vehicle</th><th>PMG Stock (KL)</th><th>HSD Stock (KL)</th><th>Total Stock (KL)</th></tr></thead><tbody>';
    
    vehicles.forEach(vehicle => {
        const totalStock = vehicle.stockPMG + vehicle.stockHSD;
        totalPMG += vehicle.stockPMG;
        totalHSD += vehicle.stockHSD;
        
        html += `
            <tr>
                <td><strong>${vehicle.number}</strong></td>
                <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
                <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
                <td style="font-weight: 700;">${totalStock.toFixed(2)} KL</td>
            </tr>
        `;
    });
    
    html += `
        <tr style="background: #f7fafc; font-weight: 700;">
            <td>TOTAL</td>
            <td><span class="stock-badge stock-pmg">${totalPMG.toFixed(2)} KL</span></td>
            <td><span class="stock-badge stock-hsd">${totalHSD.toFixed(2)} KL</span></td>
            <td style="color: #667eea; font-size: 1.2em;">${(totalPMG + totalHSD).toFixed(2)} KL</td>
        </tr>
    `;
    
    html += '</tbody></table></div></div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Stock report generated!', 'success');
}

function generateExpenseReport() {
    const expensesByCategory = {};
    expenses.forEach(e => {
        if (!expensesByCategory[e.category]) {
            expensesByCategory[e.category] = 0;
        }
        expensesByCategory[e.category] += e.amount;
    });
    
    let html = '<div class="card"><h2>üí∏ Expense Report by Category</h2><div class="table-container"><table><thead><tr><th>Category</th><th>Total Amount</th><th>Count</th></tr></thead><tbody>';
    
    Object.keys(expensesByCategory).forEach(category => {
        const count = expenses.filter(e => e.category === category).length;
        html += `
            <tr>
                <td><strong>${category}</strong></td>
                <td style="color: #f56565; font-weight: 700;">Rs. ${expensesByCategory[category].toFixed(2)}</td>
                <td>${count}</td>
            </tr>
        `;
    });
    
    const totalExpenses = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);
    html += `
        <tr style="background: #f7fafc; font-weight: 700;">
            <td>TOTAL</td>
            <td style="color: #f56565;">Rs. ${totalExpenses.toFixed(2)}</td>
            <td>${expenses.length}</td>
        </tr>
    `;
    
    html += '</tbody></table></div></div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Expense report generated!', 'success');
}

// EXPORT FUNCTIONS
function exportVehicleProfitPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Vehicle-wise Profit & Stock Analysis', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 32, { align: 'center' });
    doc.text(`Generated by: ${currentUser}`, 105, 38, { align: 'center' });
    
    const tableData = vehicles.map(v => {
        const vehicleSales = transactions.filter(t => t.vehicleId === v.id && t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
        const vehiclePurchases = transactions.filter(t => t.vehicleId === v.id && t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
        const actualProfit = vehicleSales - vehiclePurchases;
        
        return [
            v.number,
            v.driverName,
            `Rs. ${vehicleSales.toFixed(2)}`,
            `Rs. ${vehiclePurchases.toFixed(2)}`,
            `Rs. ${actualProfit.toFixed(2)}`,
            `${v.stockPMG.toFixed(2)} KL`,
            `${v.stockHSD.toFixed(2)} KL`
        ];
    });
    
    doc.autoTable({
        startY: 45,
        head: [['Vehicle', 'Driver', 'Sales', 'Purchases', 'Actual Profit', 'PMG Stock', 'HSD Stock']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`vehicle-profit-report-${Date.now()}.pdf`);
    showNotification('PDF exported! üìÑ', 'success');
}

function exportCustomerLedgerPDF() {
    const customerId = document.getElementById('customerReportSelect').value;
    const fromDate = document.getElementById('customerReportFromDate').value;
    const toDate = document.getElementById('customerReportToDate').value;
    
    if (!customerId) {
        showNotification('Please select a customer first!', 'error');
        return;
    }
    
    const customer = customers.find(c => c.id === customerId);
    if (!customer) {
        showNotification('Customer not found!', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Customer Ledger Report', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Period: ${fromDate || 'Start'} to ${toDate || 'Today'}`, 105, 32, { align: 'center' });
    
    // Customer info
    doc.setFontSize(11);
    doc.text(`Customer: ${customer.name}`, 20, 45);
    doc.text(`Contact: ${customer.contact || 'N/A'}`, 20, 52);
    doc.text(`Balance: Rs. ${customer.balance.toFixed(2)}`, 20, 59);
    
    // Filter transactions
    let customerSales = transactions.filter(t => t.partyId === customerId && t.type === 'sale');
    let customerPayments = payments.filter(p => p.partyId === customerId && p.type === 'received');
    
    if (fromDate) {
        customerSales = customerSales.filter(t => t.date >= fromDate);
        customerPayments = customerPayments.filter(p => p.date >= fromDate);
    }
    if (toDate) {
        customerSales = customerSales.filter(t => t.date <= toDate);
        customerPayments = customerPayments.filter(p => p.date <= toDate);
    }
    
    const allEntries = [
        ...customerSales.map(t => ({
            date: t.date,
            type: 'Sale',
            details: `${t.fuelType} - ${t.quantity.toFixed(2)}L`,
            debit: t.amount,
            credit: 0
        })),
        ...customerPayments.map(p => ({
            date: p.date,
            type: 'Payment',
            details: p.method,
            debit: 0,
            credit: p.amount
        }))
    ].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const tableData = allEntries.map(entry => [
        new Date(entry.date).toLocaleDateString(),
        entry.type,
        entry.details,
        entry.debit > 0 ? `Rs. ${entry.debit.toFixed(2)}` : '-',
        entry.credit > 0 ? `Rs. ${entry.credit.toFixed(2)}` : '-'
    ]);
    
    doc.autoTable({
        startY: 70,
        head: [['Date', 'Type', 'Details', 'Debit (Sales)', 'Credit (Payment)']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`customer-ledger-${customer.name}-${Date.now()}.pdf`);
    showNotification('Customer ledger PDF exported! üìÑ', 'success');
}

function exportSingleVehiclePDF() {
    const vehicleId = document.getElementById('vehicleReportSelect').value;
    const fromDate = document.getElementById('vehicleReportFromDate').value;
    const toDate = document.getElementById('vehicleReportToDate').value;
    
    if (!vehicleId) {
        showNotification('Please select a vehicle first!', 'error');
        return;
    }
    
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
        showNotification('Vehicle not found!', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Vehicle Profit Report', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Period: ${fromDate || 'Start'} to ${toDate || 'Today'}`, 105, 32, { align: 'center' });
    
    // Vehicle info
    let vehicleSales = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'sale');
    let vehiclePurchases = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'purchase');
    
    if (fromDate) {
        vehicleSales = vehicleSales.filter(t => t.date >= fromDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date >= fromDate);
    }
    if (toDate) {
        vehicleSales = vehicleSales.filter(t => t.date <= toDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date <= toDate);
    }
    
    const totalSales = vehicleSales.reduce((sum, t) => sum + t.amount, 0);
    const totalPurchases = vehiclePurchases.reduce((sum, t) => sum + t.amount, 0);
    const profit = totalSales - totalPurchases;
    
    doc.setFontSize(11);
    doc.text(`Vehicle: ${vehicle.number}`, 20, 45);
    doc.text(`Driver: ${vehicle.driverName}`, 20, 52);
    doc.text(`Sales: Rs. ${totalSales.toFixed(2)}`, 20, 59);
    doc.text(`Purchases: Rs. ${totalPurchases.toFixed(2)}`, 20, 66);
    doc.text(`Profit: Rs. ${profit.toFixed(2)}`, 20, 73);
    
    const allTransactions = [...vehicleSales, ...vehiclePurchases].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tableData = allTransactions.map(trans => [
        new Date(trans.date).toLocaleDateString(),
        trans.type.toUpperCase(),
        trans.partyName,
        trans.fuelType,
        `${trans.quantity.toFixed(2)}L`,
        `Rs. ${trans.amount.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: 82,
        head: [['Date', 'Type', 'Party', 'Fuel', 'Quantity', 'Amount']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`vehicle-report-${vehicle.number}-${Date.now()}.pdf`);
    showNotification('Vehicle report PDF exported! üìÑ', 'success');
}

function exportAllPartiesPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('All Parties Balance Report', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 32, { align: 'center' });
    doc.text(`Generated by: ${currentUser}`, 105, 38, { align: 'center' });
    
    let startY = 48;
    
    // Customers
    doc.setFontSize(11);
    doc.text('CUSTOMERS (Receivables)', 20, startY);
    const customerData = customers.map(c => [
        c.name,
        c.contact || 'N/A',
        `Rs. ${c.balance.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: startY + 5,
        head: [['Name', 'Contact', 'Balance']],
        body: customerData,
        theme: 'striped',
        headStyles: { fillColor: [72, 187, 120] }
    });
    
    startY = doc.lastAutoTable.finalY + 15;
    
    // Suppliers
    doc.text('SUPPLIERS (Payables)', 20, startY);
    const supplierData = suppliers.map(s => [
        s.name,
        s.contact || 'N/A',
        `Rs. ${s.balance.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: startY + 5,
        head: [['Name', 'Contact', 'Balance']],
        body: supplierData,
        theme: 'striped',
        headStyles: { fillColor: [237, 137, 54] }
    });
    
    startY = doc.lastAutoTable.finalY + 15;
    
    // Banks
    if (startY > 250) {
        doc.addPage();
        startY = 20;
    }
    
    doc.text('BANK ACCOUNTS', 20, startY);
    const bankData = banks.map(b => [
        b.name,
        b.accountNumber,
        `Rs. ${b.balance.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: startY + 5,
        head: [['Bank Name', 'Account Number', 'Balance']],
        body: bankData,
        theme: 'striped',
        headStyles: { fillColor: [66, 153, 225] }
    });
    
    doc.save(`all-parties-balance-${Date.now()}.pdf`);
    showNotification('All parties report PDF exported! üìÑ', 'success');
}

function exportAllDataExcel() {
    const wb = XLSX.utils.book_new();
    
    // Customers
    const customersData = customers.map(c => ({
        Name: c.name,
        Contact: c.contact,
        CNIC: c.cnic,
        'PMG Rate': c.pmgRate,
        'HSD Rate': c.hsdRate,
        Balance: c.balance,
        Address: c.address
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(customersData), 'Customers');
    
    // Suppliers
    const suppliersData = suppliers.map(s => ({
        Name: s.name,
        Contact: s.contact,
        CNIC: s.cnic,
        'PMG Rate': s.pmgRate,
        'HSD Rate': s.hsdRate,
        Balance: s.balance,
        Address: s.address
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(suppliersData), 'Suppliers');
    
    // Transactions
    const transData = transactions.map(t => ({
        Date: t.date,
        Type: t.type,
        Party: t.partyName,
        'Fuel Type': t.fuelType,
        Quantity: t.quantity,
        Rate: t.rate,
        Amount: t.amount
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transData), 'Transactions');
    
    // Payments
    const paymentsData = payments.map(p => ({
        Date: p.date,
        Type: p.type,
        Party: p.partyName,
        Amount: p.amount,
        Method: p.method,
        Notes: p.notes
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(paymentsData), 'Payments');
    
    // Expenses
    const expensesData = expenses.map(e => ({
        Date: e.date,
        Category: e.category,
        Description: e.description,
        Amount: e.amount,
        Source: e.source,
        Method: e.method
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expensesData), 'Expenses');
    
    // Vehicles with Stock
    const vehiclesData = vehicles.map(v => ({
        'Vehicle Number': v.number,
        Driver: v.driverName,
        Contact: v.contact,
        Status: v.status,
        'PMG Stock (KL)': v.stockPMG.toFixed(2),
        'HSD Stock (KL)': v.stockHSD.toFixed(2)
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(vehiclesData), 'Vehicles');
    
    // Banks
    const banksData = banks.map(b => ({
        'Bank Name': b.name,
        'Account Number': b.accountNumber,
        Balance: b.balance
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(banksData), 'Banks');
    
    // Ledger
    const ledgerData = ledgerEntries.map(l => ({
        Date: l.date,
        Type: l.type,
        Description: l.description,
        'Debit Account': l.debitAccount,
        'Debit Amount': l.debitAmount,
        'Credit Account': l.creditAccount,
        'Credit Amount': l.creditAmount
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ledgerData), 'Ledger');
    
    XLSX.writeFile(wb, `baghoor-complete-${Date.now()}.xlsx`);
    showNotification('Excel exported! üìä', 'success');
}

// BACKUP FUNCTIONS
function createBackup() {
    const backup = {
        version: '4.0',
        timestamp: new Date().toISOString(),
        createdBy: currentUser,
        data: {
            customers,
            suppliers,
            vehicles,
            banks,
            transactions,
            payments,
            expenses,
            customerTransfers,
            bankTransactions,
            rateChangeLogs,
            ledgerEntries
        }
    };
    
    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `baghoor-backup-${Date.now()}.json`;
    link.click();
    
    showNotification('Backup downloaded! üíæ', 'success');
}

function restoreBackup() {
    const fileInput = document.getElementById('backupFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('Please select a backup file!', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (backup.data) {
                customers = backup.data.customers || [];
                suppliers = backup.data.suppliers || [];
                vehicles = backup.data.vehicles || [];
                banks = backup.data.banks || [];
                transactions = backup.data.transactions || [];
                payments = backup.data.payments || [];
                expenses = backup.data.expenses || [];
                customerTransfers = backup.data.customerTransfers || [];
                bankTransactions = backup.data.bankTransactions || [];
                rateChangeLogs = backup.data.rateChangeLogs || [];
                ledgerEntries = backup.data.ledgerEntries || [];
                
                saveToStorage();
                initApp();
                closeModal('backupModal');
                showNotification('Backup restored! üéâ', 'success');
            } else {
                showNotification('Invalid backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading backup!', 'error');
        }
    };
    reader.readAsText(file);
}

// UI HELPER FUNCTIONS
function updateDashboard() {
    document.getElementById('totalCustomers').textContent = customers.length;
    document.getElementById('totalSuppliers').textContent = suppliers.length;
    document.getElementById('totalVehicles').textContent = vehicles.length;
    document.getElementById('totalBanks').textContent = banks.length;
    
    const totalReceivables = customers.reduce((sum, c) => sum + (c.balance > 0 ? c.balance : 0), 0);
    document.getElementById('totalReceivables').textContent = 'Rs. ' + totalReceivables.toFixed(2);
    
    const totalPayables = suppliers.reduce((sum, s) => sum + (s.balance > 0 ? s.balance : 0), 0);
    document.getElementById('totalPayables').textContent = 'Rs. ' + totalPayables.toFixed(2);
    
    const totalBankBalance = banks.reduce((sum, b) => sum + b.balance, 0);
    document.getElementById('totalBankBalance').textContent = 'Rs. ' + totalBankBalance.toFixed(2);
    
    const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('totalExpenses').textContent = 'Rs. ' + totalExpenses.toFixed(2);
    
    const totalStock = vehicles.reduce((sum, v) => sum + v.stockPMG + v.stockHSD, 0);
    document.getElementById('totalStock').textContent = totalStock.toFixed(2) + ' KL';
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
    
    if (tabName === 'ledger') {
        generateLedger();
    }
}

function openModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function populateDropdowns() {
    // Customers
    const customerSelects = [
        document.getElementById('saleCustomerId'),
        document.getElementById('transferFromCustomerId'),
        document.getElementById('transferToCustomerId'),
        document.getElementById('expenseCustomerId')
    ];
    
    customerSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }
    });
    
    // Customer Report Dropdown
    const customerReportSelect = document.getElementById('customerReportSelect');
    if (customerReportSelect) {
        customerReportSelect.innerHTML = '<option value="">Choose Customer</option>';
        customers.forEach(c => {
            customerReportSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
    }
    
    // Suppliers
    const supplierSelect = document.getElementById('purchaseSupplierId');
    supplierSelect.innerHTML = '<option value="">Select Supplier</option>';
    suppliers.forEach(s => {
        supplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
    });
    
    // Vehicles
    const vehicleSelects = [
        document.getElementById('saleVehicleId'),
        document.getElementById('purchaseVehicleId')
    ];
    
    vehicleSelects.forEach(select => {
        select.innerHTML = '<option value="">Select Vehicle</option>';
        vehicles.forEach(v => {
            select.innerHTML += `<option value="${v.id}">${v.number} - ${v.driverName} (PMG: ${v.stockPMG.toFixed(2)}KL, HSD: ${v.stockHSD.toFixed(2)}KL)</option>`;
        });
    });
    
    // Vehicle Report Dropdown
    const vehicleReportSelect = document.getElementById('vehicleReportSelect');
    if (vehicleReportSelect) {
        vehicleReportSelect.innerHTML = '<option value="">Choose Vehicle</option>';
        vehicles.forEach(v => {
            vehicleReportSelect.innerHTML += `<option value="${v.id}">${v.number} - ${v.driverName}</option>`;
        });
    }
    
    // Banks
    const bankSelects = [
        document.getElementById('paymentBankId'),
        document.getElementById('expenseBankId'),
        document.getElementById('bankTransBankId')
    ];
    
    bankSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Bank</option>';
            banks.forEach(b => {
                select.innerHTML += `<option value="${b.id}">${b.name} - ${b.accountNumber}</option>`;
            });
        }
    });
}

// Initialize
window.addEventListener('load', () => {
    console.log('üöÄ Baghoor Oil Traders - Complete Professional System Loaded!');
});
</script>

</body>
</html>
