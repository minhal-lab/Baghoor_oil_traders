<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baghoor Oil Traders - Complete Professional System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Supabase SDK for Cloud Sync -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Light Mode (Default) */
        :root {
            --bg-gradient-start: #f5f7fa;
            --bg-gradient-end: #c3cfe2;
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #ebf4ff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --text-tertiary: #1a202c;
            --border-color: #e2e8f0;
            --shadow: rgba(0,0,0,0.07);
            --shadow-lg: rgba(0,0,0,0.1);
            --primary-color: #667eea;
        }
        
        /* Dark Mode */
        body.dark-mode {
            --bg-gradient-start: #1a202c;
            --bg-gradient-end: #2d3748;
            --bg-primary: #2d3748;
            --bg-secondary: #1a202c;
            --bg-tertiary: #374151;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-tertiary: #f7fafc;
            --border-color: #4a5568;
            --shadow: rgba(0,0,0,0.3);
            --shadow-lg: rgba(0,0,0,0.5);
            --primary-color: #818cf8;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-box {
            background: var(--bg-primary);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px var(--shadow-lg);
            max-width: 450px;
            width: 100%;
        }
        .login-box h1 { text-align: center; color: var(--primary-color); margin-bottom: 10px; font-size: 2.2em; }
        .login-box p { text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 0.95em; }
        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .role-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        .role-btn:hover { border-color: var(--primary-color); background: var(--bg-secondary); }
        .role-btn.active { border-color: var(--primary-color); background: var(--primary-color); color: white; }
        
        .quick-entry {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 20px;
        }
        .quick-entry h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 700;
        }
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .quick-btn {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        .quick-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px var(--shadow-lg);
            border-color: var(--primary-color);
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid var(--primary-color);
        }
        .header h1 { color: var(--text-tertiary); font-size: 1.8em; font-weight: 700; }
        .company-tagline { display: block; font-size: 0.4em; color: var(--primary-color); font-weight: 600; margin-top: 5px; text-transform: uppercase; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .user-info {
            background: var(--bg-tertiary);
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .user-role { font-size: 0.8em; color: #667eea; margin-top: 2px; }
        .role-admin { color: #f56565; }
        .role-manager { color: #ed8936; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-info { background: #4299e1; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-secondary { background: #a0aec0; color: white; }
        .btn-purple { background: #805ad5; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 11px; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-bottom: 25px; }
        .stat-card {
            background: var(--bg-primary);
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: all 0.3s;
            border-left: 4px solid;
        }
        .stat-card:nth-child(1) { border-left-color: #667eea; }
        .stat-card:nth-child(2) { border-left-color: #48bb78; }
        .stat-card:nth-child(3) { border-left-color: #ed8936; }
        .stat-card:nth-child(4) { border-left-color: #4299e1; }
        .stat-card:nth-child(5) { border-left-color: #f56565; }
        .stat-card:nth-child(6) { border-left-color: #9f7aea; }
        .stat-card:nth-child(7) { border-left-color: #38b2ac; }
        .stat-card:nth-child(8) { border-left-color: #f687b3; }
        .stat-card:nth-child(9) { border-left-color: #805ad5; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px var(--shadow-lg); }
        .stat-card h3 { color: var(--text-secondary); font-size: 0.8em; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .stat-card .value { font-size: 1.8em; font-weight: 700; margin-bottom: 6px; }
        .stat-card:nth-child(1) .value { color: #667eea; }
        .stat-card:nth-child(2) .value { color: #48bb78; }
        .stat-card:nth-child(3) .value { color: #ed8936; }
        .stat-card:nth-child(4) .value { color: #4299e1; }
        .stat-card:nth-child(5) .value { color: #f56565; }
        .stat-card:nth-child(6) .value { color: #9f7aea; }
        .stat-card:nth-child(7) .value { color: #38b2ac; }
        .stat-card:nth-child(8) .value { color: #f687b3; }
        .stat-card:nth-child(9) .value { color: #805ad5; }
        
        .card { background: var(--bg-primary); padding: 22px; border-radius: 14px; box-shadow: 0 4px 6px var(--shadow); margin-bottom: 20px; }
        .card h2 { color: var(--text-tertiary); margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid var(--border-color); font-weight: 700; font-size: 1.3em; display: flex; justify-content: space-between; align-items: center; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-primary); font-weight: 600; font-size: 0.85em; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .form-group textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 10px; }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .checkbox-group label { margin: 0; font-weight: 600; color: var(--text-primary); cursor: pointer; }
        
        .table-container { overflow-x: auto; margin-top: 12px; border-radius: 10px; border: 1px solid var(--border-color); max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.85em; color: var(--text-primary); }
        th { font-weight: 700; text-transform: uppercase; color: white; }
        tbody tr:hover { background: var(--bg-secondary); }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: var(--bg-primary);
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        .modal-header h2 { color: var(--primary-color); margin: 0; }
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
        }
        .close-btn:hover { color: #f56565; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification.success { background: #48bb78; color: white; }
        .notification.error { background: #f56565; color: white; }
        .notification.warning { background: #ed8936; color: white; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 13px;
        }
        .tab:hover { color: var(--primary-color); background: var(--bg-secondary); }
        .tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .profit-loss-section { margin-top: 20px; }
        .profit-loss-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95em;
        }
        .profit-loss-item.total {
            background: var(--bg-secondary);
            font-size: 1.1em;
            font-weight: 700;
            border-bottom: none;
            margin-top: 10px;
        }
        
        #rateChangePreview {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #667eea;
        }
        
        .balance-positive { color: #48bb78; }
        .balance-negative { color: #f56565; }
        
        .ledger-entry { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .ledger-debit { border-left: 4px solid #f56565; }
        .ledger-credit { border-left: 4px solid #48bb78; }
        
        .stock-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            margin-right: 5px;
        }
        .stock-pmg { background: #667eea; color: white; }
        .stock-hsd { background: #ed8936; color: white; }
        
        /* Theme Toggle Button */
        .theme-toggle {
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }
        
        /* Admin Settings Styles */
        .user-management-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        .user-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
        }
        .user-card-info h4 {
            color: var(--text-tertiary);
            margin-bottom: 5px;
        }
        .user-card-info p {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin: 3px 0;
        }
        .user-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; }
            .header-actions { width: 100%; justify-content: center; }
            .ledger-entry { grid-template-columns: 1fr; }
            .user-card { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-container">
    <div class="login-box">
        <h1>üõ¢Ô∏è Baghoor Oil Traders</h1>
        <p>Complete Professional Accounting System</p>
        
        <div class="role-selector">
            <button class="role-btn active" onclick="selectRole('admin')">Admin</button>
            <button class="role-btn" onclick="selectRole('manager')">Manager</button>
            <button class="role-btn" onclick="selectRole('accountant')">Accountant</button>
        </div>
        
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Login</button>
        </form>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display: none;">
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div>
                <h1>
                    üõ¢Ô∏è Baghoor Oil Traders
                    <span class="company-tagline">Complete Professional Accounting System</span>
                </h1>
            </div>
            <div class="header-actions">
                <div class="user-info">
                    <span id="userDisplay"></span>
                    <span class="user-role" id="userRoleDisplay"></span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                    <span id="themeIcon">üåô</span>
                </button>
                <button class="btn btn-purple" id="adminSettingsBtn" onclick="openModal('adminSettingsModal')" style="display: none;">‚öôÔ∏è Admin Settings</button>
                <button class="btn btn-warning" onclick="openModal('backupModal')">üíæ Backup</button>
                <button class="btn btn-info" onclick="forceCloudSync()" title="Force sync local data to cloud database" style="background: #4299e1;">‚òÅÔ∏è Force Sync</button>
                <button class="btn btn-danger" onclick="clearAllData()" title="Delete all data and start fresh" style="background: #dc3545;">üóëÔ∏è Clear Data</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- QUICK ENTRY SECTION -->
        <div class="quick-entry">
            <h3>‚ö° Quick Actions</h3>
            <div class="quick-grid">
                <button class="quick-btn" onclick="openModal('customerModal')">‚ûï Add Customer</button>
                <button class="quick-btn" onclick="openModal('supplierModal')">‚ûï Add Supplier</button>
                <button class="quick-btn" onclick="openModal('saleModal')">üí∞ Record Sale</button>
                <button class="quick-btn" onclick="openModal('purchaseModal')">üõí Record Purchase</button>
                <button class="quick-btn" onclick="openModal('paymentModal')">üí≥ Record Payment</button>
                <button class="quick-btn" onclick="openModal('jvModal')">üìù JV Voucher</button>
                <button class="quick-btn" onclick="openModal('customerTransferModal')">üîÑ Customer Transfer</button>
                <button class="quick-btn" onclick="openModal('expenseModal')">üí∏ Add Expense</button>
                <button class="quick-btn" onclick="openModal('bankTransModal')">üè¶ Bank Transaction</button>
                <button class="quick-btn" onclick="openModal('vehicleModal')">üöõ Add Vehicle</button>
                <button class="quick-btn" onclick="openModal('invoiceModal')">üßæ Vehicle Invoice</button>
                <button class="quick-btn" onclick="openModal('govRateModal')">üìä Gov Rate Change</button>
            </div>
        </div>

        <!-- DASHBOARD STATS -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Total Customers</h3>
                <div class="value" id="totalCustomers">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Suppliers</h3>
                <div class="value" id="totalSuppliers">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Vehicles</h3>
                <div class="value" id="totalVehicles">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Banks</h3>
                <div class="value" id="totalBanks">0</div>
            </div>
            <div class="stat-card">
                <h3>Receivables</h3>
                <div class="value" id="totalReceivables">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Payables</h3>
                <div class="value" id="totalPayables">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Bank Balance</h3>
                <div class="value" id="totalBankBalance">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Total Expenses</h3>
                <div class="value" id="totalExpenses">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Total Stock</h3>
                <div class="value" id="totalStock">0 KL</div>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('customers')">üë• Customers</button>
            <button class="tab" onclick="switchTab('suppliers')">üè≠ Suppliers</button>
            <button class="tab" onclick="switchTab('transactions')">üí≥ Transactions</button>
            <button class="tab" onclick="switchTab('payments')">üí∞ Payments</button>
            <button class="tab" onclick="switchTab('jvouchers')">üìù JV Vouchers</button>
            <button class="tab" onclick="switchTab('owneraccounts')">üëî Owner Accounts</button>
            <button class="tab" onclick="switchTab('expenses')">üí∏ Expenses</button>
            <button class="tab" onclick="switchTab('banks')">üè¶ Banks</button>
            <button class="tab" onclick="switchTab('vehicles')">üöõ Vehicles</button>
            <button class="tab" onclick="switchTab('ledger')">üìí Ledger</button>
            <button class="tab" onclick="switchTab('reports')">üìä Reports</button>
        </div>

        <!-- CUSTOMERS TAB -->
        <div id="customers-tab" class="tab-content active">
            <div class="card">
                <h2>
                    Customers Management
                    <button class="btn btn-primary" onclick="openModal('customerModal')">Add Customer</button>
                </h2>
                <div class="form-group" style="margin-bottom: 15px;">
                    <input type="text" id="customerSearchBox" placeholder="üîç Search customers by name, contact, or CNIC..."
                           oninput="filterCustomers()" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>CNIC</th>
                                <th>PMG Rate</th>
                                <th>HSD Rate</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SUPPLIERS TAB -->
        <div id="suppliers-tab" class="tab-content">
            <div class="card">
                <h2>
                    Suppliers Management
                    <button class="btn btn-primary" onclick="openModal('supplierModal')">Add Supplier</button>
                </h2>
                <div class="form-group" style="margin-bottom: 15px;">
                    <input type="text" id="supplierSearchBox" placeholder="üîç Search suppliers by name, contact, or CNIC..."
                           oninput="filterSuppliers()" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>CNIC</th>
                                <th>PMG Rate</th>
                                <th>HSD Rate</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRANSACTIONS TAB -->
        <div id="transactions-tab" class="tab-content">
            <div class="card">
                <h2>
                    Transaction History
                    <div>
                        <button class="btn btn-success" onclick="openModal('saleModal')">Add Sale</button>
                        <button class="btn btn-warning" onclick="openModal('purchaseModal')">Add Purchase</button>
                    </div>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Reference</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAYMENTS TAB -->
        <div id="payments-tab" class="tab-content">
            <div class="card">
                <h2>
                    Payment History
                    <button class="btn btn-success" onclick="openModal('paymentModal')">Record Payment</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Party</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Bank</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- JV VOUCHERS TAB -->
        <div id="jvouchers-tab" class="tab-content">
            <div class="card">
                <h2>
                    Journal Vouchers (JV) - All Entries
                    <button class="btn btn-primary" onclick="openModal('jvModal')">Add JV Voucher</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Debit Account</th>
                                <th>Credit Account</th>
                                <th>Amount</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jvVouchersBody"></tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea;">üí° About JV Vouchers:</h4>
                    <p style="margin: 0; font-size: 0.9em; color: #4a5568;">
                        Journal Vouchers (JV) are used for internal account adjustments like customer-to-customer transfers, 
                        customer-to-supplier payments, corrections, and other accounting entries. All JV entries are listed here 
                        for cross-checking and can be deleted if needed.
                    </p>
                </div>
            </div>
        </div>

        <!-- OWNER ACCOUNTS TAB -->
        <div id="owneraccounts-tab" class="tab-content">
            <div class="card">
                <h2>
                    üëî Owner & Relatives Accounts
                    <button class="btn btn-primary" onclick="openModal('ownerAccountModal')">Add Account</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Contact</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ownerAccountsBody"></tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea;">üí° About Owner Accounts:</h4>
                    <p style="margin: 0; font-size: 0.9em; color: #4a5568;">
                        <strong>Owner Capital Account:</strong> Main business owner account for capital deposits and withdrawals.<br>
                        <strong>Relatives Accounts:</strong> Accounts for owner's family members/relatives who have financial dealings with the business (jama/amanti type transactions).
                    </p>
                </div>
            </div>
        </div>

        <!-- EXPENSES TAB -->
        <div id="expenses-tab" class="tab-content">
            <div class="card">
                <h2>
                    Expenses Management
                    <button class="btn btn-danger" onclick="openModal('expenseModal')">Add Expense</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Paid From</th>
                                <th>Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BANKS TAB -->
        <div id="banks-tab" class="tab-content">
            <div class="card">
                <h2>
                    Bank Accounts & Transactions
                    <div>
                        <button class="btn btn-primary" onclick="openModal('bankModal')">Add Bank</button>
                        <button class="btn btn-success" onclick="openModal('bankTransModal')">Bank Transaction</button>
                    </div>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bank Name</th>
                                <th>Account Number</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="banksBody"></tbody>
                    </table>
                </div>
                <h3 style="margin-top: 20px; color: #667eea;">Recent Bank Transactions</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bank</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Balance After</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bankTransactionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VEHICLES TAB -->
        <div id="vehicles-tab" class="tab-content">
            <div class="card">
                <h2>
                    Vehicle Management & Stock
                    <button class="btn btn-primary" onclick="openModal('vehicleModal')">Add Vehicle</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle Number</th>
                                <th>Driver</th>
                                <th>Contact</th>
                                <th>PMG Stock</th>
                                <th>HSD Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehiclesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- LEDGER TAB (NEW) -->
        <div id="ledger-tab" class="tab-content">
            <div class="card">
                <h2>
                    Daily Ledger (Debit/Credit)
                    <div>
                        <button class="btn btn-info" onclick="generateLedger()">üìí Generate Today's Ledger</button>
                        <button class="btn btn-success" onclick="checkBalance()">‚öñÔ∏è Check Balance</button>
                    </div>
                </h2>
                <div id="ledgerOutput"></div>
            </div>
        </div>

        <!-- REPORTS TAB -->
        <div id="reports-tab" class="tab-content">
            <div class="card">
                <h2>Reports & Analytics</h2>
                
                <!-- General Reports -->
                <h3 style="color: #667eea; margin-bottom: 10px;">üìä General Reports</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px;">
                    <button class="btn btn-info" onclick="generateProfitLossReport()">üìä Profit & Loss</button>
                    <button class="btn btn-success" onclick="generateMonthlyReport()">üìÖ Monthly Report</button>
                    <button class="btn btn-warning" onclick="generateVehicleProfitReport()">üöõ All Vehicles Profit</button>
                    <button class="btn btn-purple" onclick="generateStockReport()">üì¶ Stock Report</button>
                    <button class="btn btn-danger" onclick="generateExpenseReport()">üí∏ Expense Report</button>
                    <button class="btn btn-primary" onclick="generateAllPartiesReport()">üìã All Parties Balance</button>
                </div>
                
                <!-- Customer-wise Ledger -->
                <h3 style="color: #667eea; margin-bottom: 10px; margin-top: 25px;">üë§ Customer-wise Ledger Report</h3>
                <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Select Customer</label>
                            <select id="customerReportSelect">
                                <option value="">Choose Customer</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>From Date</label>
                            <input type="date" id="customerReportFromDate">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>To Date</label>
                            <input type="date" id="customerReportToDate">
                        </div>
                        <button class="btn btn-success" onclick="generateCustomerLedgerReport()">Generate Report</button>
                        <button class="btn btn-primary" onclick="exportCustomerLedgerPDF()">Export PDF</button>
                    </div>
                </div>
                
                <!-- Vehicle-wise Profit -->
                <h3 style="color: #667eea; margin-bottom: 10px;">üöõ Individual Vehicle Report</h3>
                <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Select Vehicle</label>
                            <select id="vehicleReportSelect">
                                <option value="">Choose Vehicle</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>From Date</label>
                            <input type="date" id="vehicleReportFromDate">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>To Date</label>
                            <input type="date" id="vehicleReportToDate">
                        </div>
                        <button class="btn btn-success" onclick="generateSingleVehicleReport()">Generate Report</button>
                        <button class="btn btn-primary" onclick="exportSingleVehiclePDF()">Export PDF</button>
                    </div>
                </div>
                
                <!-- Export Options -->
                <h3 style="color: #667eea; margin-bottom: 10px;">üíæ Export Options</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="exportVehicleProfitPDF()">üìÑ Export All Vehicles PDF</button>
                    <button class="btn btn-secondary" onclick="exportAllDataExcel()">üì• Export All Data Excel</button>
                    <button class="btn btn-info" onclick="exportAllPartiesPDF()">üìÑ Export All Parties PDF</button>
                </div>
                
                <div id="reportOutput"></div>
            </div>
        </div>
    </div>
</div>

<!-- ALL MODALS -->

<!-- CUSTOMER MODAL -->
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Customer</h2>
            <button class="close-btn" onclick="closeModal('customerModal')">&times;</button>
        </div>
        <form onsubmit="saveCustomer(event)">
            <input type="hidden" id="customerId">
            <div class="form-group">
                <label>Customer Name *</label>
                <input type="text" id="customerName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="text" id="customerContact">
                </div>
                <div class="form-group">
                    <label>CNIC</label>
                    <input type="text" id="customerCnic" placeholder="12345-1234567-1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>PMG Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="customerPmgRate" required>
                </div>
                <div class="form-group">
                    <label>HSD Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="customerHsdRate" required>
                </div>
            </div>
            <div class="form-group">
                <label>Opening Balance (Rs)</label>
                <input type="number" step="0.01" id="customerOpeningBalance" value="0" placeholder="Previous balance (if any)">
                <small style="color: var(--text-secondary); font-size: 0.85em;">üí° Enter previous balance here (Positive = Customer owes you, Negative = You owe customer)</small>
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="customerAddress"></textarea>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="customerNotes"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Save Customer</button>
        </form>
    </div>
</div>

<!-- SUPPLIER MODAL -->
<div id="supplierModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Supplier</h2>
            <button class="close-btn" onclick="closeModal('supplierModal')">&times;</button>
        </div>
        <form onsubmit="saveSupplier(event)">
            <input type="hidden" id="supplierId">
            <div class="form-group">
                <label>Supplier Name *</label>
                <input type="text" id="supplierName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="text" id="supplierContact">
                </div>
                <div class="form-group">
                    <label>CNIC</label>
                    <input type="text" id="supplierCnic" placeholder="12345-1234567-1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>PMG Rate (Self Carriage) *</label>
                    <input type="number" step="0.0001" id="supplierPmgRateSelf" required>
                    <small style="color: var(--text-secondary); font-size: 0.85em;">Rate without transport</small>
                </div>
                <div class="form-group">
                    <label>HSD Rate (Self Carriage) *</label>
                    <input type="number" step="0.0001" id="supplierHsdRateSelf" required>
                    <small style="color: var(--text-secondary); font-size: 0.85em;">Rate without transport</small>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>PMG Rate (PSO Carriage)</label>
                    <input type="number" step="0.0001" id="supplierPmgRatePSO" placeholder="0.0000">
                    <small style="color: var(--text-secondary); font-size: 0.85em;">Rate with transport (optional)</small>
                </div>
                <div class="form-group">
                    <label>HSD Rate (PSO Carriage)</label>
                    <input type="number" step="0.0001" id="supplierHsdRatePSO" placeholder="0.0000">
                    <small style="color: var(--text-secondary); font-size: 0.85em;">Rate with transport (optional)</small>
                </div>
            </div>
            <div class="form-group">
                <label>Default Carriage Type</label>
                <select id="supplierDefaultCarriage">
                    <option value="self">Self Carriage (Without Rent)</option>
                    <option value="pso">PSO Carriage (With Rent)</option>
                </select>
                <small style="color: var(--text-secondary); font-size: 0.85em;">üí° This will be auto-selected in purchases</small>
            </div>
            <div class="form-group">
                <label>Opening Balance (Rs)</label>
                <input type="number" step="0.01" id="supplierOpeningBalance" value="0" placeholder="Previous balance (if any)">
                <small style="color: var(--text-secondary); font-size: 0.85em;">üí° Enter previous balance here (Positive = You owe supplier, Negative = Supplier owes you)</small>
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="supplierAddress"></textarea>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="supplierNotes"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Save Supplier</button>
        </form>
    </div>
</div>

<!-- SALE MODAL -->
<div id="saleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Sale</h2>
            <button class="close-btn" onclick="closeModal('saleModal')">&times;</button>
        </div>
        <form onsubmit="saveSale(event)">
            <div class="form-group">
                <label>Customer *</label>
                <select id="saleCustomerId" required>
                    <option value="">Select Customer</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Fuel Type *</label>
                    <select id="saleFuelType" onchange="updateSaleRate()" required>
                        <option value="">Select Fuel</option>
                        <option value="PMG">PMG (Petrol)</option>
                        <option value="HSD">HSD (Diesel)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vehicle *</label>
                    <select id="saleVehicleId" required>
                        <option value="">Select Vehicle</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity (Liters) *</label>
                    <input type="number" step="0.01" id="saleQuantity" oninput="calculateSaleAmount()" required>
                </div>
                <div class="form-group">
                    <label>Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="saleRate" oninput="calculateSaleAmount()" required>
                </div>
            </div>
            <div class="form-group">
                <label>Subtotal (Before Discount)</label>
                <input type="number" step="0.01" id="saleSubtotal" readonly style="background: #f0f0f0; font-weight: 600;">
            </div>
            
            <!-- DISCOUNT SECTION -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #ffc107;">
                <h4 style="color: #856404; margin-bottom: 10px; font-size: 0.95em;">üí∞ Discount (Optional)</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Discount Type</label>
                        <select id="saleDiscountType" onchange="calculateSaleAmount()">
                            <option value="none">No Discount</option>
                            <option value="percentage">Percentage (%)</option>
                            <option value="fixed">Fixed Amount (Rs)</option>
                            <option value="perlitre">Rupees Per Litre (Rs/L)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Discount Value</label>
                        <input type="number" step="0.01" id="saleDiscountValue" value="0" oninput="calculateSaleAmount()" placeholder="Enter discount">
                    </div>
                </div>
                <div id="saleDiscountInfo" style="font-size: 0.85em; color: #856404; margin-top: 8px;"></div>
            </div>
            
            <div class="form-group">
                <label>Final Amount (After Discount)</label>
                <input type="number" step="0.01" id="saleAmount" readonly style="background: #d4edda; font-weight: 700; font-size: 1.1em; color: #155724;">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="saleDate" required>
            </div>
            <button type="submit" class="btn btn-success">Save Sale</button>
        </form>
    </div>
</div>

<!-- PURCHASE MODAL -->
<div id="purchaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Purchase</h2>
            <button class="close-btn" onclick="closeModal('purchaseModal')">&times;</button>
        </div>
        <form onsubmit="savePurchase(event)">
            <div class="form-group">
                <label>Supplier *</label>
                <select id="purchaseSupplierId" onchange="updatePurchaseCarriageOptions()" required>
                    <option value="">Select Supplier</option>
                </select>
            </div>
            
            <!-- CARRIAGE TYPE SELECTION -->
            <div id="purchaseCarriageSection" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #2196f3;">
                <h4 style="color: #1565c0; margin-bottom: 10px; font-size: 0.95em;">üöö Carriage Type</h4>
                <div class="form-group">
                    <label>Select Carriage Type *</label>
                    <select id="purchaseCarriageType" onchange="updatePurchaseRate()" style="font-size: 1em;">
                        <option value="self">üöó Self Carriage (Without Rent)</option>
                        <option value="pso">üöõ PSO Carriage (With Rent)</option>
                    </select>
                </div>
                <div id="purchaseCarriageInfo" style="font-size: 0.85em; color: #1565c0; margin-top: 5px;"></div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Fuel Type *</label>
                    <select id="purchaseFuelType" onchange="updatePurchaseRate()" required>
                        <option value="">Select Fuel</option>
                        <option value="PMG">PMG (Petrol)</option>
                        <option value="HSD">HSD (Diesel)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vehicle *</label>
                    <select id="purchaseVehicleId" required>
                        <option value="">Select Vehicle</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity (Liters) *</label>
                    <input type="number" step="0.01" id="purchaseQuantity" oninput="calculatePurchaseAmount()" required>
                </div>
                <div class="form-group">
                    <label>Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="purchaseRate" oninput="calculatePurchaseAmount()" required>
                </div>
            </div>
            <div class="form-group">
                <label>Subtotal (Before Discount)</label>
                <input type="number" step="0.01" id="purchaseSubtotal" readonly style="background: #f0f0f0; font-weight: 600;">
            </div>
            
            <!-- DISCOUNT SECTION -->
            <div style="background: #d1ecf1; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #17a2b8;">
                <h4 style="color: #0c5460; margin-bottom: 10px; font-size: 0.95em;">üí∞ Discount from Supplier (Optional)</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Discount Type</label>
                        <select id="purchaseDiscountType" onchange="calculatePurchaseAmount()">
                            <option value="none">No Discount</option>
                            <option value="percentage">Percentage (%)</option>
                            <option value="fixed">Fixed Amount (Rs)</option>
                            <option value="perlitre">Rupees Per Litre (Rs/L)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Discount Value</label>
                        <input type="number" step="0.01" id="purchaseDiscountValue" value="0" oninput="calculatePurchaseAmount()" placeholder="Enter discount">
                    </div>
                </div>
                <div id="purchaseDiscountInfo" style="font-size: 0.85em; color: #0c5460; margin-top: 8px;"></div>
            </div>
            
            <div class="form-group">
                <label>Final Amount (After Discount)</label>
                <input type="number" step="0.01" id="purchaseAmount" readonly style="background: #d4edda; font-weight: 700; font-size: 1.1em; color: #155724;">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="purchaseDate" required>
            </div>
            <button type="submit" class="btn btn-success">Save Purchase</button>
        </form>
    </div>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üí≥ Record Payment</h2>
            <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
        </div>
        <form onsubmit="savePayment(event)">
            <div class="form-group">
                <label>Payment Type *</label>
                <select id="paymentType" onchange="updatePaymentParties()" required>
                    <option value="">Select Type</option>
                    <option value="received">Payment Received (from Customer)</option>
                    <option value="paid">Payment Made (to Supplier)</option>
                    <option value="owner-received">Payment Received (from Owner/Relative)</option>
                    <option value="owner-paid">Payment Made (to Owner/Relative)</option>
                    <option value="customer-to-customer">Customer to Customer Transfer</option>
                </select>
            </div>
            <div class="form-group" id="paymentPartyGroup">
                <label id="paymentPartyLabel">Party *</label>
                <select id="paymentPartyId" required>
                    <option value="">Select Party</option>
                </select>
            </div>
            <div class="form-group" id="paymentToCustomerGroup" style="display: none;">
                <label>To Customer *</label>
                <select id="paymentToCustomerId">
                    <option value="">Select Customer</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="paymentAmount" required>
            </div>
            <div class="form-group">
                <label>Payment Method *</label>
                <select id="paymentMethod" onchange="toggleBankField()" required>
                    <option value="cash">Cash</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group" id="paymentBankGroup" style="display: none;">
                <label>Bank Account</label>
                <select id="paymentBankId">
                    <option value="">Select Bank</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="paymentDate" required>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="paymentNotes" placeholder="Reference number, cheque number, etc."></textarea>
            </div>
            <button type="submit" class="btn btn-success">Record Payment</button>
        </form>
    </div>
</div>

<!-- CUSTOMER TRANSFER MODAL (NEW) -->
<div id="customerTransferModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîÑ Customer to Customer Transfer</h2>
            <button class="close-btn" onclick="closeModal('customerTransferModal')">&times;</button>
        </div>
        <form onsubmit="saveCustomerTransfer(event)">
            <div class="form-group">
                <label>Paying Customer (Debit) *</label>
                <select id="transferFromCustomerId" required>
                    <option value="">Select Customer</option>
                </select>
                <small style="color: #718096;">This customer's balance will increase (debit)</small>
            </div>
            <div class="form-group">
                <label>Receiving Customer (Credit) *</label>
                <select id="transferToCustomerId" required>
                    <option value="">Select Customer</option>
                </select>
                <small style="color: #718096;">This customer's balance will decrease (credit)</small>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="transferAmount" required>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="transferDate" required>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="transferNotes" placeholder="Reason for transfer"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Record Transfer</button>
        </form>
    </div>
</div>

<!-- EXPENSE MODAL (UPDATED) -->
<div id="expenseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üí∏ Add Expense</h2>
            <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
        </div>
        <form onsubmit="saveExpense(event)">
            <input type="hidden" id="expenseId">
            <div class="form-group">
                <label>Category *</label>
                <select id="expenseCategory" required>
                    <option value="">Select Category</option>
                    <option value="Fuel">Fuel</option>
                    <option value="Salaries">Salaries</option>
                    <option value="Rent">Rent</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Vehicle Maintenance">Vehicle Maintenance</option>
                    <option value="Office Supplies">Office Supplies</option>
                    <option value="Transport">Transport</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Insurance">Insurance</option>
                    <option value="Taxes">Taxes</option>
                    <option value="Miscellaneous">Miscellaneous</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="expenseDescription" required placeholder="Details about the expense"></textarea>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="expenseAmount" required>
            </div>
            <div class="form-group">
                <label>Expense Type *</label>
                <select id="expenseType" onchange="toggleExpenseTypeField()" required>
                    <option value="general">General Expense</option>
                    <option value="vehicle">Vehicle Expense</option>
                    <option value="owner">Owner Expense</option>
                </select>
            </div>
            <div class="form-group" id="expenseVehicleGroup" style="display: none;">
                <label>Vehicle *</label>
                <select id="expenseVehicleId">
                    <option value="">Select Vehicle</option>
                </select>
                <small style="color: #718096;">Links expense to specific vehicle for profit tracking</small>
            </div>
            <div class="form-group">
                <label>Paid From *</label>
                <select id="expenseSource" onchange="toggleExpenseSourceField()" required>
                    <option value="bank">Bank Account</option>
                    <option value="customer">Customer Account</option>
                    <option value="cash">Cash</option>
                </select>
            </div>
            <div class="form-group" id="expenseBankGroup">
                <label>Bank Account *</label>
                <select id="expenseBankId">
                    <option value="">Select Bank</option>
                </select>
            </div>
            <div class="form-group" id="expenseCustomerGroup" style="display: none;">
                <label>Customer *</label>
                <select id="expenseCustomerId">
                    <option value="">Select Customer</option>
                </select>
                <small style="color: #718096;">Customer's balance will decrease (customer covers expense)</small>
            </div>
            <div class="form-group">
                <label>Payment Method *</label>
                <select id="expenseMethod" required>
                    <option value="cash">Cash</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="expenseDate" required>
            </div>
            <button type="submit" class="btn btn-danger">Save Expense</button>
        </form>
    </div>
</div>

<!-- BANK TRANSACTION MODAL -->
<div id="bankTransModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üè¶ Bank Transaction</h2>
            <button class="close-btn" onclick="closeModal('bankTransModal')">&times;</button>
        </div>
        <form onsubmit="saveBankTransaction(event)">
            <div class="form-group">
                <label>Bank Account *</label>
                <select id="bankTransBankId" required>
                    <option value="">Select Bank</option>
                </select>
            </div>
            <div class="form-group">
                <label>Transaction Type *</label>
                <select id="bankTransType" required>
                    <option value="deposit">Deposit (Money In)</option>
                    <option value="withdrawal">Withdrawal (Money Out)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="bankTransAmount" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="bankTransDescription" placeholder="Purpose of transaction"></textarea>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="bankTransDate" required>
            </div>
            <button type="submit" class="btn btn-success">Save Transaction</button>
        </form>
    </div>
</div>

<!-- VEHICLE MODAL -->
<div id="vehicleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Vehicle</h2>
            <button class="close-btn" onclick="closeModal('vehicleModal')">&times;</button>
        </div>
        <form onsubmit="saveVehicle(event)">
            <input type="hidden" id="vehicleId">
            <div class="form-group">
                <label>Vehicle Number *</label>
                <input type="text" id="vehicleNumber" required placeholder="ABC-123">
            </div>
            <div class="form-group">
                <label>Driver Name *</label>
                <input type="text" id="vehicleDriver" required>
            </div>
            <div class="form-group">
                <label>Driver Contact</label>
                <input type="text" id="vehicleContact">
            </div>
            <hr style="border: 1px solid var(--border-color); margin: 15px 0;">
            <h4 style="color: var(--primary-color); margin-bottom: 10px;">üöó Vehicle Owner Information</h4>
            <div class="form-group">
                <label>Owner Name</label>
                <input type="text" id="vehicleOwnerName" placeholder="Vehicle owner (if different from driver)">
            </div>
            <div class="form-group">
                <label>Owner Contact</label>
                <input type="text" id="vehicleOwnerContact">
            </div>
            <div class="form-group">
                <label>Owner Opening Balance (Rs)</label>
                <input type="number" step="0.01" id="vehicleOwnerBalance" value="0" placeholder="Previous balance with owner">
                <small style="color: var(--text-secondary); font-size: 0.85em;">üí° Enter previous balance (Positive = You owe owner, Negative = Owner owes you)</small>
            </div>
            <hr style="border: 1px solid var(--border-color); margin: 15px 0;">
            <div class="form-group">
                <label>Status</label>
                <select id="vehicleStatus">
                    <option value="Active">Active</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Inactive">Inactive</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success">Save Vehicle</button>
        </form>
    </div>
</div>

<!-- BANK MODAL -->
<div id="bankModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Bank Account</h2>
            <button class="close-btn" onclick="closeModal('bankModal')">&times;</button>
        </div>
        <form onsubmit="saveBank(event)">
            <input type="hidden" id="bankId">
            <div class="form-group">
                <label>Bank Name *</label>
                <input type="text" id="bankName" required placeholder="e.g., Meezan Bank">
            </div>
            <div class="form-group">
                <label>Account Number *</label>
                <input type="text" id="bankAccount" required>
            </div>
            <div class="form-group">
                <label>Opening Balance</label>
                <input type="number" step="0.01" id="bankBalance" value="0">
            </div>
            <button type="submit" class="btn btn-success">Save Bank</button>
        </form>
    </div>
</div>

<!-- BANK LEDGER MODAL -->
<div id="bankLedgerModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h2 id="bankLedgerTitle">Bank Ledger Statement</h2>
            <button class="close-btn" onclick="closeModal('bankLedgerModal')">&times;</button>
        </div>
        <div id="bankLedgerContent" style="padding: 20px;">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div id="bankLedgerInfo"></div>
                <div>
                    <button class="btn btn-primary" onclick="printBankLedger()">üñ®Ô∏è Print Statement</button>
                    <button class="btn btn-success" onclick="downloadBankLedgerPDF()">üìÑ Download PDF</button>
                </div>
            </div>
            <div class="table-container">
                <table id="bankLedgerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Debit</th>
                            <th>Credit</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="bankLedgerBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- CUSTOMER LEDGER MODAL -->
<div id="customerLedgerModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h2 id="customerLedgerTitle">Customer Ledger</h2>
            <button class="close-btn" onclick="closeModal('customerLedgerModal')">&times;</button>
        </div>
        <div id="customerLedgerContent" style="padding: 20px;">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div id="customerLedgerInfo"></div>
                <div>
                    <button class="btn btn-primary" onclick="printCustomerLedger()">üñ®Ô∏è Print</button>
                    <button class="btn btn-success" onclick="downloadCustomerLedgerPDF()">üìÑ PDF</button>
                </div>
            </div>
            <div class="table-container">
                <table id="customerLedgerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>PMG (L)</th>
                            <th>HSD (L)</th>
                            <th>Debit</th>
                            <th>Credit</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="customerLedgerBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- SUPPLIER LEDGER MODAL -->
<div id="supplierLedgerModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h2 id="supplierLedgerTitle">Supplier Ledger</h2>
            <button class="close-btn" onclick="closeModal('supplierLedgerModal')">&times;</button>
        </div>
        <div id="supplierLedgerContent" style="padding: 20px;">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div id="supplierLedgerInfo"></div>
                <div>
                    <button class="btn btn-primary" onclick="printSupplierLedger()">üñ®Ô∏è Print</button>
                    <button class="btn btn-success" onclick="downloadSupplierLedgerPDF()">üìÑ PDF</button>
                </div>
            </div>
            <div class="table-container">
                <table id="supplierLedgerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>PMG (L)</th>
                            <th>HSD (L)</th>
                            <th>Debit</th>
                            <th>Credit</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="supplierLedgerBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- VEHICLE LEDGER MODAL -->
<div id="vehicleLedgerModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h2 id="vehicleLedgerTitle">Vehicle Ledger</h2>
            <button class="close-btn" onclick="closeModal('vehicleLedgerModal')">&times;</button>
        </div>
        <div id="vehicleLedgerContent" style="padding: 20px;">
            <div style="margin-bottom: 20px;">
                <div id="vehicleLedgerInfo"></div>
                <div id="vehicleProfitSummary" style="margin-top: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                    <h3 style="margin-bottom: 10px;">üìä Profit/Loss Summary</h3>
                    <div id="vehicleProfitDetails"></div>
                </div>
            </div>
            <div class="table-container">
                <table id="vehicleLedgerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>PMG (L)</th>
                            <th>HSD (L)</th>
                            <th>Amount</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="vehicleLedgerBody"></tbody>
                </table>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-secondary" onclick="printVehicleLedger()">üñ®Ô∏è Print</button>
                <button class="btn btn-success" onclick="downloadVehicleLedgerPDF()">üìÑ Download PDF</button>
            </div>
        </div>
    </div>
</div>

<!-- OWNER ACCOUNT LEDGER MODAL -->
<div id="ownerAccountLedgerModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h2 id="ownerAccountLedgerTitle">Owner Account Ledger</h2>
            <button class="close-btn" onclick="closeModal('ownerAccountLedgerModal')">&times;</button>
        </div>
        <div id="ownerAccountLedgerContent" style="padding: 20px;">
            <div style="margin-bottom: 20px;">
                <div id="ownerAccountLedgerInfo"></div>
            </div>
            <div class="table-container">
                <table id="ownerAccountLedgerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Debit</th>
                            <th>Credit</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="ownerAccountLedgerBody"></tbody>
                </table>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-secondary" onclick="printOwnerAccountLedger()">üñ®Ô∏è Print</button>
                <button class="btn btn-success" onclick="downloadOwnerAccountLedgerPDF()">üìÑ Download PDF</button>
            </div>
        </div>
    </div>
</div>

<!-- GOVERNMENT RATE CHANGE MODAL -->
<div id="govRateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üèõÔ∏è Government Rate Change</h2>
            <button class="close-btn" onclick="closeModal('govRateModal')">&times;</button>
        </div>
        <form onsubmit="applyGovRateChange(event)">
            <div class="checkbox-group">
                <input type="checkbox" id="updatePmg" checked>
                <label for="updatePmg">Update PMG (Petrol) Rates</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="updateHsd" checked>
                <label for="updateHsd">Update HSD (Diesel) Rates</label>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Change Type</label>
                    <select id="changeType">
                        <option value="absolute">Absolute (Rs)</option>
                        <option value="percentage">Percentage (%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Direction</label>
                    <select id="changeSign">
                        <option value="1">Increase (+)</option>
                        <option value="-1">Decrease (-)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" step="0.0001" id="changeAmount" required>
            </div>
            <div class="form-group">
                <label>Apply To</label>
                <select id="changeScope">
                    <option value="all">All (Customers & Suppliers)</option>
                    <option value="customers">Customers Only</option>
                    <option value="suppliers">Suppliers Only</option>
                </select>
            </div>
            <button type="button" class="btn btn-info" onclick="previewGovRateChange()">Preview Changes</button>
            <div id="rateChangePreview" style="display: none;">
                <h3 style="color: #667eea; margin: 15px 0 10px 0;">Preview:</h3>
                <div id="previewContent"></div>
            </div>
            <button type="submit" class="btn btn-success" style="margin-top: 15px; width: 100%;">Apply Changes</button>
        </form>
    </div>
</div>

<!-- BACKUP MODAL -->
<div id="backupModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h2>üíæ Backup & Export System</h2>
            <button class="close-btn" onclick="closeModal('backupModal')">&times;</button>
        </div>
        
        <!-- Complete Backup Section -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">üì¶ Complete System Backup</h3>
            <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <p style="color: var(--text-secondary); margin-bottom: 10px;">Download ALL your data as one backup file (JSON format)</p>
                <button class="btn btn-success" onclick="createBackup()">üíæ Download Complete Backup</button>
            </div>
            <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px;">
                <p style="color: var(--text-secondary); margin-bottom: 10px;">Upload complete backup file to restore ALL data</p>
                <input type="file" id="backupFile" accept=".json" style="margin-bottom: 10px;">
                <button class="btn btn-warning" onclick="restoreBackup()">‚ö†Ô∏è Restore Complete Backup</button>
            </div>
        </div>
        
        <hr style="border: 1px solid var(--border-color); margin: 30px 0;">
        
        <!-- Individual Data Export/Backup Section -->
        <div>
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">üìä Individual Data Export & Backup</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9em;">
                <strong>PDF</strong> = For viewing/printing/records | <strong>JSON</strong> = For backup/restore
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 15px;">
                
                <!-- Customers -->
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid #48bb78;">
                    <h4 style="color: #48bb78; margin-bottom: 10px;">üë• Customers</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-info btn-sm" onclick="exportCustomersPDF()">üìÑ Export PDF</button>
                        <button class="btn btn-success btn-sm" onclick="exportCustomersJSON()">üíæ Backup (JSON)</button>
                    </div>
                    <div style="font-size: 0.85em;">
                        <input type="file" id="customersRestoreFile" accept=".json" style="font-size: 0.8em; margin-bottom: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="restoreCustomers()">‚ö†Ô∏è Restore</button>
                    </div>
                </div>
                
                <!-- Suppliers -->
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid #ed8936;">
                    <h4 style="color: #ed8936; margin-bottom: 10px;">üè≠ Suppliers</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-info btn-sm" onclick="exportSuppliersPDF()">üìÑ Export PDF</button>
                        <button class="btn btn-success btn-sm" onclick="exportSuppliersJSON()">üíæ Backup (JSON)</button>
                    </div>
                    <div style="font-size: 0.85em;">
                        <input type="file" id="suppliersRestoreFile" accept=".json" style="font-size: 0.8em; margin-bottom: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="restoreSuppliers()">‚ö†Ô∏è Restore</button>
                    </div>
                </div>
                
                <!-- Vehicles -->
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">üöõ Vehicles</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-info btn-sm" onclick="exportVehiclesPDF()">üìÑ Export PDF</button>
                        <button class="btn btn-success btn-sm" onclick="exportVehiclesJSON()">üíæ Backup (JSON)</button>
                    </div>
                    <div style="font-size: 0.85em;">
                        <input type="file" id="vehiclesRestoreFile" accept=".json" style="font-size: 0.8em; margin-bottom: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="restoreVehicles()">‚ö†Ô∏è Restore</button>
                    </div>
                </div>
                
                <!-- Banks -->
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid #4299e1;">
                    <h4 style="color: #4299e1; margin-bottom: 10px;">üè¶ Banks</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-info btn-sm" onclick="exportBanksPDF()">üìÑ Export PDF</button>
                        <button class="btn btn-success btn-sm" onclick="exportBanksJSON()">üíæ Backup (JSON)</button>
                    </div>
                    <div style="font-size: 0.85em;">
                        <input type="file" id="banksRestoreFile" accept=".json" style="font-size: 0.8em; margin-bottom: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="restoreBanks()">‚ö†Ô∏è Restore</button>
                    </div>
                </div>
                
            </div>
            
            <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 12px; border-radius: 8px; margin-top: 20px;">
                <p style="color: #856404; font-size: 0.85em; margin: 0;">
                    <strong>‚ö†Ô∏è Note:</strong> Restoring individual data will REPLACE existing data of that type only. Other data stays safe!
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN SETTINGS MODAL -->
<div id="adminSettingsModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>‚öôÔ∏è Admin Settings - User Management</h2>
            <button class="close-btn" onclick="closeModal('adminSettingsModal')">&times;</button>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">üîê System Users</h3>
            <div class="user-management-grid" id="userManagementList">
                <!-- Users will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- JV VOUCHER MODAL -->
<div id="jvModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>üìù Journal Voucher (JV Entry)</h2>
            <button class="close-btn" onclick="closeModal('jvModal')">&times;</button>
        </div>
        <form onsubmit="saveJVVoucher(event)">
            <div class="form-group">
                <label>Date *</label>
                <input type="date" id="jvDate" required>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="jvDescription" required placeholder="Describe this journal entry..."></textarea>
            </div>
            
            <hr style="border: 1px solid var(--border-color); margin: 20px 0;">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- DEBIT SIDE -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 2px solid #ffc107;">
                    <h3 style="color: #856404; margin-bottom: 15px;">üì§ DEBIT (Dr.)</h3>
                    <div class="form-group">
                        <label>Account Type *</label>
                        <select id="jvDebitType" onchange="updateJVDebitAccounts()" required>
                            <option value="">Select Type</option>
                            <option value="customer">Customer</option>
                            <option value="supplier">Supplier</option>
                            <option value="bank">Bank</option>
                            <option value="vehicle">Vehicle Owner</option>
                            <option value="owner">Owner/Relative Account</option>
                            <option value="expense">Expense</option>
                            <option value="other">Other Account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account *</label>
                        <select id="jvDebitAccount" required>
                            <option value="">Select Account</option>
                        </select>
                        <input type="text" id="jvDebitOther" placeholder="Account name" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Amount (Rs) *</label>
                        <input type="number" step="0.01" id="jvDebitAmount" oninput="validateJVAmounts()" required>
                    </div>
                </div>
                
                <!-- CREDIT SIDE -->
                <div style="background: #d4edda; padding: 15px; border-radius: 10px; border: 2px solid #28a745;">
                    <h3 style="color: #155724; margin-bottom: 15px;">üì• CREDIT (Cr.)</h3>
                    <div class="form-group">
                        <label>Account Type *</label>
                        <select id="jvCreditType" onchange="updateJVCreditAccounts()" required>
                            <option value="">Select Type</option>
                            <option value="customer">Customer</option>
                            <option value="supplier">Supplier</option>
                            <option value="bank">Bank</option>
                            <option value="vehicle">Vehicle Owner</option>
                            <option value="owner">Owner/Relative Account</option>
                            <option value="income">Income</option>
                            <option value="other">Other Account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account *</label>
                        <select id="jvCreditAccount" required>
                            <option value="">Select Account</option>
                        </select>
                        <input type="text" id="jvCreditOther" placeholder="Account name" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Amount (Rs) * <small style="color: #666;">(Auto-synced with Debit)</small></label>
                        <input type="number" step="0.01" id="jvCreditAmount" readonly required style="background: #e9ecef; cursor: not-allowed;">
                    </div>
                </div>
            </div>
            
            <div id="jvBalanceWarning" style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 8px; margin-top: 15px; display: none; text-align: center;">
                ‚ö†Ô∏è Debit and Credit amounts must be equal!
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 20px;">Save Journal Voucher</button>
        </form>
    </div>
</div>

<!-- VEHICLE INVOICE MODAL -->
<div id="invoiceModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>üßæ Generate Vehicle Invoice</h2>
            <button class="close-btn" onclick="closeModal('invoiceModal')">&times;</button>
        </div>
        
        <div class="form-group">
            <label>Select Vehicle *</label>
            <select id="invoiceVehicleId" onchange="loadVehicleInvoiceData()" required>
                <option value="">Choose Vehicle</option>
            </select>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>From Date *</label>
                <input type="date" id="invoiceFromDate" required>
            </div>
            <div class="form-group">
                <label>To Date *</label>
                <input type="date" id="invoiceToDate" required>
            </div>
        </div>
        
        <button class="btn btn-primary" onclick="generateVehicleInvoice()" style="width: 100%; margin-bottom: 20px;">üìä Generate Invoice</button>
        
        <div id="invoicePreview" style="background: var(--bg-primary); padding: 20px; border-radius: 10px; border: 2px solid var(--border-color); display: none;">
            <!-- Invoice will be generated here -->
        </div>
    </div>
</div>

<!-- OWNER ACCOUNT MODAL -->
<div id="ownerAccountModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Owner Account</h2>
            <button class="close-btn" onclick="closeModal('ownerAccountModal')">&times;</button>
        </div>
        <form onsubmit="saveOwnerAccount(event)">
            <input type="hidden" id="ownerAccountId">
            <div class="form-group">
                <label>Account Type *</label>
                <select id="ownerAccountType" required>
                    <option value="">Select Type</option>
                    <option value="owner">üëî Owner Capital</option>
                    <option value="relative">üë®‚Äçüë©‚Äçüëß Owner's Relative</option>
                </select>
            </div>
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="ownerAccountName" required placeholder="Enter name">
            </div>
            <div class="form-group">
                <label>Contact Number</label>
                <input type="text" id="ownerAccountContact" placeholder="03XX-XXXXXXX">
            </div>
            <div class="form-group">
                <label>CNIC</label>
                <input type="text" id="ownerAccountCnic" placeholder="12345-1234567-1">
            </div>
            <div class="form-group">
                <label>Opening Balance (Rs)</label>
                <input type="number" step="0.01" id="ownerAccountOpeningBalance" value="0" placeholder="Previous balance (if any)">
                <small style="color: var(--text-secondary); font-size: 0.85em;">üí° Positive = Business owes them, Negative = They owe business</small>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="ownerAccountNotes" placeholder="Any additional information..."></textarea>
            </div>
            <button type="submit" class="btn btn-success">Save Account</button>
        </form>
    </div>
</div>

<!-- OWNER ACCOUNT TRANSACTION MODAL -->
<div id="ownerAccountTransModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Owner Account Transaction</h2>
            <button class="close-btn" onclick="closeModal('ownerAccountTransModal')">&times;</button>
        </div>
        <form onsubmit="saveOwnerAccountTransaction(event)">
            <div class="form-group">
                <label>Account *</label>
                <select id="ownerTransAccountId" required>
                    <option value="">Select Account</option>
                </select>
            </div>
            <div class="form-group">
                <label>Transaction Type *</label>
                <select id="ownerTransType" required>
                    <option value="">Select Type</option>
                    <option value="deposit">üíµ Deposit (They gave money to business)</option>
                    <option value="withdrawal">üí∏ Withdrawal (Business paid them)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount (Rs) *</label>
                <input type="number" step="0.01" id="ownerTransAmount" required placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Payment Method</label>
                <select id="ownerTransMethod">
                    <option value="cash">Cash</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="ownerTransDate" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="ownerTransDescription" placeholder="Purpose of transaction..."></textarea>
            </div>
            <button type="submit" class="btn btn-success">Record Transaction</button>
        </form>
    </div>
</div>

<script>
// ==========================================
// SUPABASE CLOUD SYNC CONFIGURATION
// ==========================================
const SUPABASE_URL = 'https://druxbksscacocuclnzxs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRydXhia3NzY2Fjb2N1Y2xuenhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTMyOTQsImV4cCI6MjA3NzMyOTI5NH0._tlLjLoBVwI2hFKqpLFupERMN2ouvyDc-JG1rf574u0';
const TABLE_NAME = 'BOTs';

let supabaseClient = null;
let USE_SUPABASE = false;

// Initialize Supabase with FIXED configuration
if (typeof window.supabase !== 'undefined') {
    try {
        const { createClient } = window.supabase;
        
        // ‚úÖ FIXED: Configure Supabase to NOT use localStorage
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: false,      // Don't persist auth session
                autoRefreshToken: false,    // Don't auto-refresh tokens  
                detectSessionInUrl: false   // Don't detect session from URL
            }
        });
        
        USE_SUPABASE = true;
        console.log('‚úÖ Supabase initialized! Multi-device sync ACTIVE! üöÄ');
    } catch (error) {
        console.error('‚ùå Supabase init failed:', error);
        USE_SUPABASE = false;
    }
} else {
    console.log('‚ö†Ô∏è Supabase SDK not loaded. Using localStorage only.');
}
// ==========================================
// DATA CLEANUP AND VALIDATION FUNCTION
// ==========================================
function safeLoadData(key, defaultValue = []) {
    try {
        const data = localStorage.getItem(key);
        if (!data || data === 'undefined' || data === 'null') {
            return defaultValue;
        }
        const parsed = JSON.parse(data);
        // Validate that it's an array
        if (!Array.isArray(parsed)) {
            console.warn(`Invalid data format for ${key}, resetting to default`);
            return defaultValue;
        }
        return parsed;
    } catch (error) {
        console.error(`Error loading ${key}:`, error);
        return defaultValue;
    }
}

// DATA STORAGE - SAFE LOADING
let customers = safeLoadData('customers', []);
let suppliers = safeLoadData('suppliers', []);
let transactions = safeLoadData('transactions', []);
let payments = safeLoadData('payments', []);
let expenses = safeLoadData('expenses', []);
let customerTransfers = safeLoadData('customerTransfers', []);
let vehicles = safeLoadData('vehicles', []);
let banks = safeLoadData('banks', []);
let bankTransactions = safeLoadData('bankTransactions', []);
let rateChangeLogs = safeLoadData('rateChangeLogs', []);
let ledgerEntries = safeLoadData('ledgerEntries', []);
let jvVouchers = safeLoadData('jvVouchers', []);
let ownerAccounts = safeLoadData('ownerAccounts', []);
let currentUser = '';
let currentRole = 'admin';
let selectedRole = 'admin';

// DATA MIGRATION: Convert old 'notes' field to 'description' in customer transfers
customerTransfers.forEach(transfer => {
    if (transfer.notes && !transfer.description) {
        transfer.description = transfer.notes;
        delete transfer.notes;
    }
});
// Save migrated data
if (customerTransfers.length > 0) {
    localStorage.setItem('customerTransfers', JSON.stringify(customerTransfers));
}

// User Management Storage - ALWAYS ensure default users exist!
const DEFAULT_USERS = [
    { id: 'user_1', username: 'admin', password: 'admin123', role: 'admin', createdAt: new Date().toISOString() },
    { id: 'user_2', username: 'manager', password: 'manager123', role: 'manager', createdAt: new Date().toISOString() },
    { id: 'user_3', username: 'accountant', password: 'accountant123', role: 'accountant', createdAt: new Date().toISOString() }
];

// Function to ensure default users always exist
function ensureDefaultUsers() {
    // If no users at all, use defaults
    if (!systemUsers || systemUsers.length === 0) {
        systemUsers = [...DEFAULT_USERS];
        console.log('No users found, using defaults');
        return;
    }
    
    // Make sure each default user exists with correct password
    DEFAULT_USERS.forEach(defaultUser => {
        const existingUser = systemUsers.find(u => u.username === defaultUser.username);
        if (!existingUser) {
            // User doesn't exist, add it
            systemUsers.push({...defaultUser});
            console.log('Added missing user:', defaultUser.username);
        } else if (!existingUser.password || existingUser.password === '') {
            // User exists but has no/empty password, fix it
            existingUser.password = defaultUser.password;
            existingUser.role = defaultUser.role;
            console.log('Fixed password for user:', defaultUser.username);
        }
    });
    
    // If no valid users with passwords exist, reset to defaults
    const validUsers = systemUsers.filter(u => u.username && u.password && u.password.length > 0);
    if (validUsers.length === 0) {
        console.warn('No valid users found! Resetting to defaults');
        systemUsers = [...DEFAULT_USERS];
    }
}

let systemUsers = safeLoadData('systemUsers', []);
ensureDefaultUsers(); // Make sure defaults exist!

// Theme preference
let isDarkMode = localStorage.getItem('darkMode') === 'true';

// FORCE CLOUD SYNC FUNCTION
async function forceCloudSync() {
    if (!USE_SUPABASE || !supabaseClient) {
        showNotification('‚ùå Cloud sync not available. Supabase not initialized.', 'error');
        return;
    }

    const confirm = window.confirm('‚òÅÔ∏è Force sync all local data to cloud?\n\nThis will overwrite cloud data with your current local data.\n\nUse this if:\n‚Ä¢ Entries keep reappearing after deletion\n‚Ä¢ New entries disappear after refresh\n‚Ä¢ You see sync error warnings');

    if (!confirm) {
        return;
    }

    showNotification('üîÑ Force syncing to cloud... Please wait.', 'info');

    try {
        const { error } = await supabaseClient
            .from(TABLE_NAME)
            .upsert({
                id: 1,
                customers, suppliers, transactions, payments, expenses,
                customerTransfers, vehicles, banks, bankTransactions,
                rateChangeLogs, ledgerEntries, jvVouchers, systemUsers,
                last_updated: new Date().toISOString()
            });

        if (error) {
            console.error('‚ùå Force sync failed:', error);
            console.error('Error details:', JSON.stringify(error, null, 2));
            console.error('Error message:', error.message);
            console.error('Error hint:', error.hint);
            console.error('Error code:', error.code);
            showNotification('‚ùå Force sync failed: ' + (error.message || 'Unknown error'), 'error');
        } else {
            console.log('‚úÖ Force sync successful!');
            showNotification('‚úÖ Successfully synced to cloud! All data is now saved.', 'success');
        }
    } catch (error) {
        console.error('‚ùå Force sync error:', error);
        console.error('Error message:', error.message);
        showNotification('‚ùå Force sync error: ' + (error.message || 'Unknown error'), 'error');
    }
}

// CLEAR ALL DATA FUNCTION
async function clearAllData() {
    const confirmMsg = '‚ö†Ô∏è WARNING! This will DELETE ALL DATA permanently!\n\n' +
                      'This includes:\n' +
                      '‚Ä¢ All customers and suppliers\n' +
                      '‚Ä¢ All transactions and payments\n' +
                      '‚Ä¢ All vehicles and stock\n' +
                      '‚Ä¢ All banks and ledgers\n' +
                      '‚Ä¢ Everything from LOCAL and CLOUD!\n\n' +
                      'Type "DELETE ALL" to confirm:';
    
    const userInput = prompt(confirmMsg);
    
    if (userInput === 'DELETE ALL') {
        // Clear Supabase cloud data first
        if (USE_SUPABASE && supabaseClient) {
            try {
                await supabaseClient
                    .from(TABLE_NAME)
                    .delete()
                    .eq('id', 1);
                console.log('‚òÅÔ∏è Cloud data deleted!');
            } catch (error) {
                console.error('Cloud delete error:', error);
            }
        }
        
        // Clear all localStorage
        localStorage.clear();
        
        // Show success message
        alert('‚úÖ All data has been deleted from both local and cloud!\n\nThe page will reload with a fresh start.');
        
        // Reload page
        location.reload();
    } else {
        showNotification('‚ùå Data deletion cancelled. Nothing was deleted.', 'info');
    }
}

// Initialize vehicle stocks and owner info if not exists
vehicles.forEach(v => {
    if (!v.stockPMG) v.stockPMG = 0;
    if (!v.stockHSD) v.stockHSD = 0;
    if (!v.ownerName) v.ownerName = '';
    if (!v.ownerContact) v.ownerContact = '';
    if (!v.ownerBalance) v.ownerBalance = 0;
});

// LOGIN SYSTEM
function selectRole(role) {
    selectedRole = role;
    document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    // Check if user exists in systemUsers
    const user = systemUsers.find(u => u.username === username && u.password === password);

    if (user) {
        currentUser = username;
        currentRole = user.role;

        // Save login session to localStorage - keeps user logged in on refresh
        localStorage.setItem('loggedInUser', username);
        localStorage.setItem('loggedInRole', user.role);

        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userDisplay').textContent = username;
        document.getElementById('userRoleDisplay').textContent = user.role.toUpperCase();
        document.getElementById('userRoleDisplay').className = `user-role role-${user.role}`;
        initApp();
        showNotification('Welcome ' + username + '! üéâ', 'success');
    } else {
        showNotification('Invalid username or password!', 'error');
    }
}



// Emergency function to reset users if login fails
function emergencyResetUsers() {
    if (confirm('‚ö†Ô∏è Reset all users to default credentials?

This will:
‚Ä¢ Reset admin/admin123
‚Ä¢ Reset manager/manager123
‚Ä¢ Reset accountant/accountant123

Click OK to proceed.')) {
        // Clear everything and reset
        localStorage.clear();
        systemUsers = [...DEFAULT_USERS];
        localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
        
        // Also sync to cloud if available
        if (USE_SUPABASE && supabaseClient) {
            saveToStorage().then(() => {
                alert('‚úÖ Users reset! Please try logging in again with:

Username: admin
Password: admin123');
                location.reload();
            }).catch(() => {
                alert('‚úÖ Users reset locally! Please try logging in again with:

Username: admin
Password: admin123');
                location.reload();
            });
        } else {
            alert('‚úÖ Users reset! Please try logging in again with:

Username: admin
Password: admin123');
            location.reload();
        }
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        // Clear login session
        localStorage.removeItem('loggedInUser');
        localStorage.removeItem('loggedInRole');
        
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        currentUser = '';
        currentRole = '';
        showNotification('Logged out successfully', 'success');
    }
}

// Auto-login ENABLED - Keep users logged in on refresh
function checkLoginSession() {
    const savedUser = localStorage.getItem('loggedInUser');
    const savedRole = localStorage.getItem('loggedInRole');

    if (savedUser && savedRole) {
        // User was previously logged in, restore session
        currentUser = savedUser;
        currentRole = savedRole;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userDisplay').textContent = savedUser;
        document.getElementById('userRoleDisplay').textContent = savedRole.toUpperCase();
        document.getElementById('userRoleDisplay').className = `user-role role-${savedRole}`;
        initApp();
        console.log('‚úÖ Auto-logged in as:', savedUser);
    } else {
        // No saved session, show login screen
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
        console.log('üîê Login required');
    }
}

// INITIALIZATION
function initApp() {
    // Apply saved theme
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
    }
    
    // Show admin settings button only for admin
    if (currentRole === 'admin') {
        document.getElementById('adminSettingsBtn').style.display = 'inline-flex';
    } else {
        document.getElementById('adminSettingsBtn').style.display = 'none';
    }
    
    updateDashboard();
    renderCustomers();
    renderSuppliers();
    renderTransactions();
    renderPayments();
    renderExpenses();
    renderVehicles();
    renderBanks();
    renderBankTransactions();
    populateDropdowns();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('saleDate').value = today;
    document.getElementById('purchaseDate').value = today;
    document.getElementById('paymentDate').value = today;
    document.getElementById('expenseDate').value = today;
    document.getElementById('bankTransDate').value = today;
    document.getElementById('transferDate').value = today;
    
    // Set default dates for report filters
    if (document.getElementById('customerReportToDate')) {
        document.getElementById('customerReportToDate').value = today;
    }
    if (document.getElementById('vehicleReportToDate')) {
        document.getElementById('vehicleReportToDate').value = today;
    }
}

async function saveToStorage() {
    // Save to localStorage (local backup)
    localStorage.setItem('customers', JSON.stringify(customers));
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
    localStorage.setItem('transactions', JSON.stringify(transactions));
    localStorage.setItem('payments', JSON.stringify(payments));
    localStorage.setItem('expenses', JSON.stringify(expenses));
    localStorage.setItem('customerTransfers', JSON.stringify(customerTransfers));
    localStorage.setItem('vehicles', JSON.stringify(vehicles));
    localStorage.setItem('banks', JSON.stringify(banks));
    localStorage.setItem('bankTransactions', JSON.stringify(bankTransactions));
    localStorage.setItem('rateChangeLogs', JSON.stringify(rateChangeLogs));
    localStorage.setItem('ledgerEntries', JSON.stringify(ledgerEntries));
    localStorage.setItem('jvVouchers', JSON.stringify(jvVouchers));
    localStorage.setItem('ownerAccounts', JSON.stringify(ownerAccounts));
    localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
    
    // Also save to Supabase cloud (for multi-device sync)
    if (USE_SUPABASE && supabaseClient) {
        try {
            const { error } = await supabaseClient
                .from(TABLE_NAME)
                .upsert({
                    id: 1,
                    customers, suppliers, transactions, payments, expenses,
                    customerTransfers, vehicles, banks, bankTransactions,
                    rateChangeLogs, ledgerEntries, jvVouchers, ownerAccounts, systemUsers,
                    last_updated: new Date().toISOString()
                });
            
            if (!error) {
                console.log('‚òÅÔ∏è Data synced to cloud!');
                console.log(`üìä Synced: ${customers.length} customers, ${suppliers.length} suppliers, ${vehicles.length} vehicles, ${transactions.length} transactions`);
            } else {
                console.error('‚ùå Cloud sync failed:', error);
                console.error('Error details:', JSON.stringify(error, null, 2));
                console.error('Error message:', error.message);
                console.error('Error hint:', error.hint);
                console.error('Error code:', error.code);
                showNotification('‚ö†Ô∏è Cloud sync failed: ' + (error.message || 'Unknown error'), 'warning');
            }
        } catch (error) {
            console.error('‚ùå Cloud sync error:', error);
            console.error('Error details:', error.message);
            showNotification('‚ö†Ô∏è Cloud sync error: ' + (error.message || 'Unknown error'), 'warning');
        }
    }
}

// Add ledger entry function
function addLedgerEntry(type, description, debitAccount, debitAmount, creditAccount, creditAmount, date) {
    const entry = {
        id: 'ledger_' + Date.now(),
        type: type,
        description: description,
        debitAccount: debitAccount,
        debitAmount: debitAmount,
        creditAccount: creditAccount,
        creditAmount: creditAmount,
        date: date || new Date().toISOString().split('T')[0],
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    ledgerEntries.push(entry);
    saveToStorage();
}

// CUSTOMER FUNCTIONS
function saveCustomer(e) {
    e.preventDefault();
    
    const openingBalance = parseFloat(document.getElementById('customerOpeningBalance').value) || 0;
    
    const customer = {
        id: document.getElementById('customerId').value || 'cust_' + Date.now(),
        name: document.getElementById('customerName').value,
        contact: document.getElementById('customerContact').value,
        cnic: document.getElementById('customerCnic').value,
        pmgRate: parseFloat(document.getElementById('customerPmgRate').value).toFixed(4),
        hsdRate: parseFloat(document.getElementById('customerHsdRate').value).toFixed(4),
        address: document.getElementById('customerAddress').value,
        notes: document.getElementById('customerNotes').value,
        balance: 0,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = customers.findIndex(c => c.id === customer.id);
    if (existingIndex >= 0) {
        // Editing existing customer - use edited balance from form
        customer.balance = openingBalance;
        customers[existingIndex] = customer;
        showNotification('Customer updated! ‚úÖ', 'success');
    } else {
        // New customer - set opening balance
        customer.balance = openingBalance;
        customers.push(customer);
        showNotification('Customer added! ‚úÖ' + (openingBalance !== 0 ? ` (Opening balance: Rs. ${openingBalance.toFixed(2)})` : ''), 'success');
    }
    
    saveToStorage();
    renderCustomers();
    closeModal('customerModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderCustomers() {
    const tbody = document.getElementById('customersBody');
    tbody.innerHTML = '';

    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();

    customers.forEach(customer => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${customer.name}</strong></td>
            <td>${customer.contact || '-'}</td>
            <td>${customer.cnic || '-'}</td>
            <td>Rs. ${parseFloat(customer.pmgRate).toFixed(4)}</td>
            <td>Rs. ${parseFloat(customer.hsdRate).toFixed(4)}</td>
            <td class="${customer.balance >= 0 ? 'balance-positive' : 'balance-negative'}">Rs. ${customer.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-success btn-sm" onclick="viewCustomerLedger('${customer.id}')">üìä Ledger</button>
                <button class="btn btn-info btn-sm" onclick='editCustomer(${JSON.stringify(customer).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer.id}')">Delete</button>
            </td>
        `;
        fragment.appendChild(row);
    });

    tbody.appendChild(fragment);
}

function filterCustomers() {
    const searchTerm = document.getElementById('customerSearchBox').value.toLowerCase();
    const tbody = document.getElementById('customersBody');
    tbody.innerHTML = '';

    const filteredCustomers = customers.filter(customer => {
        return customer.name.toLowerCase().includes(searchTerm) ||
               (customer.contact && customer.contact.toLowerCase().includes(searchTerm)) ||
               (customer.cnic && customer.cnic.toLowerCase().includes(searchTerm));
    });

    const fragment = document.createDocumentFragment();

    filteredCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${customer.name}</strong></td>
            <td>${customer.contact || '-'}</td>
            <td>${customer.cnic || '-'}</td>
            <td>Rs. ${parseFloat(customer.pmgRate).toFixed(4)}</td>
            <td>Rs. ${parseFloat(customer.hsdRate).toFixed(4)}</td>
            <td class="${customer.balance >= 0 ? 'balance-positive' : 'balance-negative'}">Rs. ${customer.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-success btn-sm" onclick="viewCustomerLedger('${customer.id}')">üìä Ledger</button>
                <button class="btn btn-info btn-sm" onclick='editCustomer(${JSON.stringify(customer).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer.id}')">Delete</button>
            </td>
        `;
        fragment.appendChild(row);
    });

    tbody.appendChild(fragment);
}

function editCustomer(customer) {
    // Set ID first to prevent clearing
    document.getElementById('customerId').value = customer.id;

    // Open modal (will detect we're editing and won't clear)
    openModal('customerModal');

    // Now fill all fields (they won't be cleared)
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerContact').value = customer.contact || '';
    document.getElementById('customerCnic').value = customer.cnic || '';
    document.getElementById('customerPmgRate').value = customer.pmgRate;
    document.getElementById('customerHsdRate').value = customer.hsdRate;
    document.getElementById('customerAddress').value = customer.address || '';
    document.getElementById('customerNotes').value = customer.notes || '';

    // Set balance as EDITABLE
    const balanceField = document.getElementById('customerOpeningBalance');
    balanceField.value = customer.balance.toFixed(2);
    balanceField.disabled = false;
    balanceField.style.backgroundColor = '';
    balanceField.title = 'Edit opening balance if needed';
}

function deleteCustomer(id) {
    if (confirm('Are you sure?')) {
        customers = customers.filter(c => c.id !== id);
        saveToStorage();
        renderCustomers();
        updateDashboard();
        populateDropdowns();
        showNotification('Customer deleted!', 'success');
    }
}

// SUPPLIER FUNCTIONS
function saveSupplier(e) {
    e.preventDefault();
    
    const openingBalance = parseFloat(document.getElementById('supplierOpeningBalance').value) || 0;
    
    const supplier = {
        id: document.getElementById('supplierId').value || 'supp_' + Date.now(),
        name: document.getElementById('supplierName').value,
        contact: document.getElementById('supplierContact').value,
        cnic: document.getElementById('supplierCnic').value,
        pmgRateSelf: parseFloat(document.getElementById('supplierPmgRateSelf').value).toFixed(4),
        hsdRateSelf: parseFloat(document.getElementById('supplierHsdRateSelf').value).toFixed(4),
        pmgRatePSO: parseFloat(document.getElementById('supplierPmgRatePSO').value || 0).toFixed(4),
        hsdRatePSO: parseFloat(document.getElementById('supplierHsdRatePSO').value || 0).toFixed(4),
        defaultCarriage: document.getElementById('supplierDefaultCarriage').value,
        address: document.getElementById('supplierAddress').value,
        notes: document.getElementById('supplierNotes').value,
        balance: 0,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = suppliers.findIndex(s => s.id === supplier.id);
    if (existingIndex >= 0) {
        // Editing - use edited balance from form
        supplier.balance = openingBalance;
        suppliers[existingIndex] = supplier;
        showNotification('Supplier updated! ‚úÖ', 'success');
    } else {
        // New supplier - set opening balance
        supplier.balance = openingBalance;
        suppliers.push(supplier);
        showNotification('Supplier added! ‚úÖ' + (openingBalance !== 0 ? ` (Opening balance: Rs. ${openingBalance.toFixed(2)})` : ''), 'success');
    }
    
    saveToStorage();
    renderSuppliers();
    closeModal('supplierModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderSuppliers() {
    const tbody = document.getElementById('suppliersBody');
    tbody.innerHTML = '';
    
    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    
    suppliers.forEach(supplier => {
        // Support both old format (pmgRate) and new format (pmgRateSelf)
        const pmgRate = supplier.pmgRateSelf || supplier.pmgRate || 0;
        const hsdRate = supplier.hsdRateSelf || supplier.hsdRate || 0;
        const carriageType = supplier.defaultCarriage || 'self';
        const carriageIcon = carriageType === 'pso' ? 'üöõ' : 'üöó';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${supplier.name}</strong></td>
            <td>${supplier.contact || '-'}</td>
            <td>${supplier.cnic || '-'}</td>
            <td>Rs. ${parseFloat(pmgRate).toFixed(4)} ${carriageIcon}</td>
            <td>Rs. ${parseFloat(hsdRate).toFixed(4)} ${carriageIcon}</td>
            <td class="${supplier.balance >= 0 ? 'balance-positive' : 'balance-negative'}">Rs. ${supplier.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-success btn-sm" onclick="viewSupplierLedger('${supplier.id}')">üìä Ledger</button>
                <button class="btn btn-info btn-sm" onclick='editSupplier(${JSON.stringify(supplier).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteSupplier('${supplier.id}')">Delete</button>
            </td>
        `;
        fragment.appendChild(row);
    });
    
    tbody.appendChild(fragment);
}

function filterSuppliers() {
    const searchTerm = document.getElementById('supplierSearchBox').value.toLowerCase();
    const tbody = document.getElementById('suppliersBody');
    tbody.innerHTML = '';

    const filteredSuppliers = suppliers.filter(supplier => {
        return supplier.name.toLowerCase().includes(searchTerm) ||
               (supplier.contact && supplier.contact.toLowerCase().includes(searchTerm)) ||
               (supplier.cnic && supplier.cnic.toLowerCase().includes(searchTerm));
    });

    const fragment = document.createDocumentFragment();

    filteredSuppliers.forEach(supplier => {
        const pmgRate = supplier.pmgRateSelf || supplier.pmgRate || 0;
        const hsdRate = supplier.hsdRateSelf || supplier.hsdRate || 0;
        const carriageType = supplier.defaultCarriage || 'self';
        const carriageIcon = carriageType === 'pso' ? 'üöõ' : 'üöó';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${supplier.name}</strong></td>
            <td>${supplier.contact || '-'}</td>
            <td>${supplier.cnic || '-'}</td>
            <td>Rs. ${parseFloat(pmgRate).toFixed(4)} ${carriageIcon}</td>
            <td>Rs. ${parseFloat(hsdRate).toFixed(4)} ${carriageIcon}</td>
            <td class="${supplier.balance >= 0 ? 'balance-positive' : 'balance-negative'}">Rs. ${supplier.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-success btn-sm" onclick="viewSupplierLedger('${supplier.id}')">üìä Ledger</button>
                <button class="btn btn-info btn-sm" onclick='editSupplier(${JSON.stringify(supplier).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteSupplier('${supplier.id}')">Delete</button>
            </td>
        `;
        fragment.appendChild(row);
    });

    tbody.appendChild(fragment);
}

function editSupplier(supplier) {
    // Set ID first to prevent clearing
    document.getElementById('supplierId').value = supplier.id;
    
    // Open modal (will detect we're editing and won't clear)
    openModal('supplierModal');
    
    // Now fill all fields (they won't be cleared)
    document.getElementById('supplierName').value = supplier.name;
    document.getElementById('supplierContact').value = supplier.contact || '';
    document.getElementById('supplierCnic').value = supplier.cnic || '';
    
    // Support both old and new format
    document.getElementById('supplierPmgRateSelf').value = supplier.pmgRateSelf || supplier.pmgRate || '';
    document.getElementById('supplierHsdRateSelf').value = supplier.hsdRateSelf || supplier.hsdRate || '';
    document.getElementById('supplierPmgRatePSO').value = supplier.pmgRatePSO || '';
    document.getElementById('supplierHsdRatePSO').value = supplier.hsdRatePSO || '';
    document.getElementById('supplierDefaultCarriage').value = supplier.defaultCarriage || 'self';
    
    document.getElementById('supplierAddress').value = supplier.address || '';
    document.getElementById('supplierNotes').value = supplier.notes || '';
    
    // Set balance as EDITABLE
    const balanceField = document.getElementById('supplierOpeningBalance');
    balanceField.value = supplier.balance.toFixed(2);
    balanceField.disabled = false;
    balanceField.style.backgroundColor = '';
    balanceField.title = 'Edit opening balance if needed';
}

function deleteSupplier(id) {
    if (confirm('Are you sure?')) {
        suppliers = suppliers.filter(s => s.id !== id);
        saveToStorage();
        renderSuppliers();
        updateDashboard();
        populateDropdowns();
        showNotification('Supplier deleted!', 'success');
    }
}

// TRANSACTION FUNCTIONS
async function saveSale(e) {
    e.preventDefault();
    
    const customerId = document.getElementById('saleCustomerId').value;
    const customer = customers.find(c => c.id === customerId);
    const fuelType = document.getElementById('saleFuelType').value;
    const quantity = parseFloat(document.getElementById('saleQuantity').value);
    const rate = parseFloat(document.getElementById('saleRate').value);
    const subtotal = parseFloat(document.getElementById('saleSubtotal').value);
    const amount = parseFloat(document.getElementById('saleAmount').value);
    const vehicleId = document.getElementById('saleVehicleId').value;
    const vehicle = vehicles.find(v => v.id === vehicleId);
    const date = document.getElementById('saleDate').value;
    
    // Get discount details
    const discountType = document.getElementById('saleDiscountType').value;
    const discountValue = parseFloat(document.getElementById('saleDiscountValue').value) || 0;
    const discountAmount = subtotal - amount;
    
    // Check if vehicle has enough stock
    if (fuelType === 'PMG' && vehicle.stockPMG < quantity/1000) {
        showNotification('Insufficient PMG stock in vehicle!', 'error');
        return;
    }
    if (fuelType === 'HSD' && vehicle.stockHSD < quantity/1000) {
        showNotification('Insufficient HSD stock in vehicle!', 'error');
        return;
    }
    
    const transaction = {
        id: 'trans_' + Date.now(),
        type: 'sale',
        partyId: customerId,
        partyName: customer.name,
        fuelType: fuelType,
        quantity: quantity,
        rate: rate,
        subtotal: subtotal,
        discountType: discountType,
        discountValue: discountValue,
        discountAmount: discountAmount,
        amount: amount,
        vehicleId: vehicleId,
        date: date,
        createdAt: new Date().toISOString()
    };
    
    // Add transaction first
    transactions.push(transaction);
    
    // Update customer balance
    customer.balance += amount;
    
    // Deduct from vehicle stock - CRITICAL: Update the actual vehicle object in the array
    const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
    if (fuelType === 'PMG') {
        vehicles[vehicleIndex].stockPMG -= quantity / 1000; // Convert liters to KL
    } else {
        vehicles[vehicleIndex].stockHSD -= quantity / 1000;
    }
    
    // Ledger entry
    addLedgerEntry('sale', `Sale to ${customer.name} - ${fuelType}`, 
        `Customer: ${customer.name}`, amount, 'Sales Revenue', amount, date);
    
    // CRITICAL: Force save to localStorage IMMEDIATELY
    await saveToStorage();
    
    // CRITICAL: Force complete UI refresh
    renderTransactions();
    renderCustomers();
    renderVehicles();
    updateDashboard();
    populateDropdowns();
    
    // Close modal and reset form
    closeModal('saleModal');
    e.target.reset();
    calculateSaleAmount(); // Reset display
    
    // Success message
    let msg = '‚úÖ Sale recorded successfully!';
    if (discountAmount > 0) {
        msg += ` (Discount: Rs. ${discountAmount.toFixed(2)})`;
    }
    showNotification(msg, 'success');
}

async function savePurchase(e) {
    e.preventDefault();
    
    const supplierId = document.getElementById('purchaseSupplierId').value;
    const supplier = suppliers.find(s => s.id === supplierId);
    const fuelType = document.getElementById('purchaseFuelType').value;
    const quantity = parseFloat(document.getElementById('purchaseQuantity').value);
    const rate = parseFloat(document.getElementById('purchaseRate').value);
    const subtotal = parseFloat(document.getElementById('purchaseSubtotal').value);
    const amount = parseFloat(document.getElementById('purchaseAmount').value);
    const vehicleId = document.getElementById('purchaseVehicleId').value;
    const vehicle = vehicles.find(v => v.id === vehicleId);
    const date = document.getElementById('purchaseDate').value;
    
    // Get discount details
    const discountType = document.getElementById('purchaseDiscountType').value;
    const discountValue = parseFloat(document.getElementById('purchaseDiscountValue').value) || 0;
    const discountAmount = subtotal - amount;
    
    const transaction = {
        id: 'trans_' + Date.now(),
        type: 'purchase',
        partyId: supplierId,
        partyName: supplier.name,
        fuelType: fuelType,
        quantity: quantity,
        rate: rate,
        subtotal: subtotal,
        discountType: discountType,
        discountValue: discountValue,
        discountAmount: discountAmount,
        amount: amount,
        vehicleId: vehicleId,
        date: date,
        createdAt: new Date().toISOString()
    };
    
    transactions.push(transaction);
    supplier.balance += amount;
    
    // Add to vehicle stock
    if (fuelType === 'PMG') {
        vehicle.stockPMG += quantity / 1000; // Convert liters to KL
    } else {
        vehicle.stockHSD += quantity / 1000;
    }
    
    // Ledger entry
    addLedgerEntry('purchase', `Purchase from ${supplier.name} - ${fuelType}`, 
        'Inventory', amount, `Supplier: ${supplier.name}`, amount, date);
    
    await saveToStorage();
    renderTransactions();
    renderSuppliers();
    renderVehicles();
    closeModal('purchaseModal');
    updateDashboard();
    
    let msg = 'Purchase recorded! Stock updated! ‚úÖ';
    if (discountAmount > 0) {
        msg += ` (Discount: Rs. ${discountAmount.toFixed(2)})`;
    }
    showNotification(msg, 'success');
    e.target.reset();
    calculatePurchaseAmount(); // Reset display
}

// Pagination variables
let transactionsPage = 1;
const transactionsPerPage = 50; // Show 50 at a time

function renderTransactions() {
    const tbody = document.getElementById('transactionsBody');
    tbody.innerHTML = '';
    
    // COMBINE ALL ENTRY TYPES INTO ONE ARRAY!
    let allEntries = [];
    
    // 1. Add regular transactions (sales/purchases)
    transactions.forEach(trans => {
        const vehicle = vehicles.find(v => v.id === trans.vehicleId);
        let discountDisplay = '';
        if (trans.discountAmount && trans.discountAmount > 0) {
            discountDisplay = ` (Discount: Rs. ${trans.discountAmount.toFixed(2)})`;
        }
        allEntries.push({
            id: trans.id,
            date: trans.date,
            type: trans.type === 'sale' ? 'SALE' : 'PURCHASE',
            typeColor: trans.type === 'sale' ? '#48bb78' : '#ed8936',
            description: `${trans.partyName} - ${trans.fuelType} (${trans.quantity.toFixed(2)} L @ Rs. ${trans.rate.toFixed(2)})${discountDisplay}`,
            amount: trans.amount,
            reference: vehicle ? vehicle.number : '-',
            deleteFunction: `deleteTransaction('${trans.id}', '${trans.type}', '${trans.partyId}', '${trans.vehicleId}', '${trans.fuelType}', ${trans.quantity}, ${trans.amount})`,
            entryType: 'transaction'
        });
    });
    
    // 2. Add payments
    payments.forEach(payment => {
        const party = payment.type === 'received' 
            ? customers.find(c => c.id === payment.partyId)
            : suppliers.find(s => s.id === payment.partyId);
        allEntries.push({
            id: payment.id,
            date: payment.date,
            type: payment.type === 'received' ? 'PAYMENT IN' : 'PAYMENT OUT',
            typeColor: payment.type === 'received' ? '#4299e1' : '#9f7aea',
            description: `${party ? party.name : 'Unknown'} - ${payment.method}`,
            amount: payment.amount,
            reference: payment.referenceNo || '-',
            deleteFunction: `deletePayment('${payment.id}')`,
            entryType: 'payment'
        });
    });
    
    // 3. Add expenses
    expenses.forEach(expense => {
        let expenseDesc = expense.description;
        if (expense.source === 'customer') {
            const customer = customers.find(c => c.id === expense.customerId);
            if (customer) expenseDesc += ` (Paid for ${customer.name})`;
        }
        allEntries.push({
            id: expense.id,
            date: expense.date,
            type: 'EXPENSE',
            typeColor: '#f56565',
            description: expenseDesc,
            amount: expense.amount,
            reference: expense.category || '-',
            deleteFunction: `deleteExpense('${expense.id}')`,
            entryType: 'expense'
        });
    });
    
    // 4. Add customer transfers
    customerTransfers.forEach(transfer => {
        const fromCustomer = customers.find(c => c.id === transfer.fromCustomerId);
        const toCustomer = customers.find(c => c.id === transfer.toCustomerId);
        allEntries.push({
            id: transfer.id,
            date: transfer.date,
            type: 'TRANSFER',
            typeColor: '#38b2ac',
            description: `Transfer from ${fromCustomer ? fromCustomer.name : 'Unknown'} to ${toCustomer ? toCustomer.name : 'Unknown'}`,
            amount: transfer.amount,
            reference: transfer.description || '-',
            deleteFunction: `deleteCustomerTransfer('${transfer.id}')`,
            entryType: 'transfer'
        });
    });
    
    // 5. Add JV vouchers
    jvVouchers.forEach(jv => {
        allEntries.push({
            id: jv.id,
            date: jv.date,
            type: 'JV VOUCHER',
            typeColor: '#805ad5',
            description: `${jv.description} (Dr: ${jv.debitType} / Cr: ${jv.creditType})`,
            amount: jv.debitAmount,
            reference: jv.voucherNumber || '-',
            deleteFunction: `deleteJVVoucher('${jv.id}')`,
            entryType: 'jv'
        });
    });
    
    // 6. Add bank transactions
    bankTransactions.forEach(bankTrans => {
        const bank = banks.find(b => b.id === bankTrans.bankId);
        allEntries.push({
            id: bankTrans.id,
            date: bankTrans.date,
            type: bankTrans.type === 'deposit' ? 'BANK DEPOSIT' : 'BANK WITHDRAWAL',
            typeColor: bankTrans.type === 'deposit' ? '#48bb78' : '#f56565',
            description: `${bank ? bank.name : 'Unknown Bank'} - ${bankTrans.description}`,
            amount: bankTrans.amount,
            reference: bankTrans.referenceNo || '-',
            deleteFunction: `deleteBankTransaction('${bankTrans.id}')`,
            entryType: 'bank'
        });
    });
    
    // Sort all entries by date (newest first)
    allEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Show loading message for large datasets
    if (allEntries.length > 100) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">‚è≥ Loading all transactions...</td></tr>';
    }
    
    // Use setTimeout to prevent UI blocking for large datasets
    setTimeout(() => {
        const fragment = document.createDocumentFragment();
        
        // Get paginated entries
        const startIndex = (transactionsPage - 1) * transactionsPerPage;
        const endIndex = startIndex + transactionsPerPage;
        const paginatedEntries = allEntries.slice(startIndex, endIndex);
        
        paginatedEntries.forEach(entry => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td><span style="background: ${entry.typeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600;">${entry.type}</span></td>
                <td>${entry.description}</td>
                <td style="font-weight: 700;">Rs. ${entry.amount.toFixed(2)}</td>
                <td>${entry.reference}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="${entry.deleteFunction}">üóëÔ∏è Delete</button>
                </td>
            `;
            fragment.appendChild(row);
        });
        
        tbody.innerHTML = '';
        tbody.appendChild(fragment);
        
        // Show pagination info
        const totalPages = Math.ceil(allEntries.length / transactionsPerPage);
        if (totalPages > 1) {
            const paginationRow = document.createElement('tr');
            paginationRow.innerHTML = `
                <td colspan="6" style="text-align: center; padding: 15px; background: var(--bg-secondary);">
                    <button class="btn btn-sm btn-secondary" onclick="changeTransactionsPage(-1)" ${transactionsPage === 1 ? 'disabled' : ''}>‚Üê Previous</button>
                    <span style="margin: 0 15px; font-weight: 700;">Page ${transactionsPage} of ${totalPages} (${allEntries.length} total entries)</span>
                    <button class="btn btn-sm btn-secondary" onclick="changeTransactionsPage(1)" ${transactionsPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>
                </td>
            `;
            tbody.appendChild(paginationRow);
        }
        
        // Show total count
        if (allEntries.length > 0) {
            const summaryRow = document.createElement('tr');
            summaryRow.innerHTML = `
                <td colspan="6" style="text-align: center; padding: 10px; background: var(--bg-tertiary); font-weight: 600;">
                    üìä Showing ${allEntries.length} entries: ${transactions.length} Sales/Purchases | ${payments.length} Payments | ${expenses.length} Expenses | ${customerTransfers.length} Transfers | ${jvVouchers.length} JV Vouchers | ${bankTransactions.length} Bank Trans
                </td>
            `;
            tbody.appendChild(summaryRow);
        }
    }, 10); // Small delay to prevent UI blocking
}

function changeTransactionsPage(direction) {
    const totalPages = Math.ceil(transactions.length / transactionsPerPage);
    transactionsPage += direction;
    if (transactionsPage < 1) transactionsPage = 1;
    if (transactionsPage > totalPages) transactionsPage = totalPages;
    renderTransactions();
}

async function deleteTransaction(transId, type, partyId, vehicleId, fuelType, quantity, amount) {
    if (!confirm('Are you sure you want to delete this transaction? This will reverse all changes made by this transaction.')) {
        return;
    }
    
    // Find the transaction
    const transIndex = transactions.findIndex(t => t.id === transId);
    if (transIndex === -1) {
        showNotification('Transaction not found!', 'error');
        return;
    }
    
    const transaction = transactions[transIndex];
    
    // Reverse the effects based on transaction type
    if (type === 'sale') {
        // Find customer and reduce their balance
        const customerIndex = customers.findIndex(c => c.id === partyId);
        if (customerIndex >= 0) {
            customers[customerIndex].balance -= amount;
        }
        
        // Add stock back to vehicle
        const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
        if (vehicleIndex >= 0) {
            if (fuelType === 'PMG') {
                vehicles[vehicleIndex].stockPMG += quantity / 1000; // Convert liters back to KL
            } else {
                vehicles[vehicleIndex].stockHSD += quantity / 1000;
            }
        }
    } else if (type === 'purchase') {
        // Find supplier and reduce their balance
        const supplierIndex = suppliers.findIndex(s => s.id === partyId);
        if (supplierIndex >= 0) {
            suppliers[supplierIndex].balance -= amount;
        }
        
        // Remove stock from vehicle
        const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
        if (vehicleIndex >= 0) {
            if (fuelType === 'PMG') {
                vehicles[vehicleIndex].stockPMG -= quantity / 1000; // Convert liters to KL
            } else {
                vehicles[vehicleIndex].stockHSD -= quantity / 1000;
            }
        }
    }
    
    // Remove the transaction
    transactions.splice(transIndex, 1);
    
    // CRITICAL: Force save and complete refresh
    await saveToStorage();
    renderTransactions();
    renderCustomers();
    renderSuppliers();
    renderVehicles();
    updateDashboard();
    populateDropdowns();
    
    showNotification('‚úÖ Transaction deleted successfully! All changes reversed.', 'success');
}

function updateSaleRate() {
    const customerId = document.getElementById('saleCustomerId').value;
    const fuelType = document.getElementById('saleFuelType').value;
    
    if (customerId && fuelType) {
        const customer = customers.find(c => c.id === customerId);
        const rate = fuelType === 'PMG' ? customer.pmgRate : customer.hsdRate;
        document.getElementById('saleRate').value = rate;
        calculateSaleAmount();
    }
}

function calculateSaleAmount() {
    const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
    const rate = parseFloat(document.getElementById('saleRate').value) || 0;
    const subtotal = quantity * rate;
    
    // Update subtotal
    document.getElementById('saleSubtotal').value = subtotal.toFixed(2);
    
    // Get discount details
    const discountType = document.getElementById('saleDiscountType').value;
    const discountValue = parseFloat(document.getElementById('saleDiscountValue').value) || 0;
    
    let discountAmount = 0;
    let finalAmount = subtotal;
    let discountInfo = '';
    
    if (discountType === 'percentage' && discountValue > 0) {
        discountAmount = (subtotal * discountValue) / 100;
        finalAmount = subtotal - discountAmount;
        discountInfo = `üí∞ Discount: ${discountValue}% = Rs. ${discountAmount.toFixed(2)}`;
    } else if (discountType === 'fixed' && discountValue > 0) {
        discountAmount = discountValue;
        finalAmount = subtotal - discountAmount;
        const percentageDiscount = ((discountAmount / subtotal) * 100).toFixed(2);
        discountInfo = `üí∞ Discount: Rs. ${discountAmount.toFixed(2)} (${percentageDiscount}%)`;
    } else if (discountType === 'perlitre' && discountValue > 0) {
        // Per Litre discount: discount_per_litre * quantity
        discountAmount = discountValue * quantity;
        finalAmount = subtotal - discountAmount;
        const percentageDiscount = ((discountAmount / subtotal) * 100).toFixed(2);
        discountInfo = `üí∞ Discount: Rs. ${discountValue}/L √ó ${quantity} L = Rs. ${discountAmount.toFixed(2)} (${percentageDiscount}%)`;
    } else {
        discountInfo = 'No discount applied';
    }
    
    // Update final amount and info
    document.getElementById('saleAmount').value = finalAmount.toFixed(2);
    document.getElementById('saleDiscountInfo').innerHTML = discountInfo;
}

function updatePurchaseCarriageOptions() {
    const supplierId = document.getElementById('purchaseSupplierId').value;
    const carriageSection = document.getElementById('purchaseCarriageSection');
    const carriageTypeSelect = document.getElementById('purchaseCarriageType');
    const carriageInfo = document.getElementById('purchaseCarriageInfo');
    
    if (!supplierId) {
        carriageSection.style.display = 'none';
        return;
    }
    
    const supplier = suppliers.find(s => s.id === supplierId);
    if (!supplier) return;
    
    // Show carriage section
    carriageSection.style.display = 'block';
    
    // Set default carriage type
    carriageTypeSelect.value = supplier.defaultCarriage || 'self';
    
    // Show rate information
    const pmgSelf = supplier.pmgRateSelf || supplier.pmgRate || 0;
    const hsdSelf = supplier.hsdRateSelf || supplier.hsdRate || 0;
    const pmgPSO = supplier.pmgRatePSO || 0;
    const hsdPSO = supplier.hsdRatePSO || 0;
    
    carriageInfo.innerHTML = `
        <strong>üöó Self Carriage:</strong> PMG: Rs. ${parseFloat(pmgSelf).toFixed(4)}/L, HSD: Rs. ${parseFloat(hsdSelf).toFixed(4)}/L<br>
        <strong>üöõ PSO Carriage:</strong> PMG: Rs. ${pmgPSO > 0 ? parseFloat(pmgPSO).toFixed(4) : 'N/A'}/L, HSD: Rs. ${hsdPSO > 0 ? parseFloat(hsdPSO).toFixed(4) : 'N/A'}/L
    `;
    
    // Update rate based on selection
    updatePurchaseRate();
}

function updatePurchaseRate() {
    const supplierId = document.getElementById('purchaseSupplierId').value;
    const fuelType = document.getElementById('purchaseFuelType').value;
    const carriageTypeSelect = document.getElementById('purchaseCarriageType');
    
    if (supplierId && fuelType) {
        const supplier = suppliers.find(s => s.id === supplierId);
        
        // Use selected carriage type from dropdown
        const carriageType = carriageTypeSelect ? carriageTypeSelect.value : (supplier.defaultCarriage || 'self');
        
        let rate;
        if (fuelType === 'PMG') {
            // Use PSO rate if carriage is pso, otherwise use Self rate
            rate = carriageType === 'pso' && supplier.pmgRatePSO 
                ? supplier.pmgRatePSO 
                : (supplier.pmgRateSelf || supplier.pmgRate || 0);
        } else {
            rate = carriageType === 'pso' && supplier.hsdRatePSO 
                ? supplier.hsdRatePSO 
                : (supplier.hsdRateSelf || supplier.hsdRate || 0);
        }
        
        document.getElementById('purchaseRate').value = rate;
        calculatePurchaseAmount();
    }
}

function calculatePurchaseAmount() {
    const quantity = parseFloat(document.getElementById('purchaseQuantity').value) || 0;
    const rate = parseFloat(document.getElementById('purchaseRate').value) || 0;
    const subtotal = quantity * rate;
    
    // Update subtotal
    document.getElementById('purchaseSubtotal').value = subtotal.toFixed(2);
    
    // Get discount details
    const discountType = document.getElementById('purchaseDiscountType').value;
    const discountValue = parseFloat(document.getElementById('purchaseDiscountValue').value) || 0;
    
    let discountAmount = 0;
    let finalAmount = subtotal;
    let discountInfo = '';
    
    if (discountType === 'percentage' && discountValue > 0) {
        discountAmount = (subtotal * discountValue) / 100;
        finalAmount = subtotal - discountAmount;
        discountInfo = `üí∞ Discount: ${discountValue}% = Rs. ${discountAmount.toFixed(2)}`;
    } else if (discountType === 'fixed' && discountValue > 0) {
        discountAmount = discountValue;
        finalAmount = subtotal - discountAmount;
        const percentageDiscount = ((discountAmount / subtotal) * 100).toFixed(2);
        discountInfo = `üí∞ Discount: Rs. ${discountAmount.toFixed(2)} (${percentageDiscount}%)`;
    } else if (discountType === 'perlitre' && discountValue > 0) {
        // Per Litre discount: discount_per_litre * quantity
        discountAmount = discountValue * quantity;
        finalAmount = subtotal - discountAmount;
        const percentageDiscount = ((discountAmount / subtotal) * 100).toFixed(2);
        discountInfo = `üí∞ Discount: Rs. ${discountValue}/L √ó ${quantity} L = Rs. ${discountAmount.toFixed(2)} (${percentageDiscount}%)`;
    } else {
        discountInfo = 'No discount applied';
    }
    
    // Update final amount and info
    document.getElementById('purchaseAmount').value = finalAmount.toFixed(2);
    document.getElementById('purchaseDiscountInfo').innerHTML = discountInfo;
}

// PAYMENT FUNCTIONS
function updatePaymentParties() {
    const type = document.getElementById('paymentType').value;
    const partySelect = document.getElementById('paymentPartyId');
    const toCustomerSelect = document.getElementById('paymentToCustomerId');
    const label = document.getElementById('paymentPartyLabel');
    const toCustomerGroup = document.getElementById('paymentToCustomerGroup');
    const partyGroup = document.getElementById('paymentPartyGroup');

    partySelect.innerHTML = '<option value="">Select Party</option>';
    toCustomerSelect.innerHTML = '<option value="">Select Customer</option>';

    if (type === 'received') {
        label.textContent = 'Customer *';
        partyGroup.style.display = 'block';
        toCustomerGroup.style.display = 'none';
        customers.forEach(c => {
            partySelect.innerHTML += `<option value="${c.id}">${c.name} (Balance: Rs. ${c.balance.toFixed(2)})</option>`;
        });
    } else if (type === 'paid') {
        label.textContent = 'Supplier *';
        partyGroup.style.display = 'block';
        toCustomerGroup.style.display = 'none';
        suppliers.forEach(s => {
            partySelect.innerHTML += `<option value="${s.id}">${s.name} (Balance: Rs. ${s.balance.toFixed(2)})</option>`;
        });
    } else if (type === 'owner-received') {
        label.textContent = 'Owner/Relative Account *';
        partyGroup.style.display = 'block';
        toCustomerGroup.style.display = 'none';
        ownerAccounts.forEach(a => {
            const icon = a.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
            partySelect.innerHTML += `<option value="${a.id}">${icon} ${a.name} (Balance: Rs. ${a.balance.toFixed(2)})</option>`;
        });
    } else if (type === 'owner-paid') {
        label.textContent = 'Owner/Relative Account *';
        partyGroup.style.display = 'block';
        toCustomerGroup.style.display = 'none';
        ownerAccounts.forEach(a => {
            const icon = a.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
            partySelect.innerHTML += `<option value="${a.id}">${icon} ${a.name} (Balance: Rs. ${a.balance.toFixed(2)})</option>`;
        });
    } else if (type === 'customer-to-customer') {
        label.textContent = 'From Customer *';
        partyGroup.style.display = 'block';
        toCustomerGroup.style.display = 'block';
        customers.forEach(c => {
            partySelect.innerHTML += `<option value="${c.id}">${c.name} (Balance: Rs. ${c.balance.toFixed(2)})</option>`;
            toCustomerSelect.innerHTML += `<option value="${c.id}">${c.name} (Balance: Rs. ${c.balance.toFixed(2)})</option>`;
        });
    } else {
        partyGroup.style.display = 'none';
        toCustomerGroup.style.display = 'none';
    }
}

function toggleBankField() {
    const method = document.getElementById('paymentMethod').value;
    const bankGroup = document.getElementById('paymentBankGroup');
    
    if (method === 'bank' || method === 'cheque') {
        bankGroup.style.display = 'block';
    } else {
        bankGroup.style.display = 'none';
    }
}

async function savePayment(e) {
    e.preventDefault();

    const type = document.getElementById('paymentType').value;
    const partyId = document.getElementById('paymentPartyId').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const method = document.getElementById('paymentMethod').value;
    const bankId = document.getElementById('paymentBankId').value;
    const date = document.getElementById('paymentDate').value;
    const notes = document.getElementById('paymentNotes').value;

    let party, partyName;

    if (type === 'customer-to-customer') {
        // Handle customer to customer transfer
        const toCustomerId = document.getElementById('paymentToCustomerId').value;
        if (!toCustomerId || toCustomerId === partyId) {
            showNotification('Please select different customers for transfer!', 'error');
            return;
        }

        const fromCustomer = customers.find(c => c.id === partyId);
        const toCustomer = customers.find(c => c.id === toCustomerId);

        if (!fromCustomer || !toCustomer) {
            showNotification('Customer not found!', 'error');
            return;
        }

        // Create customer transfer
        const transfer = {
            id: 'ct_' + Date.now(),
            fromCustomerId: partyId,
            fromCustomerName: fromCustomer.name,
            toCustomerId: toCustomerId,
            toCustomerName: toCustomer.name,
            amount: amount,
            date: date,
            notes: notes,
            createdBy: currentUser,
            createdAt: new Date().toISOString()
        };

        // Update balances
        fromCustomer.balance -= amount; // Reduces from customer's receivable
        toCustomer.balance += amount;   // Increases to customer's receivable

        customerTransfers.push(transfer);

        // Ledger entries
        addLedgerEntry('customer_transfer', `Transfer from ${fromCustomer.name} to ${toCustomer.name}`,
            `Customer: ${fromCustomer.name}`, amount, `Customer: ${toCustomer.name}`, amount, date);

        await saveToStorage();
        renderCustomers();
        updateDashboard();
        closeModal('paymentModal');
        showNotification(`Transfer of Rs. ${amount.toFixed(2)} from ${fromCustomer.name} to ${toCustomer.name} recorded! üîÑ`, 'success');
        e.target.reset();
        return;
    }

    if (type === 'received') {
        party = customers.find(c => c.id === partyId);
        partyName = party.name;
        party.balance -= amount;

        // Ledger entry
        addLedgerEntry('payment_received', `Payment from ${partyName}`,
            bankId ? 'Bank' : 'Cash', amount, `Customer: ${partyName}`, amount, date);
    } else if (type === 'paid') {
        party = suppliers.find(s => s.id === partyId);
        partyName = party.name;
        party.balance -= amount;

        // Ledger entry
        addLedgerEntry('payment_made', `Payment to ${partyName}`,
            `Supplier: ${partyName}`, amount, bankId ? 'Bank' : 'Cash', amount, date);
    } else if (type === 'owner-received') {
        party = ownerAccounts.find(a => a.id === partyId);
        const icon = party.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
        partyName = `${icon} ${party.name}`;
        party.balance -= amount; // Owner balance decreases when they give money to business

        // Ledger entry
        addLedgerEntry('payment_received', `Payment from ${partyName}`,
            bankId ? 'Bank' : 'Cash', amount, `Owner: ${party.name}`, amount, date);
    } else if (type === 'owner-paid') {
        party = ownerAccounts.find(a => a.id === partyId);
        const icon = party.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
        partyName = `${icon} ${party.name}`;
        party.balance += amount; // Owner balance increases when business gives them money

        // Ledger entry
        addLedgerEntry('payment_made', `Payment to ${partyName}`,
            `Owner: ${party.name}`, amount, bankId ? 'Bank' : 'Cash', amount, date);
    }
    
    const payment = {
        id: 'pay_' + Date.now(),
        type: type,
        partyId: partyId,
        partyName: partyName,
        amount: amount,
        method: method,
        bankId: bankId,
        date: date,
        notes: notes,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    payments.push(payment);

    // Update bank balance AND create bank transaction entry
    if (bankId && (method === 'bank' || method === 'cheque')) {
        const bank = banks.find(b => b.id === bankId);
        if (bank) {
            if (type === 'received') {
                bank.balance += amount;
            } else {
                bank.balance -= amount;
            }

            // Create bank transaction entry for tracking
            const bankTransaction = {
                id: 'bt_' + Date.now(),
                bankId: bankId,
                bankName: bank.name,
                type: (type === 'received' || type === 'owner-received') ? 'deposit' : 'withdrawal',
                amount: amount,
                description: (type === 'received' || type === 'owner-received') ? `Payment from ${partyName}` : `Payment to ${partyName}`,
                date: date,
                balanceAfter: bank.balance,
                createdBy: currentUser,
                createdAt: new Date().toISOString()
            };
            bankTransactions.push(bankTransaction);
        }
    }

    await saveToStorage();
    renderPayments();
    renderTransactions(); // Update unified transactions view
    renderCustomers();
    renderSuppliers();
    renderBanks();
    renderOwnerAccounts(); // Refresh owner accounts
    closeModal('paymentModal');
    updateDashboard();
    showNotification('Payment recorded! üí∞', 'success');
    e.target.reset();
}

function renderPayments() {
    const tbody = document.getElementById('paymentsBody');
    tbody.innerHTML = '';
    
    payments.slice().reverse().forEach(payment => {
        const bank = banks.find(b => b.id === payment.bankId);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(payment.date).toLocaleDateString()}</td>
            <td>${payment.partyName}</td>
            <td><span style="background: ${payment.type === 'received' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${payment.type === 'received' ? 'RECEIVED' : 'PAID'}</span></td>
            <td style="font-weight: 700;">Rs. ${payment.amount.toFixed(2)}</td>
            <td>${payment.method.toUpperCase()}</td>
            <td>${bank ? bank.name : '-'}</td>
            <td>${payment.notes || '-'}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')">Delete</button>
            </td>
        `;
    });
}

// CUSTOMER TRANSFER FUNCTIONS (NEW)
function saveCustomerTransfer(e) {
    e.preventDefault();
    
    const fromId = document.getElementById('transferFromCustomerId').value;
    const toId = document.getElementById('transferToCustomerId').value;
    const amount = parseFloat(document.getElementById('transferAmount').value);
    const date = document.getElementById('transferDate').value;
    const notes = document.getElementById('transferNotes').value;
    
    if (fromId === toId) {
        showNotification('Cannot transfer to same customer!', 'error');
        return;
    }
    
    const fromCustomer = customers.find(c => c.id === fromId);
    const toCustomer = customers.find(c => c.id === toId);
    
    const transfer = {
        id: 'transfer_' + Date.now(),
        fromCustomerId: fromId,
        fromCustomerName: fromCustomer.name,
        toCustomerId: toId,
        toCustomerName: toCustomer.name,
        amount: amount,
        date: date,
        description: notes,  // Changed from 'notes' to 'description' for consistency
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    // Update balances
    fromCustomer.balance += amount; // Debit (paying customer's balance increases)
    toCustomer.balance -= amount;   // Credit (receiving customer's balance decreases)
    
    customerTransfers.push(transfer);

    // NOTE: No ledger entry needed - customer transfers are tracked in customerTransfers array only
    // Removed addLedgerEntry() to prevent duplicate/phantom entries

    saveToStorage();
    renderCustomers();
    renderTransactions(); // Update unified transactions view
    closeModal('customerTransferModal');
    updateDashboard();
    showNotification('Customer transfer recorded! üîÑ', 'success');
    e.target.reset();
}

// EXPENSE FUNCTIONS (UPDATED)
function toggleExpenseTypeField() {
    const type = document.getElementById('expenseType').value;
    const vehicleGroup = document.getElementById('expenseVehicleGroup');

    if (type === 'vehicle') {
        vehicleGroup.style.display = 'block';
    } else {
        vehicleGroup.style.display = 'none';
    }
}

function toggleExpenseSourceField() {
    const source = document.getElementById('expenseSource').value;
    const bankGroup = document.getElementById('expenseBankGroup');
    const customerGroup = document.getElementById('expenseCustomerGroup');

    bankGroup.style.display = 'none';
    customerGroup.style.display = 'none';

    if (source === 'bank') {
        bankGroup.style.display = 'block';
    } else if (source === 'customer') {
        customerGroup.style.display = 'block';
    }
}

function saveExpense(e) {
    e.preventDefault();

    const expenseType = document.getElementById('expenseType').value;
    const vehicleId = document.getElementById('expenseVehicleId').value;

    const expense = {
        id: document.getElementById('expenseId').value || 'exp_' + Date.now(),
        category: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        source: document.getElementById('expenseSource').value,
        bankId: document.getElementById('expenseBankId').value,
        customerId: document.getElementById('expenseCustomerId').value,
        method: document.getElementById('expenseMethod').value,
        date: document.getElementById('expenseDate').value,
        expenseType: expenseType,
        vehicleId: (expenseType === 'vehicle' ? vehicleId : ''),
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };

    const existingIndex = expenses.findIndex(e => e.id === expense.id);
    if (existingIndex >= 0) {
        expenses[existingIndex] = expense;
        showNotification('Expense updated! ‚úÖ', 'success');
    } else {
        expenses.push(expense);

        // Update balance based on source
        if (expense.source === 'bank' && expense.bankId) {
            const bank = banks.find(b => b.id === expense.bankId);
            if (bank) bank.balance -= expense.amount;
        } else if (expense.source === 'customer' && expense.customerId) {
            const customer = customers.find(c => c.id === expense.customerId);
            if (customer) {
                customer.balance -= expense.amount;

                // If customer covers vehicle expense, link it to vehicle
                if (expenseType === 'vehicle' && vehicleId) {
                    // This expense is tracked in vehicle ledger automatically
                }
            }
        }

        // Ledger entry
        const sourceAccount = expense.source === 'bank' ? 'Bank' :
                             expense.source === 'customer' ? 'Customer' : 'Cash';
        const expenseTypeLabel = expenseType === 'vehicle' ? 'üöó Vehicle' :
                                expenseType === 'owner' ? 'üë§ Owner' : 'üìã General';
        addLedgerEntry('expense', `${expenseTypeLabel} Expense: ${expense.category} - ${expense.description}`,
            expense.category, expense.amount, sourceAccount, expense.amount, expense.date);

        showNotification('Expense added! üí∏', 'success');
    }

    saveToStorage();
    renderExpenses();
    renderTransactions(); // Update unified transactions view
    renderBanks();
    renderCustomers();
    closeModal('expenseModal');
    updateDashboard();
    e.target.reset();
}

function renderExpenses() {
    const tbody = document.getElementById('expensesBody');
    tbody.innerHTML = '';
    
    expenses.slice().reverse().forEach(expense => {
        let paidFrom = '';
        if (expense.source === 'bank' && expense.bankId) {
            const bank = banks.find(b => b.id === expense.bankId);
            paidFrom = bank ? bank.name : 'Bank';
        } else if (expense.source === 'customer' && expense.customerId) {
            const customer = customers.find(c => c.id === expense.customerId);
            paidFrom = customer ? customer.name : 'Customer';
        } else {
            paidFrom = 'Cash';
        }
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(expense.date).toLocaleDateString()}</td>
            <td><span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${expense.category}</span></td>
            <td>${expense.description}</td>
            <td style="color: #f56565; font-weight: 700;">Rs. ${expense.amount.toFixed(2)}</td>
            <td>${paidFrom}</td>
            <td>${expense.method.toUpperCase()}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteExpense('${expense.id}')">Delete</button>
            </td>
        `;
    });
}

async function deleteExpense(id) {
    if (confirm('Are you sure?')) {
        expenses = expenses.filter(e => e.id !== id);
        await saveToStorage();
        renderExpenses();
        renderTransactions(); // Update unified transactions view
        updateDashboard();
        showNotification('Expense deleted!', 'success');
    }
}

// DELETE PAYMENT FUNCTION
function deletePayment(id) {
    if (!confirm('Are you sure you want to delete this payment? This will reverse all balance changes.')) {
        return;
    }
    
    const payment = payments.find(p => p.id === id);
    if (!payment) {
        showNotification('Payment not found!', 'error');
        return;
    }
    
    // Reverse the payment effect on balances
    if (payment.type === 'received') {
        // Payment received from customer - increase their balance back
        const customer = customers.find(c => c.id === payment.partyId);
        if (customer) {
            customer.balance += payment.amount;
        }
    } else if (payment.type === 'paid') {
        // Payment made to supplier - increase their balance back (we owe them more)
        const supplier = suppliers.find(s => s.id === payment.partyId);
        if (supplier) {
            supplier.balance += payment.amount;
        }
    }
    
    // Remove the payment
    payments = payments.filter(p => p.id !== id);
    
    saveToStorage();
    renderPayments();
    renderTransactions(); // Update unified transactions view
    renderCustomers();
    renderSuppliers();
    updateDashboard();
    showNotification('Payment deleted successfully! ‚úÖ', 'success');
}

// DELETE CUSTOMER TRANSFER FUNCTION
async function deleteCustomerTransfer(id) {
    if (!confirm('Are you sure you want to delete this transfer? This will reverse the balance changes.')) {
        return;
    }

    const transfer = customerTransfers.find(t => t.id === id);
    if (!transfer) {
        showNotification('Transfer not found!', 'error');
        return;
    }

    // Show deleting message
    showNotification('üîÑ Deleting transfer and syncing to cloud...', 'info');

    // Reverse the transfer
    const fromCustomer = customers.find(c => c.id === transfer.fromCustomerId);
    const toCustomer = customers.find(c => c.id === transfer.toCustomerId);

    if (fromCustomer) {
        fromCustomer.balance += transfer.amount; // Give back the amount they paid
    }
    if (toCustomer) {
        toCustomer.balance -= transfer.amount; // Take back the amount they received
    }

    // Remove the transfer
    customerTransfers = customerTransfers.filter(t => t.id !== id);

    // IMPORTANT: Also remove any related ledger entries to prevent phantom entries
    // Clean up ledger entries that might reference this transfer
    ledgerEntries = ledgerEntries.filter(entry => {
        // Remove ledger entries that reference these customers and match the transfer amount and date
        const isRelatedEntry = entry.type === 'customer_transfer' &&
                              entry.date === transfer.date &&
                              (entry.debitAmount === transfer.amount || entry.creditAmount === transfer.amount) &&
                              (entry.debitAccount?.includes(fromCustomer?.name) ||
                               entry.creditAccount?.includes(toCustomer?.name));
        return !isRelatedEntry;
    });

    // CRITICAL: Wait for cloud sync to complete before showing success
    await saveToStorage();

    renderCustomerTransfers();
    renderTransactions(); // Update unified transactions view
    renderCustomers();
    updateDashboard();
    showNotification('Transfer deleted successfully! ‚úÖ (Cloud synced)', 'success');
}

// RENDER CUSTOMER TRANSFERS FUNCTION
// Since customer transfers don't have a dedicated tab, this function ensures
// that any views displaying transfers are updated after changes
function renderCustomerTransfers() {
    // Customer transfers are displayed in:
    // 1. Unified Transactions tab (via renderTransactions)
    // 2. Customer ledgers (via viewCustomerLedger)
    // This function is called to maintain consistency after add/delete operations
    // No specific rendering needed as renderTransactions() handles display
}

// DELETE BANK TRANSACTION FUNCTION
function deleteBankTransaction(id) {
    if (!confirm('Are you sure you want to delete this bank transaction? This will reverse the balance change.')) {
        return;
    }
    
    const bankTrans = bankTransactions.find(t => t.id === id);
    if (!bankTrans) {
        showNotification('Bank transaction not found!', 'error');
        return;
    }
    
    // Reverse the bank balance
    const bank = banks.find(b => b.id === bankTrans.bankId);
    if (bank) {
        if (bankTrans.type === 'deposit') {
            bank.balance -= bankTrans.amount; // Remove the deposit
        } else if (bankTrans.type === 'withdrawal') {
            bank.balance += bankTrans.amount; // Add back the withdrawal
        }
    }
    
    // Remove the transaction
    bankTransactions = bankTransactions.filter(t => t.id !== id);
    
    saveToStorage();
    renderBankTransactions();
    renderTransactions(); // Update unified transactions view
    renderBanks();
    updateDashboard();
    showNotification('Bank transaction deleted successfully! ‚úÖ', 'success');
}


// OWNER ACCOUNTS FUNCTIONS
function saveOwnerAccount(e) {
    e.preventDefault();
    
    const accountId = document.getElementById('ownerAccountId').value || 'owner_' + Date.now();
    const existingIndex = ownerAccounts.findIndex(a => a.id === accountId);
    
    const account = {
        id: accountId,
        type: document.getElementById('ownerAccountType').value,
        name: document.getElementById('ownerAccountName').value,
        contact: document.getElementById('ownerAccountContact').value,
        cnic: document.getElementById('ownerAccountCnic').value,
        notes: document.getElementById('ownerAccountNotes').value,
        createdAt: existingIndex >= 0 ? ownerAccounts[existingIndex].createdAt : new Date().toISOString()
    };
    
    if (existingIndex >= 0) {
        // Editing - keep current balance
        account.balance = ownerAccounts[existingIndex].balance || 0;
        ownerAccounts[existingIndex] = account;
        showNotification('Owner account updated! ‚úÖ', 'success');
    } else {
        // New account - set opening balance
        const openingBalance = parseFloat(document.getElementById('ownerAccountOpeningBalance').value) || 0;
        account.balance = openingBalance;
        ownerAccounts.push(account);
        showNotification('Owner account added! ‚úÖ' + (openingBalance !== 0 ? ` (Balance: Rs. ${openingBalance.toFixed(2)})` : ''), 'success');
    }
    
    saveToStorage();
    renderOwnerAccounts();
    closeModal('ownerAccountModal');
    e.target.reset();
}

function renderOwnerAccounts() {
    const tbody = document.getElementById('ownerAccountsBody');
    tbody.innerHTML = '';
    
    if (ownerAccounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #a0aec0; padding: 30px;">No owner accounts yet. Click "Add Account" to create your first account.</td></tr>';
        return;
    }
    
    ownerAccounts.forEach(account => {
        const typeIcon = account.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
        const typeText = account.type === 'owner' ? 'Owner Capital' : 'Relative';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${typeIcon} ${account.name}</strong></td>
            <td><span style="background: ${account.type === 'owner' ? '#667eea' : '#48bb78'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${typeText}</span></td>
            <td>${account.contact || '-'}</td>
            <td class="${account.balance >= 0 ? 'balance-positive' : 'balance-negative'}">Rs. ${account.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-primary btn-sm" onclick="viewOwnerAccountLedger('${account.id}')" title="View ledger">Ledger</button>
                <button class="btn btn-success btn-sm" onclick="openOwnerTransactionModal('${account.id}')" title="Record transaction">Transaction</button>
                <button class="btn btn-info btn-sm" onclick='editOwnerAccount(${JSON.stringify(account).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteOwnerAccount('${account.id}')">Delete</button>
            </td>
        `;
    });
}

function editOwnerAccount(account) {
    // Set ID first to prevent clearing
    document.getElementById('ownerAccountId').value = account.id;
    
    // Open modal
    openModal('ownerAccountModal');
    
    // Fill fields
    document.getElementById('ownerAccountType').value = account.type;
    document.getElementById('ownerAccountName').value = account.name;
    document.getElementById('ownerAccountContact').value = account.contact || '';
    document.getElementById('ownerAccountCnic').value = account.cnic || '';
    document.getElementById('ownerAccountNotes').value = account.notes || '';
    
    // Show balance (disabled)
    const balanceField = document.getElementById('ownerAccountOpeningBalance');
    balanceField.value = account.balance.toFixed(2);
    balanceField.disabled = true;
    balanceField.style.backgroundColor = '#f7fafc';
    balanceField.title = 'Current balance (use transactions to change)';
}

function deleteOwnerAccount(id) {
    const account = ownerAccounts.find(a => a.id === id);
    if (!account) return;

    if (confirm(`Delete ${account.name}?\n\nThis will remove the account and all its transaction history.`)) {
        ownerAccounts = ownerAccounts.filter(a => a.id !== id);
        saveToStorage();
        renderOwnerAccounts();
        showNotification('Owner account deleted!', 'success');
    }
}

function viewOwnerAccountLedger(accountId) {
    const account = ownerAccounts.find(a => a.id === accountId);
    if (!account) {
        showNotification('Owner account not found!', 'error');
        return;
    }

    const typeIcon = account.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
    const typeText = account.type === 'owner' ? 'Owner Capital' : 'Relative';

    // Set title and info
    document.getElementById('ownerAccountLedgerTitle').textContent = `${typeIcon} ${account.name} - Ledger`;
    document.getElementById('ownerAccountLedgerInfo').innerHTML = `
        <div style="font-size: 0.95em;">
            <strong>Type:</strong> ${typeText}<br>
            <strong>Contact:</strong> ${account.contact || 'N/A'}<br>
            <strong>Current Balance:</strong> <span class="${account.balance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${account.balance.toFixed(2)}</span>
        </div>
    `;

    // Get JV entries for this owner account
    const jvEntries = jvVouchers.filter(jv =>
        (jv.debitType === 'owner' && jv.debitAccount === 'owner_' + accountId) ||
        (jv.creditType === 'owner' && jv.creditAccount === 'owner_' + accountId)
    ).map(jv => {
        const isDebit = jv.debitType === 'owner' && jv.debitAccount === 'owner_' + accountId;
        return {
            date: jv.date,
            description: `üìù JV: ${jv.description}`,
            type: 'jv',
            amount: isDebit ? jv.debitAmount : jv.creditAmount,
            isDebit: isDebit,
            source: 'jv',
            id: jv.id
        };
    });

    const allEntries = [...jvEntries]
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    // Calculate opening balance by working backward from current balance
    let openingBalance = account.balance;
    allEntries.forEach(entry => {
        if (entry.isDebit) {
            openingBalance -= entry.amount;
        } else {
            openingBalance += entry.amount;
        }
    });

    // Render ledger table
    const tbody = document.getElementById('ownerAccountLedgerBody');
    tbody.innerHTML = '';
    let runningBalance = openingBalance;

    // Opening balance row
    const openingRow = tbody.insertRow();
    openingRow.innerHTML = `
        <td colspan="3"><strong>Opening Balance</strong></td>
        <td>-</td>
        <td>-</td>
        <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
    `;

    // Transaction rows
    allEntries.forEach(entry => {
        const row = tbody.insertRow();

        if (entry.isDebit) {
            runningBalance += entry.amount;
        } else {
            runningBalance -= entry.amount;
        }

        const typeLabel = entry.type === 'jv' ? 'JV' : 'TRANSACTION';
        const typeBg = '#667eea';

        row.innerHTML = `
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.description}</td>
            <td><span class="badge" style="background: ${typeBg}">${typeLabel}</span></td>
            <td style="color: #48bb78; font-weight: 600;">${entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
            <td style="color: #f56565; font-weight: 600;">${!entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
            <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
        `;
    });

    // Closing balance row
    const closingRow = tbody.insertRow();
    closingRow.innerHTML = `
        <td colspan="3"><strong>Closing Balance</strong></td>
        <td>-</td>
        <td>-</td>
        <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
    `;

    window.currentOwnerAccountLedger = { accountId, account, allEntries, openingBalance };
    openModal('ownerAccountLedgerModal');
}

function printOwnerAccountLedger() {
    if (!window.currentOwnerAccountLedger) return;
    const { account, allEntries, openingBalance } = window.currentOwnerAccountLedger;

    const typeIcon = account.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
    const typeText = account.type === 'owner' ? 'Owner Capital' : 'Relative';

    let printContent = `
        <html>
        <head>
            <title>${account.name} - Owner Account Ledger</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { text-align: center; color: #2d3748; }
                .info { margin: 20px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                th { background: #667eea; color: white; }
                .total-row { font-weight: bold; background: #f7fafc; }
            </style>
        </head>
        <body>
            <h1>${typeIcon} ${account.name} - Owner Account Ledger</h1>
            <div class="info">
                <strong>Type:</strong> ${typeText}<br>
                <strong>Contact:</strong> ${account.contact || 'N/A'}<br>
                <strong>Current Balance:</strong> Rs. ${account.balance.toFixed(2)}<br>
                <strong>Statement Date:</strong> ${new Date().toLocaleDateString()}
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>Debit</th>
                        <th>Credit</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
    `;

    let runningBalance = openingBalance;
    printContent += `<tr class="total-row"><td colspan="3">Opening Balance</td><td>-</td><td>-</td><td>Rs. ${runningBalance.toFixed(2)}</td></tr>`;

    allEntries.forEach(entry => {
        if (entry.isDebit) {
            runningBalance += entry.amount;
        } else {
            runningBalance -= entry.amount;
        }
        const typeLabel = entry.type === 'jv' ? 'JV' : 'TRANSACTION';
        printContent += `
            <tr>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td>${entry.description}</td>
                <td>${typeLabel}</td>
                <td>${entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
                <td>${!entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
                <td>Rs. ${runningBalance.toFixed(2)}</td>
            </tr>
        `;
    });

    printContent += `<tr class="total-row"><td colspan="3">Closing Balance</td><td>-</td><td>-</td><td>Rs. ${runningBalance.toFixed(2)}</td></tr>`;
    printContent += `</tbody></table></body></html>`;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

function downloadOwnerAccountLedgerPDF() {
    showNotification('üí° Tip: Use Print > Save as PDF option!', 'info');
    printOwnerAccountLedger();
}

function openOwnerTransactionModal(accountId) {
    document.getElementById('ownerTransAccountId').value = accountId;
    
    // Populate accounts dropdown
    const select = document.getElementById('ownerTransAccountId');
    select.innerHTML = '<option value="">Select Account</option>';
    ownerAccounts.forEach(a => {
        const icon = a.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
        select.innerHTML += `<option value="${a.id}" ${a.id === accountId ? 'selected' : ''}>${icon} ${a.name} (Bal: Rs. ${a.balance.toFixed(2)})</option>`;
    });
    
    // Set today's date
    document.getElementById('ownerTransDate').value = new Date().toISOString().split('T')[0];
    
    openModal('ownerAccountTransModal');
}

function saveOwnerAccountTransaction(e) {
    e.preventDefault();
    
    const accountId = document.getElementById('ownerTransAccountId').value;
    const account = ownerAccounts.find(a => a.id === accountId);
    
    if (!account) {
        showNotification('Account not found!', 'error');
        return;
    }
    
    const transType = document.getElementById('ownerTransType').value;
    const amount = parseFloat(document.getElementById('ownerTransAmount').value);
    const method = document.getElementById('ownerTransMethod').value;
    const date = document.getElementById('ownerTransDate').value;
    const description = document.getElementById('ownerTransDescription').value;
    
    // Create transaction record
    const transaction = {
        id: 'ownertrans_' + Date.now(),
        accountId: accountId,
        accountName: account.name,
        type: transType,
        amount: amount,
        method: method,
        date: date,
        description: description,
        balanceBefore: account.balance,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    // Update account balance
    if (transType === 'deposit') {
        // They gave money to business - balance increases (business owes them more)
        account.balance += amount;
    } else {
        // Business paid them - balance decreases (business owes them less)
        account.balance -= amount;
    }
    
    transaction.balanceAfter = account.balance;
    
    // Add to transactions array
    if (!transactions) transactions = [];
    transactions.push({
        id: transaction.id,
        type: 'owner_account',
        ownerAccountId: accountId,
        ownerAccountName: account.name,
        ownerAccountType: account.type,
        transactionType: transType,
        amount: amount,
        description: description,
        date: date,
        method: method,
        balanceBefore: transaction.balanceBefore,
        balanceAfter: transaction.balanceAfter,
        createdBy: currentUser,
        createdAt: transaction.createdAt
    });
    
    saveToStorage();
    renderOwnerAccounts();
    renderTransactions();
    closeModal('ownerAccountTransModal');
    
    showNotification(`‚úÖ Transaction recorded! ${account.name} balance: Rs. ${account.balance.toFixed(2)}`, 'success');
    e.target.reset();
}

// JV VOUCHERS FUNCTIONS
function renderJVVouchers() {
    const tbody = document.getElementById('jvVouchersBody');
    tbody.innerHTML = '';
    
    if (jvVouchers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #a0aec0; padding: 30px;">No JV entries yet. Click "Add JV Voucher" to create your first entry.</td></tr>';
        return;
    }
    
    // Show newest first
    jvVouchers.slice().reverse().forEach(jv => {
        // Get account names
        let debitAccountName = jv.debitAccount;
        let creditAccountName = jv.creditAccount;
        
        // Format account names nicely
        if (jv.debitType === 'customer') {
            const custId = jv.debitAccount.replace('customer_', '');
            const cust = customers.find(c => c.id === custId);
            debitAccountName = cust ? `üë§ ${cust.name}` : 'Customer';
        } else if (jv.debitType === 'supplier') {
            const suppId = jv.debitAccount.replace('supplier_', '');
            const supp = suppliers.find(s => s.id === suppId);
            debitAccountName = supp ? `üè≠ ${supp.name}` : 'Supplier';
        } else if (jv.debitType === 'bank') {
            const bankId = jv.debitAccount.replace('bank_', '');
            const bank = banks.find(b => b.id === bankId);
            debitAccountName = bank ? `üè¶ ${bank.name}` : 'Bank';
        } else if (jv.debitType === 'expense') {
            debitAccountName = `üí∏ ${jv.debitAccount}`;
        } else {
            debitAccountName = jv.debitAccount;
        }
        
        if (jv.creditType === 'customer') {
            const custId = jv.creditAccount.replace('customer_', '');
            const cust = customers.find(c => c.id === custId);
            creditAccountName = cust ? `üë§ ${cust.name}` : 'Customer';
        } else if (jv.creditType === 'supplier') {
            const suppId = jv.creditAccount.replace('supplier_', '');
            const supp = suppliers.find(s => s.id === suppId);
            creditAccountName = supp ? `üè≠ ${supp.name}` : 'Supplier';
        } else if (jv.creditType === 'bank') {
            const bankId = jv.creditAccount.replace('bank_', '');
            const bank = banks.find(b => b.id === bankId);
            creditAccountName = bank ? `üè¶ ${bank.name}` : 'Bank';
        } else if (jv.creditType === 'expense') {
            creditAccountName = `üí∏ ${jv.creditAccount}`;
        } else {
            creditAccountName = jv.creditAccount;
        }
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(jv.date).toLocaleDateString()}</td>
            <td><strong>${jv.description}</strong></td>
            <td>
                <div style="padding: 4px 8px; background: #fed7d7; color: #c53030; border-radius: 4px; display: inline-block; font-size: 0.85em;">
                    <strong>DR:</strong> ${debitAccountName}
                </div>
            </td>
            <td>
                <div style="padding: 4px 8px; background: #c6f6d5; color: #22543d; border-radius: 4px; display: inline-block; font-size: 0.85em;">
                    <strong>CR:</strong> ${creditAccountName}
                </div>
            </td>
            <td style="font-weight: 700; color: #667eea;">Rs. ${jv.debitAmount.toFixed(2)}</td>
            <td><span style="background: #e2e8f0; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">${jv.createdBy || 'System'}</span></td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteJVVoucher('${jv.id}')" title="Delete this JV entry">Delete</button>
            </td>
        `;
    });
}

function deleteJVVoucher(id) {
    const jv = jvVouchers.find(j => j.id === id);
    if (!jv) {
        showNotification('JV not found!', 'error');
        return;
    }

    const confirmMsg = `‚ö†Ô∏è Delete this JV entry?\n\n` +
                      `Date: ${new Date(jv.date).toLocaleDateString()}\n` +
                      `Description: ${jv.description}\n` +
                      `Amount: Rs. ${jv.debitAmount.toFixed(2)}\n\n` +
                      `This will reverse the accounting effect.`;

    if (confirm(confirmMsg)) {
        // FIXED: Directly reverse balances without creating new transaction entries

        // Reverse debit side (opposite of what was done)
        if (jv.debitType === 'customer') {
            const custId = jv.debitAccount.replace('customer_', '');
            const cust = customers.find(c => c.id === custId);
            if (cust) cust.balance -= jv.debitAmount; // Reverse the debit
        } else if (jv.debitType === 'supplier') {
            const suppId = jv.debitAccount.replace('supplier_', '');
            const supp = suppliers.find(s => s.id === suppId);
            if (supp) supp.balance += jv.debitAmount; // Reverse the debit
        } else if (jv.debitType === 'bank') {
            const bankId = jv.debitAccount.replace('bank_', '');
            const bank = banks.find(b => b.id === bankId);
            if (bank) bank.balance -= jv.debitAmount; // Reverse the debit
        } else if (jv.debitType === 'vehicle') {
            const vehId = jv.debitAccount.replace('vehicle_', '');
            const veh = vehicles.find(v => v.id === vehId);
            if (veh) veh.ownerBalance += jv.debitAmount; // Reverse the debit
        }

        // Reverse credit side (opposite of what was done)
        if (jv.creditType === 'customer') {
            const custId = jv.creditAccount.replace('customer_', '');
            const cust = customers.find(c => c.id === custId);
            if (cust) cust.balance += jv.creditAmount; // Reverse the credit
        } else if (jv.creditType === 'supplier') {
            const suppId = jv.creditAccount.replace('supplier_', '');
            const supp = suppliers.find(s => s.id === suppId);
            if (supp) supp.balance -= jv.creditAmount; // Reverse the credit
        } else if (jv.creditType === 'bank') {
            const bankId = jv.creditAccount.replace('bank_', '');
            const bank = banks.find(b => b.id === bankId);
            if (bank) bank.balance += jv.creditAmount; // Reverse the credit
        } else if (jv.creditType === 'vehicle') {
            const vehId = jv.creditAccount.replace('vehicle_', '');
            const veh = vehicles.find(v => v.id === vehId);
            if (veh) veh.ownerBalance -= jv.creditAmount; // Reverse the credit
        }

        // Remove the JV from list
        jvVouchers = jvVouchers.filter(j => j.id !== id);

        saveToStorage();
        renderJVVouchers();
        renderTransactions(); // Update unified transactions view
        renderCustomers();
        renderSuppliers();
        renderBanks();
        updateDashboard();
        showNotification('JV entry deleted successfully! ‚úÖ', 'success');
    }
}

// BANK FUNCTIONS
function saveBank(e) {
    e.preventDefault();
    
    const bank = {
        id: document.getElementById('bankId').value || 'bank_' + Date.now(),
        name: document.getElementById('bankName').value,
        accountNumber: document.getElementById('bankAccount').value,
        balance: parseFloat(document.getElementById('bankBalance').value),
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = banks.findIndex(b => b.id === bank.id);
    if (existingIndex >= 0) {
        banks[existingIndex] = bank;
        showNotification('Bank updated! ‚úÖ', 'success');
    } else {
        banks.push(bank);
        showNotification('Bank added! ‚úÖ', 'success');
    }
    
    saveToStorage();
    renderBanks();
    closeModal('bankModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderBanks() {
    const tbody = document.getElementById('banksBody');
    tbody.innerHTML = '';

    banks.forEach(bank => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${bank.name}</strong></td>
            <td>${bank.accountNumber}</td>
            <td class="${bank.balance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${bank.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-success btn-sm" onclick="viewBankLedger('${bank.id}')">üìä View Ledger</button>
                <button class="btn btn-info btn-sm" onclick='editBank(${JSON.stringify(bank).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteBank('${bank.id}')">Delete</button>
            </td>
        `;
    });
}

function editBank(bank) {
    document.getElementById('bankId').value = bank.id;
    document.getElementById('bankName').value = bank.name;
    document.getElementById('bankAccount').value = bank.accountNumber;
    document.getElementById('bankBalance').value = bank.balance;
    openModal('bankModal');
}

function deleteBank(id) {
    if (confirm('Are you sure?')) {
        banks = banks.filter(b => b.id !== id);
        saveToStorage();
        renderBanks();
        updateDashboard();
        populateDropdowns();
        showNotification('Bank deleted!', 'success');
    }
}

// BANK LEDGER FUNCTIONS
function viewBankLedger(bankId) {
    const bank = banks.find(b => b.id === bankId);
    if (!bank) {
        showNotification('Bank not found!', 'error');
        return;
    }

    // Set title and info
    document.getElementById('bankLedgerTitle').textContent = `${bank.name} - Ledger Statement`;
    document.getElementById('bankLedgerInfo').innerHTML = `
        <div style="font-size: 0.95em;">
            <strong>Account Number:</strong> ${bank.accountNumber}<br>
            <strong>Current Balance:</strong> <span class="${bank.balance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${bank.balance.toFixed(2)}</span>
        </div>
    `;

    // Get all transactions for this bank
    const bankTrans = bankTransactions
        .filter(t => t.bankId === bankId)
        .sort((a, b) => new Date(a.date) - new Date(b.date)); // Oldest first for running balance

    // Also get JV entries that affect this bank from jvVouchers
    const jvEntries = jvVouchers.filter(jv =>
        (jv.debitType === 'bank' && jv.debitAccount === 'bank_' + bankId) ||
        (jv.creditType === 'bank' && jv.creditAccount === 'bank_' + bankId)
    ).map(jv => {
        const isDebit = jv.debitType === 'bank' && jv.debitAccount === 'bank_' + bankId;
        return {
            date: jv.date,
            description: `üìù JV: ${jv.description}`,
            type: isDebit ? 'deposit' : 'withdrawal',
            amount: isDebit ? jv.debitAmount : jv.creditAmount,
            source: 'jv',
            id: jv.id
        };
    });

    // Combine and sort all entries
    const allEntries = [...bankTrans, ...jvEntries].sort((a, b) => new Date(a.date) - new Date(b.date));

    // Calculate opening balance (work backwards from current balance)
    let openingBalance = bank.balance;
    allEntries.forEach(entry => {
        if (entry.type === 'deposit') {
            openingBalance -= entry.amount;
        } else {
            openingBalance += entry.amount;
        }
    });

    // Render ledger table
    const tbody = document.getElementById('bankLedgerBody');
    tbody.innerHTML = '';

    let runningBalance = openingBalance;

    // Opening balance row
    const openingRow = tbody.insertRow();
    openingRow.innerHTML = `
        <td colspan="3"><strong>Opening Balance</strong></td>
        <td>-</td>
        <td>-</td>
        <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
    `;

    // Transaction rows
    allEntries.forEach(entry => {
        const row = tbody.insertRow();
        const isDebit = entry.type === 'deposit';

        if (isDebit) {
            runningBalance += entry.amount;
        } else {
            runningBalance -= entry.amount;
        }

        row.innerHTML = `
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.description || '-'}</td>
            <td><span class="badge" style="background: ${isDebit ? '#48bb78' : '#f56565'}">${isDebit ? 'DEPOSIT' : 'WITHDRAWAL'}</span></td>
            <td style="color: #48bb78; font-weight: 600;">${isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
            <td style="color: #f56565; font-weight: 600;">${!isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
            <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
        `;
    });

    // Closing balance row
    const closingRow = tbody.insertRow();
    closingRow.innerHTML = `
        <td colspan="3"><strong>Closing Balance</strong></td>
        <td>-</td>
        <td>-</td>
        <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
    `;

    // Store bank ID for print/PDF functions
    window.currentBankLedger = { bankId, bank, allEntries, openingBalance };

    openModal('bankLedgerModal');
}

function printBankLedger() {
    if (!window.currentBankLedger) return;

    const { bank, allEntries, openingBalance } = window.currentBankLedger;

    let printContent = `
        <html>
        <head>
            <title>${bank.name} - Bank Statement</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { text-align: center; color: #2d3748; }
                .info { margin: 20px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                th { background: #667eea; color: white; }
                .balance-positive { color: #48bb78; }
                .balance-negative { color: #f56565; }
                .total-row { font-weight: bold; background: #f7fafc; }
            </style>
        </head>
        <body>
            <h1>${bank.name} - Bank Statement</h1>
            <div class="info">
                <strong>Account Number:</strong> ${bank.accountNumber}<br>
                <strong>Current Balance:</strong> Rs. ${bank.balance.toFixed(2)}<br>
                <strong>Statement Date:</strong> ${new Date().toLocaleDateString()}
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>Debit</th>
                        <th>Credit</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
    `;

    let runningBalance = openingBalance;
    printContent += `
        <tr class="total-row">
            <td colspan="3">Opening Balance</td>
            <td>-</td>
            <td>-</td>
            <td>Rs. ${runningBalance.toFixed(2)}</td>
        </tr>
    `;

    allEntries.forEach(entry => {
        const isDebit = entry.type === 'deposit';
        if (isDebit) {
            runningBalance += entry.amount;
        } else {
            runningBalance -= entry.amount;
        }

        printContent += `
            <tr>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td>${entry.description || '-'}</td>
                <td>${isDebit ? 'DEPOSIT' : 'WITHDRAWAL'}</td>
                <td>${isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
                <td>${!isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
                <td>Rs. ${runningBalance.toFixed(2)}</td>
            </tr>
        `;
    });

    printContent += `
        <tr class="total-row">
            <td colspan="3">Closing Balance</td>
            <td>-</td>
            <td>-</td>
            <td>Rs. ${runningBalance.toFixed(2)}</td>
        </tr>
    `;

    printContent += `
                </tbody>
            </table>
        </body>
        </html>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

function downloadBankLedgerPDF() {
    showNotification('üí° Tip: Use your browser Print > Save as PDF option from the print dialog!', 'info');
    printBankLedger();
}

// CUSTOMER LEDGER FUNCTIONS
function viewCustomerLedger(customerId) {
    const customer = customers.find(c => c.id === customerId);
    if (!customer) {
        showNotification('Customer not found!', 'error');
        return;
    }

    // Set title and info
    document.getElementById('customerLedgerTitle').textContent = `${customer.name} - Customer Ledger`;
    document.getElementById('customerLedgerInfo').innerHTML = `
        <div style="font-size: 0.95em;">
            <strong>Contact:</strong> ${customer.contact || 'N/A'}<br>
            <strong>Current Balance:</strong> <span class="${customer.balance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${customer.balance.toFixed(2)}</span>
        </div>
    `;

    // Get all transactions for this customer (sales and purchases)
    const custTrans = transactions
        .filter(t => t.partyId === customerId || t.customerId === customerId)
        .map(t => ({
            date: t.date,
            description: `${t.description || (t.type === 'sale' ? 'Sale' : 'Transaction')} - ${t.fuelType} (${t.quantity} L @ Rs.${t.rate})`,
            type: t.type === 'sale' ? 'sale' : (t.type === 'purchase' ? 'purchase' : 'jv'),
            amount: Math.abs(t.amount),
            pmgQty: (t.fuelType === 'PMG' || t.fuelType === 'Petrol') ? (t.quantity || 0) : 0,
            hsdQty: (t.fuelType === 'HSD' || t.fuelType === 'Diesel') ? (t.quantity || 0) : 0,
            isDebit: (t.type === 'payment' || t.amount < 0), // Payment or negative amount = debit (reduces customer balance)
            source: t.source || 'transaction',
            id: t.id
        }));

    // Get payments by this customer (using both customerId and partyId)
    const custPayments = payments
        .filter(p => (p.customerId === customerId || (p.partyId === customerId && p.type === 'received')))
        .map(p => ({
            date: p.date,
            description: `Payment Received - ${p.method || p.paymentMethod}`,
            type: 'payment',
            amount: p.amount,
            pmgQty: 0,
            hsdQty: 0,
            isDebit: true, // Payment reduces customer balance
            source: 'payment',
            id: p.id
        }));

    // Get customer transfers (from and to)
    const custTransfers = customerTransfers.filter(ct =>
        ct.fromCustomerId === customerId || ct.toCustomerId === customerId
    ).map(ct => {
        const isFrom = ct.fromCustomerId === customerId;
        return {
            date: ct.date,
            description: isFrom ? `Transfer TO: ${ct.toCustomerName}` : `Transfer FROM: ${ct.fromCustomerName}`,
            type: 'transfer',
            amount: ct.amount,
            pmgQty: 0,
            hsdQty: 0,
            isDebit: isFrom, // If paying for someone, it's debit
            source: 'transfer',
            id: ct.id
        };
    });

    // Get JV entries
    const jvEntries = jvVouchers.filter(jv =>
        (jv.debitType === 'customer' && jv.debitAccount === 'customer_' + customerId) ||
        (jv.creditType === 'customer' && jv.creditAccount === 'customer_' + customerId)
    ).map(jv => {
        const isDebit = jv.debitType === 'customer' && jv.debitAccount === 'customer_' + customerId;
        return {
            date: jv.date,
            description: `üìù JV: ${jv.description}`,
            type: 'jv',
            amount: isDebit ? jv.debitAmount : jv.creditAmount,
            pmgQty: 0,
            hsdQty: 0,
            isDebit: isDebit,
            source: 'jv',
            id: jv.id
        };
    });

    // Get customer expenses (when customer covers expenses)
    const custExpenses = expenses.filter(e => e.customerId === customerId && e.source === 'customer')
        .map(e => ({
            date: e.date,
            description: `üí∏ Expense: ${e.category} - ${e.description}`,
            type: 'expense',
            amount: e.amount,
            pmgQty: 0,
            hsdQty: 0,
            isDebit: true, // Expense reduces customer balance
            source: 'expense',
            id: e.id
        }));

    // Combine and sort all entries
    const allEntries = [...custTrans, ...custPayments, ...custTransfers, ...jvEntries, ...custExpenses]
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    // Calculate opening balance
    let openingBalance = customer.balance;
    allEntries.forEach(entry => {
        if (entry.isDebit) {
            openingBalance -= entry.amount;
        } else {
            openingBalance += entry.amount;
        }
    });

    // Render ledger table
    const tbody = document.getElementById('customerLedgerBody');
    tbody.innerHTML = '';
    let runningBalance = openingBalance;

    // Opening balance row
    const openingRow = tbody.insertRow();
    openingRow.innerHTML = `
        <td colspan="3"><strong>Opening Balance</strong></td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
    `;

    // Transaction rows
    allEntries.forEach(entry => {
        const row = tbody.insertRow();

        if (entry.isDebit) {
            runningBalance -= entry.amount;
        } else {
            runningBalance += entry.amount;
        }

        const typeLabel = entry.type === 'sale' ? 'SALE' :
                         entry.type === 'payment' ? 'PAYMENT' :
                         entry.type === 'transfer' ? 'TRANSFER' :
                         entry.type === 'expense' ? 'EXPENSE' : 'JV';
        const typeBg = entry.type === 'sale' ? '#805ad5' :
                      entry.type === 'payment' ? '#48bb78' :
                      entry.type === 'transfer' ? '#ed8936' :
                      entry.type === 'expense' ? '#f56565' : '#667eea';

        row.innerHTML = `
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.description}</td>
            <td><span class="badge" style="background: ${typeBg}">${typeLabel}</span></td>
            <td style="color: #667eea; font-weight: 600;">${entry.pmgQty > 0 ? entry.pmgQty.toFixed(2) : '-'}</td>
            <td style="color: #f59e0b; font-weight: 600;">${entry.hsdQty > 0 ? entry.hsdQty.toFixed(2) : '-'}</td>
            <td style="color: #f56565; font-weight: 600;">${!entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
            <td style="color: #48bb78; font-weight: 600;">${entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
            <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
        `;
    });

    // Calculate totals for PMG and HSD
    let totalPMG = 0;
    let totalHSD = 0;
    allEntries.forEach(entry => {
        totalPMG += entry.pmgQty;
        totalHSD += entry.hsdQty;
    });

    // Add summary row for totals
    const summaryRow = tbody.insertRow();
    summaryRow.style.background = 'var(--bg-secondary)';
    summaryRow.style.fontWeight = 'bold';
    summaryRow.innerHTML = `
        <td colspan="3"><strong>üìä Total Supplied</strong></td>
        <td style="color: #667eea; font-weight: 700;">${totalPMG > 0 ? totalPMG.toFixed(2) + ' L' : '-'}</td>
        <td style="color: #f59e0b; font-weight: 700;">${totalHSD > 0 ? totalHSD.toFixed(2) + ' L' : '-'}</td>
        <td colspan="3">-</td>
    `;

    // Closing balance row
    const closingRow = tbody.insertRow();
    closingRow.innerHTML = `
        <td colspan="3"><strong>Closing Balance</strong></td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
    `;

    window.currentCustomerLedger = { customerId, customer, allEntries, openingBalance };
    openModal('customerLedgerModal');
}

function printCustomerLedger() {
    if (!window.currentCustomerLedger) return;
    const { customer, allEntries, openingBalance } = window.currentCustomerLedger;

    let printContent = `
        <html>
        <head>
            <title>${customer.name} - Customer Ledger</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { text-align: center; color: #2d3748; }
                .info { margin: 20px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                th { background: #667eea; color: white; }
                .total-row { font-weight: bold; background: #f7fafc; }
            </style>
        </head>
        <body>
            <h1>${customer.name} - Customer Ledger</h1>
            <div class="info">
                <strong>Contact:</strong> ${customer.contact || 'N/A'}<br>
                <strong>Current Balance:</strong> Rs. ${customer.balance.toFixed(2)}<br>
                <strong>Statement Date:</strong> ${new Date().toLocaleDateString()}
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>PMG (L)</th>
                        <th>HSD (L)</th>
                        <th>Debit</th>
                        <th>Credit</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
    `;

    let runningBalance = openingBalance;
    let totalPMG = 0;
    let totalHSD = 0;

    printContent += `<tr class="total-row"><td colspan="5">Opening Balance</td><td>-</td><td>-</td><td>Rs. ${runningBalance.toFixed(2)}</td></tr>`;

    allEntries.forEach(entry => {
        if (entry.isDebit) {
            runningBalance -= entry.amount;
        } else {
            runningBalance += entry.amount;
        }
        totalPMG += entry.pmgQty;
        totalHSD += entry.hsdQty;
        const typeLabel = entry.type === 'sale' ? 'SALE' : entry.type === 'payment' ? 'PAYMENT' : entry.type === 'transfer' ? 'TRANSFER' : entry.type === 'expense' ? 'EXPENSE' : 'JV';
        printContent += `
            <tr>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td>${entry.description}</td>
                <td>${typeLabel}</td>
                <td>${entry.pmgQty > 0 ? entry.pmgQty.toFixed(2) : '-'}</td>
                <td>${entry.hsdQty > 0 ? entry.hsdQty.toFixed(2) : '-'}</td>
                <td>${!entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
                <td>${entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
                <td>Rs. ${runningBalance.toFixed(2)}</td>
            </tr>
        `;
    });

    printContent += `<tr class="total-row"><td colspan="3"><strong>Total Supplied</strong></td><td style="color: #667eea; font-weight: bold;">${totalPMG > 0 ? totalPMG.toFixed(2) + ' L' : '-'}</td><td style="color: #f59e0b; font-weight: bold;">${totalHSD > 0 ? totalHSD.toFixed(2) + ' L' : '-'}</td><td colspan="3">-</td></tr>`;
    printContent += `<tr class="total-row"><td colspan="5">Closing Balance</td><td>-</td><td>-</td><td>Rs. ${runningBalance.toFixed(2)}</td></tr>`;
    printContent += `</tbody></table></body></html>`;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

function downloadCustomerLedgerPDF() {
    showNotification('üí° Tip: Use Print > Save as PDF option!', 'info');
    printCustomerLedger();
}

// SUPPLIER LEDGER FUNCTIONS
function viewSupplierLedger(supplierId) {
    const supplier = suppliers.find(s => s.id === supplierId);
    if (!supplier) {
        showNotification('Supplier not found!', 'error');
        return;
    }

    document.getElementById('supplierLedgerTitle').textContent = `${supplier.name} - Supplier Ledger`;
    document.getElementById('supplierLedgerInfo').innerHTML = `
        <div style="font-size: 0.95em;">
            <strong>Contact:</strong> ${supplier.contact || 'N/A'}<br>
            <strong>Current Balance:</strong> <span class="${supplier.balance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${supplier.balance.toFixed(2)}</span>
        </div>
    `;

    // Get all transactions for this supplier (purchases)
    const suppTrans = transactions
        .filter(t => (t.supplierId === supplierId || t.partyId === supplierId) && t.type === 'purchase')
        .map(t => ({
            date: t.date,
            description: `Purchase - ${t.fuelType} (${t.quantity} L @ Rs.${t.rate})`,
            type: 'purchase',
            amount: Math.abs(t.amount),
            pmgQty: (t.fuelType === 'PMG' || t.fuelType === 'Petrol') ? (t.quantity || 0) : 0,
            hsdQty: (t.fuelType === 'HSD' || t.fuelType === 'Diesel') ? (t.quantity || 0) : 0,
            isDebit: false, // Purchase increases our liability (we owe supplier)
            source: 'transaction',
            id: t.id
        }));

    // Get payments to this supplier
    const suppPayments = payments
        .filter(p => p.partyId === supplierId && p.type === 'paid')
        .map(p => ({
            date: p.date,
            description: `Payment Made - ${p.method || p.paymentMethod} ${p.notes ? '(' + p.notes + ')' : ''}`,
            type: 'payment',
            amount: p.amount,
            pmgQty: 0,
            hsdQty: 0,
            isDebit: true, // Payment reduces our liability (debit reduces balance)
            source: 'payment',
            id: p.id
        }));

    // Get JV entries
    const jvEntries = jvVouchers.filter(jv =>
        (jv.debitType === 'supplier' && jv.debitAccount === 'supplier_' + supplierId) ||
        (jv.creditType === 'supplier' && jv.creditAccount === 'supplier_' + supplierId)
    ).map(jv => {
        const isDebit = jv.debitType === 'supplier' && jv.debitAccount === 'supplier_' + supplierId;
        return {
            date: jv.date,
            description: `üìù JV: ${jv.description}`,
            type: 'jv',
            amount: isDebit ? jv.debitAmount : jv.creditAmount,
            pmgQty: 0,
            hsdQty: 0,
            isDebit: isDebit,
            source: 'jv',
            id: jv.id
        };
    });

    const allEntries = [...suppTrans, ...suppPayments, ...jvEntries]
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    // Calculate opening balance by working backward from current balance
    let openingBalance = supplier.balance;
    allEntries.forEach(entry => {
        if (entry.isDebit) {
            openingBalance -= entry.amount;
        } else {
            openingBalance += entry.amount;
        }
    });

    const tbody = document.getElementById('supplierLedgerBody');
    tbody.innerHTML = '';
    let runningBalance = openingBalance;

    const openingRow = tbody.insertRow();
    openingRow.innerHTML = `
        <td colspan="3"><strong>Opening Balance</strong></td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
    `;

    allEntries.forEach(entry => {
        const row = tbody.insertRow();

        // Update running balance
        if (entry.isDebit) {
            runningBalance -= entry.amount;
        } else {
            runningBalance += entry.amount;
        }

        const typeLabel = entry.type === 'purchase' ? 'PURCHASE' :
                         entry.type === 'payment' ? 'PAYMENT' : 'JV';
        const typeBg = entry.type === 'purchase' ? '#ed8936' :
                      entry.type === 'payment' ? '#48bb78' : '#667eea';

        row.innerHTML = `
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.description}</td>
            <td><span class="badge" style="background: ${typeBg}">${typeLabel}</span></td>
            <td style="color: #667eea; font-weight: 600;">${entry.pmgQty > 0 ? entry.pmgQty.toFixed(2) : '-'}</td>
            <td style="color: #f59e0b; font-weight: 600;">${entry.hsdQty > 0 ? entry.hsdQty.toFixed(2) : '-'}</td>
            <td style="color: #f56565; font-weight: 600;">${!entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
            <td style="color: #48bb78; font-weight: 600;">${entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
            <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
        `;
    });

    // Calculate totals for PMG and HSD
    let totalPMG = 0;
    let totalHSD = 0;
    allEntries.forEach(entry => {
        totalPMG += entry.pmgQty;
        totalHSD += entry.hsdQty;
    });

    // Add summary row for totals
    const summaryRow = tbody.insertRow();
    summaryRow.style.background = 'var(--bg-secondary)';
    summaryRow.style.fontWeight = 'bold';
    summaryRow.innerHTML = `
        <td colspan="3"><strong>üìä Total Purchased</strong></td>
        <td style="color: #667eea; font-weight: 700;">${totalPMG > 0 ? totalPMG.toFixed(2) + ' L' : '-'}</td>
        <td style="color: #f59e0b; font-weight: 700;">${totalHSD > 0 ? totalHSD.toFixed(2) + ' L' : '-'}</td>
        <td colspan="3">-</td>
    `;

    const closingRow = tbody.insertRow();
    closingRow.innerHTML = `
        <td colspan="3"><strong>Closing Balance</strong></td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
    `;

    window.currentSupplierLedger = { supplierId, supplier, allEntries, openingBalance };
    openModal('supplierLedgerModal');
}

function printSupplierLedger() {
    if (!window.currentSupplierLedger) return;
    const { supplier, allEntries, openingBalance } = window.currentSupplierLedger;

    let printContent = `
        <html>
        <head>
            <title>${supplier.name} - Supplier Ledger</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { text-align: center; color: #2d3748; }
                .info { margin: 20px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                th { background: #667eea; color: white; }
                .total-row { font-weight: bold; background: #f7fafc; }
            </style>
        </head>
        <body>
            <h1>${supplier.name} - Supplier Ledger</h1>
            <div class="info">
                <strong>Contact:</strong> ${supplier.contact || 'N/A'}<br>
                <strong>Current Balance:</strong> Rs. ${supplier.balance.toFixed(2)}<br>
                <strong>Statement Date:</strong> ${new Date().toLocaleDateString()}
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>PMG (L)</th>
                        <th>HSD (L)</th>
                        <th>Debit</th>
                        <th>Credit</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
    `;

    let runningBalance = openingBalance;
    let totalPMG = 0;
    let totalHSD = 0;

    printContent += `<tr class="total-row"><td colspan="5">Opening Balance</td><td>-</td><td>-</td><td>Rs. ${runningBalance.toFixed(2)}</td></tr>`;

    allEntries.forEach(entry => {
        if (entry.isDebit) {
            runningBalance -= entry.amount;
        } else {
            runningBalance += entry.amount;
        }
        totalPMG += entry.pmgQty;
        totalHSD += entry.hsdQty;
        const typeLabel = entry.type === 'purchase' ? 'PURCHASE' : entry.type === 'payment' ? 'PAYMENT' : 'JV';
        printContent += `
            <tr>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td>${entry.description}</td>
                <td>${typeLabel}</td>
                <td>${entry.pmgQty > 0 ? entry.pmgQty.toFixed(2) : '-'}</td>
                <td>${entry.hsdQty > 0 ? entry.hsdQty.toFixed(2) : '-'}</td>
                <td>${entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
                <td>${!entry.isDebit ? 'Rs. ' + entry.amount.toFixed(2) : '-'}</td>
                <td>Rs. ${runningBalance.toFixed(2)}</td>
            </tr>
        `;
    });

    printContent += `<tr class="total-row"><td colspan="3"><strong>Total Purchased</strong></td><td style="color: #667eea; font-weight: bold;">${totalPMG > 0 ? totalPMG.toFixed(2) + ' L' : '-'}</td><td style="color: #f59e0b; font-weight: bold;">${totalHSD > 0 ? totalHSD.toFixed(2) + ' L' : '-'}</td><td colspan="3">-</td></tr>`;
    printContent += `<tr class="total-row"><td colspan="5">Closing Balance</td><td>-</td><td>-</td><td>Rs. ${runningBalance.toFixed(2)}</td></tr>`;
    printContent += `</tbody></table></body></html>`;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

function downloadSupplierLedgerPDF() {
    showNotification('üí° Tip: Use Print > Save as PDF option!', 'info');
    printSupplierLedger();
}

// BANK TRANSACTION FUNCTIONS
function saveBankTransaction(e) {
    e.preventDefault();
    
    const bankId = document.getElementById('bankTransBankId').value;
    const type = document.getElementById('bankTransType').value;
    const amount = parseFloat(document.getElementById('bankTransAmount').value);
    const description = document.getElementById('bankTransDescription').value;
    const date = document.getElementById('bankTransDate').value;
    
    const bank = banks.find(b => b.id === bankId);
    
    if (type === 'deposit') {
        bank.balance += amount;
    } else {
        bank.balance -= amount;
    }
    
    const transaction = {
        id: 'banktrans_' + Date.now(),
        bankId: bankId,
        bankName: bank.name,
        type: type,
        amount: amount,
        description: description,
        date: date,
        balanceAfter: bank.balance,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    bankTransactions.push(transaction);
    
    // Ledger entry
    if (type === 'deposit') {
        addLedgerEntry('bank_deposit', description || 'Bank Deposit', 
            'Bank', amount, 'Cash/Revenue', amount, date);
    } else {
        addLedgerEntry('bank_withdrawal', description || 'Bank Withdrawal', 
            'Cash/Expense', amount, 'Bank', amount, date);
    }
    
    saveToStorage();
    renderBankTransactions();
    renderTransactions(); // Update unified transactions view
    renderBanks();
    closeModal('bankTransModal');
    updateDashboard();
    showNotification('Bank transaction recorded! üè¶', 'success');
    e.target.reset();
}

function renderBankTransactions() {
    const tbody = document.getElementById('bankTransactionsBody');
    tbody.innerHTML = '';
    
    bankTransactions.slice().reverse().slice(0, 20).forEach(trans => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(trans.date).toLocaleDateString()}</td>
            <td>${trans.bankName}</td>
            <td><span style="background: ${trans.type === 'deposit' ? '#48bb78' : '#f56565'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${trans.type.toUpperCase()}</span></td>
            <td style="font-weight: 700;">Rs. ${trans.amount.toFixed(2)}</td>
            <td>${trans.description || '-'}</td>
            <td style="font-weight: 600;">Rs. ${trans.balanceAfter.toFixed(2)}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteBankTransaction('${trans.id}')">Delete</button>
            </td>
        `;
    });
}

// VEHICLE FUNCTIONS
function saveVehicle(e) {
    e.preventDefault();
    
    const vehicleId = document.getElementById('vehicleId').value || 'veh_' + Date.now();
    const existingIndex = vehicles.findIndex(v => v.id === vehicleId);
    
    const vehicle = {
        id: vehicleId,
        number: document.getElementById('vehicleNumber').value,
        driver: document.getElementById('vehicleDriver').value,
        driverName: document.getElementById('vehicleDriver').value, // Keep both for compatibility
        contact: document.getElementById('vehicleContact').value,
        ownerName: document.getElementById('vehicleOwnerName').value,
        ownerContact: document.getElementById('vehicleOwnerContact').value,
        status: document.getElementById('vehicleStatus').value,
        createdAt: existingIndex >= 0 ? vehicles[existingIndex].createdAt : new Date().toISOString()
    };
    
    const ownerBalance = parseFloat(document.getElementById('vehicleOwnerBalance').value) || 0;

    if (existingIndex >= 0) {
        // Editing - keep stock but allow editing owner balance
        vehicle.stockPMG = vehicles[existingIndex].stockPMG;
        vehicle.stockHSD = vehicles[existingIndex].stockHSD;
        vehicle.ownerBalance = ownerBalance;
        vehicles[existingIndex] = vehicle;
        showNotification('Vehicle updated! ‚úÖ', 'success');
    } else {
        // New vehicle - set opening balance and initial stock
        vehicle.ownerBalance = ownerBalance;
        vehicle.stockPMG = 0;
        vehicle.stockHSD = 0;
        vehicles.push(vehicle);
        showNotification('Vehicle added! ‚úÖ' + (ownerBalance !== 0 ? ` (Owner balance: Rs. ${ownerBalance.toFixed(2)})` : ''), 'success');
    }
    
    saveToStorage();
    renderVehicles();
    closeModal('vehicleModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderVehicles() {
    const tbody = document.getElementById('vehiclesBody');
    tbody.innerHTML = '';
    
    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    
    vehicles.forEach(vehicle => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${vehicle.number}</strong></td>
            <td>${vehicle.driverName}</td>
            <td>${vehicle.contact || '-'}</td>
            <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
            <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
            <td><span style="background: ${vehicle.status === 'Active' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${vehicle.status}</span></td>
            <td>
                <button class="btn btn-success btn-sm" onclick="viewVehicleLedger('${vehicle.id}')">üìä Ledger</button>
                <button class="btn btn-info btn-sm" onclick='editVehicle(${JSON.stringify(vehicle).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteVehicle('${vehicle.id}')">Delete</button>
            </td>
        `;
        fragment.appendChild(row);
    });
    
    tbody.appendChild(fragment);
}

function editVehicle(vehicle) {
    document.getElementById('vehicleId').value = vehicle.id;
    document.getElementById('vehicleNumber').value = vehicle.number;
    document.getElementById('vehicleDriver').value = vehicle.driverName;
    document.getElementById('vehicleContact').value = vehicle.contact || '';
    document.getElementById('vehicleOwnerName').value = vehicle.ownerName || '';
    document.getElementById('vehicleOwnerContact').value = vehicle.ownerContact || '';
    document.getElementById('vehicleStatus').value = vehicle.status;

    // Set owner balance as EDITABLE
    const balanceField = document.getElementById('vehicleOwnerBalance');
    balanceField.value = (vehicle.ownerBalance || 0).toFixed(2);
    balanceField.disabled = false;
    balanceField.style.backgroundColor = '';

    openModal('vehicleModal');
}

function deleteVehicle(id) {
    if (confirm('Are you sure?')) {
        vehicles = vehicles.filter(v => v.id !== id);
        saveToStorage();
        renderVehicles();
        updateDashboard();
        populateDropdowns();
        showNotification('Vehicle deleted!', 'success');
    }
}

function viewVehicleLedger(vehicleId) {
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
        showNotification('Vehicle not found!', 'error');
        return;
    }

    // Set title and info
    document.getElementById('vehicleLedgerTitle').textContent = `${vehicle.number} - Vehicle Ledger`;
    document.getElementById('vehicleLedgerInfo').innerHTML = `
        <div style="font-size: 0.95em;">
            <strong>Driver:</strong> ${vehicle.driverName || 'N/A'}<br>
            <strong>Owner:</strong> ${vehicle.ownerName || 'N/A'}<br>
            <strong>Owner Balance:</strong> <span class="${vehicle.ownerBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${(vehicle.ownerBalance || 0).toFixed(2)}</span>
        </div>
    `;

    // Get all transactions involving this vehicle
    const vehicleTrans = transactions
        .filter(t => t.vehicleId === vehicleId)
        .map(t => ({
            date: t.date,
            description: `${t.type === 'sale' ? 'Sale to' : 'Purchase from'} ${t.partyName} - ${t.fuelType} (${t.quantity} L @ Rs.${t.rate})`,
            type: t.type,
            amount: Math.abs(t.amount),
            pmgQty: (t.fuelType === 'PMG' || t.fuelType === 'Petrol') ? (t.quantity || 0) : 0,
            hsdQty: (t.fuelType === 'HSD' || t.fuelType === 'Diesel') ? (t.quantity || 0) : 0,
            isIncome: t.type === 'sale',
            source: 'transaction',
            id: t.id
        }));

    // Get vehicle expenses (check both source=vehicle and expenseType=vehicle)
    const vehicleExpenses = expenses
        .filter(e => (e.source === 'vehicle' || e.expenseType === 'vehicle') && e.vehicleId === vehicleId)
        .map(e => ({
            date: e.date,
            description: `üí∏ Expense: ${e.category} - ${e.description}`,
            type: 'expense',
            amount: e.amount,
            pmgQty: 0,
            hsdQty: 0,
            isIncome: false,
            source: 'expense',
            id: e.id
        }));

    // Get JV entries for this vehicle
    const jvEntries = jvVouchers.filter(jv =>
        (jv.debitType === 'vehicle' && jv.debitAccount === 'vehicle_' + vehicleId) ||
        (jv.creditType === 'vehicle' && jv.creditAccount === 'vehicle_' + vehicleId)
    ).map(jv => {
        const isDebit = jv.debitType === 'vehicle' && jv.debitAccount === 'vehicle_' + vehicleId;
        return {
            date: jv.date,
            description: `üìù JV: ${jv.description}`,
            type: 'jv',
            amount: isDebit ? jv.debitAmount : jv.creditAmount,
            pmgQty: 0,
            hsdQty: 0,
            isIncome: !isDebit,
            source: 'jv',
            id: jv.id
        };
    });

    // Combine all entries
    const allEntries = [...vehicleTrans, ...vehicleExpenses, ...jvEntries]
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    // Calculate profit/loss
    let totalIncome = 0;
    let totalExpenses = 0;

    allEntries.forEach(entry => {
        if (entry.isIncome) {
            totalIncome += entry.amount;
        } else {
            totalExpenses += entry.amount;
        }
    });

    const netProfit = totalIncome - totalExpenses;

    // Display profit summary
    document.getElementById('vehicleProfitDetails').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <div>
                <div style="color: var(--text-secondary); font-size: 0.85em;">Total Income</div>
                <div style="color: #48bb78; font-weight: 700; font-size: 1.3em;">Rs. ${totalIncome.toFixed(2)}</div>
            </div>
            <div>
                <div style="color: var(--text-secondary); font-size: 0.85em;">Total Expenses</div>
                <div style="color: #f56565; font-weight: 700; font-size: 1.3em;">Rs. ${totalExpenses.toFixed(2)}</div>
            </div>
            <div>
                <div style="color: var(--text-secondary); font-size: 0.85em;">Net Profit/Loss</div>
                <div class="${netProfit >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700; font-size: 1.3em;">Rs. ${netProfit.toFixed(2)}</div>
            </div>
        </div>
    `;

    // Render ledger table
    const tbody = document.getElementById('vehicleLedgerBody');
    tbody.innerHTML = '';
    let runningBalance = vehicle.ownerBalance || 0;

    // Calculate PMG/HSD totals
    let totalPMG = 0;
    let totalHSD = 0;
    allEntries.forEach(entry => {
        totalPMG += entry.pmgQty || 0;
        totalHSD += entry.hsdQty || 0;
    });

    // Opening balance row
    const openingRow = tbody.insertRow();
    openingRow.innerHTML = `
        <td colspan="5"><strong>Opening Balance</strong></td>
        <td>-</td>
        <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
    `;

    // Transaction rows
    allEntries.forEach(entry => {
        const row = tbody.insertRow();

        if (entry.isIncome) {
            runningBalance += entry.amount;
        } else {
            runningBalance -= entry.amount;
        }

        const typeLabel = entry.type === 'sale' ? 'SALE' :
                         entry.type === 'purchase' ? 'PURCHASE' :
                         entry.type === 'expense' ? 'EXPENSE' : 'JV';
        const typeBg = entry.type === 'sale' ? '#805ad5' :
                      entry.type === 'purchase' ? '#ed8936' :
                      entry.type === 'expense' ? '#f56565' : '#667eea';

        row.innerHTML = `
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.description}</td>
            <td><span class="badge" style="background: ${typeBg}">${typeLabel}</span></td>
            <td style="color: #667eea; font-weight: 600;">${entry.pmgQty > 0 ? entry.pmgQty.toFixed(2) : '-'}</td>
            <td style="color: #f59e0b; font-weight: 600;">${entry.hsdQty > 0 ? entry.hsdQty.toFixed(2) : '-'}</td>
            <td style="color: ${entry.isIncome ? '#48bb78' : '#f56565'}; font-weight: 600;">${entry.isIncome ? '+' : '-'} Rs. ${entry.amount.toFixed(2)}</td>
            <td class="${runningBalance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${runningBalance.toFixed(2)}</td>
        `;
    });

    // Add total row for quantities
    const totalRow = tbody.insertRow();
    totalRow.style.background = 'var(--bg-secondary)';
    totalRow.style.fontWeight = 'bold';
    totalRow.innerHTML = `
        <td colspan="3"><strong>üìä Total Sold</strong></td>
        <td style="color: #667eea; font-weight: 700;">${totalPMG > 0 ? totalPMG.toFixed(2) + ' L' : '-'}</td>
        <td style="color: #f59e0b; font-weight: 700;">${totalHSD > 0 ? totalHSD.toFixed(2) + ' L' : '-'}</td>
        <td colspan="2">-</td>
    `;

    window.currentVehicleLedger = { vehicleId, vehicle, allEntries, openingBalance: vehicle.ownerBalance || 0, totalIncome, totalExpenses, netProfit };
    openModal('vehicleLedgerModal');
}

function printVehicleLedger() {
    if (!window.currentVehicleLedger) return;
    const { vehicle, allEntries, openingBalance, totalIncome, totalExpenses, netProfit } = window.currentVehicleLedger;

    let printContent = `
        <html>
        <head>
            <title>${vehicle.number} - Vehicle Ledger</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { text-align: center; color: #2d3748; }
                .info { margin: 20px 0; }
                .profit-summary { background: #f7fafc; padding: 15px; margin: 20px 0; border-radius: 8px; }
                .profit-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
                .profit-item { text-align: center; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                th { background: #667eea; color: white; }
                .total-row { font-weight: bold; background: #f7fafc; }
            </style>
        </head>
        <body>
            <h1>${vehicle.number} - Vehicle Ledger</h1>
            <div class="info">
                <strong>Driver:</strong> ${vehicle.driverName || 'N/A'}<br>
                <strong>Owner:</strong> ${vehicle.ownerName || 'N/A'}<br>
                <strong>Statement Date:</strong> ${new Date().toLocaleDateString()}
            </div>
            <div class="profit-summary">
                <h3>Profit/Loss Summary</h3>
                <div class="profit-grid">
                    <div class="profit-item">
                        <div>Total Income</div>
                        <div style="color: #48bb78; font-weight: bold; font-size: 1.2em;">Rs. ${totalIncome.toFixed(2)}</div>
                    </div>
                    <div class="profit-item">
                        <div>Total Expenses</div>
                        <div style="color: #f56565; font-weight: bold; font-size: 1.2em;">Rs. ${totalExpenses.toFixed(2)}</div>
                    </div>
                    <div class="profit-item">
                        <div>Net Profit/Loss</div>
                        <div style="color: ${netProfit >= 0 ? '#48bb78' : '#f56565'}; font-weight: bold; font-size: 1.2em;">Rs. ${netProfit.toFixed(2)}</div>
                    </div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>PMG (L)</th>
                        <th>HSD (L)</th>
                        <th>Amount</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
    `;

    let runningBalance = openingBalance;
    let totalPMG = 0;
    let totalHSD = 0;

    printContent += `<tr class="total-row"><td colspan="5">Opening Balance</td><td>-</td><td>Rs. ${runningBalance.toFixed(2)}</td></tr>`;

    allEntries.forEach(entry => {
        if (entry.isIncome) {
            runningBalance += entry.amount;
        } else {
            runningBalance -= entry.amount;
        }
        totalPMG += entry.pmgQty || 0;
        totalHSD += entry.hsdQty || 0;
        const typeLabel = entry.type === 'sale' ? 'SALE' : entry.type === 'purchase' ? 'PURCHASE' : entry.type === 'expense' ? 'EXPENSE' : 'JV';
        printContent += `
            <tr>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td>${entry.description}</td>
                <td>${typeLabel}</td>
                <td>${entry.pmgQty > 0 ? entry.pmgQty.toFixed(2) : '-'}</td>
                <td>${entry.hsdQty > 0 ? entry.hsdQty.toFixed(2) : '-'}</td>
                <td style="color: ${entry.isIncome ? '#48bb78' : '#f56565'};">${entry.isIncome ? '+' : '-'} Rs. ${entry.amount.toFixed(2)}</td>
                <td>Rs. ${runningBalance.toFixed(2)}</td>
            </tr>
        `;
    });

    printContent += `<tr class="total-row"><td colspan="3"><strong>Total Sold</strong></td><td style="color: #667eea; font-weight: bold;">${totalPMG > 0 ? totalPMG.toFixed(2) + ' L' : '-'}</td><td style="color: #f59e0b; font-weight: bold;">${totalHSD > 0 ? totalHSD.toFixed(2) + ' L' : '-'}</td><td colspan="2">-</td></tr>`;
    printContent += `</tbody></table></body></html>`;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

function downloadVehicleLedgerPDF() {
    showNotification('üí° Tip: Use Print > Save as PDF option!', 'info');
    printVehicleLedger();
}

// LEDGER FUNCTIONS (NEW)
function generateLedger() {
    let html = '<div class="card"><h2>üìí Customer Ledger</h2>';
    
    if (customers.length === 0) {
        html += '<p style="text-align: center; color: #718096; padding: 20px;">No customers found</p></div>';
        document.getElementById('ledgerOutput').innerHTML = html;
        return;
    }
    
    customers.forEach(customer => {
        // Get all transactions for this customer
        const customerSales = transactions.filter(t => t.partyId === customer.id && t.type === 'sale');
        const customerPayments = payments.filter(p => p.partyId === customer.id && p.type === 'received');
        
        // EXPENSES with robust checks
        const customerExpenses = expenses.filter(e => 
            e.source === 'customer' && 
            e.customerId && 
            e.customerId === customer.id
        );
        
        // TRANSFERS with robust checks
        const transfersFrom = customerTransfers.filter(t => 
            t.fromCustomerId && 
            t.fromCustomerId === customer.id
        );
        const transfersTo = customerTransfers.filter(t => 
            t.toCustomerId && 
            t.toCustomerId === customer.id
        );
        
        // JV ENTRIES with robust checks
        const jvDebits = jvVouchers.filter(jv => {
            if (jv.debitType === 'customer' && jv.debitAccount) {
                return jv.debitAccount === customer.id || 
                       jv.debitAccount === 'customer_' + customer.id ||
                       jv.debitAccount.includes(customer.id);
            }
            return false;
        });
        const jvCredits = jvVouchers.filter(jv => {
            if (jv.creditType === 'customer' && jv.creditAccount) {
                return jv.creditAccount === customer.id || 
                       jv.creditAccount === 'customer_' + customer.id ||
                       jv.creditAccount.includes(customer.id);
            }
            return false;
        });
        
        // Calculate totals
        const totalSales = customerSales.reduce((sum, t) => sum + t.amount, 0);
        const totalPayments = customerPayments.reduce((sum, p) => sum + p.amount, 0);
        const totalExpenses = customerExpenses.reduce((sum, e) => sum + e.amount, 0);
        const totalTransfersFrom = transfersFrom.reduce((sum, t) => sum + t.amount, 0);
        const totalTransfersTo = transfersTo.reduce((sum, t) => sum + t.amount, 0);
        const totalJVDebits = jvDebits.reduce((sum, jv) => sum + jv.debitAmount, 0);
        const totalJVCredits = jvCredits.reduce((sum, jv) => sum + jv.creditAmount, 0);
        const balance = customer.balance;
        
        html += `
            <div style="border: 2px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; background: #f7fafc;">
                <h3 style="color: #667eea; margin-bottom: 10px; font-size: 1.2em;">
                    ${customer.name}
                    <span style="float: right; color: ${balance >= 0 ? '#48bb78' : '#f56565'}; font-size: 0.9em;">
                        Balance: Rs. ${balance.toFixed(2)}
                    </span>
                </h3>
                <p style="color: #718096; font-size: 0.9em; margin-bottom: 15px;">
                    Contact: ${customer.contact || 'N/A'} | CNIC: ${customer.cnic || 'N/A'}
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-bottom: 15px;">
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Sales</div>
                        <div style="color: #48bb78; font-weight: 700; font-size: 0.95em;">Rs. ${totalSales.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Payments</div>
                        <div style="color: #4299e1; font-weight: 700; font-size: 0.95em;">Rs. ${totalPayments.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Expenses</div>
                        <div style="color: #f56565; font-weight: 700; font-size: 0.95em;">Rs. ${totalExpenses.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Paid For</div>
                        <div style="color: #9f7aea; font-weight: 700; font-size: 0.95em;">Rs. ${totalTransfersFrom.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Received</div>
                        <div style="color: #38b2ac; font-weight: 700; font-size: 0.95em;">Rs. ${totalTransfersTo.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">JV Dr</div>
                        <div style="color: #ed8936; font-weight: 700; font-size: 0.95em;">Rs. ${totalJVDebits.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">JV Cr</div>
                        <div style="color: #f687b3; font-weight: 700; font-size: 0.95em;">Rs. ${totalJVCredits.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Balance</div>
                        <div style="color: ${balance >= 0 ? '#e53e3e' : '#38a169'}; font-weight: 700; font-size: 0.95em;">Rs. ${balance.toFixed(2)}</div>
                    </div>
                </div>
                
                ${customerSales.length > 0 || customerPayments.length > 0 || customerExpenses.length > 0 || 
                  transfersFrom.length > 0 || transfersTo.length > 0 || jvDebits.length > 0 || jvCredits.length > 0 ? `
                <table style="width: 100%; font-size: 0.85em; background: white; border-radius: 8px;">
                    <thead style="background: #667eea; color: white;">
                        <tr>
                            <th style="padding: 8px; text-align: left;">Date</th>
                            <th style="padding: 8px; text-align: left;">Type</th>
                            <th style="padding: 8px; text-align: left;">Details</th>
                            <th style="padding: 8px; text-align: right;">Debit (Sales)</th>
                            <th style="padding: 8px; text-align: right;">Credit (Payment)</th>
                        </tr>
                    </thead>
                    <tbody>
        ` : '<p style="text-align: center; color: #718096; padding: 10px;">No transactions yet</p>'}
        `;
        
        // Combine and sort all entries by date
        const allEntries = [
            ...customerSales.map(t => ({
                date: t.date,
                type: 'Sale',
                details: `${t.fuelType} - ${t.quantity.toFixed(2)} L @ Rs. ${t.rate.toFixed(4)}`,
                debit: t.amount,
                credit: 0
            })),
            ...customerPayments.map(p => ({
                date: p.date,
                type: 'Payment',
                details: `${p.method} - ${p.notes || 'Payment received'}`,
                debit: 0,
                credit: p.amount
            })),
            ...customerExpenses.map(e => ({
                date: e.date,
                type: 'Expense',
                details: `${e.category || 'Expense'} - ${e.description || ''}`,
                debit: 0,
                credit: e.amount
            })),
            ...transfersFrom.map(t => ({
                date: t.date,
                type: 'Transfer Out',
                details: `Paid for ${t.toCustomerName || 'Customer'}`,
                debit: t.amount,
                credit: 0
            })),
            ...transfersTo.map(t => ({
                date: t.date,
                type: 'Transfer In',
                details: `${t.fromCustomerName || 'Customer'} paid`,
                debit: 0,
                credit: t.amount
            })),
            ...jvDebits.map(jv => ({
                date: jv.date,
                type: 'JV Dr',
                details: jv.description || 'Journal Entry',
                debit: jv.debitAmount || 0,
                credit: 0
            })),
            ...jvCredits.map(jv => ({
                date: jv.date,
                type: 'JV Cr',
                details: jv.description || 'Journal Entry',
                debit: 0,
                credit: jv.creditAmount || 0
            }))
        ].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        allEntries.slice(0, 10).forEach(entry => {
            html += `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 8px;">${new Date(entry.date).toLocaleDateString()}</td>
                    <td style="padding: 8px;">
                        <span style="background: ${
                            entry.type === 'Sale' ? '#48bb78' : 
                            entry.type === 'Payment' ? '#4299e1' : 
                            entry.type === 'Expense' ? '#f56565' :
                            entry.type === 'Transfer Out' ? '#9f7aea' :
                            entry.type === 'Transfer In' ? '#38b2ac' :
                            entry.type === 'JV Dr' ? '#ed8936' :
                            entry.type === 'JV Cr' ? '#f687b3' : '#718096'
                        }; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600;">
                            ${entry.type}
                        </span>
                    </td>
                    <td style="padding: 8px;">${entry.details}</td>
                    <td style="padding: 8px; text-align: right; color: #f56565; font-weight: 600;">
                        ${entry.debit > 0 ? 'Rs. ' + entry.debit.toFixed(2) : '-'}
                    </td>
                    <td style="padding: 8px; text-align: right; color: #48bb78; font-weight: 600;">
                        ${entry.credit > 0 ? 'Rs. ' + entry.credit.toFixed(2) : '-'}
                    </td>
                </tr>
            `;
        });
        
        if (customerSales.length > 0 || customerPayments.length > 0 || customerExpenses.length > 0 || 
            transfersFrom.length > 0 || transfersTo.length > 0 || jvDebits.length > 0 || jvCredits.length > 0) {
            html += `
                    </tbody>
                </table>
                ${allEntries.length > 10 ? `<p style="text-align: center; color: #718096; margin-top: 10px; font-size: 0.85em;">Showing last 10 transactions</p>` : ''}
            `;
        }
        
        html += '</div>';
    });
    
    html += '</div>';
    document.getElementById('ledgerOutput').innerHTML = html;
    showNotification('Customer ledger generated! üìí', 'success');
}

function checkBalance() {
    const today = new Date().toISOString().split('T')[0];
    const todayEntries = ledgerEntries.filter(e => e.date === today);
    
    let totalDebits = 0;
    let totalCredits = 0;
    
    todayEntries.forEach(entry => {
        totalDebits += entry.debitAmount;
        totalCredits += entry.creditAmount;
    });
    
    const balanced = Math.abs(totalDebits - totalCredits) < 0.01;
    
    let html = `
        <div class="card">
            <h2>‚öñÔ∏è Balance Check for ${new Date().toLocaleDateString()}</h2>
            <div class="profit-loss-section">
                <div class="profit-loss-item">
                    <span>Total Debits</span>
                    <span style="color: #f56565; font-weight: 700;">Rs. ${totalDebits.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Credits</span>
                    <span style="color: #48bb78; font-weight: 700;">Rs. ${totalCredits.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item total">
                    <span>Difference</span>
                    <span style="color: ${balanced ? '#48bb78' : '#f56565'};">Rs. ${Math.abs(totalDebits - totalCredits).toFixed(2)}</span>
                </div>
                <div class="profit-loss-item" style="background: ${balanced ? '#48bb78' : '#f56565'}; color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <span style="font-size: 1.2em;">${balanced ? '‚úÖ Books are BALANCED!' : '‚ö†Ô∏è Books are NOT balanced!'}</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('ledgerOutput').innerHTML = html;
    
    if (balanced) {
        showNotification('Books are perfectly balanced! ‚úÖ', 'success');
    } else {
        showNotification('Warning: Books are not balanced! ‚ö†Ô∏è', 'warning');
    }
}

// GOV RATE CHANGE
function roundRate(rate) {
    return Math.round(rate * 10000) / 10000;
}

function previewGovRateChange() {
    const updatePmg = document.getElementById('updatePmg').checked;
    const updateHsd = document.getElementById('updateHsd').checked;
    const changeType = document.getElementById('changeType').value;
    const changeSign = parseInt(document.getElementById('changeSign').value);
    const changeAmount = parseFloat(document.getElementById('changeAmount').value);
    const scope = document.getElementById('changeScope').value;
    
    if (!updatePmg && !updateHsd) {
        showNotification('Select at least one fuel type!', 'error');
        return;
    }
    
    let affectedParties = [];
    if (scope === 'all' || scope === 'customers') affectedParties = affectedParties.concat(customers);
    if (scope === 'all' || scope === 'suppliers') affectedParties = affectedParties.concat(suppliers);
    
    let html = '<table style="width:100%; font-size:0.85em;"><thead><tr><th>Name</th><th>Old PMG</th><th>New PMG</th><th>Old HSD</th><th>New HSD</th></tr></thead><tbody>';
    
    affectedParties.slice(0, 5).forEach(party => {
        // Support both customer format (pmgRate) and supplier format (pmgRateSelf)
        const oldPmg = parseFloat(party.pmgRateSelf || party.pmgRate || 0);
        const oldHsd = parseFloat(party.hsdRateSelf || party.hsdRate || 0);
        
        let newPmg, newHsd;
        if (changeType === 'absolute') {
            newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
            newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
        } else {
            newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
            newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
        }
        
        html += `
            <tr>
                <td><strong>${party.name}</strong></td>
                <td>Rs. ${oldPmg.toFixed(4)}</td>
                <td style="color:${newPmg > oldPmg ? '#48bb78' : newPmg < oldPmg ? '#f56565' : '#718096'};">Rs. ${newPmg.toFixed(4)}</td>
                <td>Rs. ${oldHsd.toFixed(4)}</td>
                <td style="color:${newHsd > oldHsd ? '#48bb78' : newHsd < oldHsd ? '#f56565' : '#718096'};">Rs. ${newHsd.toFixed(4)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    if (affectedParties.length > 5) {
        html += `<p style="text-align:center; margin-top:10px; color:#718096;">... and ${affectedParties.length - 5} more</p>`;
    }
    html += `<p style="text-align:center; margin-top:15px; font-weight:700; color:#667eea;">Total: ${affectedParties.length} parties</p>`;
    
    document.getElementById('previewContent').innerHTML = html;
    document.getElementById('rateChangePreview').style.display = 'block';
}

function applyGovRateChange(e) {
    e.preventDefault();
    
    const updatePmg = document.getElementById('updatePmg').checked;
    const updateHsd = document.getElementById('updateHsd').checked;
    const changeType = document.getElementById('changeType').value;
    const changeSign = parseInt(document.getElementById('changeSign').value);
    const changeAmount = parseFloat(document.getElementById('changeAmount').value);
    const scope = document.getElementById('changeScope').value;
    
    if (!updatePmg && !updateHsd) {
        showNotification('Select at least one fuel type!', 'error');
        return;
    }
    
    if (!confirm(`Apply rate change?\nType: ${changeType}\nAmount: ${changeSign > 0 ? '+' : ''}${changeAmount}\nScope: ${scope}`)) {
        return;
    }
    
    const logEntry = {
        id: 'log_' + Date.now(),
        updatePmg,
        updateHsd,
        changeType,
        changeSign,
        changeAmount,
        scope,
        appliedBy: currentUser,
        appliedAt: new Date().toISOString(),
        changes: []
    };
    
    if (scope === 'all' || scope === 'customers') {
        customers.forEach(customer => {
            const oldPmg = parseFloat(customer.pmgRate);
            const oldHsd = parseFloat(customer.hsdRate);
            
            let newPmg, newHsd;
            if (changeType === 'absolute') {
                newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
            } else {
                newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
            }
            
            logEntry.changes.push({
                partyId: customer.id,
                partyName: customer.name,
                partyType: 'customer',
                oldPmgRate: oldPmg,
                newPmgRate: newPmg,
                oldHsdRate: oldHsd,
                newHsdRate: newHsd
            });
            
            customer.pmgRate = newPmg.toFixed(4);
            customer.hsdRate = newHsd.toFixed(4);
        });
    }
    
    if (scope === 'all' || scope === 'suppliers') {
        suppliers.forEach(supplier => {
            // Use Self Carriage rate as base, or fallback to old pmgRate
            const oldPmg = parseFloat(supplier.pmgRateSelf || supplier.pmgRate || 0);
            const oldHsd = parseFloat(supplier.hsdRateSelf || supplier.hsdRate || 0);
            
            let newPmg, newHsd;
            if (changeType === 'absolute') {
                newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
            } else {
                newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
            }
            
            logEntry.changes.push({
                partyId: supplier.id,
                partyName: supplier.name,
                partyType: 'supplier',
                oldPmgRate: oldPmg,
                newPmgRate: newPmg,
                oldHsdRate: oldHsd,
                newHsdRate: newHsd
            });
            
            // Update Self Carriage rates (base rates)
            supplier.pmgRateSelf = newPmg.toFixed(4);
            supplier.hsdRateSelf = newHsd.toFixed(4);
            
            // If supplier has PSO rates, update those too proportionally
            if (supplier.pmgRatePSO) {
                const pmgDiff = newPmg - oldPmg;
                supplier.pmgRatePSO = (parseFloat(supplier.pmgRatePSO) + pmgDiff).toFixed(4);
            }
            if (supplier.hsdRatePSO) {
                const hsdDiff = newHsd - oldHsd;
                supplier.hsdRatePSO = (parseFloat(supplier.hsdRatePSO) + hsdDiff).toFixed(4);
            }
        });
    }
    
    rateChangeLogs.push(logEntry);
    saveToStorage();
    
    showNotification(`üéâ Rate change applied to ${logEntry.changes.length} parties!`, 'success');
    closeModal('govRateModal');
    renderCustomers();
    renderSuppliers();
    document.getElementById('rateChangePreview').style.display = 'none';
    document.getElementById('changeAmount').value = '';
}

// REPORT FUNCTIONS
function generateCustomerLedgerReport() {
    const customerId = document.getElementById('customerReportSelect').value;
    const fromDate = document.getElementById('customerReportFromDate').value;
    const toDate = document.getElementById('customerReportToDate').value;
    
    if (!customerId) {
        showNotification('Please select a customer!', 'error');
        return;
    }
    
    const customer = customers.find(c => c.id === customerId);
    if (!customer) {
        showNotification('Customer not found!', 'error');
        return;
    }
    
    // Filter transactions by date if dates are provided
    let customerSales = transactions.filter(t => t.partyId === customerId && t.type === 'sale');
    let customerPayments = payments.filter(p => p.partyId === customerId && p.type === 'received');
    
    // EXPENSES - Check if customerId field exists and matches, AND source is 'customer'
    let customerExpenses = expenses.filter(e => 
        e.source === 'customer' && 
        e.customerId && 
        e.customerId === customerId
    );
    
    // TRANSFERS FROM - this customer paid for others
    let transfersFrom = customerTransfers.filter(t => 
        t.fromCustomerId && 
        t.fromCustomerId === customerId
    );
    
    // TRANSFERS TO - others paid for this customer  
    let transfersTo = customerTransfers.filter(t => 
        t.toCustomerId && 
        t.toCustomerId === customerId
    );
    
    // JV DEBITS - customer on debit side
    // Account format can be: "customer_cust_123" or just the ID
    let jvDebits = jvVouchers.filter(jv => {
        if (jv.debitType === 'customer' && jv.debitAccount) {
            // Check if account matches customer ID directly or with prefix
            return jv.debitAccount === customerId || 
                   jv.debitAccount === 'customer_' + customerId ||
                   jv.debitAccount.includes(customerId);
        }
        return false;
    });
    
    // JV CREDITS - customer on credit side
    let jvCredits = jvVouchers.filter(jv => {
        if (jv.creditType === 'customer' && jv.creditAccount) {
            return jv.creditAccount === customerId || 
                   jv.creditAccount === 'customer_' + customerId ||
                   jv.creditAccount.includes(customerId);
        }
        return false;
    });
    
    // Apply date filters
    if (fromDate) {
        customerSales = customerSales.filter(t => t.date >= fromDate);
        customerPayments = customerPayments.filter(p => p.date >= fromDate);
        customerExpenses = customerExpenses.filter(e => e.date >= fromDate);
        transfersFrom = transfersFrom.filter(t => t.date >= fromDate);
        transfersTo = transfersTo.filter(t => t.date >= fromDate);
        jvDebits = jvDebits.filter(jv => jv.date >= fromDate);
        jvCredits = jvCredits.filter(jv => jv.date >= fromDate);
    }
    if (toDate) {
        customerSales = customerSales.filter(t => t.date <= toDate);
        customerPayments = customerPayments.filter(p => p.date <= toDate);
        customerExpenses = customerExpenses.filter(e => e.date <= toDate);
        transfersFrom = transfersFrom.filter(t => t.date <= toDate);
        transfersTo = transfersTo.filter(t => t.date <= toDate);
        jvDebits = jvDebits.filter(jv => jv.date <= toDate);
        jvCredits = jvCredits.filter(jv => jv.date <= toDate);
    }
    
    // Calculate totals
    const totalSales = customerSales.reduce((sum, t) => sum + t.amount, 0);
    const totalPayments = customerPayments.reduce((sum, p) => sum + p.amount, 0);
    const totalExpenses = customerExpenses.reduce((sum, e) => sum + e.amount, 0);
    const totalTransfersFrom = transfersFrom.reduce((sum, t) => sum + t.amount, 0);
    const totalTransfersTo = transfersTo.reduce((sum, t) => sum + t.amount, 0);
    const totalJVDebits = jvDebits.reduce((sum, jv) => sum + jv.debitAmount, 0);
    const totalJVCredits = jvCredits.reduce((sum, jv) => sum + jv.creditAmount, 0);
    const balance = customer.balance;
    
    let html = `
        <div class="card">
            <h2>üìí Customer Ledger Report</h2>
            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">${customer.name}</h3>
                        <p style="margin: 5px 0;"><strong>Contact:</strong> ${customer.contact || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>CNIC:</strong> ${customer.cnic || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>Address:</strong> ${customer.address || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="margin: 5px 0;"><strong>PMG Rate:</strong> Rs. ${customer.pmgRate}</p>
                        <p style="margin: 5px 0;"><strong>HSD Rate:</strong> Rs. ${customer.hsdRate}</p>
                        <p style="margin: 5px 0;"><strong>Report Period:</strong> ${fromDate || 'Start'} to ${toDate || 'Today'}</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                <div style="background: #48bb78; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Sales</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalSales.toFixed(2)}</div>
                </div>
                <div style="background: #4299e1; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Payments</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalPayments.toFixed(2)}</div>
                </div>
                <div style="background: #f56565; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Expenses</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalExpenses.toFixed(2)}</div>
                </div>
                <div style="background: #9f7aea; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Paid For Others</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalTransfersFrom.toFixed(2)}</div>
                </div>
                <div style="background: #38b2ac; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Others Paid</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalTransfersTo.toFixed(2)}</div>
                </div>
                <div style="background: #ed8936; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">JV Debits</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalJVDebits.toFixed(2)}</div>
                </div>
                <div style="background: #f687b3; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">JV Credits</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalJVCredits.toFixed(2)}</div>
                </div>
                <div style="background: ${balance >= 0 ? '#e53e3e' : '#38a169'}; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Balance</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${balance.toFixed(2)}</div>
                </div>
            </div>
            
            ${customerSales.length > 0 || customerPayments.length > 0 || customerExpenses.length > 0 || transfersFrom.length > 0 || transfersTo.length > 0 || jvDebits.length > 0 || jvCredits.length > 0 ? `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Debit (Sales)</th>
                            <th>Credit (Payment)</th>
                            <th>Running Balance</th>
                        </tr>
                    </thead>
                    <tbody>
            ` : '<p style="text-align: center; color: #718096; padding: 20px;">No transactions in selected period</p>'}
    `;
    
    // Combine and sort all entries by date
    const allEntries = [
        ...customerSales.map(t => ({
            date: t.date,
            type: 'Sale',
            details: `${t.fuelType} - ${t.quantity.toFixed(2)} L @ Rs. ${t.rate.toFixed(4)}`,
            debit: t.amount,
            credit: 0
        })),
        ...customerPayments.map(p => ({
            date: p.date,
            type: 'Payment',
            details: `${p.method} - ${p.notes || 'Payment received'}`,
            debit: 0,
            credit: p.amount
        })),
        ...customerExpenses.map(e => ({
            date: e.date,
            type: 'Expense',
            details: `${e.category || 'Expense'} - ${e.description || ''}`,
            debit: 0,
            credit: e.amount
        })),
        ...transfersFrom.map(t => ({
            date: t.date,
            type: 'Transfer Out',
            details: `Paid for ${t.toCustomerName || 'Customer'} - ${t.description || ''}`,
            debit: t.amount,
            credit: 0
        })),
        ...transfersTo.map(t => ({
            date: t.date,
            type: 'Transfer In',
            details: `${t.fromCustomerName || 'Customer'} paid for this - ${t.description || ''}`,
            debit: 0,
            credit: t.amount
        })),
        ...jvDebits.map(jv => ({
            date: jv.date,
            type: 'JV Debit',
            details: `${jv.description || 'Journal Entry'} (Dr: ${jv.debitAccount || ''})`,
            debit: jv.debitAmount || 0,
            credit: 0
        })),
        ...jvCredits.map(jv => ({
            date: jv.date,
            type: 'JV Credit',
            details: `${jv.description || 'Journal Entry'} (Cr: ${jv.creditAccount || ''})`,
            debit: 0,
            credit: jv.creditAmount || 0
        }))
    ].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    let runningBalance = 0;
    allEntries.forEach(entry => {
        runningBalance += entry.debit - entry.credit;
        html += `
            <tr>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td>
                    <span style="background: ${
                        entry.type === 'Sale' ? '#48bb78' : 
                        entry.type === 'Payment' ? '#4299e1' : 
                        entry.type === 'Expense' ? '#f56565' :
                        entry.type === 'Transfer Out' ? '#9f7aea' :
                        entry.type === 'Transfer In' ? '#38b2ac' :
                        entry.type === 'JV Debit' ? '#ed8936' :
                        entry.type === 'JV Credit' ? '#f687b3' : '#718096'
                    }; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8em; font-weight: 600;">
                        ${entry.type}
                    </span>
                </td>
                <td>${entry.details}</td>
                <td style="color: #f56565; font-weight: 600;">
                    ${entry.debit > 0 ? 'Rs. ' + entry.debit.toFixed(2) : '-'}
                </td>
                <td style="color: #48bb78; font-weight: 600;">
                    ${entry.credit > 0 ? 'Rs. ' + entry.credit.toFixed(2) : '-'}
                </td>
                <td style="font-weight: 700; color: ${runningBalance >= 0 ? '#ed8936' : '#48bb78'};">
                    Rs. ${runningBalance.toFixed(2)}
                </td>
            </tr>
        `;
    });
    
    if (customerSales.length > 0 || customerPayments.length > 0 || customerExpenses.length > 0 || 
        transfersFrom.length > 0 || transfersTo.length > 0 || jvDebits.length > 0 || jvCredits.length > 0) {
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    html += '</div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Customer ledger report generated! üìí', 'success');
}

function generateSingleVehicleReport() {
    const vehicleId = document.getElementById('vehicleReportSelect').value;
    const fromDate = document.getElementById('vehicleReportFromDate').value;
    const toDate = document.getElementById('vehicleReportToDate').value;
    
    if (!vehicleId) {
        showNotification('Please select a vehicle!', 'error');
        return;
    }
    
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
        showNotification('Vehicle not found!', 'error');
        return;
    }
    
    // Filter transactions by date if dates are provided
    let vehicleSales = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'sale');
    let vehiclePurchases = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'purchase');
    
    if (fromDate) {
        vehicleSales = vehicleSales.filter(t => t.date >= fromDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date >= fromDate);
    }
    if (toDate) {
        vehicleSales = vehicleSales.filter(t => t.date <= toDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date <= toDate);
    }
    
    const totalSales = vehicleSales.reduce((sum, t) => sum + t.amount, 0);
    const totalPurchases = vehiclePurchases.reduce((sum, t) => sum + t.amount, 0);
    const profit = totalSales - totalPurchases;
    
    // Calculate fuel-wise breakdown
    const pmgSales = vehicleSales.filter(t => t.fuelType === 'PMG').reduce((sum, t) => sum + t.amount, 0);
    const hsdSales = vehicleSales.filter(t => t.fuelType === 'HSD').reduce((sum, t) => sum + t.amount, 0);
    const pmgPurchases = vehiclePurchases.filter(t => t.fuelType === 'PMG').reduce((sum, t) => sum + t.amount, 0);
    const hsdPurchases = vehiclePurchases.filter(t => t.fuelType === 'HSD').reduce((sum, t) => sum + t.amount, 0);
    
    let html = `
        <div class="card">
            <h2>üöõ Vehicle Profit Report</h2>
            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">${vehicle.number}</h3>
                        <p style="margin: 5px 0;"><strong>Driver:</strong> ${vehicle.driverName}</p>
                        <p style="margin: 5px 0;"><strong>Contact:</strong> ${vehicle.contact || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: ${vehicle.status === 'Active' ? '#48bb78' : '#ed8936'};">${vehicle.status}</span></p>
                    </div>
                    <div>
                        <p style="margin: 5px 0;"><strong>Current PMG Stock:</strong> ${vehicle.stockPMG.toFixed(2)} KL</p>
                        <p style="margin: 5px 0;"><strong>Current HSD Stock:</strong> ${vehicle.stockHSD.toFixed(2)} KL</p>
                        <p style="margin: 5px 0;"><strong>Report Period:</strong> ${fromDate || 'Start'} to ${toDate || 'Today'}</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: #48bb78; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Total Sales</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${totalSales.toFixed(2)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${vehicleSales.length} transactions</div>
                </div>
                <div style="background: #ed8936; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Total Purchases</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${totalPurchases.toFixed(2)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${vehiclePurchases.length} transactions</div>
                </div>
                <div style="background: ${profit >= 0 ? '#667eea' : '#f56565'}; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Profit/Loss</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${profit.toFixed(2)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${profit >= 0 ? 'Profit ‚úÖ' : 'Loss ‚ö†Ô∏è'}</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">PMG (Petrol)</h4>
                    <p style="margin: 5px 0;"><strong>Sales:</strong> Rs. ${pmgSales.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Purchases:</strong> Rs. ${pmgPurchases.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Profit:</strong> <span style="color: ${(pmgSales - pmgPurchases) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700;">Rs. ${(pmgSales - pmgPurchases).toFixed(2)}</span></p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #ed8936;">
                    <h4 style="color: #ed8936; margin-bottom: 10px;">HSD (Diesel)</h4>
                    <p style="margin: 5px 0;"><strong>Sales:</strong> Rs. ${hsdSales.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Purchases:</strong> Rs. ${hsdPurchases.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Profit:</strong> <span style="color: ${(hsdSales - hsdPurchases) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700;">Rs. ${(hsdSales - hsdPurchases).toFixed(2)}</span></p>
                </div>
            </div>
            
            ${vehicleSales.length > 0 || vehiclePurchases.length > 0 ? `
            <h3 style="color: #667eea; margin-bottom: 10px;">Transaction Details</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Party</th>
                            <th>Fuel</th>
                            <th>Quantity (L)</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            ` : '<p style="text-align: center; color: #718096; padding: 20px;">No transactions in selected period</p>'}
    `;
    
    // Combine all transactions and sort by date
    const allTransactions = [...vehicleSales, ...vehiclePurchases].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    allTransactions.forEach(trans => {
        html += `
            <tr>
                <td>${new Date(trans.date).toLocaleDateString()}</td>
                <td>
                    <span style="background: ${trans.type === 'sale' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8em;">
                        ${trans.type.toUpperCase()}
                    </span>
                </td>
                <td>${trans.partyName}</td>
                <td><span style="background: ${trans.fuelType === 'PMG' ? '#667eea' : '#ed8936'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">${trans.fuelType}</span></td>
                <td>${trans.quantity.toFixed(2)}</td>
                <td>Rs. ${trans.rate.toFixed(4)}</td>
                <td style="font-weight: 700; color: ${trans.type === 'sale' ? '#48bb78' : '#ed8936'};">Rs. ${trans.amount.toFixed(2)}</td>
            </tr>
        `;
    });
    
    if (vehicleSales.length > 0 || vehiclePurchases.length > 0) {
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    html += '</div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Vehicle report generated! üöõ', 'success');
}

function generateAllPartiesReport() {
    let html = `
        <div class="card">
            <h2>üìã All Parties Balance Report</h2>
            <p style="color: #718096; margin-bottom: 20px;">Complete overview of all balances as of ${new Date().toLocaleDateString()}</p>
            
            <!-- Customers Section -->
            <h3 style="color: #48bb78; margin-top: 20px; margin-bottom: 10px;">üë• Customers (Receivables)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>PMG Rate</th>
                            <th>HSD Rate</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalReceivables = 0;
    customers.forEach(customer => {
        totalReceivables += customer.balance > 0 ? customer.balance : 0;
        html += `
            <tr>
                <td><strong>${customer.name}</strong></td>
                <td>${customer.contact || 'N/A'}</td>
                <td>Rs. ${customer.pmgRate}</td>
                <td>Rs. ${customer.hsdRate}</td>
                <td style="font-weight: 700; color: ${customer.balance > 0 ? '#ed8936' : '#48bb78'};">
                    Rs. ${customer.balance.toFixed(2)}
                </td>
                <td>
                    ${customer.balance > 0 ? '<span style="background: #ed8936; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">PENDING</span>' : '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">CLEAR</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #48bb78;">
                            <td colspan="4"><strong>TOTAL RECEIVABLES</strong></td>
                            <td style="color: #ed8936; font-size: 1.2em;">Rs. ${totalReceivables.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Suppliers Section -->
            <h3 style="color: #ed8936; margin-top: 30px; margin-bottom: 10px;">üè≠ Suppliers (Payables)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>PMG Rate</th>
                            <th>HSD Rate</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalPayables = 0;
    suppliers.forEach(supplier => {
        totalPayables += supplier.balance > 0 ? supplier.balance : 0;
        // Use Self Carriage rate as primary, fallback to old rate
        const pmgRate = supplier.pmgRateSelf || supplier.pmgRate || 0;
        const hsdRate = supplier.hsdRateSelf || supplier.hsdRate || 0;
        const carriageIcon = supplier.defaultCarriage === 'pso' ? ' üöõ' : ' üöó';
        html += `
            <tr>
                <td><strong>${supplier.name}</strong></td>
                <td>${supplier.contact || 'N/A'}</td>
                <td>Rs. ${parseFloat(pmgRate).toFixed(4)}${carriageIcon}</td>
                <td>Rs. ${parseFloat(hsdRate).toFixed(4)}${carriageIcon}</td>
                <td style="font-weight: 700; color: ${supplier.balance > 0 ? '#f56565' : '#48bb78'};">
                    Rs. ${supplier.balance.toFixed(2)}
                </td>
                <td>
                    ${supplier.balance > 0 ? '<span style="background: #f56565; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">TO PAY</span>' : '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">CLEAR</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #ed8936;">
                            <td colspan="4"><strong>TOTAL PAYABLES</strong></td>
                            <td style="color: #f56565; font-size: 1.2em;">Rs. ${totalPayables.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Banks Section -->
            <h3 style="color: #4299e1; margin-top: 30px; margin-bottom: 10px;">üè¶ Bank Accounts</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Bank Name</th>
                            <th>Account Number</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalBankBalance = 0;
    banks.forEach(bank => {
        totalBankBalance += bank.balance;
        html += `
            <tr>
                <td><strong>${bank.name}</strong></td>
                <td>${bank.accountNumber}</td>
                <td style="font-weight: 700; color: ${bank.balance >= 0 ? '#48bb78' : '#f56565'};">
                    Rs. ${bank.balance.toFixed(2)}
                </td>
                <td>
                    ${bank.balance >= 0 ? '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">POSITIVE</span>' : '<span style="background: #f56565; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">NEGATIVE</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #4299e1;">
                            <td colspan="2"><strong>TOTAL BANK BALANCE</strong></td>
                            <td style="color: #4299e1; font-size: 1.2em;">Rs. ${totalBankBalance.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Vehicles Section -->
            <h3 style="color: #805ad5; margin-top: 30px; margin-bottom: 10px;">üöõ Vehicles & Stock</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Vehicle Number</th>
                            <th>Driver</th>
                            <th>Owner</th>
                            <th>PMG Stock (KL)</th>
                            <th>HSD Stock (KL)</th>
                            <th>Total Stock (KL)</th>
                            <th>Owner Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    let totalStock = 0;
    let totalVehicleBalance = 0;
    vehicles.forEach(vehicle => {
        const vehicleStock = vehicle.stockPMG + vehicle.stockHSD;
        totalStock += vehicleStock;
        const ownerBalance = vehicle.ownerBalance || 0;
        totalVehicleBalance += ownerBalance;
        html += `
            <tr>
                <td><strong>${vehicle.number}</strong></td>
                <td>${vehicle.driverName}</td>
                <td>${vehicle.ownerName || '-'}</td>
                <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
                <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
                <td style="font-weight: 700;">${vehicleStock.toFixed(2)} KL</td>
                <td style="font-weight: 700; color: ${ownerBalance >= 0 ? '#48bb78' : '#f56565'};">Rs. ${ownerBalance.toFixed(2)}</td>
                <td>
                    <span style="background: ${vehicle.status === 'Active' ? '#48bb78' : '#ed8936'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">${vehicle.status}</span>
                </td>
            </tr>
        `;
    });

    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #805ad5;">
                            <td colspan="5"><strong>TOTAL STOCK</strong></td>
                            <td style="color: #805ad5; font-size: 1.2em;">${totalStock.toFixed(2)} KL</td>
                            <td style="color: ${totalVehicleBalance >= 0 ? '#48bb78' : '#f56565'}; font-size: 1.2em;">Rs. ${totalVehicleBalance.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Owner & Relative Accounts Section -->
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 10px;">üëî Owner & Relative Accounts</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Contact</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    let totalOwnerBalance = 0;
    ownerAccounts.forEach(account => {
        totalOwnerBalance += account.balance;
        const typeIcon = account.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
        const typeText = account.type === 'owner' ? 'Owner Capital' : 'Relative';
        html += `
            <tr>
                <td><strong>${typeIcon} ${account.name}</strong></td>
                <td><span style="background: ${account.type === 'owner' ? '#667eea' : '#48bb78'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">${typeText}</span></td>
                <td>${account.contact || 'N/A'}</td>
                <td style="font-weight: 700; color: ${account.balance >= 0 ? '#48bb78' : '#f56565'};">Rs. ${account.balance.toFixed(2)}</td>
                <td>
                    ${account.balance >= 0 ? '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">POSITIVE</span>' : '<span style="background: #f56565; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">NEGATIVE</span>'}
                </td>
            </tr>
        `;
    });

    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #667eea;">
                            <td colspan="3"><strong>TOTAL OWNER/RELATIVE BALANCE</strong></td>
                            <td style="color: ${totalOwnerBalance >= 0 ? '#48bb78' : '#f56565'}; font-size: 1.2em;">Rs. ${totalOwnerBalance.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Summary -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-top: 30px;">
                <h3 style="color: white; margin-bottom: 15px; text-align: center;">üìä Financial Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Total Receivables</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalReceivables.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Total Payables</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalPayables.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Bank Balance</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalBankBalance.toFixed(2)}</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Vehicle Owner Balance</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalVehicleBalance.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Owner/Relative Balance</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalOwnerBalance.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 10px;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Net Position</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${(totalReceivables - totalPayables + totalBankBalance + totalVehicleBalance + totalOwnerBalance).toFixed(2)}</div>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" style="background: white; color: #667eea; font-weight: 700; padding: 12px 30px;" onclick="printAllPartiesReport()">üñ®Ô∏è Print / Download PDF</button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('reportOutput').innerHTML = html;
    showNotification('All parties report generated! üìã', 'success');
}

function printAllPartiesReport() {
    const reportContent = document.getElementById('reportOutput').innerHTML;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>All Parties Balance Report - Baghoor Oil Traders</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1, h2, h3 { color: #2d3748; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                th { background: #667eea; color: white; }
                .stock-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; }
                .stock-pmg { background: #667eea; color: white; }
                .stock-hsd { background: #f59e0b; color: white; }
                .card { margin: 20px 0; }
                .table-container { overflow-x: auto; }
            </style>
        </head>
        <body>
            ${reportContent}
        </body>
        </html>
    `);
    printWindow.document.close();

    setTimeout(() => {
        printWindow.print();
    }, 500);
}

function generateProfitLossReport() {
    const totalSales = transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
    const totalPurchases = transactions.filter(t => t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);

    // Breakdown expenses by type
    const vehicleExpenses = expenses.filter(e => e.expenseType === 'vehicle').reduce((sum, e) => sum + e.amount, 0);
    const ownerExpenses = expenses.filter(e => e.expenseType === 'owner').reduce((sum, e) => sum + e.amount, 0);
    const generalExpenses = expenses.filter(e => !e.expenseType || e.expenseType === 'general').reduce((sum, e) => sum + e.amount, 0);
    const totalExpenses = vehicleExpenses + ownerExpenses + generalExpenses;

    const grossProfit = totalSales - totalPurchases;
    const netProfit = grossProfit - totalExpenses;

    const html = `
        <div class="card">
            <h2>üìä Profit & Loss Statement</h2>
            <div class="profit-loss-section">
                <div class="profit-loss-item">
                    <span>Total Sales</span>
                    <span style="color: #48bb78; font-weight: 600;">Rs. ${totalSales.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Purchases</span>
                    <span style="color: #f56565; font-weight: 600;">Rs. ${totalPurchases.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Gross Profit</span>
                    <span style="font-weight: 600;">Rs. ${grossProfit.toFixed(2)}</span>
                </div>
                <div style="margin: 15px 0; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <h3 style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.9em;">üí∏ Expense Breakdown</h3>
                    <div class="profit-loss-item" style="padding: 5px 0;">
                        <span>üöó Vehicle Expenses</span>
                        <span style="color: #ed8936; font-weight: 600;">Rs. ${vehicleExpenses.toFixed(2)}</span>
                    </div>
                    <div class="profit-loss-item" style="padding: 5px 0;">
                        <span>üë§ Owner Expenses</span>
                        <span style="color: #ed8936; font-weight: 600;">Rs. ${ownerExpenses.toFixed(2)}</span>
                    </div>
                    <div class="profit-loss-item" style="padding: 5px 0;">
                        <span>üìã General Expenses</span>
                        <span style="color: #ed8936; font-weight: 600;">Rs. ${generalExpenses.toFixed(2)}</span>
                    </div>
                    <div class="profit-loss-item" style="padding: 5px 0; border-top: 1px solid var(--border-color); margin-top: 5px; padding-top: 10px;">
                        <span>Total Expenses</span>
                        <span style="color: #ed8936; font-weight: 700;">Rs. ${totalExpenses.toFixed(2)}</span>
                    </div>
                </div>
                <div class="profit-loss-item total">
                    <span>Net Profit</span>
                    <span style="color: ${netProfit >= 0 ? '#48bb78' : '#f56565'};">Rs. ${netProfit.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Profit & Loss generated!', 'success');
}

function generateMonthlyReport() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    const monthlyTransactions = transactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
    });

    const filteredExpenses = expenses.filter(e => {
        const eDate = new Date(e.date);
        return eDate.getMonth() === currentMonth && eDate.getFullYear() === currentYear;
    });

    // Breakdown monthly expenses by type
    const monthlyVehicleExpenses = filteredExpenses.filter(e => e.expenseType === 'vehicle').reduce((sum, e) => sum + e.amount, 0);
    const monthlyOwnerExpenses = filteredExpenses.filter(e => e.expenseType === 'owner').reduce((sum, e) => sum + e.amount, 0);
    const monthlyGeneralExpenses = filteredExpenses.filter(e => !e.expenseType || e.expenseType === 'general').reduce((sum, e) => sum + e.amount, 0);
    const monthlyExpenses = monthlyVehicleExpenses + monthlyOwnerExpenses + monthlyGeneralExpenses;

    const monthlySales = monthlyTransactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
    const monthlyPurchases = monthlyTransactions.filter(t => t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
    const monthlyProfit = monthlySales - monthlyPurchases - monthlyExpenses;

    const html = `
        <div class="card">
            <h2>üìÖ Monthly Report - ${now.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
            <div class="profit-loss-section">
                <div class="profit-loss-item">
                    <span>Monthly Sales</span>
                    <span style="color: #48bb78; font-weight: 600;">Rs. ${monthlySales.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Monthly Purchases</span>
                    <span style="color: #f56565; font-weight: 600;">Rs. ${monthlyPurchases.toFixed(2)}</span>
                </div>
                <div style="margin: 15px 0; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <h3 style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.9em;">üí∏ Monthly Expense Breakdown</h3>
                    <div class="profit-loss-item" style="padding: 5px 0;">
                        <span>üöó Vehicle Expenses</span>
                        <span style="color: #ed8936; font-weight: 600;">Rs. ${monthlyVehicleExpenses.toFixed(2)}</span>
                    </div>
                    <div class="profit-loss-item" style="padding: 5px 0;">
                        <span>üë§ Owner Expenses</span>
                        <span style="color: #ed8936; font-weight: 600;">Rs. ${monthlyOwnerExpenses.toFixed(2)}</span>
                    </div>
                    <div class="profit-loss-item" style="padding: 5px 0;">
                        <span>üìã General Expenses</span>
                        <span style="color: #ed8936; font-weight: 600;">Rs. ${monthlyGeneralExpenses.toFixed(2)}</span>
                    </div>
                    <div class="profit-loss-item" style="padding: 5px 0; border-top: 1px solid var(--border-color); margin-top: 5px; padding-top: 10px;">
                        <span>Total Monthly Expenses</span>
                        <span style="color: #ed8936; font-weight: 700;">Rs. ${monthlyExpenses.toFixed(2)}</span>
                    </div>
                </div>
                <div class="profit-loss-item">
                    <span>Total Transactions</span>
                    <span style="font-weight: 600;">${monthlyTransactions.length}</span>
                </div>
                <div class="profit-loss-item total">
                    <span>Monthly Net Profit</span>
                    <span style="color: ${monthlyProfit >= 0 ? '#48bb78' : '#f56565'};">Rs. ${monthlyProfit.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Monthly report generated!', 'success');
}

function generateVehicleProfitReport() {
    let html = '<div class="card"><h2>üöõ Vehicle-wise Profit Analysis</h2><div class="table-container"><table><thead><tr><th>Vehicle</th><th>Driver</th><th>Total Sales</th><th>Total Purchases</th><th>Profit/Loss</th><th>PMG Stock</th><th>HSD Stock</th><th>Deliveries</th></tr></thead><tbody>';
    
    let totalSalesAll = 0;
    let totalPurchasesAll = 0;
    let totalProfitAll = 0;
    
    vehicles.forEach(vehicle => {
        // Calculate ACTUAL sales from this vehicle
        const vehicleSales = transactions.filter(t => t.vehicleId === vehicle.id && t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
        
        // Calculate ACTUAL purchases into this vehicle
        const vehiclePurchases = transactions.filter(t => t.vehicleId === vehicle.id && t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
        
        // Calculate REAL profit = Sales - Purchases
        const actualProfit = vehicleSales - vehiclePurchases;
        
        // Count deliveries
        const deliveryCount = transactions.filter(t => t.vehicleId === vehicle.id).length;
        
        totalSalesAll += vehicleSales;
        totalPurchasesAll += vehiclePurchases;
        totalProfitAll += actualProfit;
        
        html += `
            <tr>
                <td><strong>${vehicle.number}</strong></td>
                <td>${vehicle.driverName}</td>
                <td style="color: #48bb78; font-weight: 700;">Rs. ${vehicleSales.toFixed(2)}</td>
                <td style="color: #ed8936; font-weight: 700;">Rs. ${vehiclePurchases.toFixed(2)}</td>
                <td style="color: ${actualProfit >= 0 ? '#667eea' : '#f56565'}; font-weight: 700; font-size: 1.1em;">
                    Rs. ${actualProfit.toFixed(2)}
                    ${actualProfit >= 0 ? '‚úÖ' : '‚ö†Ô∏è'}
                </td>
                <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
                <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
                <td>${deliveryCount}</td>
            </tr>
        `;
    });
    
    // Add totals row
    html += `
        <tr style="background: #f7fafc; font-weight: 700; font-size: 1.1em; border-top: 3px solid #667eea;">
            <td colspan="2"><strong>TOTAL</strong></td>
            <td style="color: #48bb78;">Rs. ${totalSalesAll.toFixed(2)}</td>
            <td style="color: #ed8936;">Rs. ${totalPurchasesAll.toFixed(2)}</td>
            <td style="color: ${totalProfitAll >= 0 ? '#667eea' : '#f56565'}; font-size: 1.2em;">
                Rs. ${totalProfitAll.toFixed(2)}
                ${totalProfitAll >= 0 ? 'üéâ' : '‚ö†Ô∏è'}
            </td>
            <td colspan="3"></td>
        </tr>
    `;
    
    html += '</tbody></table></div>';
    
    // Add summary section
    html += `
        <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 10px; border-left: 4px solid #667eea;">
            <h3 style="color: #667eea; margin-bottom: 10px;">üìä Summary</h3>
            <p style="margin: 5px 0;"><strong>Total Sales:</strong> Rs. ${totalSalesAll.toFixed(2)}</p>
            <p style="margin: 5px 0;"><strong>Total Purchases:</strong> Rs. ${totalPurchasesAll.toFixed(2)}</p>
            <p style="margin: 5px 0;"><strong>Overall Profit:</strong> <span style="color: ${totalProfitAll >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700; font-size: 1.2em;">Rs. ${totalProfitAll.toFixed(2)}</span></p>
            <p style="margin: 5px 0; color: #718096; font-size: 0.9em;"><em>Note: This shows actual profit (Sales - Purchases) for each vehicle</em></p>
        </div>
    `;
    
    html += '</div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Vehicle profit report generated! üöõ', 'success');
}

function generateStockReport() {
    let totalPMG = 0;
    let totalHSD = 0;
    
    let html = '<div class="card"><h2>üì¶ Stock Report</h2><div class="table-container"><table><thead><tr><th>Vehicle</th><th>PMG Stock (KL)</th><th>HSD Stock (KL)</th><th>Total Stock (KL)</th></tr></thead><tbody>';
    
    vehicles.forEach(vehicle => {
        const totalStock = vehicle.stockPMG + vehicle.stockHSD;
        totalPMG += vehicle.stockPMG;
        totalHSD += vehicle.stockHSD;
        
        html += `
            <tr>
                <td><strong>${vehicle.number}</strong></td>
                <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
                <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
                <td style="font-weight: 700;">${totalStock.toFixed(2)} KL</td>
            </tr>
        `;
    });
    
    html += `
        <tr style="background: #f7fafc; font-weight: 700;">
            <td>TOTAL</td>
            <td><span class="stock-badge stock-pmg">${totalPMG.toFixed(2)} KL</span></td>
            <td><span class="stock-badge stock-hsd">${totalHSD.toFixed(2)} KL</span></td>
            <td style="color: #667eea; font-size: 1.2em;">${(totalPMG + totalHSD).toFixed(2)} KL</td>
        </tr>
    `;
    
    html += '</tbody></table></div></div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Stock report generated!', 'success');
}

function generateExpenseReport() {
    const expensesByCategory = {};
    expenses.forEach(e => {
        if (!expensesByCategory[e.category]) {
            expensesByCategory[e.category] = 0;
        }
        expensesByCategory[e.category] += e.amount;
    });
    
    let html = '<div class="card"><h2>üí∏ Expense Report by Category</h2><div class="table-container"><table><thead><tr><th>Category</th><th>Total Amount</th><th>Count</th></tr></thead><tbody>';
    
    Object.keys(expensesByCategory).forEach(category => {
        const count = expenses.filter(e => e.category === category).length;
        html += `
            <tr>
                <td><strong>${category}</strong></td>
                <td style="color: #f56565; font-weight: 700;">Rs. ${expensesByCategory[category].toFixed(2)}</td>
                <td>${count}</td>
            </tr>
        `;
    });
    
    const totalExpenses = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);
    html += `
        <tr style="background: #f7fafc; font-weight: 700;">
            <td>TOTAL</td>
            <td style="color: #f56565;">Rs. ${totalExpenses.toFixed(2)}</td>
            <td>${expenses.length}</td>
        </tr>
    `;
    
    html += '</tbody></table></div></div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Expense report generated!', 'success');
}

// EXPORT FUNCTIONS
function exportVehicleProfitPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Vehicle-wise Profit & Stock Analysis', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 32, { align: 'center' });
    doc.text(`Generated by: ${currentUser}`, 105, 38, { align: 'center' });
    
    const tableData = vehicles.map(v => {
        const vehicleSales = transactions.filter(t => t.vehicleId === v.id && t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
        const vehiclePurchases = transactions.filter(t => t.vehicleId === v.id && t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
        const actualProfit = vehicleSales - vehiclePurchases;
        
        return [
            v.number,
            v.driverName,
            `Rs. ${vehicleSales.toFixed(2)}`,
            `Rs. ${vehiclePurchases.toFixed(2)}`,
            `Rs. ${actualProfit.toFixed(2)}`,
            `${v.stockPMG.toFixed(2)} KL`,
            `${v.stockHSD.toFixed(2)} KL`
        ];
    });
    
    doc.autoTable({
        startY: 45,
        head: [['Vehicle', 'Driver', 'Sales', 'Purchases', 'Actual Profit', 'PMG Stock', 'HSD Stock']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`vehicle-profit-report-${Date.now()}.pdf`);
    showNotification('PDF exported! üìÑ', 'success');
}

function exportCustomerLedgerPDF() {
    const customerId = document.getElementById('customerReportSelect').value;
    const fromDate = document.getElementById('customerReportFromDate').value;
    const toDate = document.getElementById('customerReportToDate').value;
    
    if (!customerId) {
        showNotification('Please select a customer first!', 'error');
        return;
    }
    
    const customer = customers.find(c => c.id === customerId);
    if (!customer) {
        showNotification('Customer not found!', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Customer Ledger Report', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Period: ${fromDate || 'Start'} to ${toDate || 'Today'}`, 105, 32, { align: 'center' });
    
    // Customer info
    doc.setFontSize(11);
    doc.text(`Customer: ${customer.name}`, 20, 45);
    doc.text(`Contact: ${customer.contact || 'N/A'}`, 20, 52);
    doc.text(`Balance: Rs. ${customer.balance.toFixed(2)}`, 20, 59);
    
    // Filter transactions
    let customerSales = transactions.filter(t => t.partyId === customerId && t.type === 'sale');
    let customerPayments = payments.filter(p => p.partyId === customerId && p.type === 'received');
    
    if (fromDate) {
        customerSales = customerSales.filter(t => t.date >= fromDate);
        customerPayments = customerPayments.filter(p => p.date >= fromDate);
    }
    if (toDate) {
        customerSales = customerSales.filter(t => t.date <= toDate);
        customerPayments = customerPayments.filter(p => p.date <= toDate);
    }
    
    const allEntries = [
        ...customerSales.map(t => ({
            date: t.date,
            type: 'Sale',
            details: `${t.fuelType} - ${t.quantity.toFixed(2)}L`,
            debit: t.amount,
            credit: 0
        })),
        ...customerPayments.map(p => ({
            date: p.date,
            type: 'Payment',
            details: p.method,
            debit: 0,
            credit: p.amount
        }))
    ].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const tableData = allEntries.map(entry => [
        new Date(entry.date).toLocaleDateString(),
        entry.type,
        entry.details,
        entry.debit > 0 ? `Rs. ${entry.debit.toFixed(2)}` : '-',
        entry.credit > 0 ? `Rs. ${entry.credit.toFixed(2)}` : '-'
    ]);
    
    doc.autoTable({
        startY: 70,
        head: [['Date', 'Type', 'Details', 'Debit (Sales)', 'Credit (Payment)']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`customer-ledger-${customer.name}-${Date.now()}.pdf`);
    showNotification('Customer ledger PDF exported! üìÑ', 'success');
}

function exportSingleVehiclePDF() {
    const vehicleId = document.getElementById('vehicleReportSelect').value;
    const fromDate = document.getElementById('vehicleReportFromDate').value;
    const toDate = document.getElementById('vehicleReportToDate').value;
    
    if (!vehicleId) {
        showNotification('Please select a vehicle first!', 'error');
        return;
    }
    
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
        showNotification('Vehicle not found!', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Vehicle Profit Report', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Period: ${fromDate || 'Start'} to ${toDate || 'Today'}`, 105, 32, { align: 'center' });
    
    // Vehicle info
    let vehicleSales = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'sale');
    let vehiclePurchases = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'purchase');
    
    if (fromDate) {
        vehicleSales = vehicleSales.filter(t => t.date >= fromDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date >= fromDate);
    }
    if (toDate) {
        vehicleSales = vehicleSales.filter(t => t.date <= toDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date <= toDate);
    }
    
    const totalSales = vehicleSales.reduce((sum, t) => sum + t.amount, 0);
    const totalPurchases = vehiclePurchases.reduce((sum, t) => sum + t.amount, 0);
    const profit = totalSales - totalPurchases;
    
    doc.setFontSize(11);
    doc.text(`Vehicle: ${vehicle.number}`, 20, 45);
    doc.text(`Driver: ${vehicle.driverName}`, 20, 52);
    doc.text(`Sales: Rs. ${totalSales.toFixed(2)}`, 20, 59);
    doc.text(`Purchases: Rs. ${totalPurchases.toFixed(2)}`, 20, 66);
    doc.text(`Profit: Rs. ${profit.toFixed(2)}`, 20, 73);
    
    const allTransactions = [...vehicleSales, ...vehiclePurchases].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tableData = allTransactions.map(trans => [
        new Date(trans.date).toLocaleDateString(),
        trans.type.toUpperCase(),
        trans.partyName,
        trans.fuelType,
        `${trans.quantity.toFixed(2)}L`,
        `Rs. ${trans.amount.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: 82,
        head: [['Date', 'Type', 'Party', 'Fuel', 'Quantity', 'Amount']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`vehicle-report-${vehicle.number}-${Date.now()}.pdf`);
    showNotification('Vehicle report PDF exported! üìÑ', 'success');
}

function exportAllPartiesPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('All Parties Balance Report', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 32, { align: 'center' });
    doc.text(`Generated by: ${currentUser}`, 105, 38, { align: 'center' });
    
    let startY = 48;
    
    // Customers
    doc.setFontSize(11);
    doc.text('CUSTOMERS (Receivables)', 20, startY);
    const customerData = customers.map(c => [
        c.name,
        c.contact || 'N/A',
        `Rs. ${c.balance.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: startY + 5,
        head: [['Name', 'Contact', 'Balance']],
        body: customerData,
        theme: 'striped',
        headStyles: { fillColor: [72, 187, 120] }
    });
    
    startY = doc.lastAutoTable.finalY + 15;
    
    // Suppliers
    doc.text('SUPPLIERS (Payables)', 20, startY);
    const supplierData = suppliers.map(s => [
        s.name,
        s.contact || 'N/A',
        `Rs. ${s.balance.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: startY + 5,
        head: [['Name', 'Contact', 'Balance']],
        body: supplierData,
        theme: 'striped',
        headStyles: { fillColor: [237, 137, 54] }
    });
    
    startY = doc.lastAutoTable.finalY + 15;
    
    // Banks
    if (startY > 250) {
        doc.addPage();
        startY = 20;
    }
    
    doc.text('BANK ACCOUNTS', 20, startY);
    const bankData = banks.map(b => [
        b.name,
        b.accountNumber,
        `Rs. ${b.balance.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: startY + 5,
        head: [['Bank Name', 'Account Number', 'Balance']],
        body: bankData,
        theme: 'striped',
        headStyles: { fillColor: [66, 153, 225] }
    });
    
    doc.save(`all-parties-balance-${Date.now()}.pdf`);
    showNotification('All parties report PDF exported! üìÑ', 'success');
}

function exportAllDataExcel() {
    const wb = XLSX.utils.book_new();
    
    // Customers
    const customersData = customers.map(c => ({
        Name: c.name,
        Contact: c.contact,
        CNIC: c.cnic,
        'PMG Rate': c.pmgRate,
        'HSD Rate': c.hsdRate,
        Balance: c.balance,
        Address: c.address
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(customersData), 'Customers');
    
    // Suppliers
    const suppliersData = suppliers.map(s => ({
        Name: s.name,
        Contact: s.contact,
        CNIC: s.cnic,
        'PMG Rate (Self)': s.pmgRateSelf || s.pmgRate || 0,
        'PMG Rate (PSO)': s.pmgRatePSO || 'N/A',
        'HSD Rate (Self)': s.hsdRateSelf || s.hsdRate || 0,
        'HSD Rate (PSO)': s.hsdRatePSO || 'N/A',
        'Default Carriage': s.defaultCarriage === 'pso' ? 'PSO' : 'Self',
        Balance: s.balance,
        Address: s.address
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(suppliersData), 'Suppliers');
    
    // Transactions
    const transData = transactions.map(t => ({
        Date: t.date,
        Type: t.type,
        Party: t.partyName,
        'Fuel Type': t.fuelType,
        Quantity: t.quantity,
        Rate: t.rate,
        Amount: t.amount
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transData), 'Transactions');
    
    // Payments
    const paymentsData = payments.map(p => ({
        Date: p.date,
        Type: p.type,
        Party: p.partyName,
        Amount: p.amount,
        Method: p.method,
        Notes: p.notes
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(paymentsData), 'Payments');
    
    // Expenses
    const expensesData = expenses.map(e => ({
        Date: e.date,
        Category: e.category,
        Description: e.description,
        Amount: e.amount,
        Source: e.source,
        Method: e.method
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expensesData), 'Expenses');
    
    // Vehicles with Stock
    const vehiclesData = vehicles.map(v => ({
        'Vehicle Number': v.number,
        Driver: v.driverName,
        Contact: v.contact,
        Status: v.status,
        'PMG Stock (KL)': v.stockPMG.toFixed(2),
        'HSD Stock (KL)': v.stockHSD.toFixed(2)
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(vehiclesData), 'Vehicles');
    
    // Banks
    const banksData = banks.map(b => ({
        'Bank Name': b.name,
        'Account Number': b.accountNumber,
        Balance: b.balance
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(banksData), 'Banks');
    
    // Ledger
    const ledgerData = ledgerEntries.map(l => ({
        Date: l.date,
        Type: l.type,
        Description: l.description,
        'Debit Account': l.debitAccount,
        'Debit Amount': l.debitAmount,
        'Credit Account': l.creditAccount,
        'Credit Amount': l.creditAmount
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ledgerData), 'Ledger');
    
    XLSX.writeFile(wb, `baghoor-complete-${Date.now()}.xlsx`);
    showNotification('Excel exported! üìä', 'success');
}

// BACKUP FUNCTIONS
function createBackup() {
    // Create workbook
    const wb = XLSX.utils.book_new();
    
    // Backup metadata
    const metadata = [{
        'Backup Version': '4.0',
        'Created Date': new Date().toLocaleDateString(),
        'Created Time': new Date().toLocaleTimeString(),
        'Created By': currentUser || 'System',
        'Total Customers': customers.length,
        'Total Suppliers': suppliers.length,
        'Total Vehicles': vehicles.length,
        'Total Banks': banks.length,
        'Total Transactions': transactions.length
    }];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(metadata), 'Backup Info');
    
    // Customers
    const customersData = customers.map(c => ({
        ID: c.id,
        Name: c.name,
        Contact: c.contact || '',
        CNIC: c.cnic || '',
        'PMG Rate': c.pmgRate,
        'HSD Rate': c.hsdRate,
        Balance: c.balance,
        Address: c.address || '',
        Notes: c.notes || '',
        'Created At': c.createdAt
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(customersData), 'Customers');
    
    // Suppliers
    const suppliersData = suppliers.map(s => ({
        ID: s.id,
        Name: s.name,
        Contact: s.contact || '',
        CNIC: s.cnic || '',
        'PMG Rate (Self)': s.pmgRateSelf || s.pmgRate || 0,
        'PMG Rate (PSO)': s.pmgRatePSO || 0,
        'HSD Rate (Self)': s.hsdRateSelf || s.hsdRate || 0,
        'HSD Rate (PSO)': s.hsdRatePSO || 0,
        'Default Carriage': s.defaultCarriage || 'self',
        Balance: s.balance,
        Address: s.address || '',
        Notes: s.notes || '',
        'Created At': s.createdAt
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(suppliersData), 'Suppliers');
    
    // Vehicles
    const vehiclesData = vehicles.map(v => ({
        ID: v.id,
        Number: v.number,
        Driver: v.driver,
        Contact: v.contact,
        Status: v.status,
        'Stock PMG (KL)': v.stockPMG,
        'Stock HSD (KL)': v.stockHSD,
        'Owner Name': v.ownerName || '',
        'Owner Contact': v.ownerContact || '',
        'Owner Balance': v.ownerBalance || 0
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(vehiclesData), 'Vehicles');
    
    // Banks
    const banksData = banks.map(b => ({
        ID: b.id,
        Name: b.name,
        'Account Number': b.accountNumber,
        Balance: b.balance,
        'Created At': b.createdAt
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(banksData), 'Banks');
    
    // Transactions
    const transactionsData = transactions.map(t => ({
        ID: t.id,
        Date: t.date,
        Type: t.type,
        'Customer/Supplier': t.customerName || t.supplierName || '',
        'Fuel Type': t.fuelType,
        'Quantity (L)': t.quantity,
        'Rate (Rs/L)': t.rate,
        Amount: t.amount,
        Description: t.description || '',
        Vehicle: t.vehicleNumber || '',
        'Created By': t.createdBy || '',
        'Created At': t.createdAt
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transactionsData), 'Transactions');
    
    // Payments
    const paymentsData = payments.map(p => ({
        ID: p.id,
        Date: p.date,
        Type: p.type,
        'Party Name': p.partyName,
        Amount: p.amount,
        Method: p.method,
        Description: p.description || '',
        'Created By': p.createdBy || '',
        'Created At': p.createdAt
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(paymentsData), 'Payments');
    
    // Expenses
    const expensesData = expenses.map(e => ({
        ID: e.id,
        Date: e.date,
        Category: e.category,
        Description: e.description,
        Amount: e.amount,
        Method: e.method,
        Source: e.source,
        'Created At': e.createdAt
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expensesData), 'Expenses');
    
    // Bank Transactions
    const bankTransData = bankTransactions.map(bt => ({
        ID: bt.id,
        Date: bt.date,
        Bank: bt.bankName,
        Type: bt.type,
        Amount: bt.amount,
        Description: bt.description || '',
        'Balance After': bt.balanceAfter,
        'Created By': bt.createdBy || '',
        'Created At': bt.createdAt
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(bankTransData), 'Bank Transactions');
    
    // JV Vouchers
    if (jvVouchers && jvVouchers.length > 0) {
        const jvData = jvVouchers.map(jv => ({
            ID: jv.id,
            Date: jv.date,
            Description: jv.description,
            'Debit Type': jv.debitType,
            'Debit Account': jv.debitAccount,
            'Debit Amount': jv.debitAmount,
            'Credit Type': jv.creditType,
            'Credit Account': jv.creditAccount,
            'Credit Amount': jv.creditAmount,
            'Created By': jv.createdBy || '',
            'Created At': jv.createdAt
        }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(jvData), 'JV Vouchers');
    }
    
    // Owner Accounts
    if (ownerAccounts && ownerAccounts.length > 0) {
        const ownerData = ownerAccounts.map(a => ({
            ID: a.id,
            Name: a.name,
            Type: a.type === 'owner' ? 'Owner Capital' : 'Relative',
            Contact: a.contact || '',
            CNIC: a.cnic || '',
            Balance: a.balance,
            Notes: a.notes || '',
            'Created At': a.createdAt
        }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ownerData), 'Owner Accounts');
    }
    
    // Download Excel
    const fileName = `Baghoor-Backup-${new Date().toISOString().split('T')[0]}-${Date.now()}.xlsx`;
    XLSX.writeFile(wb, fileName);

    // Also create JSON backup for restore functionality
    const jsonBackup = {
        version: '4.0',
        timestamp: new Date().toISOString(),
        createdBy: currentUser || 'System',
        data: {
            customers: customers,
            suppliers: suppliers,
            vehicles: vehicles,
            banks: banks,
            transactions: transactions,
            payments: payments,
            expenses: expenses,
            customerTransfers: customerTransfers,
            bankTransactions: bankTransactions,
            rateChangeLogs: rateChangeLogs,
            ledgerEntries: ledgerEntries,
            jvVouchers: jvVouchers,
            ownerAccounts: ownerAccounts,
            systemUsers: systemUsers
        }
    };

    const jsonBlob = new Blob([JSON.stringify(jsonBackup, null, 2)], { type: 'application/json' });
    const jsonUrl = URL.createObjectURL(jsonBlob);
    const jsonLink = document.createElement('a');
    jsonLink.href = jsonUrl;
    jsonLink.download = `Baghoor-Backup-${new Date().toISOString().split('T')[0]}-${Date.now()}.json`;
    jsonLink.click();

    showNotification('‚úÖ Complete backup downloaded (Excel + JSON)! üíæ', 'success');
}

function restoreBackup() {
    const fileInput = document.getElementById('backupFile');
    const file = fileInput.files[0];

    if (!file) {
        showNotification('Please select a backup file!', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);

            if (backup.data) {
                // Restore all data
                customers = backup.data.customers || [];
                suppliers = backup.data.suppliers || [];
                vehicles = backup.data.vehicles || [];
                banks = backup.data.banks || [];
                transactions = backup.data.transactions || [];
                payments = backup.data.payments || [];
                expenses = backup.data.expenses || [];
                customerTransfers = backup.data.customerTransfers || [];
                bankTransactions = backup.data.bankTransactions || [];
                rateChangeLogs = backup.data.rateChangeLogs || [];
                ledgerEntries = backup.data.ledgerEntries || [];
                jvVouchers = backup.data.jvVouchers || [];
                ownerAccounts = backup.data.ownerAccounts || [];
                systemUsers = backup.data.systemUsers || [];

                saveToStorage();

                // Re-render all UI components
                renderCustomers();
                renderSuppliers();
                renderVehicles();
                renderBanks();
                renderTransactions();
                renderPayments();
                renderExpenses();
                updateDashboard();
                populateDropdowns();

                closeModal('backupModal');
                showNotification('Backup restored successfully! üéâ Please refresh the page.', 'success');

                // Auto-refresh after 2 seconds
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification('Invalid backup file format!', 'error');
                console.error('Backup file missing data property');
            }
        } catch (err) {
            showNotification('Error reading backup file: ' + err.message, 'error');
            console.error('Backup restore error:', err);
        }
    };

    reader.onerror = function() {
        showNotification('Failed to read file!', 'error');
    };

    reader.readAsText(file);
}

// INDIVIDUAL DATA EXPORT & RESTORE FUNCTIONS

// ===== CUSTOMERS =====
function exportCustomersPDF() {
    window.print(); // Simple print for now - in production, use jsPDF
    showNotification('Use Print dialog to save as PDF', 'success');
}

function exportCustomersJSON() {
    const data = { customers: customers };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'customers-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    showNotification('Customers backup downloaded! üíæ', 'success');
}

function restoreCustomers() {
    const file = document.getElementById('customersRestoreFile').files[0];
    if (!file) {
        showNotification('Please select a file!', 'error');
        return;
    }
    
    if (!confirm('This will REPLACE all existing customers! Continue?')) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            if (backup.customers) {
                customers = backup.customers;
                saveToStorage();
                renderCustomers();
                updateDashboard();
                showNotification('Customers restored! ‚úÖ', 'success');
            } else {
                showNotification('Invalid customers backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading file!', 'error');
        }
    };
    reader.readAsText(file);
}

// ===== SUPPLIERS =====
function exportSuppliersPDF() {
    window.print();
    showNotification('Use Print dialog to save as PDF', 'success');
}

function exportSuppliersJSON() {
    const data = { suppliers: suppliers };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'suppliers-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    showNotification('Suppliers backup downloaded! üíæ', 'success');
}

function restoreSuppliers() {
    const file = document.getElementById('suppliersRestoreFile').files[0];
    if (!file) {
        showNotification('Please select a file!', 'error');
        return;
    }
    
    if (!confirm('This will REPLACE all existing suppliers! Continue?')) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            if (backup.suppliers) {
                suppliers = backup.suppliers;
                saveToStorage();
                renderSuppliers();
                updateDashboard();
                showNotification('Suppliers restored! ‚úÖ', 'success');
            } else {
                showNotification('Invalid suppliers backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading file!', 'error');
        }
    };
    reader.readAsText(file);
}

// ===== VEHICLES =====
function exportVehiclesPDF() {
    window.print();
    showNotification('Use Print dialog to save as PDF', 'success');
}

function exportVehiclesJSON() {
    const data = { vehicles: vehicles };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'vehicles-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    showNotification('Vehicles backup downloaded! üíæ', 'success');
}

function restoreVehicles() {
    const file = document.getElementById('vehiclesRestoreFile').files[0];
    if (!file) {
        showNotification('Please select a file!', 'error');
        return;
    }
    
    if (!confirm('This will REPLACE all existing vehicles! Continue?')) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            if (backup.vehicles) {
                vehicles = backup.vehicles;
                saveToStorage();
                renderVehicles();
                updateDashboard();
                showNotification('Vehicles restored! ‚úÖ', 'success');
            } else {
                showNotification('Invalid vehicles backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading file!', 'error');
        }
    };
    reader.readAsText(file);
}

// ===== BANKS =====
function exportBanksPDF() {
    window.print();
    showNotification('Use Print dialog to save as PDF', 'success');
}

function exportBanksJSON() {
    const data = { banks: banks, bankTransactions: bankTransactions };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'banks-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    showNotification('Banks backup downloaded! üíæ', 'success');
}

function restoreBanks() {
    const file = document.getElementById('banksRestoreFile').files[0];
    if (!file) {
        showNotification('Please select a file!', 'error');
        return;
    }
    
    if (!confirm('This will REPLACE all existing banks and bank transactions! Continue?')) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            if (backup.banks) {
                banks = backup.banks;
                bankTransactions = backup.bankTransactions || [];
                saveToStorage();
                renderBanks();
                renderBankTransactions();
                updateDashboard();
                showNotification('Banks restored! ‚úÖ', 'success');
            } else {
                showNotification('Invalid banks backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading file!', 'error');
        }
    };
    reader.readAsText(file);
}

// UI HELPER FUNCTIONS
function updateDashboard() {
    document.getElementById('totalCustomers').textContent = customers.length;
    document.getElementById('totalSuppliers').textContent = suppliers.length;
    document.getElementById('totalVehicles').textContent = vehicles.length;
    document.getElementById('totalBanks').textContent = banks.length;
    
    const totalReceivables = customers.reduce((sum, c) => sum + (c.balance > 0 ? c.balance : 0), 0);
    document.getElementById('totalReceivables').textContent = 'Rs. ' + totalReceivables.toFixed(2);
    
    const totalPayables = suppliers.reduce((sum, s) => sum + (s.balance > 0 ? s.balance : 0), 0);
    document.getElementById('totalPayables').textContent = 'Rs. ' + totalPayables.toFixed(2);
    
    const totalBankBalance = banks.reduce((sum, b) => sum + b.balance, 0);
    document.getElementById('totalBankBalance').textContent = 'Rs. ' + totalBankBalance.toFixed(2);
    
    const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('totalExpenses').textContent = 'Rs. ' + totalExpenses.toFixed(2);
    
    const totalStock = vehicles.reduce((sum, v) => sum + v.stockPMG + v.stockHSD, 0);
    document.getElementById('totalStock').textContent = totalStock.toFixed(2) + ' KL';
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
    
    if (tabName === 'ledger') {
        generateLedger();
    } else if (tabName === 'jvouchers') {
        renderJVVouchers();
    } else if (tabName === 'owneraccounts') {
        renderOwnerAccounts();
    }
}

function openModal(modalId) {
    // Special handling for admin settings modal
    if (modalId === 'adminSettingsModal') {
        if (currentRole !== 'admin') {
            showNotification('Only admin can access this!', 'error');
            return;
        }
        renderUserManagement();
    }
    
    // Clear supplier form ONLY when opening to add new (not when editing)
    if (modalId === 'supplierModal') {
        // Check if we're editing (ID exists) or adding new (ID empty)
        const isEditing = document.getElementById('supplierId').value !== '';
        
        if (!isEditing) {
            // Only clear if adding new
            document.getElementById('supplierId').value = '';
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierContact').value = '';
            document.getElementById('supplierCnic').value = '';
            document.getElementById('supplierPmgRateSelf').value = '';
            document.getElementById('supplierHsdRateSelf').value = '';
            document.getElementById('supplierPmgRatePSO').value = '';
            document.getElementById('supplierHsdRatePSO').value = '';
            document.getElementById('supplierDefaultCarriage').value = 'self';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierNotes').value = '';
            const supplierBalanceField = document.getElementById('supplierOpeningBalance');
            supplierBalanceField.value = '0';
            supplierBalanceField.disabled = false;
            supplierBalanceField.style.backgroundColor = '';
            supplierBalanceField.title = 'Enter opening balance if supplier has previous balance';
        }
    }
    
    // Clear customer form ONLY when opening to add new (not when editing)
    if (modalId === 'customerModal') {
        // Check if we're editing (ID exists) or adding new (ID empty)
        const isEditing = document.getElementById('customerId').value !== '';
        
        if (!isEditing) {
            // Only clear if adding new
            document.getElementById('customerId').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerContact').value = '';
            document.getElementById('customerCnic').value = '';
            document.getElementById('customerPmgRate').value = '';
            document.getElementById('customerHsdRate').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerNotes').value = '';
            const customerBalanceField = document.getElementById('customerOpeningBalance');
            customerBalanceField.value = '0';
            customerBalanceField.disabled = false;
            customerBalanceField.style.backgroundColor = '';
            customerBalanceField.title = 'Enter opening balance if customer has previous balance';
        }
    }
    
    // Clear vehicle form ONLY when opening to add new (not when editing)
    if (modalId === 'vehicleModal') {
        const isEditing = document.getElementById('vehicleId').value !== '';
        
        if (!isEditing) {
            document.getElementById('vehicleId').value = '';
            document.getElementById('vehicleNumber').value = '';
            document.getElementById('vehicleDriver').value = '';
            document.getElementById('vehicleContact').value = '';
            document.getElementById('vehicleStatus').value = 'Active';
        }
    }
    
    // Clear owner account form ONLY when opening to add new
    if (modalId === 'ownerAccountModal') {
        const isEditing = document.getElementById('ownerAccountId').value !== '';
        
        if (!isEditing) {
            document.getElementById('ownerAccountId').value = '';
            document.getElementById('ownerAccountType').value = '';
            document.getElementById('ownerAccountName').value = '';
            document.getElementById('ownerAccountContact').value = '';
            document.getElementById('ownerAccountCnic').value = '';
            document.getElementById('ownerAccountNotes').value = '';
            const balanceField = document.getElementById('ownerAccountOpeningBalance');
            balanceField.value = '0';
            balanceField.disabled = false;
            balanceField.style.backgroundColor = '';
            balanceField.title = 'Enter opening balance if account has previous balance';
        }
    }
    
    // Initialize JV modal
    if (modalId === 'jvModal') {
        initJVModal();
    }

    // Initialize invoice modal
    if (modalId === 'invoiceModal') {
        initInvoiceModal();
    }

    // Populate dropdowns for payment modal
    if (modalId === 'paymentModal') {
        populateDropdowns();
        updatePaymentParties();
    }

    // Populate dropdowns for expense modal
    if (modalId === 'expenseModal') {
        populateDropdowns();
    }

    // Populate dropdowns for bank transaction modal
    if (modalId === 'bankTransModal') {
        populateDropdowns();
    }

    // Populate dropdowns for customer transfer modal
    if (modalId === 'customerTransferModal') {
        populateDropdowns();
    }

    // Populate dropdowns for sale modal
    if (modalId === 'saleModal') {
        populateDropdowns();
    }

    // Populate dropdowns for purchase modal
    if (modalId === 'purchaseModal') {
        populateDropdowns();
    }

    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function populateDropdowns() {
    // Customers
    const customerSelects = [
        document.getElementById('saleCustomerId'),
        document.getElementById('transferFromCustomerId'),
        document.getElementById('transferToCustomerId'),
        document.getElementById('expenseCustomerId')
    ];
    
    customerSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }
    });
    
    // Customer Report Dropdown
    const customerReportSelect = document.getElementById('customerReportSelect');
    if (customerReportSelect) {
        customerReportSelect.innerHTML = '<option value="">Choose Customer</option>';
        customers.forEach(c => {
            customerReportSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
    }
    
    // Suppliers
    const supplierSelect = document.getElementById('purchaseSupplierId');
    supplierSelect.innerHTML = '<option value="">Select Supplier</option>';
    suppliers.forEach(s => {
        supplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
    });
    
    // Vehicles
    const vehicleSelects = [
        document.getElementById('saleVehicleId'),
        document.getElementById('purchaseVehicleId'),
        document.getElementById('expenseVehicleId')
    ];

    vehicleSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Vehicle</option>';
            vehicles.forEach(v => {
                select.innerHTML += `<option value="${v.id}">${v.number} - ${v.driverName} (PMG: ${v.stockPMG.toFixed(2)}KL, HSD: ${v.stockHSD.toFixed(2)}KL)</option>`;
            });
        }
    });
    
    // Vehicle Report Dropdown
    const vehicleReportSelect = document.getElementById('vehicleReportSelect');
    if (vehicleReportSelect) {
        vehicleReportSelect.innerHTML = '<option value="">Choose Vehicle</option>';
        vehicles.forEach(v => {
            vehicleReportSelect.innerHTML += `<option value="${v.id}">${v.number} - ${v.driverName}</option>`;
        });
    }
    
    // Banks
    const bankSelects = [
        document.getElementById('paymentBankId'),
        document.getElementById('expenseBankId'),
        document.getElementById('bankTransBankId')
    ];
    
    bankSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Bank</option>';
            banks.forEach(b => {
                select.innerHTML += `<option value="${b.id}">${b.name} - ${b.accountNumber}</option>`;
            });
        }
    });
}

// JV VOUCHER FUNCTIONS
function updateJVDebitAccounts() {
    const type = document.getElementById('jvDebitType').value;
    const accountSelect = document.getElementById('jvDebitAccount');
    const otherInput = document.getElementById('jvDebitOther');

    accountSelect.innerHTML = '<option value="">Select Account</option>';
    otherInput.style.display = 'none';

    if (type === 'customer') {
        customers.forEach(c => accountSelect.innerHTML += `<option value="customer_${c.id}">${c.name}</option>`);
    } else if (type === 'supplier') {
        suppliers.forEach(s => accountSelect.innerHTML += `<option value="supplier_${s.id}">${s.name}</option>`);
    } else if (type === 'bank') {
        banks.forEach(b => accountSelect.innerHTML += `<option value="bank_${b.id}">${b.name}</option>`);
    } else if (type === 'vehicle') {
        vehicles.forEach(v => accountSelect.innerHTML += `<option value="vehicle_${v.id}">${v.number} - ${v.ownerName || 'Owner'}</option>`);
    } else if (type === 'owner') {
        ownerAccounts.forEach(a => {
            const icon = a.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
            accountSelect.innerHTML += `<option value="owner_${a.id}">${icon} ${a.name}</option>`;
        });
    } else if (type === 'other') {
        otherInput.style.display = 'block';
    }
}

function updateJVCreditAccounts() {
    const type = document.getElementById('jvCreditType').value;
    const accountSelect = document.getElementById('jvCreditAccount');
    const otherInput = document.getElementById('jvCreditOther');

    accountSelect.innerHTML = '<option value="">Select Account</option>';
    otherInput.style.display = 'none';

    if (type === 'customer') {
        customers.forEach(c => accountSelect.innerHTML += `<option value="customer_${c.id}">${c.name}</option>`);
    } else if (type === 'supplier') {
        suppliers.forEach(s => accountSelect.innerHTML += `<option value="supplier_${s.id}">${s.name}</option>`);
    } else if (type === 'bank') {
        banks.forEach(b => accountSelect.innerHTML += `<option value="bank_${b.id}">${b.name}</option>`);
    } else if (type === 'vehicle') {
        vehicles.forEach(v => accountSelect.innerHTML += `<option value="vehicle_${v.id}">${v.number} - ${v.ownerName || 'Owner'}</option>`);
    } else if (type === 'owner') {
        ownerAccounts.forEach(a => {
            const icon = a.type === 'owner' ? 'üëî' : 'üë®‚Äçüë©‚Äçüëß';
            accountSelect.innerHTML += `<option value="owner_${a.id}">${icon} ${a.name}</option>`;
        });
    } else if (type === 'other') {
        otherInput.style.display = 'block';
    }
}

function validateJVAmounts() {
    const debitInput = document.getElementById('jvDebitAmount');
    const creditInput = document.getElementById('jvCreditAmount');
    const debit = parseFloat(debitInput.value) || 0;
    const warning = document.getElementById('jvBalanceWarning');
    
    // AUTO-SYNC: When debit amount changes, automatically update credit amount
    if (debit > 0) {
        creditInput.value = debit.toFixed(2);
        warning.style.display = 'none';
    } else {
        warning.style.display = 'none';
    }
}

function saveJVVoucher(e) {
    e.preventDefault();
    
    const debit = parseFloat(document.getElementById('jvDebitAmount').value);
    const credit = parseFloat(document.getElementById('jvCreditAmount').value);
    
    if (debit !== credit) {
        showNotification('Debit and Credit must be equal!', 'error');
        return;
    }
    
    const jv = {
        id: 'jv_' + Date.now(),
        date: document.getElementById('jvDate').value,
        description: document.getElementById('jvDescription').value,
        debitType: document.getElementById('jvDebitType').value,
        debitAccount: document.getElementById('jvDebitType').value === 'other' ? 
            document.getElementById('jvDebitOther').value : 
            document.getElementById('jvDebitAccount').value,
        debitAmount: debit,
        creditType: document.getElementById('jvCreditType').value,
        creditAccount: document.getElementById('jvCreditType').value === 'other' ? 
            document.getElementById('jvCreditOther').value : 
            document.getElementById('jvCreditAccount').value,
        creditAmount: credit,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    jvVouchers.push(jv);
    
    // Update accounts and create visible transactions
    updateAccountFromJV(jv.debitType, jv.debitAccount, debit, 'debit', jv.description, jv.date);
    updateAccountFromJV(jv.creditType, jv.creditAccount, credit, 'credit', jv.description, jv.date);
    
    saveToStorage();
    renderJVVouchers();
    renderTransactions(); // Update unified transactions view
    renderCustomers();
    renderSuppliers();
    renderBanks(); // Refresh banks to show new transactions
    renderOwnerAccounts(); // Refresh owner accounts
    updateDashboard();
    showNotification('JV Voucher saved! ‚úÖ', 'success');
    closeModal('jvModal');
    e.target.reset();
}

function updateAccountFromJV(type, account, amount, side, jvDescription, jvDate) {
    // FIXED: Only update balances, don't create duplicate transaction entries
    // The JV voucher entry itself will show in the unified transactions view

    if (type === 'customer') {
        const custId = account.replace('customer_', '');
        const cust = customers.find(c => c.id === custId);
        if (cust) {
            // Debit increases customer balance (they owe more), Credit decreases (they paid)
            cust.balance += side === 'debit' ? amount : -amount;
        }
    } else if (type === 'supplier') {
        const suppId = account.replace('supplier_', '');
        const supp = suppliers.find(s => s.id === suppId);
        if (supp) {
            // Credit increases supplier balance (we owe more), Debit decreases (we paid)
            supp.balance += side === 'credit' ? amount : -amount;
        }
    } else if (type === 'bank') {
        const bankId = account.replace('bank_', '');
        const bank = banks.find(b => b.id === bankId);
        if (bank) {
            // Debit increases bank balance (deposit), Credit decreases (withdrawal)
            bank.balance += side === 'debit' ? amount : -amount;
        }
    } else if (type === 'vehicle') {
        const vehId = account.replace('vehicle_', '');
        const veh = vehicles.find(v => v.id === vehId);
        if (veh) {
            // Credit increases vehicle owner balance, Debit decreases
            veh.ownerBalance += side === 'credit' ? amount : -amount;
        }
    } else if (type === 'owner') {
        const ownerId = account.replace('owner_', '');
        const owner = ownerAccounts.find(a => a.id === ownerId);
        if (owner) {
            // Debit increases owner balance (capital injection, amount owed to owner)
            // Credit decreases owner balance (withdrawal, payment from owner)
            owner.balance += side === 'debit' ? amount : -amount;
        }
    } else if (type === 'expense') {
        // Handle expense accounts if needed
        // Expenses typically increase with debit
    }
}

// VEHICLE INVOICE FUNCTIONS
function loadVehicleInvoiceData() {
    const select = document.getElementById('invoiceVehicleId');
    select.innerHTML = '<option value="">Choose Vehicle</option>';
    vehicles.forEach(v => {
        select.innerHTML += `<option value="${v.id}">${v.number} - ${v.driverName || v.driver}</option>`;
    });
}

function generateVehicleInvoice() {
    const vehicleId = document.getElementById('invoiceVehicleId').value;
    const fromDate = document.getElementById('invoiceFromDate').value;
    const toDate = document.getElementById('invoiceToDate').value;
    
    if (!vehicleId || !fromDate || !toDate) {
        showNotification('Please fill all fields!', 'error');
        return;
    }
    
    const vehicle = vehicles.find(v => v.id === vehicleId);
    const vehicleTrans = transactions.filter(t => 
        t.vehicleId === vehicleId && 
        t.date >= fromDate && 
        t.date <= toDate
    );
    
    if (vehicleTrans.length === 0) {
        showNotification('No transactions found for this period!', 'warning');
        return;
    }
    
    let html = `
        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px;">
            <h2 style="color: var(--primary-color); margin-bottom: 5px;">üõ¢Ô∏è Baghoor Oil Traders</h2>
            <h3 style="color: var(--text-secondary); font-size: 1.1em;">Vehicle Invoice</h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <p><strong>Vehicle Number:</strong> ${vehicle.number}</p>
                <p><strong>Driver:</strong> ${vehicle.driverName || vehicle.driver}</p>
                ${vehicle.ownerName ? `<p><strong>Owner:</strong> ${vehicle.ownerName}</p>` : ''}
            </div>
            <div style="text-align: right;">
                <p><strong>Invoice Date:</strong> ${new Date().toLocaleDateString()}</p>
                <p><strong>Period:</strong> ${new Date(fromDate).toLocaleDateString()} to ${new Date(toDate).toLocaleDateString()}</p>
            </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead style="background: var(--primary-color); color: white;">
                <tr>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Date</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Type</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Party</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Fuel</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Qty (L)</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Rate</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Amount</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalSales = 0;
    let totalPurchases = 0;
    
    vehicleTrans.forEach(t => {
        html += `
            <tr>
                <td style="padding: 8px; border: 1px solid var(--border-color);">${new Date(t.date).toLocaleDateString()}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color);"><span style="background: ${t.type === 'sale' ? '#48bb78' : '#ed8936'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">${t.type.toUpperCase()}</span></td>
                <td style="padding: 8px; border: 1px solid var(--border-color);">${t.partyName}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color);">${t.fuelType}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color); text-align: right;">${t.quantity.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color); text-align: right;">Rs. ${t.rate.toFixed(4)}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color); text-align: right;"><strong>Rs. ${t.amount.toFixed(2)}</strong></td>
            </tr>
        `;
        
        if (t.type === 'sale') totalSales += t.amount;
        else totalPurchases += t.amount;
    });
    
    const profit = totalSales - totalPurchases;
    
    html += `
            </tbody>
            <tfoot style="background: var(--bg-secondary); font-weight: bold;">
                <tr>
                    <td colspan="6" style="padding: 10px; border: 1px solid var(--border-color); text-align: right;">Total Sales:</td>
                    <td style="padding: 10px; border: 1px solid var(--border-color); text-align: right; color: #48bb78;">Rs. ${totalSales.toFixed(2)}</td>
                </tr>
                <tr>
                    <td colspan="6" style="padding: 10px; border: 1px solid var(--border-color); text-align: right;">Total Purchases:</td>
                    <td style="padding: 10px; border: 1px solid var(--border-color); text-align: right; color: #ed8936;">Rs. ${totalPurchases.toFixed(2)}</td>
                </tr>
                <tr style="background: ${profit >= 0 ? '#d4edda' : '#f8d7da'};">
                    <td colspan="6" style="padding: 12px; border: 1px solid var(--border-color); text-align: right; font-size: 1.1em;">NET PROFIT:</td>
                    <td style="padding: 12px; border: 1px solid var(--border-color); text-align: right; font-size: 1.2em; color: ${profit >= 0 ? '#155724' : '#721c24'};">Rs. ${profit.toFixed(2)}</td>
                </tr>
            </tfoot>
        </table>
        
        <div style="margin-top: 30px; text-align: center; color: var(--text-secondary); font-size: 0.9em;">
            <p>This is a computer-generated invoice</p>
            <button class="btn btn-success" onclick="window.print()" style="margin-top: 15px;">üñ®Ô∏è Print Invoice</button>
        </div>
    `;
    
    document.getElementById('invoicePreview').innerHTML = html;
    document.getElementById('invoicePreview').style.display = 'block';
    showNotification('Invoice generated! ‚úÖ', 'success');
}

// Initialize invoice dropdowns when modal opens
function initInvoiceModal() {
    loadVehicleInvoiceData();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoiceToDate').value = today;
    const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('invoiceFromDate').value = firstDay;
}

// Initialize JV modal date
function initJVModal() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('jvDate').value = today;
}

// THEME TOGGLE FUNCTIONS
function toggleTheme() {
    isDarkMode = !isDarkMode;
    localStorage.setItem('darkMode', isDarkMode);
    
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
        showNotification('Dark mode enabled üåô', 'success');
    } else {
        document.body.classList.remove('dark-mode');
        document.getElementById('themeIcon').textContent = 'üåô';
        showNotification('Light mode enabled ‚òÄÔ∏è', 'success');
    }
}

// USER MANAGEMENT FUNCTIONS
function openAdminSettings() {
    if (currentRole !== 'admin') {
        showNotification('Only admin can access this!', 'error');
        return;
    }
    renderUserManagement();
    openModal('adminSettingsModal');
}

function renderUserManagement() {
    const container = document.getElementById('userManagementList');
    container.innerHTML = '';
    
    systemUsers.forEach(user => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        userCard.innerHTML = `
            <div class="user-card-info">
                <h4>${user.username}</h4>
                <p><strong>Role:</strong> <span style="color: var(--primary-color); text-transform: capitalize;">${user.role}</span></p>
                <p style="font-size: 0.8em; color: var(--text-secondary);">Created: ${new Date(user.createdAt).toLocaleDateString()}</p>
            </div>
            <div class="user-card-actions">
                <button class="btn btn-info btn-sm" onclick="changeUserPassword('${user.id}')">üîê Change Password</button>
                <button class="btn btn-warning btn-sm" onclick="changeUserRole('${user.id}')">üë§ Change Role</button>
                ${user.username !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Delete</button>` : ''}
            </div>
        `;
        container.appendChild(userCard);
    });
    
    // Add "Add New User" button
    const addUserBtn = document.createElement('div');
    addUserBtn.style.textAlign = 'center';
    addUserBtn.style.marginTop = '20px';
    addUserBtn.innerHTML = '<button class="btn btn-success" onclick="addNewUser()">‚ûï Add New User</button>';
    container.appendChild(addUserBtn);
}

function changeUserPassword(userId) {
    const user = systemUsers.find(u => u.id === userId);
    if (!user) {
        showNotification('User not found!', 'error');
        return;
    }
    
    const newPassword = prompt(`Enter new password for ${user.username}:`);
    if (newPassword && newPassword.length >= 4) {
        user.password = newPassword;
        saveToStorage();
        showNotification(`Password changed for ${user.username}! ‚úÖ`, 'success');
        renderUserManagement();
    } else if (newPassword !== null) {
        showNotification('Password must be at least 4 characters!', 'error');
    }
}

function changeUserRole(userId) {
    const user = systemUsers.find(u => u.id === userId);
    if (!user) {
        showNotification('User not found!', 'error');
        return;
    }
    
    if (user.username === 'admin') {
        showNotification('Cannot change admin role!', 'error');
        return;
    }
    
    const roles = ['admin', 'manager', 'accountant'];
    const currentIndex = roles.indexOf(user.role);
    const roleOptions = roles.map((r, i) => `${i + 1}. ${r.toUpperCase()}`).join('\n');
    
    const choice = prompt(`Select new role for ${user.username}:\n\n${roleOptions}\n\nCurrent role: ${user.role.toUpperCase()}\n\nEnter number (1-3):`);
    
    if (choice && ['1', '2', '3'].includes(choice)) {
        const newRole = roles[parseInt(choice) - 1];
        user.role = newRole;
        saveToStorage();
        showNotification(`Role changed to ${newRole.toUpperCase()} for ${user.username}! ‚úÖ`, 'success');
        renderUserManagement();
    }
}

function deleteUser(userId) {
    const user = systemUsers.find(u => u.id === userId);
    if (!user) {
        showNotification('User not found!', 'error');
        return;
    }
    
    if (confirm(`Are you sure you want to delete user "${user.username}"?\n\nThis action cannot be undone!`)) {
        systemUsers = systemUsers.filter(u => u.id !== userId);
        saveToStorage();
        showNotification(`User ${user.username} deleted! ‚úÖ`, 'success');
        renderUserManagement();
    }
}

function addNewUser() {
    const username = prompt('Enter username for new user:');
    if (!username) return;
    
    // Check if username already exists
    if (systemUsers.find(u => u.username === username)) {
        showNotification('Username already exists!', 'error');
        return;
    }
    
    const password = prompt('Enter password (min 4 characters):');
    if (!password || password.length < 4) {
        showNotification('Password must be at least 4 characters!', 'error');
        return;
    }
    
    const roles = ['admin', 'manager', 'accountant'];
    const roleOptions = roles.map((r, i) => `${i + 1}. ${r.toUpperCase()}`).join('\n');
    const roleChoice = prompt(`Select role:\n\n${roleOptions}\n\nEnter number (1-3):`);
    
    if (!roleChoice || !['1', '2', '3'].includes(roleChoice)) {
        showNotification('Invalid role selection!', 'error');
        return;
    }
    
    const role = roles[parseInt(roleChoice) - 1];
    
    const newUser = {
        id: 'user_' + Date.now(),
        username: username,
        password: password,
        role: role,
        createdAt: new Date().toISOString()
    };
    
    systemUsers.push(newUser);
    saveToStorage();
    showNotification(`User ${username} created successfully! ‚úÖ`, 'success');
    renderUserManagement();
}

// Initialize
window.addEventListener('load', async () => {
    console.log('üöÄ Baghoor Oil Traders - Complete Professional System Loaded!');
    
    // Check if user was previously logged in (fix auto-logout on refresh)
    checkLoginSession();
    
    // Clean up any corrupted data on load
    try {
        // Remove null/undefined entries
        customers = customers.filter(c => c && c.id);
        suppliers = suppliers.filter(s => s && s.id);
        transactions = transactions.filter(t => t && t.id);
        vehicles = vehicles.filter(v => v && v.id);
        banks = banks.filter(b => b && b.id);
        
        // Fix any missing properties
        vehicles.forEach(v => {
            if (!v.stockPMG) v.stockPMG = 0;
            if (!v.stockHSD) v.stockHSD = 0;
            if (!v.ownerName) v.ownerName = '';
            if (!v.ownerContact) v.ownerContact = '';
            if (!v.ownerBalance) v.ownerBalance = 0;
        });
        
        console.log('‚úÖ Data validation complete');
        console.log(`üìä Local: ${customers.length} customers, ${transactions.length} transactions`);
    } catch (error) {
        console.error('‚ö†Ô∏è Error during data cleanup:', error);
    }
    
    // Load data from Supabase cloud and set up real-time sync
    if (USE_SUPABASE && supabaseClient) {
        try {
            console.log('üîÑ Loading data from cloud...');
            
            // Load data from Supabase
            const { data, error } = await supabaseClient
                .from(TABLE_NAME)
                .select('*')
                .eq('id', 1)
                .maybeSingle();
            
            if (data) {
                console.log('üì• Cloud data loaded!');

                // Store counts before loading to detect data loss
                const localVehicleCount = vehicles.length;
                const localCustomerCount = customers.length;
                const localSupplierCount = suppliers.length;

                // Update arrays with cloud data
                if (data.customers) customers = data.customers;
                if (data.suppliers) suppliers = data.suppliers;
                if (data.transactions) transactions = data.transactions;
                if (data.payments) payments = data.payments;
                if (data.expenses) expenses = data.expenses;
                if (data.customerTransfers) customerTransfers = data.customerTransfers;
                if (data.vehicles) vehicles = data.vehicles;
                if (data.banks) banks = data.banks;
                if (data.bankTransactions) bankTransactions = data.bankTransactions;
                if (data.rateChangeLogs) rateChangeLogs = data.rateChangeLogs;
                if (data.ledgerEntries) ledgerEntries = data.ledgerEntries;
                if (data.jvVouchers) jvVouchers = data.jvVouchers;
                if (data.ownerAccounts) ownerAccounts = data.ownerAccounts;
                if (data.systemUsers && data.systemUsers.length > 0) systemUsers = data.systemUsers;

                // Warn if data counts decreased significantly (potential data loss)
                if (vehicles.length < localVehicleCount) {
                    console.warn(`‚ö†Ô∏è Vehicle count decreased from ${localVehicleCount} to ${vehicles.length}!`);
                }
                if (customers.length < localCustomerCount) {
                    console.warn(`‚ö†Ô∏è Customer count decreased from ${localCustomerCount} to ${customers.length}!`);
                }
                if (suppliers.length < localSupplierCount) {
                    console.warn(`‚ö†Ô∏è Supplier count decreased from ${localSupplierCount} to ${suppliers.length}!`);
                }
                
                // CRITICAL: Always ensure default users exist!
                ensureDefaultUsers();
                
                // Save to localStorage as backup
                localStorage.setItem('customers', JSON.stringify(customers));
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('payments', JSON.stringify(payments));
                localStorage.setItem('expenses', JSON.stringify(expenses));
                localStorage.setItem('customerTransfers', JSON.stringify(customerTransfers));
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                localStorage.setItem('banks', JSON.stringify(banks));
                localStorage.setItem('bankTransactions', JSON.stringify(bankTransactions));
                localStorage.setItem('rateChangeLogs', JSON.stringify(rateChangeLogs));
                localStorage.setItem('ledgerEntries', JSON.stringify(ledgerEntries));
                localStorage.setItem('jvVouchers', JSON.stringify(jvVouchers));
                localStorage.setItem('ownerAccounts', JSON.stringify(ownerAccounts));
                localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                
                console.log(`‚úÖ Synced: ${customers.length} customers, ${transactions.length} transactions`);
                console.log(`üë• Users available: ${systemUsers.length} (including defaults)`);
            } else if (!error || error.code === 'PGRST116') {
                console.log('üìù First time! Uploading local data...');
                ensureDefaultUsers(); // Make sure defaults exist before first upload!
                await saveToStorage();
            }
            
            // Set up real-time sync
            console.log('üîÑ Setting up real-time sync...');
            supabaseClient
                .channel('BOTs_realtime')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: TABLE_NAME },
                    (payload) => {
                        console.log('üì° Update received!');
                        if (payload.new) {
                            const data = payload.new;
                            if (data.customers) customers = data.customers;
                            if (data.suppliers) suppliers = data.suppliers;
                            if (data.transactions) transactions = data.transactions;
                            if (data.payments) payments = data.payments;
                            if (data.expenses) expenses = data.expenses;
                            if (data.customerTransfers) customerTransfers = data.customerTransfers;
                            if (data.vehicles) vehicles = data.vehicles;
                            if (data.banks) banks = data.banks;
                            if (data.bankTransactions) bankTransactions = data.bankTransactions;
                            if (data.rateChangeLogs) rateChangeLogs = data.rateChangeLogs;
                            if (data.ledgerEntries) ledgerEntries = data.ledgerEntries;
                            if (data.jvVouchers) jvVouchers = data.jvVouchers;
                            if (data.ownerAccounts) ownerAccounts = data.ownerAccounts;
                            if (data.systemUsers && data.systemUsers.length > 0) systemUsers = data.systemUsers;
                            
                            // CRITICAL: Always ensure default users exist!
                            ensureDefaultUsers();
                            
                            // Refresh displays if logged in
                            try {
                                if (typeof renderTransactions === 'function') renderTransactions();
                                if (typeof renderCustomers === 'function') renderCustomers();
                                if (typeof renderSuppliers === 'function') renderSuppliers();
                                if (typeof renderVehicles === 'function') renderVehicles();
                                if (typeof updateDashboard === 'function') updateDashboard();
                                console.log('‚úÖ Display updated!');
                            } catch (e) {}
                        }
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('‚úÖ Real-time sync active! üéâ');
                    }
                });
        } catch (error) {
            console.error('‚ö†Ô∏è Cloud sync error:', error);
            console.log('Using local data only');
        }
    } else {
        console.log('üíæ Local mode only');
    }
});
</script>

</body>
</html>
