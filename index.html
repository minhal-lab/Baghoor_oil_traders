<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baghoor Oil Traders - Complete System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 450px;
            width: 100%;
        }
        .login-box h1 { text-align: center; color: #667eea; margin-bottom: 10px; font-size: 2.2em; }
        .login-box p { text-align: center; color: #718096; margin-bottom: 30px; font-size: 0.95em; }
        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .role-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
        }
        .role-btn:hover { border-color: #667eea; background: #f7fafc; }
        .role-btn.active { border-color: #667eea; background: #667eea; color: white; }
        
        /* Quick Entry Section */
        .quick-entry {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 20px;
        }
        .quick-entry h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .quick-btn {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        .quick-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #667eea;
        }
        .header h1 { color: #1a202c; font-size: 1.8em; display: flex; align-items: center; gap: 15px; font-weight: 700; }
        .company-tagline { display: block; font-size: 0.4em; color: #667eea; font-weight: 600; margin-top: 5px; text-transform: uppercase; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .user-info {
            background: #ebf4ff;
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .user-role { font-size: 0.8em; color: #667eea; margin-top: 2px; }
        .role-admin { color: #f56565; }
        .role-manager { color: #ed8936; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-info { background: #4299e1; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-secondary { background: #a0aec0; color: white; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-bottom: 25px; }
        .stat-card {
            background: white;
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: all 0.3s;
            border-left: 4px solid;
        }
        .stat-card:nth-child(1) { border-left-color: #667eea; }
        .stat-card:nth-child(2) { border-left-color: #48bb78; }
        .stat-card:nth-child(3) { border-left-color: #ed8936; }
        .stat-card:nth-child(4) { border-left-color: #4299e1; }
        .stat-card:nth-child(5) { border-left-color: #f56565; }
        .stat-card:nth-child(6) { border-left-color: #9f7aea; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #718096; font-size: 0.8em; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .stat-card .value { font-size: 1.8em; font-weight: 700; margin-bottom: 6px; }
        .stat-card:nth-child(1) .value { color: #667eea; }
        .stat-card:nth-child(2) .value { color: #48bb78; }
        .stat-card:nth-child(3) .value { color: #ed8936; }
        .stat-card:nth-child(4) .value { color: #4299e1; }
        .stat-card:nth-child(5) .value { color: #f56565; }
        .stat-card:nth-child(6) .value { color: #9f7aea; }
        .stat-card .change { font-size: 0.8em; color: #718096; font-weight: 600; }
        .card { background: white; padding: 22px; border-radius: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
        .card h2 { color: #1a202c; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.3em; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: #4a5568; font-weight: 600; font-size: 0.85em; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            background: #f7fafc;
            color: #2d3748;
        }
        .form-group textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; background: white; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f7fafc; border-radius: 8px; margin-bottom: 10px; }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .checkbox-group label { margin: 0; font-weight: 600; color: #2d3748; cursor: pointer; }
        .table-container { overflow-x: auto; margin-top: 12px; border-radius: 10px; border: 1px solid #e2e8f0; max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        table th, table td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.85em; }
        table th { background: #f7fafc; color: #4a5568; font-weight: 700; text-transform: uppercase; font-size: 0.75em; position: sticky; top: 0; z-index: 10; }
        table tr:hover { background: #f7fafc; }
        .action-btn { padding: 5px 12px; margin: 0 2px; border: none; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: 600; color: white; }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .action-btn.edit { background: #667eea; }
        .action-btn.delete { background: #f56565; }
        .action-btn.view { background: #4299e1; }
        .tabs { display: flex; gap: 8px; margin-bottom: 18px; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: transparent; color: #718096; font-weight: 600; border-bottom: 3px solid transparent; margin-bottom: -2px; font-size: 0.9em; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #1a202c; font-weight: 700; }
        .close-modal { font-size: 28px; cursor: pointer; color: #a0aec0; border: none; background: none; }
        .close-modal:hover { color: #f56565; }
        .badge { padding: 4px 10px; border-radius: 10px; font-size: 0.7em; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: #c6f6d5; color: #22543d; }
        .badge-danger { background: #fed7d7; color: #742a2a; }
        .badge-warning { background: #feebc8; color: #7c2d12; }
        .badge-info { background: #bee3f8; color: #2c5282; }
        .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 18px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2000; min-width: 280px; border-left: 4px solid; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        .notification.success { border-left-color: #48bb78; }
        .notification.error { border-left-color: #f56565; }
        .profit-positive { color: #48bb78; font-weight: 700; }
        .profit-negative { color: #f56565; font-weight: 700; }
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            .form-row, .dashboard-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 12px; }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-container">
    <div class="login-box">
        <h1>🛢️ Baghoor Oil</h1>
        <p>Premium Petrol & HSD Distribution System</p>
        
        <form onsubmit="handleLogin(event)">
            <div class="role-selector">
                <div class="role-btn active" onclick="selectRole('admin')">
                    <div style="font-size:2em;">👑</div>
                    <div>Admin</div>
                </div>
                <div class="role-btn" onclick="selectRole('manager')">
                    <div style="font-size:2em;">👤</div>
                    <div>Manager</div>
                </div>
            </div>
            
            <input type="hidden" id="selectedRole" value="admin">
            
            <div class="form-group">
                <label>Username</label>
                <input type="password" id="loginUsername" required placeholder="Enter username" autocomplete="off">
            </div>
            
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" required placeholder="Enter password" autocomplete="new-password">
            </div>
            
            <button type="submit" class="btn btn-primary" style="width:100%; padding:15px;">
                🔐 Login
            </button>
        </form>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                🛢️ Baghoor Oil Traders
                <span class="company-tagline">Premium Distribution System</span>
            </h1>
            <div class="header-actions">
                <div class="user-info">
                    <span id="currentUsername">Admin</span>
                    <span class="user-role" id="currentUserRole">Administrator</span>
                </div>
                <button class="btn btn-info" onclick="openModal('govRateModal')">📊 Update Rates</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Quick Entry Section -->
        <div class="quick-entry">
            <h3>⚡ Quick Entry</h3>
            <div class="quick-grid">
                <button class="quick-btn" onclick="quickEntry('customer')">👥 Add Customer</button>
                <button class="quick-btn" onclick="quickEntry('supplier')">🏭 Add Supplier</button>
                <button class="quick-btn" onclick="quickEntry('sale')">💰 Record Sale</button>
                <button class="quick-btn" onclick="quickEntry('expense')">💸 Add Expense</button>
                <button class="quick-btn" onclick="quickEntry('payment')">💳 Record Payment</button>
                <button class="quick-btn" onclick="quickEntry('bank')">🏦 Bank Transaction</button>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Total Customers</h3>
                <div class="value" id="totalCustomers">0</div>
                <div class="change">Active accounts</div>
            </div>
            <div class="stat-card">
                <h3>Total Receivables</h3>
                <div class="value" id="totalReceivables">Rs. 0</div>
                <div class="change">To be collected</div>
            </div>
            <div class="stat-card">
                <h3>Total Suppliers</h3>
                <div class="value" id="totalSuppliers">0</div>
                <div class="change">Active suppliers</div>
            </div>
            <div class="stat-card">
                <h3>Total Payables</h3>
                <div class="value" id="totalPayables">Rs. 0</div>
                <div class="change">To be paid</div>
            </div>
            <div class="stat-card">
                <h3>Today's Sales</h3>
                <div class="value" id="todaySales">Rs. 0</div>
                <div class="change">Current day</div>
            </div>
            <div class="stat-card">
                <h3>Bank Balance</h3>
                <div class="value" id="bankBalance">Rs. 0</div>
                <div class="change">Current balance</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('customers')">👥 Customers</button>
                <button class="tab" onclick="switchTab('suppliers')">🏭 Suppliers</button>
                <button class="tab" onclick="switchTab('sales')">💰 Sales</button>
                <button class="tab" onclick="switchTab('purchases')">📦 Purchases</button>
                <button class="tab" onclick="switchTab('expenses')">💸 Expenses</button>
                <button class="tab" onclick="switchTab('payments')">💳 Payments</button>
                <button class="tab" onclick="switchTab('bank')">🏦 Bank</button>
                <button class="tab" onclick="switchTab('ledger')">📒 Ledger</button>
            </div>

            <!-- Customers Tab -->
            <div id="customers" class="tab-content active">
                <button class="btn btn-primary" onclick="openModal('customerModal')">+ Add Customer</button>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>PMG Rate</th>
                                <th>HSD Rate</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Suppliers Tab -->
            <div id="suppliers" class="tab-content">
                <button class="btn btn-primary" onclick="openModal('supplierModal')">+ Add Supplier</button>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>PMG Rate</th>
                                <th>HSD Rate</th>
                                <th>Balance Due</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Sales Tab -->
            <div id="sales" class="tab-content">
                <button class="btn btn-success" onclick="openModal('saleModal')">+ Record Sale</button>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Product</th>
                                <th>Quantity (L)</th>
                                <th>Rate</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Purchases Tab -->
            <div id="purchases" class="tab-content">
                <button class="btn btn-warning" onclick="openModal('purchaseModal')">+ Record Purchase</button>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Supplier</th>
                                <th>Product</th>
                                <th>Quantity (L)</th>
                                <th>Rate</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchasesTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses" class="tab-content">
                <button class="btn btn-danger" onclick="openModal('expenseModal')">+ Add Expense</button>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Linked To</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Tab -->
            <div id="payments" class="tab-content">
                <button class="btn btn-success" onclick="openModal('paymentModal')">+ Record Payment</button>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Bank Tab -->
            <div id="bank" class="tab-content">
                <button class="btn btn-info" onclick="openModal('bankModal')">+ Bank Transaction</button>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bankTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Ledger Tab -->
            <div id="ledger" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Account</th>
                                <th>Description</th>
                                <th>Debit</th>
                                <th>Credit</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="ledgerTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->

<!-- Customer Modal -->
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="customerModalTitle">Add Customer</h2>
            <button class="close-modal" onclick="closeModal('customerModal')">&times;</button>
        </div>
        <form onsubmit="saveCustomer(event)">
            <input type="hidden" id="customerId">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="customerName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>PMG Rate (Rs/L) *</label>
                    <input type="number" id="customerPmgRate" step="0.0001" required placeholder="255.5250">
                </div>
                <div class="form-group">
                    <label>HSD Rate (Rs/L) *</label>
                    <input type="number" id="customerHsdRate" step="0.0001" required placeholder="260.7500">
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;">Save Customer</button>
        </form>
    </div>
</div>

<!-- Supplier Modal -->
<div id="supplierModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Supplier</h2>
            <button class="close-modal" onclick="closeModal('supplierModal')">&times;</button>
        </div>
        <form onsubmit="saveSupplier(event)">
            <input type="hidden" id="supplierId">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="supplierName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>PMG Rate (Rs/L) *</label>
                    <input type="number" id="supplierPmgRate" step="0.0001" required placeholder="252.3450">
                </div>
                <div class="form-group">
                    <label>HSD Rate (Rs/L) *</label>
                    <input type="number" id="supplierHsdRate" step="0.0001" required placeholder="257.8900">
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;">Save Supplier</button>
        </form>
    </div>
</div>

<!-- Sale Modal -->
<div id="saleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Sale</h2>
            <button class="close-modal" onclick="closeModal('saleModal')">&times;</button>
        </div>
        <form onsubmit="saveSale(event)">
            <div class="form-group">
                <label>Customer *</label>
                <select id="saleCustomer" required></select>
            </div>
            <div class="form-group">
                <label>Product *</label>
                <select id="saleProduct" required onchange="updateSaleRate()">
                    <option value="">Select Product</option>
                    <option value="pmg">PMG (Petrol)</option>
                    <option value="hsd">HSD (Diesel)</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity (Liters) *</label>
                    <input type="number" id="saleQuantity" required step="0.01" onchange="calculateSaleTotal()">
                </div>
                <div class="form-group">
                    <label>Rate (Rs/L) *</label>
                    <input type="number" id="saleRate" required step="0.0001" onchange="calculateSaleTotal()">
                </div>
            </div>
            <div class="form-group">
                <label>Total Amount</label>
                <input type="number" id="saleTotal" readonly style="font-weight:700; font-size:1.1em;">
            </div>
            <button type="submit" class="btn btn-success" style="width:100%;">Record Sale</button>
        </form>
    </div>
</div>

<!-- Purchase Modal -->
<div id="purchaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Purchase</h2>
            <button class="close-modal" onclick="closeModal('purchaseModal')">&times;</button>
        </div>
        <form onsubmit="savePurchase(event)">
            <div class="form-group">
                <label>Supplier *</label>
                <select id="purchaseSupplier" required></select>
            </div>
            <div class="form-group">
                <label>Product *</label>
                <select id="purchaseProduct" required onchange="updatePurchaseRate()">
                    <option value="">Select Product</option>
                    <option value="pmg">PMG (Petrol)</option>
                    <option value="hsd">HSD (Diesel)</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity (Liters) *</label>
                    <input type="number" id="purchaseQuantity" required step="0.01" onchange="calculatePurchaseTotal()">
                </div>
                <div class="form-group">
                    <label>Rate (Rs/L) *</label>
                    <input type="number" id="purchaseRate" required step="0.0001" onchange="calculatePurchaseTotal()">
                </div>
            </div>
            <div class="form-group">
                <label>Total Amount</label>
                <input type="number" id="purchaseTotal" readonly style="font-weight:700; font-size:1.1em;">
            </div>
            <button type="submit" class="btn btn-warning" style="width:100%;">Record Purchase</button>
        </form>
    </div>
</div>

<!-- Expense Modal -->
<div id="expenseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Expense</h2>
            <button class="close-modal" onclick="closeModal('expenseModal')">&times;</button>
        </div>
        <form onsubmit="saveExpense(event)">
            <div class="form-group">
                <label>Category *</label>
                <select id="expenseCategory" required>
                    <option value="">Select Category</option>
                    <option value="vehicle">Vehicle</option>
                    <option value="salary">Salary</option>
                    <option value="utility">Utility</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="expenseDescription" required></textarea>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" id="expenseAmount" required step="0.01">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="expenseOnBehalfCustomer" onchange="toggleExpenseCustomer()">
                <label for="expenseOnBehalfCustomer">This expense is on behalf of a customer</label>
            </div>
            <div class="form-group" id="expenseCustomerGroup" style="display:none;">
                <label>Select Customer *</label>
                <select id="expenseCustomerId"></select>
            </div>
            <button type="submit" class="btn btn-danger" style="width:100%;">Save Expense</button>
        </form>
    </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Payment</h2>
            <button class="close-modal" onclick="closeModal('paymentModal')">&times;</button>
        </div>
        <form onsubmit="savePayment(event)">
            <div class="form-group">
                <label>Payment Type *</label>
                <select id="paymentType" required onchange="updatePaymentFields()">
                    <option value="">-- Select Type --</option>
                    <option value="customer_to_bank">Customer pays to Bank</option>
                    <option value="customer_to_supplier">Customer pays to Supplier</option>
                    <option value="customer_to_owner">Customer pays to Owner</option>
                    <option value="owner_to_supplier">Owner pays to Supplier</option>
                </select>
            </div>
            <div class="form-group" id="paymentFromGroup">
                <label>From (Payer) *</label>
                <select id="paymentFrom" required></select>
            </div>
            <div class="form-group" id="paymentToGroup">
                <label>To (Receiver) *</label>
                <select id="paymentTo" required></select>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" id="paymentAmount" required step="0.01">
            </div>
            <div class="form-group">
                <label>Payment Method *</label>
                <select id="paymentMethod" required>
                    <option value="cash">Cash</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="paymentDescription"></textarea>
            </div>
            <button type="submit" class="btn btn-success" style="width:100%;">Save Payment</button>
        </form>
    </div>
</div>

<!-- Bank Modal -->
<div id="bankModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Bank Transaction</h2>
            <button class="close-modal" onclick="closeModal('bankModal')">&times;</button>
        </div>
        <form onsubmit="saveBankTransaction(event)">
            <div class="form-group">
                <label>Transaction Type *</label>
                <select id="bankTransactionType" required onchange="updateBankFields()">
                    <option value="">-- Select Type --</option>
                    <option value="deposit">Deposit (Money In)</option>
                    <option value="withdrawal">Withdrawal (Money Out)</option>
                    <option value="transfer">Transfer Between Accounts</option>
                </select>
            </div>
            <div class="form-group" id="bankFromGroup" style="display:none;">
                <label>From Account *</label>
                <select id="bankFrom"></select>
            </div>
            <div class="form-group" id="bankToGroup" style="display:none;">
                <label>To Account *</label>
                <select id="bankTo"></select>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" id="bankAmount" required step="0.01">
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="bankDescription" required></textarea>
            </div>
            <button type="submit" class="btn btn-info" style="width:100%;">Save Transaction</button>
        </form>
    </div>
</div>

<!-- Government Rate Update Modal -->
<div id="govRateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>📊 Government Rate Update</h2>
            <button class="close-modal" onclick="closeModal('govRateModal')">&times;</button>
        </div>
        <form onsubmit="applyGovRateChange(event)">
            <div style="background:#ebf4ff; padding:15px; border-radius:10px; margin-bottom:15px;">
                <p style="color:#667eea; font-weight:600;">Select fuel types and enter rate changes</p>
            </div>
            
            <div class="form-group">
                <label>Fuel Type(s) *</label>
                <div style="display:flex; gap:15px;">
                    <label style="display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="updatePmg" checked> PMG (Petrol)
                    </label>
                    <label style="display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="updateHsd" checked> HSD (Diesel)
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Change Type *</label>
                <select id="changeType" required>
                    <option value="absolute">Absolute (PKR)</option>
                    <option value="percent">Percent (%)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Change Direction *</label>
                <select id="changeSign" required>
                    <option value="1">Increase (+)</option>
                    <option value="-1">Decrease (-)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" id="changeAmount" step="0.0001" min="0" required placeholder="e.g., 2.5000 or 5 (for 5%)">
            </div>
            
            <div class="form-group">
                <label>Apply To *</label>
                <select id="changeScope" required>
                    <option value="all">All Customers & Suppliers</option>
                    <option value="customers">Customers Only</option>
                    <option value="suppliers">Suppliers Only</option>
                </select>
            </div>
            
            <button type="button" class="btn btn-info" onclick="previewRateChange()" style="width:100%; margin-bottom:10px;">
                👁️ Preview Changes
            </button>
            
            <div id="rateChangePreview" style="display:none; background:#f7fafc; padding:15px; border-radius:10px; margin:10px 0; max-height:300px; overflow-y:auto;">
                <h4 style="color:#667eea; margin-bottom:10px;">Preview:</h4>
                <div id="previewContent"></div>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width:100%;">
                ✅ Apply Changes
            </button>
        </form>
    </div>
</div>

<script>
// Global Variables
let currentUser = null;
let currentRole = null;
let customers = [];
let suppliers = [];
let sales = [];
let purchases = [];
let expenses = [];
let payments = [];
let bankTransactions = [];
let ledger = [];
let rateChangeLogs = [];

// Helper Functions
function formatRate(value) {
    return parseFloat(value).toFixed(4);
}

function roundRate(value) {
    return Math.round(value * 10000) / 10000;
}

function formatCurrency(value) {
    return new Intl.NumberFormat('en-PK', {
        style: 'currency',
        currency: 'PKR',
        minimumFractionDigits: 2
    }).format(value).replace('PKR', 'Rs.');
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Login Functions
function selectRole(role) {
    document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.role-btn').classList.add('active');
    document.getElementById('selectedRole').value = role;
}

function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const role = document.getElementById('selectedRole').value;
    
    // Simple authentication (replace with real auth)
    if ((role === 'admin' && username === 'admin' && password === 'admin123') ||
        (role === 'manager' && username === 'manager' && password === 'manager123')) {
        currentUser = username;
        currentRole = role;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('currentUsername').textContent = username;
        document.getElementById('currentUserRole').textContent = role === 'admin' ? 'Administrator' : 'Manager';
        loadData();
        updateDashboardStats();
        renderCustomers();
        renderSuppliers();
        showNotification('Login successful!');
    } else {
        showNotification('Invalid credentials!', 'error');
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        currentUser = null;
        currentRole = null;
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
    }
}

// Data Loading
function loadData() {
    customers = JSON.parse(localStorage.getItem('customers')) || [];
    suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
    sales = JSON.parse(localStorage.getItem('sales')) || [];
    purchases = JSON.parse(localStorage.getItem('purchases')) || [];
    expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    payments = JSON.parse(localStorage.getItem('payments')) || [];
    bankTransactions = JSON.parse(localStorage.getItem('bankTransactions')) || [];
    ledger = JSON.parse(localStorage.getItem('ledger')) || [];
    rateChangeLogs = JSON.parse(localStorage.getItem('rateChangeLogs')) || [];
}

// Quick Entry
function quickEntry(type) {
    const modalMap = {
        'customer': 'customerModal',
        'supplier': 'supplierModal',
        'sale': 'saleModal',
        'expense': 'expenseModal',
        'payment': 'paymentModal',
        'bank': 'bankModal'
    };
    openModal(modalMap[type]);
}

// Modal Functions
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    if (modalId === 'saleModal') {
        populateCustomerSelect('saleCustomer');
    } else if (modalId === 'purchaseModal') {
        populateSupplierSelect('purchaseSupplier');
    } else if (modalId === 'expenseModal') {
        populateCustomerSelect('expenseCustomerId');
    } else if (modalId === 'paymentModal') {
        updatePaymentFields();
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.getElementById(modalId).querySelector('form')?.reset();
}

// Tab Functions
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
    
    if (tabName === 'customers') renderCustomers();
    else if (tabName === 'suppliers') renderSuppliers();
    else if (tabName === 'sales') renderSales();
    else if (tabName === 'purchases') renderPurchases();
    else if (tabName === 'expenses') renderExpenses();
    else if (tabName === 'payments') renderPayments();
    else if (tabName === 'bank') renderBankTransactions();
    else if (tabName === 'ledger') renderLedger();
}

// Customer Functions
function saveCustomer(e) {
    e.preventDefault();
    const id = document.getElementById('customerId').value || 'cust_' + Date.now();
    const customer = {
        id,
        name: document.getElementById('customerName').value,
        pmgRate: formatRate(document.getElementById('customerPmgRate').value),
        hsdRate: formatRate(document.getElementById('customerHsdRate').value),
        balance: customers.find(c => c.id === id)?.balance || 0
    };
    
    const index = customers.findIndex(c => c.id === id);
    if (index >= 0) {
        customers[index] = customer;
    } else {
        customers.push(customer);
    }
    
    localStorage.setItem('customers', JSON.stringify(customers));
    renderCustomers();
    updateDashboardStats();
    closeModal('customerModal');
    showNotification('Customer saved successfully!');
}

function renderCustomers() {
    const tbody = document.getElementById('customersTable');
    if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#a0aec0;">No customers yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = customers.map(c => `
        <tr>
            <td><strong>${c.name}</strong></td>
            <td>Rs. ${c.pmgRate}/L</td>
            <td>Rs. ${c.hsdRate}/L</td>
            <td class="${c.balance > 0 ? 'profit-negative' : 'profit-positive'}">${formatCurrency(c.balance)}</td>
            <td>
                <button class="action-btn edit" onclick="editCustomer('${c.id}')">Edit</button>
                <button class="action-btn delete" onclick="deleteCustomer('${c.id}')">Delete</button>
            </td>
        </tr>
    `).join('');
}

function editCustomer(id) {
    const customer = customers.find(c => c.id === id);
    if (!customer) return;
    
    document.getElementById('customerId').value = customer.id;
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerPmgRate').value = customer.pmgRate;
    document.getElementById('customerHsdRate').value = customer.hsdRate;
    document.getElementById('customerModalTitle').textContent = 'Edit Customer';
    openModal('customerModal');
}

function deleteCustomer(id) {
    if (confirm('Delete this customer?')) {
        customers = customers.filter(c => c.id !== id);
        localStorage.setItem('customers', JSON.stringify(customers));
        renderCustomers();
        updateDashboardStats();
        showNotification('Customer deleted!');
    }
}

// Supplier Functions
function saveSupplier(e) {
    e.preventDefault();
    const id = document.getElementById('supplierId').value || 'supp_' + Date.now();
    const supplier = {
        id,
        name: document.getElementById('supplierName').value,
        pmgRate: formatRate(document.getElementById('supplierPmgRate').value),
        hsdRate: formatRate(document.getElementById('supplierHsdRate').value),
        balance: suppliers.find(s => s.id === id)?.balance || 0
    };
    
    const index = suppliers.findIndex(s => s.id === id);
    if (index >= 0) {
        suppliers[index] = supplier;
    } else {
        suppliers.push(supplier);
    }
    
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
    renderSuppliers();
    updateDashboardStats();
    closeModal('supplierModal');
    showNotification('Supplier saved successfully!');
}

function renderSuppliers() {
    const tbody = document.getElementById('suppliersTable');
    if (suppliers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#a0aec0;">No suppliers yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = suppliers.map(s => `
        <tr>
            <td><strong>${s.name}</strong></td>
            <td>Rs. ${s.pmgRate}/L</td>
            <td>Rs. ${s.hsdRate}/L</td>
            <td class="${s.balance > 0 ? 'profit-negative' : ''}">${formatCurrency(s.balance)}</td>
            <td>
                <button class="action-btn edit" onclick="editSupplier('${s.id}')">Edit</button>
                <button class="action-btn delete" onclick="deleteSupplier('${s.id}')">Delete</button>
            </td>
        </tr>
    `).join('');
}

function editSupplier(id) {
    const supplier = suppliers.find(s => s.id === id);
    if (!supplier) return;
    
    document.getElementById('supplierId').value = supplier.id;
    document.getElementById('supplierName').value = supplier.name;
    document.getElementById('supplierPmgRate').value = supplier.pmgRate;
    document.getElementById('supplierHsdRate').value = supplier.hsdRate;
    openModal('supplierModal');
}

function deleteSupplier(id) {
    if (confirm('Delete this supplier?')) {
        suppliers = suppliers.filter(s => s.id !== id);
        localStorage.setItem('suppliers', JSON.stringify(suppliers));
        renderSuppliers();
        updateDashboardStats();
        showNotification('Supplier deleted!');
    }
}

// Sale Functions
function populateCustomerSelect(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Select Customer</option>' + 
        customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function populateSupplierSelect(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Select Supplier</option>' + 
        suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
}

function updateSaleRate() {
    const customerId = document.getElementById('saleCustomer').value;
    const product = document.getElementById('saleProduct').value;
    if (!customerId || !product) return;
    
    const customer = customers.find(c => c.id === customerId);
    if (customer) {
        document.getElementById('saleRate').value = product === 'pmg' ? customer.pmgRate : customer.hsdRate;
        calculateSaleTotal();
    }
}

function calculateSaleTotal() {
    const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
    const rate = parseFloat(document.getElementById('saleRate').value) || 0;
    document.getElementById('saleTotal').value = (quantity * rate).toFixed(2);
}

function saveSale(e) {
    e.preventDefault();
    const customerId = document.getElementById('saleCustomer').value;
    const customer = customers.find(c => c.id === customerId);
    
    const sale = {
        id: 'sale_' + Date.now(),
        customerId,
        customerName: customer.name,
        product: document.getElementById('saleProduct').value,
        quantity: parseFloat(document.getElementById('saleQuantity').value),
        rate: formatRate(document.getElementById('saleRate').value),
        total: parseFloat(document.getElementById('saleTotal').value),
        date: new Date().toISOString(),
        createdBy: currentUser
    };
    
    sales.push(sale);
    customer.balance += sale.total;
    
    localStorage.setItem('sales', JSON.stringify(sales));
    localStorage.setItem('customers', JSON.stringify(customers));
    
    renderSales();
    renderCustomers();
    updateDashboardStats();
    closeModal('saleModal');
    showNotification('Sale recorded successfully!');
}

function renderSales() {
    const tbody = document.getElementById('salesTable');
    if (sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#a0aec0;">No sales yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = sales.slice().reverse().map(s => {
        const date = new Date(s.date);
        return `
            <tr>
                <td>${date.toLocaleDateString()}</td>
                <td><strong>${s.customerName}</strong></td>
                <td><span class="badge badge-${s.product === 'pmg' ? 'success' : 'warning'}">${s.product.toUpperCase()}</span></td>
                <td>${s.quantity.toLocaleString()} L</td>
                <td>Rs. ${s.rate}/L</td>
                <td class="profit-positive" style="font-weight:700;">${formatCurrency(s.total)}</td>
                <td>
                    <button class="action-btn delete" onclick="deleteSale('${s.id}')">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

function deleteSale(id) {
    if (confirm('Delete this sale?')) {
        const sale = sales.find(s => s.id === id);
        const customer = customers.find(c => c.id === sale.customerId);
        if (customer) customer.balance -= sale.total;
        
        sales = sales.filter(s => s.id !== id);
        localStorage.setItem('sales', JSON.stringify(sales));
        localStorage.setItem('customers', JSON.stringify(customers));
        renderSales();
        renderCustomers();
        updateDashboardStats();
        showNotification('Sale deleted!');
    }
}

// Purchase Functions
function updatePurchaseRate() {
    const supplierId = document.getElementById('purchaseSupplier').value;
    const product = document.getElementById('purchaseProduct').value;
    if (!supplierId || !product) return;
    
    const supplier = suppliers.find(s => s.id === supplierId);
    if (supplier) {
        document.getElementById('purchaseRate').value = product === 'pmg' ? supplier.pmgRate : supplier.hsdRate;
        calculatePurchaseTotal();
    }
}

function calculatePurchaseTotal() {
    const quantity = parseFloat(document.getElementById('purchaseQuantity').value) || 0;
    const rate = parseFloat(document.getElementById('purchaseRate').value) || 0;
    document.getElementById('purchaseTotal').value = (quantity * rate).toFixed(2);
}

function savePurchase(e) {
    e.preventDefault();
    const supplierId = document.getElementById('purchaseSupplier').value;
    const supplier = suppliers.find(s => s.id === supplierId);
    
    const purchase = {
        id: 'purch_' + Date.now(),
        supplierId,
        supplierName: supplier.name,
        product: document.getElementById('purchaseProduct').value,
        quantity: parseFloat(document.getElementById('purchaseQuantity').value),
        rate: formatRate(document.getElementById('purchaseRate').value),
        total: parseFloat(document.getElementById('purchaseTotal').value),
        date: new Date().toISOString(),
        createdBy: currentUser
    };
    
    purchases.push(purchase);
    supplier.balance += purchase.total;
    
    localStorage.setItem('purchases', JSON.stringify(purchases));
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
    
    renderPurchases();
    renderSuppliers();
    updateDashboardStats();
    closeModal('purchaseModal');
    showNotification('Purchase recorded successfully!');
}

function renderPurchases() {
    const tbody = document.getElementById('purchasesTable');
    if (purchases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#a0aec0;">No purchases yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = purchases.slice().reverse().map(p => {
        const date = new Date(p.date);
        return `
            <tr>
                <td>${date.toLocaleDateString()}</td>
                <td><strong>${p.supplierName}</strong></td>
                <td><span class="badge badge-${p.product === 'pmg' ? 'success' : 'warning'}">${p.product.toUpperCase()}</span></td>
                <td>${p.quantity.toLocaleString()} L</td>
                <td>Rs. ${p.rate}/L</td>
                <td class="profit-negative" style="font-weight:700;">${formatCurrency(p.total)}</td>
                <td>
                    <button class="action-btn delete" onclick="deletePurchase('${p.id}')">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

function deletePurchase(id) {
    if (confirm('Delete this purchase?')) {
        const purchase = purchases.find(p => p.id === id);
        const supplier = suppliers.find(s => s.id === purchase.supplierId);
        if (supplier) supplier.balance -= purchase.total;
        
        purchases = purchases.filter(p => p.id !== id);
        localStorage.setItem('purchases', JSON.stringify(purchases));
        localStorage.setItem('suppliers', JSON.stringify(suppliers));
        renderPurchases();
        renderSuppliers();
        updateDashboardStats();
        showNotification('Purchase deleted!');
    }
}

// Expense Functions
function toggleExpenseCustomer() {
    const checked = document.getElementById('expenseOnBehalfCustomer').checked;
    document.getElementById('expenseCustomerGroup').style.display = checked ? 'block' : 'none';
}

function saveExpense(e) {
    e.preventDefault();
    const onBehalfCustomer = document.getElementById('expenseOnBehalfCustomer').checked;
    const customerId = onBehalfCustomer ? document.getElementById('expenseCustomerId').value : null;
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    
    const expense = {
        id: 'exp_' + Date.now(),
        category: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        amount,
        customerId,
        customerName: customerId ? customers.find(c => c.id === customerId)?.name : null,
        date: new Date().toISOString(),
        createdBy: currentUser
    };
    
    expenses.push(expense);
    
    // If on behalf of customer, add to their balance
    if (customerId) {
        const customer = customers.find(c => c.id === customerId);
        if (customer) customer.balance += amount;
        localStorage.setItem('customers', JSON.stringify(customers));
    }
    
    localStorage.setItem('expenses', JSON.stringify(expenses));
    
    renderExpenses();
    renderCustomers();
    updateDashboardStats();
    closeModal('expenseModal');
    showNotification('Expense recorded successfully!');
}

function renderExpenses() {
    const tbody = document.getElementById('expensesTable');
    if (expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#a0aec0;">No expenses yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = expenses.slice().reverse().map(e => {
        const date = new Date(e.date);
        return `
            <tr>
                <td>${date.toLocaleDateString()}</td>
                <td><span class="badge badge-warning">${e.category.toUpperCase()}</span></td>
                <td>${e.description}</td>
                <td class="profit-negative" style="font-weight:700;">${formatCurrency(e.amount)}</td>
                <td>${e.customerName || '-'}</td>
                <td>
                    <button class="action-btn delete" onclick="deleteExpense('${e.id}')">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

function deleteExpense(id) {
    if (confirm('Delete this expense?')) {
        const expense = expenses.find(e => e.id === id);
        if (expense.customerId) {
            const customer = customers.find(c => c.id === expense.customerId);
            if (customer) customer.balance -= expense.amount;
            localStorage.setItem('customers', JSON.stringify(customers));
        }
        
        expenses = expenses.filter(e => e.id !== id);
        localStorage.setItem('expenses', JSON.stringify(expenses));
        renderExpenses();
        renderCustomers();
        updateDashboardStats();
        showNotification('Expense deleted!');
    }
}

// Payment Functions
function updatePaymentFields() {
    const type = document.getElementById('paymentType').value;
    const fromSelect = document.getElementById('paymentFrom');
    const toSelect = document.getElementById('paymentTo');
    
    fromSelect.innerHTML = '<option value="">-- Select --</option>';
    toSelect.innerHTML = '<option value="">-- Select --</option>';
    
    switch(type) {
        case 'customer_to_bank':
            customers.forEach(c => {
                fromSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            toSelect.innerHTML += '<option value="bank">Bank Account</option>';
            break;
            
        case 'customer_to_supplier':
            customers.forEach(c => {
                fromSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            suppliers.forEach(s => {
                toSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            break;
            
        case 'customer_to_owner':
            customers.forEach(c => {
                fromSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            toSelect.innerHTML += '<option value="owner">Owner Account</option>';
            break;
            
        case 'owner_to_supplier':
            fromSelect.innerHTML += '<option value="owner">Owner Account</option>';
            suppliers.forEach(s => {
                toSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            break;
    }
}

function savePayment(e) {
    e.preventDefault();
    const type = document.getElementById('paymentType').value;
    const fromId = document.getElementById('paymentFrom').value;
    const toId = document.getElementById('paymentTo').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    
    const payment = {
        id: 'pay_' + Date.now(),
        type,
        fromId,
        toId,
        amount,
        method: document.getElementById('paymentMethod').value,
        description: document.getElementById('paymentDescription').value,
        date: new Date().toISOString(),
        createdBy: currentUser
    };
    
    payments.push(payment);
    
    // Update accounts
    if (type === 'customer_to_bank') {
        const customer = customers.find(c => c.id === fromId);
        if (customer) customer.balance -= amount;
    } else if (type === 'customer_to_supplier') {
        const customer = customers.find(c => c.id === fromId);
        const supplier = suppliers.find(s => s.id === toId);
        if (customer) customer.balance -= amount;
        if (supplier) supplier.balance -= amount;
    } else if (type === 'customer_to_owner') {
        const customer = customers.find(c => c.id === fromId);
        if (customer) customer.balance -= amount;
    } else if (type === 'owner_to_supplier') {
        const supplier = suppliers.find(s => s.id === toId);
        if (supplier) supplier.balance -= amount;
    }
    
    localStorage.setItem('payments', JSON.stringify(payments));
    localStorage.setItem('customers', JSON.stringify(customers));
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
    
    renderPayments();
    renderCustomers();
    renderSuppliers();
    updateDashboardStats();
    closeModal('paymentModal');
    showNotification('Payment recorded successfully!');
}

function renderPayments() {
    const tbody = document.getElementById('paymentsTable');
    if (payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#a0aec0;">No payments yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = payments.slice().reverse().map(p => {
        const date = new Date(p.date);
        const fromName = p.fromId === 'owner' ? 'Owner' : p.fromId === 'bank' ? 'Bank' : 
            (customers.find(c => c.id === p.fromId)?.name || suppliers.find(s => s.id === p.fromId)?.name || 'Unknown');
        const toName = p.toId === 'owner' ? 'Owner' : p.toId === 'bank' ? 'Bank' : 
            (customers.find(c => c.id === p.toId)?.name || suppliers.find(s => s.id === p.toId)?.name || 'Unknown');
        
        return `
            <tr>
                <td>${date.toLocaleDateString()}</td>
                <td><strong>${fromName}</strong></td>
                <td><strong>${toName}</strong></td>
                <td class="profit-positive" style="font-weight:700;">${formatCurrency(p.amount)}</td>
                <td><span class="badge badge-info">${p.method.toUpperCase()}</span></td>
                <td>
                    <button class="action-btn delete" onclick="deletePayment('${p.id}')">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

function deletePayment(id) {
    if (confirm('Delete this payment?')) {
        payments = payments.filter(p => p.id !== id);
        localStorage.setItem('payments', JSON.stringify(payments));
        renderPayments();
        showNotification('Payment deleted!');
    }
}

// Bank Functions
function updateBankFields() {
    const type = document.getElementById('bankTransactionType').value;
    const fromGroup = document.getElementById('bankFromGroup');
    const toGroup = document.getElementById('bankToGroup');
    const fromSelect = document.getElementById('bankFrom');
    const toSelect = document.getElementById('bankTo');
    
    fromGroup.style.display = 'none';
    toGroup.style.display = 'none';
    fromSelect.innerHTML = '<option value="">-- Select --</option>';
    toSelect.innerHTML = '<option value="">-- Select --</option>';
    
    if (type === 'deposit') {
        fromGroup.style.display = 'block';
        customers.forEach(c => {
            fromSelect.innerHTML += `<option value="${c.id}">${c.name} (Customer)</option>`;
        });
    } else if (type === 'withdrawal') {
        toGroup.style.display = 'block';
        suppliers.forEach(s => {
            toSelect.innerHTML += `<option value="${s.id}">${s.name} (Supplier)</option>`;
        });
        toSelect.innerHTML += '<option value="owner">Owner</option>';
    } else if (type === 'transfer') {
        fromGroup.style.display = 'block';
        toGroup.style.display = 'block';
        fromSelect.innerHTML += '<option value="bank">Bank Account</option>';
        toSelect.innerHTML += '<option value="bank">Bank Account</option>';
    }
}

function saveBankTransaction(e) {
    e.preventDefault();
    const type = document.getElementById('bankTransactionType').value;
    const amount = parseFloat(document.getElementById('bankAmount').value);
    
    const transaction = {
        id: 'bank_' + Date.now(),
        type,
        fromId: document.getElementById('bankFrom')?.value || null,
        toId: document.getElementById('bankTo')?.value || null,
        amount,
        description: document.getElementById('bankDescription').value,
        date: new Date().toISOString(),
        createdBy: currentUser
    };
    
    bankTransactions.push(transaction);
    localStorage.setItem('bankTransactions', JSON.stringify(bankTransactions));
    
    renderBankTransactions();
    updateDashboardStats();
    closeModal('bankModal');
    showNotification('Bank transaction recorded successfully!');
}

function renderBankTransactions() {
    const tbody = document.getElementById('bankTable');
    if (bankTransactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#a0aec0;">No bank transactions yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = bankTransactions.slice().reverse().map(t => {
        const date = new Date(t.date);
        const fromName = t.fromId ? (customers.find(c => c.id === t.fromId)?.name || t.fromId) : '-';
        const toName = t.toId ? (suppliers.find(s => s.id === t.toId)?.name || t.toId) : '-';
        
        return `
            <tr>
                <td>${date.toLocaleDateString()}</td>
                <td><span class="badge badge-info">${t.type.toUpperCase()}</span></td>
                <td>${fromName}</td>
                <td>${toName}</td>
                <td class="profit-positive" style="font-weight:700;">${formatCurrency(t.amount)}</td>
                <td>
                    <button class="action-btn delete" onclick="deleteBankTransaction('${t.id}')">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

function deleteBankTransaction(id) {
    if (confirm('Delete this bank transaction?')) {
        bankTransactions = bankTransactions.filter(t => t.id !== id);
        localStorage.setItem('bankTransactions', JSON.stringify(bankTransactions));
        renderBankTransactions();
        updateDashboardStats();
        showNotification('Bank transaction deleted!');
    }
}

// Ledger
function renderLedger() {
    const tbody = document.getElementById('ledgerTable');
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#a0aec0;">Ledger feature coming soon!</td></tr>';
}

// Government Rate Update
function previewRateChange() {
    const updatePmg = document.getElementById('updatePmg').checked;
    const updateHsd = document.getElementById('updateHsd').checked;
    const changeType = document.getElementById('changeType').value;
    const changeSign = parseInt(document.getElementById('changeSign').value);
    const changeAmount = parseFloat(document.getElementById('changeAmount').value);
    const scope = document.getElementById('changeScope').value;
    
    if (!updatePmg && !updateHsd) {
        showNotification('Select at least one fuel type!', 'error');
        return;
    }
    
    let affectedParties = [];
    if (scope === 'all' || scope === 'customers') affectedParties = affectedParties.concat(customers);
    if (scope === 'all' || scope === 'suppliers') affectedParties = affectedParties.concat(suppliers);
    
    let html = '<table style="width:100%; font-size:0.85em;"><thead><tr><th>Name</th><th>Old PMG</th><th>New PMG</th><th>Old HSD</th><th>New HSD</th></tr></thead><tbody>';
    
    affectedParties.slice(0, 5).forEach(party => {
        const oldPmg = parseFloat(party.pmgRate);
        const oldHsd = parseFloat(party.hsdRate);
        
        let newPmg, newHsd;
        if (changeType === 'absolute') {
            newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
            newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
        } else {
            newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
            newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
        }
        
        html += `
            <tr>
                <td><strong>${party.name}</strong></td>
                <td>Rs. ${oldPmg.toFixed(4)}</td>
                <td style="color:${newPmg > oldPmg ? '#48bb78' : newPmg < oldPmg ? '#f56565' : '#718096'};">Rs. ${newPmg.toFixed(4)}</td>
                <td>Rs. ${oldHsd.toFixed(4)}</td>
                <td style="color:${newHsd > oldHsd ? '#48bb78' : newHsd < oldHsd ? '#f56565' : '#718096'};">Rs. ${newHsd.toFixed(4)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    if (affectedParties.length > 5) {
        html += `<p style="text-align:center; margin-top:10px; color:#718096;">... and ${affectedParties.length - 5} more</p>`;
    }
    html += `<p style="text-align:center; margin-top:15px; font-weight:700; color:#667eea;">Total: ${affectedParties.length} parties</p>`;
    
    document.getElementById('previewContent').innerHTML = html;
    document.getElementById('rateChangePreview').style.display = 'block';
}

function applyGovRateChange(e) {
    e.preventDefault();
    
    const updatePmg = document.getElementById('updatePmg').checked;
    const updateHsd = document.getElementById('updateHsd').checked;
    const changeType = document.getElementById('changeType').value;
    const changeSign = parseInt(document.getElementById('changeSign').value);
    const changeAmount = parseFloat(document.getElementById('changeAmount').value);
    const scope = document.getElementById('changeScope').value;
    
    if (!updatePmg && !updateHsd) {
        showNotification('Select at least one fuel type!', 'error');
        return;
    }
    
    if (!confirm(`Apply rate change?\nType: ${changeType}\nAmount: ${changeSign > 0 ? '+' : ''}${changeAmount}\nThis will update all rates!`)) {
        return;
    }
    
    const logEntry = {
        id: 'log_' + Date.now(),
        updatePmg,
        updateHsd,
        changeType,
        changeSign,
        changeAmount,
        scope,
        appliedBy: currentUser,
        appliedAt: new Date().toISOString(),
        changes: []
    };
    
    // Update customers
    if (scope === 'all' || scope === 'customers') {
        customers.forEach(customer => {
            const oldPmg = parseFloat(customer.pmgRate);
            const oldHsd = parseFloat(customer.hsdRate);
            
            let newPmg, newHsd;
            if (changeType === 'absolute') {
                newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
            } else {
                newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
            }
            
            logEntry.changes.push({
                partyId: customer.id,
                partyName: customer.name,
                partyType: 'customer',
                oldPmgRate: oldPmg,
                newPmgRate: newPmg,
                oldHsdRate: oldHsd,
                newHsdRate: newHsd
            });
            
            customer.pmgRate = newPmg.toFixed(4);
            customer.hsdRate = newHsd.toFixed(4);
        });
    }
    
    // Update suppliers
    if (scope === 'all' || scope === 'suppliers') {
        suppliers.forEach(supplier => {
            const oldPmg = parseFloat(supplier.pmgRate);
            const oldHsd = parseFloat(supplier.hsdRate);
            
            let newPmg, newHsd;
            if (changeType === 'absolute') {
                newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
            } else {
                newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
            }
            
            logEntry.changes.push({
                partyId: supplier.id,
                partyName: supplier.name,
                partyType: 'supplier',
                oldPmgRate: oldPmg,
                newPmgRate: newPmg,
                oldHsdRate: oldHsd,
                newHsdRate: newHsd
            });
            
            supplier.pmgRate = newPmg.toFixed(4);
            supplier.hsdRate = newHsd.toFixed(4);
        });
    }
    
    rateChangeLogs.push(logEntry);
    localStorage.setItem('rateChangeLogs', JSON.stringify(rateChangeLogs));
    localStorage.setItem('customers', JSON.stringify(customers));
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
    
    showNotification(`Rate change applied to ${logEntry.changes.length} parties!`, 'success');
    closeModal('govRateModal');
    renderCustomers();
    renderSuppliers();
    document.getElementById('rateChangePreview').style.display = 'none';
}

// Dashboard Stats
function updateDashboardStats() {
    document.getElementById('totalCustomers').textContent = customers.length;
    document.getElementById('totalSuppliers').textContent = suppliers.length;
    
    const totalReceivables = customers.reduce((sum, c) => sum + (c.balance > 0 ? c.balance : 0), 0);
    const totalPayables = suppliers.reduce((sum, s) => sum + (s.balance > 0 ? s.balance : 0), 0);
    
    document.getElementById('totalReceivables').textContent = formatCurrency(totalReceivables);
    document.getElementById('totalPayables').textContent = formatCurrency(totalPayables);
    
    const today = new Date().toDateString();
    const todaySales = sales.filter(s => new Date(s.date).toDateString() === today)
        .reduce((sum, s) => sum + s.total, 0);
    document.getElementById('todaySales').textContent = formatCurrency(todaySales);
    
    const bankBalance = bankTransactions
        .filter(t => t.type === 'deposit')
        .reduce((sum, t) => sum + t.amount, 0) -
        bankTransactions
        .filter(t => t.type === 'withdrawal')
        .reduce((sum, t) => sum + t.amount, 0);
    document.getElementById('bankBalance').textContent = formatCurrency(bankBalance);
}
</script>
</body>
</html>
