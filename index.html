<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baghoor Oil Traders - Complete Professional System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Supabase SDK for Cloud Sync -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Light Mode (Default) */
        :root {
            --bg-gradient-start: #f5f7fa;
            --bg-gradient-end: #c3cfe2;
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #ebf4ff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --text-tertiary: #1a202c;
            --border-color: #e2e8f0;
            --shadow: rgba(0,0,0,0.07);
            --shadow-lg: rgba(0,0,0,0.1);
            --primary-color: #667eea;
        }
        
        /* Dark Mode */
        body.dark-mode {
            --bg-gradient-start: #1a202c;
            --bg-gradient-end: #2d3748;
            --bg-primary: #2d3748;
            --bg-secondary: #1a202c;
            --bg-tertiary: #374151;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-tertiary: #f7fafc;
            --border-color: #4a5568;
            --shadow: rgba(0,0,0,0.3);
            --shadow-lg: rgba(0,0,0,0.5);
            --primary-color: #818cf8;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-box {
            background: var(--bg-primary);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px var(--shadow-lg);
            max-width: 450px;
            width: 100%;
        }
        .login-box h1 { text-align: center; color: var(--primary-color); margin-bottom: 10px; font-size: 2.2em; }
        .login-box p { text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 0.95em; }
        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .role-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        .role-btn:hover { border-color: var(--primary-color); background: var(--bg-secondary); }
        .role-btn.active { border-color: var(--primary-color); background: var(--primary-color); color: white; }
        
        .quick-entry {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 20px;
        }
        .quick-entry h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 700;
        }
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .quick-btn {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        .quick-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px var(--shadow-lg);
            border-color: var(--primary-color);
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid var(--primary-color);
        }
        .header h1 { color: var(--text-tertiary); font-size: 1.8em; font-weight: 700; }
        .company-tagline { display: block; font-size: 0.4em; color: var(--primary-color); font-weight: 600; margin-top: 5px; text-transform: uppercase; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .user-info {
            background: var(--bg-tertiary);
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .user-role { font-size: 0.8em; color: #667eea; margin-top: 2px; }
        .role-admin { color: #f56565; }
        .role-manager { color: #ed8936; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-info { background: #4299e1; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-secondary { background: #a0aec0; color: white; }
        .btn-purple { background: #805ad5; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 11px; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-bottom: 25px; }
        .stat-card {
            background: var(--bg-primary);
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: all 0.3s;
            border-left: 4px solid;
        }
        .stat-card:nth-child(1) { border-left-color: #667eea; }
        .stat-card:nth-child(2) { border-left-color: #48bb78; }
        .stat-card:nth-child(3) { border-left-color: #ed8936; }
        .stat-card:nth-child(4) { border-left-color: #4299e1; }
        .stat-card:nth-child(5) { border-left-color: #f56565; }
        .stat-card:nth-child(6) { border-left-color: #9f7aea; }
        .stat-card:nth-child(7) { border-left-color: #38b2ac; }
        .stat-card:nth-child(8) { border-left-color: #f687b3; }
        .stat-card:nth-child(9) { border-left-color: #805ad5; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px var(--shadow-lg); }
        .stat-card h3 { color: var(--text-secondary); font-size: 0.8em; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .stat-card .value { font-size: 1.8em; font-weight: 700; margin-bottom: 6px; }
        .stat-card:nth-child(1) .value { color: #667eea; }
        .stat-card:nth-child(2) .value { color: #48bb78; }
        .stat-card:nth-child(3) .value { color: #ed8936; }
        .stat-card:nth-child(4) .value { color: #4299e1; }
        .stat-card:nth-child(5) .value { color: #f56565; }
        .stat-card:nth-child(6) .value { color: #9f7aea; }
        .stat-card:nth-child(7) .value { color: #38b2ac; }
        .stat-card:nth-child(8) .value { color: #f687b3; }
        .stat-card:nth-child(9) .value { color: #805ad5; }
        
        .card { background: var(--bg-primary); padding: 22px; border-radius: 14px; box-shadow: 0 4px 6px var(--shadow); margin-bottom: 20px; }
        .card h2 { color: var(--text-tertiary); margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid var(--border-color); font-weight: 700; font-size: 1.3em; display: flex; justify-content: space-between; align-items: center; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-primary); font-weight: 600; font-size: 0.85em; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .form-group textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 10px; }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .checkbox-group label { margin: 0; font-weight: 600; color: var(--text-primary); cursor: pointer; }
        
        .table-container { overflow-x: auto; margin-top: 12px; border-radius: 10px; border: 1px solid var(--border-color); max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.85em; color: var(--text-primary); }
        th { font-weight: 700; text-transform: uppercase; color: white; }
        tbody tr:hover { background: var(--bg-secondary); }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: var(--bg-primary);
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        .modal-header h2 { color: var(--primary-color); margin: 0; }
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
        }
        .close-btn:hover { color: #f56565; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification.success { background: #48bb78; color: white; }
        .notification.error { background: #f56565; color: white; }
        .notification.warning { background: #ed8936; color: white; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 13px;
        }
        .tab:hover { color: var(--primary-color); background: var(--bg-secondary); }
        .tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .profit-loss-section { margin-top: 20px; }
        .profit-loss-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95em;
        }
        .profit-loss-item.total {
            background: var(--bg-secondary);
            font-size: 1.1em;
            font-weight: 700;
            border-bottom: none;
            margin-top: 10px;
        }
        
        #rateChangePreview {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #667eea;
        }
        
        .balance-positive { color: #48bb78; }
        .balance-negative { color: #f56565; }
        
        .ledger-entry { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .ledger-debit { border-left: 4px solid #f56565; }
        .ledger-credit { border-left: 4px solid #48bb78; }
        
        .stock-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            margin-right: 5px;
        }
        .stock-pmg { background: #667eea; color: white; }
        .stock-hsd { background: #ed8936; color: white; }
        
        /* Theme Toggle Button */
        .theme-toggle {
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }
        
        /* Admin Settings Styles */
        .user-management-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        .user-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
        }
        .user-card-info h4 {
            color: var(--text-tertiary);
            margin-bottom: 5px;
        }
        .user-card-info p {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin: 3px 0;
        }
        .user-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; }
            .header-actions { width: 100%; justify-content: center; }
            .ledger-entry { grid-template-columns: 1fr; }
            .user-card { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-container">
    <div class="login-box">
        <h1>🛢️ Baghoor Oil Traders</h1>
        <p>Complete Professional Accounting System</p>
        
        <div class="role-selector">
            <button class="role-btn active" onclick="selectRole('admin')">Admin</button>
            <button class="role-btn" onclick="selectRole('manager')">Manager</button>
            <button class="role-btn" onclick="selectRole('accountant')">Accountant</button>
        </div>
        
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Login</button>
        </form>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display: none;">
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div>
                <h1>
                    🛢️ Baghoor Oil Traders
                    <span class="company-tagline">Complete Professional Accounting System</span>
                </h1>
            </div>
            <div class="header-actions">
                <div class="user-info">
                    <span id="userDisplay"></span>
                    <span class="user-role" id="userRoleDisplay"></span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                    <span id="themeIcon">🌙</span>
                </button>
                <button class="btn btn-purple" id="adminSettingsBtn" onclick="openModal('adminSettingsModal')" style="display: none;">⚙️ Admin Settings</button>
                <button class="btn btn-warning" onclick="openModal('backupModal')">💾 Backup</button>
                <button class="btn btn-danger" onclick="clearAllData()" title="Delete all data and start fresh" style="background: #dc3545;">🗑️ Clear Data</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- QUICK ENTRY SECTION -->
        <div class="quick-entry">
            <h3>⚡ Quick Actions</h3>
            <div class="quick-grid">
                <button class="quick-btn" onclick="openModal('customerModal')">➕ Add Customer</button>
                <button class="quick-btn" onclick="openModal('supplierModal')">➕ Add Supplier</button>
                <button class="quick-btn" onclick="openModal('saleModal')">💰 Record Sale</button>
                <button class="quick-btn" onclick="openModal('purchaseModal')">🛒 Record Purchase</button>
                <button class="quick-btn" onclick="openModal('paymentModal')">💳 Record Payment</button>
                <button class="quick-btn" onclick="openModal('jvModal')">📝 JV Voucher</button>
                <button class="quick-btn" onclick="openModal('customerTransferModal')">🔄 Customer Transfer</button>
                <button class="quick-btn" onclick="openModal('expenseModal')">💸 Add Expense</button>
                <button class="quick-btn" onclick="openModal('bankTransModal')">🏦 Bank Transaction</button>
                <button class="quick-btn" onclick="openModal('vehicleModal')">🚛 Add Vehicle</button>
                <button class="quick-btn" onclick="openModal('invoiceModal')">🧾 Vehicle Invoice</button>
                <button class="quick-btn" onclick="openModal('govRateModal')">📊 Gov Rate Change</button>
            </div>
        </div>

        <!-- DASHBOARD STATS -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Total Customers</h3>
                <div class="value" id="totalCustomers">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Suppliers</h3>
                <div class="value" id="totalSuppliers">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Vehicles</h3>
                <div class="value" id="totalVehicles">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Banks</h3>
                <div class="value" id="totalBanks">0</div>
            </div>
            <div class="stat-card">
                <h3>Receivables</h3>
                <div class="value" id="totalReceivables">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Payables</h3>
                <div class="value" id="totalPayables">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Bank Balance</h3>
                <div class="value" id="totalBankBalance">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Total Expenses</h3>
                <div class="value" id="totalExpenses">Rs. 0</div>
            </div>
            <div class="stat-card">
                <h3>Total Stock</h3>
                <div class="value" id="totalStock">0 KL</div>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('customers')">👥 Customers</button>
            <button class="tab" onclick="switchTab('suppliers')">🏭 Suppliers</button>
            <button class="tab" onclick="switchTab('transactions')">💳 Transactions</button>
            <button class="tab" onclick="switchTab('payments')">💰 Payments</button>
            <button class="tab" onclick="switchTab('expenses')">💸 Expenses</button>
            <button class="tab" onclick="switchTab('banks')">🏦 Banks</button>
            <button class="tab" onclick="switchTab('vehicles')">🚛 Vehicles</button>
            <button class="tab" onclick="switchTab('ledger')">📒 Ledger</button>
            <button class="tab" onclick="switchTab('reports')">📊 Reports</button>
        </div>

        <!-- CUSTOMERS TAB -->
        <div id="customers-tab" class="tab-content active">
            <div class="card">
                <h2>
                    Customers Management
                    <button class="btn btn-primary" onclick="openModal('customerModal')">Add Customer</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>CNIC</th>
                                <th>PMG Rate</th>
                                <th>HSD Rate</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SUPPLIERS TAB -->
        <div id="suppliers-tab" class="tab-content">
            <div class="card">
                <h2>
                    Suppliers Management
                    <button class="btn btn-primary" onclick="openModal('supplierModal')">Add Supplier</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>CNIC</th>
                                <th>PMG Rate</th>
                                <th>HSD Rate</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRANSACTIONS TAB -->
        <div id="transactions-tab" class="tab-content">
            <div class="card">
                <h2>
                    Transaction History
                    <div>
                        <button class="btn btn-success" onclick="openModal('saleModal')">Add Sale</button>
                        <button class="btn btn-warning" onclick="openModal('purchaseModal')">Add Purchase</button>
                    </div>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Party</th>
                                <th>Fuel</th>
                                <th>Quantity</th>
                                <th>Rate</th>
                                <th>Amount</th>
                                <th>Vehicle</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAYMENTS TAB -->
        <div id="payments-tab" class="tab-content">
            <div class="card">
                <h2>
                    Payment History
                    <button class="btn btn-success" onclick="openModal('paymentModal')">Record Payment</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Party</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Bank</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- EXPENSES TAB -->
        <div id="expenses-tab" class="tab-content">
            <div class="card">
                <h2>
                    Expenses Management
                    <button class="btn btn-danger" onclick="openModal('expenseModal')">Add Expense</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Paid From</th>
                                <th>Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BANKS TAB -->
        <div id="banks-tab" class="tab-content">
            <div class="card">
                <h2>
                    Bank Accounts & Transactions
                    <div>
                        <button class="btn btn-primary" onclick="openModal('bankModal')">Add Bank</button>
                        <button class="btn btn-success" onclick="openModal('bankTransModal')">Bank Transaction</button>
                    </div>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bank Name</th>
                                <th>Account Number</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="banksBody"></tbody>
                    </table>
                </div>
                <h3 style="margin-top: 20px; color: #667eea;">Recent Bank Transactions</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bank</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Balance After</th>
                            </tr>
                        </thead>
                        <tbody id="bankTransactionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VEHICLES TAB -->
        <div id="vehicles-tab" class="tab-content">
            <div class="card">
                <h2>
                    Vehicle Management & Stock
                    <button class="btn btn-primary" onclick="openModal('vehicleModal')">Add Vehicle</button>
                </h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle Number</th>
                                <th>Driver</th>
                                <th>Contact</th>
                                <th>PMG Stock</th>
                                <th>HSD Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehiclesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- LEDGER TAB (NEW) -->
        <div id="ledger-tab" class="tab-content">
            <div class="card">
                <h2>
                    Daily Ledger (Debit/Credit)
                    <div>
                        <button class="btn btn-info" onclick="generateLedger()">📒 Generate Today's Ledger</button>
                        <button class="btn btn-success" onclick="checkBalance()">⚖️ Check Balance</button>
                    </div>
                </h2>
                <div id="ledgerOutput"></div>
            </div>
        </div>

        <!-- REPORTS TAB -->
        <div id="reports-tab" class="tab-content">
            <div class="card">
                <h2>Reports & Analytics</h2>
                
                <!-- General Reports -->
                <h3 style="color: #667eea; margin-bottom: 10px;">📊 General Reports</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px;">
                    <button class="btn btn-info" onclick="generateProfitLossReport()">📊 Profit & Loss</button>
                    <button class="btn btn-success" onclick="generateMonthlyReport()">📅 Monthly Report</button>
                    <button class="btn btn-warning" onclick="generateVehicleProfitReport()">🚛 All Vehicles Profit</button>
                    <button class="btn btn-purple" onclick="generateStockReport()">📦 Stock Report</button>
                    <button class="btn btn-danger" onclick="generateExpenseReport()">💸 Expense Report</button>
                    <button class="btn btn-primary" onclick="generateAllPartiesReport()">📋 All Parties Balance</button>
                </div>
                
                <!-- Customer-wise Ledger -->
                <h3 style="color: #667eea; margin-bottom: 10px; margin-top: 25px;">👤 Customer-wise Ledger Report</h3>
                <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Select Customer</label>
                            <select id="customerReportSelect">
                                <option value="">Choose Customer</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>From Date</label>
                            <input type="date" id="customerReportFromDate">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>To Date</label>
                            <input type="date" id="customerReportToDate">
                        </div>
                        <button class="btn btn-success" onclick="generateCustomerLedgerReport()">Generate Report</button>
                        <button class="btn btn-primary" onclick="exportCustomerLedgerPDF()">Export PDF</button>
                    </div>
                </div>
                
                <!-- Vehicle-wise Profit -->
                <h3 style="color: #667eea; margin-bottom: 10px;">🚛 Individual Vehicle Report</h3>
                <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Select Vehicle</label>
                            <select id="vehicleReportSelect">
                                <option value="">Choose Vehicle</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>From Date</label>
                            <input type="date" id="vehicleReportFromDate">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>To Date</label>
                            <input type="date" id="vehicleReportToDate">
                        </div>
                        <button class="btn btn-success" onclick="generateSingleVehicleReport()">Generate Report</button>
                        <button class="btn btn-primary" onclick="exportSingleVehiclePDF()">Export PDF</button>
                    </div>
                </div>
                
                <!-- Export Options -->
                <h3 style="color: #667eea; margin-bottom: 10px;">💾 Export Options</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="exportVehicleProfitPDF()">📄 Export All Vehicles PDF</button>
                    <button class="btn btn-secondary" onclick="exportAllDataExcel()">📥 Export All Data Excel</button>
                    <button class="btn btn-info" onclick="exportAllPartiesPDF()">📄 Export All Parties PDF</button>
                </div>
                
                <div id="reportOutput"></div>
            </div>
        </div>
    </div>
</div>

<!-- ALL MODALS -->

<!-- CUSTOMER MODAL -->
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Customer</h2>
            <button class="close-btn" onclick="closeModal('customerModal')">&times;</button>
        </div>
        <form onsubmit="saveCustomer(event)">
            <input type="hidden" id="customerId">
            <div class="form-group">
                <label>Customer Name *</label>
                <input type="text" id="customerName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="text" id="customerContact">
                </div>
                <div class="form-group">
                    <label>CNIC</label>
                    <input type="text" id="customerCnic" placeholder="12345-1234567-1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>PMG Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="customerPmgRate" required>
                </div>
                <div class="form-group">
                    <label>HSD Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="customerHsdRate" required>
                </div>
            </div>
            <div class="form-group">
                <label>Opening Balance (Rs)</label>
                <input type="number" step="0.01" id="customerOpeningBalance" value="0" placeholder="Previous balance (if any)">
                <small style="color: var(--text-secondary); font-size: 0.85em;">💡 Enter previous balance here (Positive = Customer owes you, Negative = You owe customer)</small>
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="customerAddress"></textarea>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="customerNotes"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Save Customer</button>
        </form>
    </div>
</div>

<!-- SUPPLIER MODAL -->
<div id="supplierModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Supplier</h2>
            <button class="close-btn" onclick="closeModal('supplierModal')">&times;</button>
        </div>
        <form onsubmit="saveSupplier(event)">
            <input type="hidden" id="supplierId">
            <div class="form-group">
                <label>Supplier Name *</label>
                <input type="text" id="supplierName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="text" id="supplierContact">
                </div>
                <div class="form-group">
                    <label>CNIC</label>
                    <input type="text" id="supplierCnic" placeholder="12345-1234567-1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>PMG Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="supplierPmgRate" required>
                </div>
                <div class="form-group">
                    <label>HSD Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="supplierHsdRate" required>
                </div>
            </div>
            <div class="form-group">
                <label>Opening Balance (Rs)</label>
                <input type="number" step="0.01" id="supplierOpeningBalance" value="0" placeholder="Previous balance (if any)">
                <small style="color: var(--text-secondary); font-size: 0.85em;">💡 Enter previous balance here (Positive = You owe supplier, Negative = Supplier owes you)</small>
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="supplierAddress"></textarea>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="supplierNotes"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Save Supplier</button>
        </form>
    </div>
</div>

<!-- SALE MODAL -->
<div id="saleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Sale</h2>
            <button class="close-btn" onclick="closeModal('saleModal')">&times;</button>
        </div>
        <form onsubmit="saveSale(event)">
            <div class="form-group">
                <label>Customer *</label>
                <select id="saleCustomerId" required>
                    <option value="">Select Customer</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Fuel Type *</label>
                    <select id="saleFuelType" onchange="updateSaleRate()" required>
                        <option value="">Select Fuel</option>
                        <option value="PMG">PMG (Petrol)</option>
                        <option value="HSD">HSD (Diesel)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vehicle *</label>
                    <select id="saleVehicleId" required>
                        <option value="">Select Vehicle</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity (Liters) *</label>
                    <input type="number" step="0.01" id="saleQuantity" oninput="calculateSaleAmount()" required>
                </div>
                <div class="form-group">
                    <label>Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="saleRate" oninput="calculateSaleAmount()" required>
                </div>
            </div>
            <div class="form-group">
                <label>Subtotal (Before Discount)</label>
                <input type="number" step="0.01" id="saleSubtotal" readonly style="background: #f0f0f0; font-weight: 600;">
            </div>
            
            <!-- DISCOUNT SECTION -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #ffc107;">
                <h4 style="color: #856404; margin-bottom: 10px; font-size: 0.95em;">💰 Discount (Optional)</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Discount Type</label>
                        <select id="saleDiscountType" onchange="calculateSaleAmount()">
                            <option value="none">No Discount</option>
                            <option value="percentage">Percentage (%)</option>
                            <option value="fixed">Fixed Amount (Rs)</option>
                            <option value="perlitre">Rupees Per Litre (Rs/L)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Discount Value</label>
                        <input type="number" step="0.01" id="saleDiscountValue" value="0" oninput="calculateSaleAmount()" placeholder="Enter discount">
                    </div>
                </div>
                <div id="saleDiscountInfo" style="font-size: 0.85em; color: #856404; margin-top: 8px;"></div>
            </div>
            
            <div class="form-group">
                <label>Final Amount (After Discount)</label>
                <input type="number" step="0.01" id="saleAmount" readonly style="background: #d4edda; font-weight: 700; font-size: 1.1em; color: #155724;">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="saleDate" required>
            </div>
            <button type="submit" class="btn btn-success">Save Sale</button>
        </form>
    </div>
</div>

<!-- PURCHASE MODAL -->
<div id="purchaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Purchase</h2>
            <button class="close-btn" onclick="closeModal('purchaseModal')">&times;</button>
        </div>
        <form onsubmit="savePurchase(event)">
            <div class="form-group">
                <label>Supplier *</label>
                <select id="purchaseSupplierId" required>
                    <option value="">Select Supplier</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Fuel Type *</label>
                    <select id="purchaseFuelType" onchange="updatePurchaseRate()" required>
                        <option value="">Select Fuel</option>
                        <option value="PMG">PMG (Petrol)</option>
                        <option value="HSD">HSD (Diesel)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vehicle *</label>
                    <select id="purchaseVehicleId" required>
                        <option value="">Select Vehicle</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantity (Liters) *</label>
                    <input type="number" step="0.01" id="purchaseQuantity" oninput="calculatePurchaseAmount()" required>
                </div>
                <div class="form-group">
                    <label>Rate (Rs/L) *</label>
                    <input type="number" step="0.0001" id="purchaseRate" oninput="calculatePurchaseAmount()" required>
                </div>
            </div>
            <div class="form-group">
                <label>Subtotal (Before Discount)</label>
                <input type="number" step="0.01" id="purchaseSubtotal" readonly style="background: #f0f0f0; font-weight: 600;">
            </div>
            
            <!-- DISCOUNT SECTION -->
            <div style="background: #d1ecf1; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #17a2b8;">
                <h4 style="color: #0c5460; margin-bottom: 10px; font-size: 0.95em;">💰 Discount from Supplier (Optional)</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Discount Type</label>
                        <select id="purchaseDiscountType" onchange="calculatePurchaseAmount()">
                            <option value="none">No Discount</option>
                            <option value="percentage">Percentage (%)</option>
                            <option value="fixed">Fixed Amount (Rs)</option>
                            <option value="perlitre">Rupees Per Litre (Rs/L)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Discount Value</label>
                        <input type="number" step="0.01" id="purchaseDiscountValue" value="0" oninput="calculatePurchaseAmount()" placeholder="Enter discount">
                    </div>
                </div>
                <div id="purchaseDiscountInfo" style="font-size: 0.85em; color: #0c5460; margin-top: 8px;"></div>
            </div>
            
            <div class="form-group">
                <label>Final Amount (After Discount)</label>
                <input type="number" step="0.01" id="purchaseAmount" readonly style="background: #d4edda; font-weight: 700; font-size: 1.1em; color: #155724;">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="purchaseDate" required>
            </div>
            <button type="submit" class="btn btn-success">Save Purchase</button>
        </form>
    </div>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>💳 Record Payment</h2>
            <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
        </div>
        <form onsubmit="savePayment(event)">
            <div class="form-group">
                <label>Payment Type *</label>
                <select id="paymentType" onchange="updatePaymentParties()" required>
                    <option value="">Select Type</option>
                    <option value="received">Payment Received (from Customer)</option>
                    <option value="paid">Payment Made (to Supplier)</option>
                </select>
            </div>
            <div class="form-group">
                <label id="paymentPartyLabel">Party *</label>
                <select id="paymentPartyId" required>
                    <option value="">Select Party</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="paymentAmount" required>
            </div>
            <div class="form-group">
                <label>Payment Method *</label>
                <select id="paymentMethod" onchange="toggleBankField()" required>
                    <option value="cash">Cash</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group" id="paymentBankGroup" style="display: none;">
                <label>Bank Account</label>
                <select id="paymentBankId">
                    <option value="">Select Bank</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="paymentDate" required>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="paymentNotes" placeholder="Reference number, cheque number, etc."></textarea>
            </div>
            <button type="submit" class="btn btn-success">Record Payment</button>
        </form>
    </div>
</div>

<!-- CUSTOMER TRANSFER MODAL (NEW) -->
<div id="customerTransferModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>🔄 Customer to Customer Transfer</h2>
            <button class="close-btn" onclick="closeModal('customerTransferModal')">&times;</button>
        </div>
        <form onsubmit="saveCustomerTransfer(event)">
            <div class="form-group">
                <label>Paying Customer (Debit) *</label>
                <select id="transferFromCustomerId" required>
                    <option value="">Select Customer</option>
                </select>
                <small style="color: #718096;">This customer's balance will increase (debit)</small>
            </div>
            <div class="form-group">
                <label>Receiving Customer (Credit) *</label>
                <select id="transferToCustomerId" required>
                    <option value="">Select Customer</option>
                </select>
                <small style="color: #718096;">This customer's balance will decrease (credit)</small>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="transferAmount" required>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="transferDate" required>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="transferNotes" placeholder="Reason for transfer"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Record Transfer</button>
        </form>
    </div>
</div>

<!-- EXPENSE MODAL (UPDATED) -->
<div id="expenseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>💸 Add Expense</h2>
            <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
        </div>
        <form onsubmit="saveExpense(event)">
            <input type="hidden" id="expenseId">
            <div class="form-group">
                <label>Category *</label>
                <select id="expenseCategory" required>
                    <option value="">Select Category</option>
                    <option value="Fuel">Fuel</option>
                    <option value="Salaries">Salaries</option>
                    <option value="Rent">Rent</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Vehicle Maintenance">Vehicle Maintenance</option>
                    <option value="Office Supplies">Office Supplies</option>
                    <option value="Transport">Transport</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Insurance">Insurance</option>
                    <option value="Taxes">Taxes</option>
                    <option value="Miscellaneous">Miscellaneous</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="expenseDescription" required placeholder="Details about the expense"></textarea>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="expenseAmount" required>
            </div>
            <div class="form-group">
                <label>Paid From *</label>
                <select id="expenseSource" onchange="toggleExpenseSourceField()" required>
                    <option value="bank">Bank Account</option>
                    <option value="customer">Customer Account</option>
                    <option value="cash">Cash</option>
                </select>
            </div>
            <div class="form-group" id="expenseBankGroup">
                <label>Bank Account *</label>
                <select id="expenseBankId">
                    <option value="">Select Bank</option>
                </select>
            </div>
            <div class="form-group" id="expenseCustomerGroup" style="display: none;">
                <label>Customer *</label>
                <select id="expenseCustomerId">
                    <option value="">Select Customer</option>
                </select>
                <small style="color: #718096;">Customer's balance will decrease</small>
            </div>
            <div class="form-group">
                <label>Payment Method *</label>
                <select id="expenseMethod" required>
                    <option value="cash">Cash</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="expenseDate" required>
            </div>
            <button type="submit" class="btn btn-danger">Save Expense</button>
        </form>
    </div>
</div>

<!-- BANK TRANSACTION MODAL -->
<div id="bankTransModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>🏦 Bank Transaction</h2>
            <button class="close-btn" onclick="closeModal('bankTransModal')">&times;</button>
        </div>
        <form onsubmit="saveBankTransaction(event)">
            <div class="form-group">
                <label>Bank Account *</label>
                <select id="bankTransBankId" required>
                    <option value="">Select Bank</option>
                </select>
            </div>
            <div class="form-group">
                <label>Transaction Type *</label>
                <select id="bankTransType" required>
                    <option value="deposit">Deposit (Money In)</option>
                    <option value="withdrawal">Withdrawal (Money Out)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" step="0.01" id="bankTransAmount" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="bankTransDescription" placeholder="Purpose of transaction"></textarea>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="bankTransDate" required>
            </div>
            <button type="submit" class="btn btn-success">Save Transaction</button>
        </form>
    </div>
</div>

<!-- VEHICLE MODAL -->
<div id="vehicleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Vehicle</h2>
            <button class="close-btn" onclick="closeModal('vehicleModal')">&times;</button>
        </div>
        <form onsubmit="saveVehicle(event)">
            <input type="hidden" id="vehicleId">
            <div class="form-group">
                <label>Vehicle Number *</label>
                <input type="text" id="vehicleNumber" required placeholder="ABC-123">
            </div>
            <div class="form-group">
                <label>Driver Name *</label>
                <input type="text" id="vehicleDriver" required>
            </div>
            <div class="form-group">
                <label>Driver Contact</label>
                <input type="text" id="vehicleContact">
            </div>
            <hr style="border: 1px solid var(--border-color); margin: 15px 0;">
            <h4 style="color: var(--primary-color); margin-bottom: 10px;">🚗 Vehicle Owner Information</h4>
            <div class="form-group">
                <label>Owner Name</label>
                <input type="text" id="vehicleOwnerName" placeholder="Vehicle owner (if different from driver)">
            </div>
            <div class="form-group">
                <label>Owner Contact</label>
                <input type="text" id="vehicleOwnerContact">
            </div>
            <div class="form-group">
                <label>Owner Opening Balance (Rs)</label>
                <input type="number" step="0.01" id="vehicleOwnerBalance" value="0" placeholder="Previous balance with owner">
                <small style="color: var(--text-secondary); font-size: 0.85em;">💡 Enter previous balance (Positive = You owe owner, Negative = Owner owes you)</small>
            </div>
            <hr style="border: 1px solid var(--border-color); margin: 15px 0;">
            <div class="form-group">
                <label>Status</label>
                <select id="vehicleStatus">
                    <option value="Active">Active</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Inactive">Inactive</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success">Save Vehicle</button>
        </form>
    </div>
</div>

<!-- BANK MODAL -->
<div id="bankModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add/Edit Bank Account</h2>
            <button class="close-btn" onclick="closeModal('bankModal')">&times;</button>
        </div>
        <form onsubmit="saveBank(event)">
            <input type="hidden" id="bankId">
            <div class="form-group">
                <label>Bank Name *</label>
                <input type="text" id="bankName" required placeholder="e.g., Meezan Bank">
            </div>
            <div class="form-group">
                <label>Account Number *</label>
                <input type="text" id="bankAccount" required>
            </div>
            <div class="form-group">
                <label>Opening Balance</label>
                <input type="number" step="0.01" id="bankBalance" value="0">
            </div>
            <button type="submit" class="btn btn-success">Save Bank</button>
        </form>
    </div>
</div>

<!-- GOVERNMENT RATE CHANGE MODAL -->
<div id="govRateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>🏛️ Government Rate Change</h2>
            <button class="close-btn" onclick="closeModal('govRateModal')">&times;</button>
        </div>
        <form onsubmit="applyGovRateChange(event)">
            <div class="checkbox-group">
                <input type="checkbox" id="updatePmg" checked>
                <label for="updatePmg">Update PMG (Petrol) Rates</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="updateHsd" checked>
                <label for="updateHsd">Update HSD (Diesel) Rates</label>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Change Type</label>
                    <select id="changeType">
                        <option value="absolute">Absolute (Rs)</option>
                        <option value="percentage">Percentage (%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Direction</label>
                    <select id="changeSign">
                        <option value="1">Increase (+)</option>
                        <option value="-1">Decrease (-)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" step="0.0001" id="changeAmount" required>
            </div>
            <div class="form-group">
                <label>Apply To</label>
                <select id="changeScope">
                    <option value="all">All (Customers & Suppliers)</option>
                    <option value="customers">Customers Only</option>
                    <option value="suppliers">Suppliers Only</option>
                </select>
            </div>
            <button type="button" class="btn btn-info" onclick="previewGovRateChange()">Preview Changes</button>
            <div id="rateChangePreview" style="display: none;">
                <h3 style="color: #667eea; margin: 15px 0 10px 0;">Preview:</h3>
                <div id="previewContent"></div>
            </div>
            <button type="submit" class="btn btn-success" style="margin-top: 15px; width: 100%;">Apply Changes</button>
        </form>
    </div>
</div>

<!-- BACKUP MODAL -->
<div id="backupModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h2>💾 Backup & Export System</h2>
            <button class="close-btn" onclick="closeModal('backupModal')">&times;</button>
        </div>
        
        <!-- Complete Backup Section -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">📦 Complete System Backup</h3>
            <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <p style="color: var(--text-secondary); margin-bottom: 10px;">Download ALL your data as one backup file (JSON format)</p>
                <button class="btn btn-success" onclick="createBackup()">💾 Download Complete Backup</button>
            </div>
            <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px;">
                <p style="color: var(--text-secondary); margin-bottom: 10px;">Upload complete backup file to restore ALL data</p>
                <input type="file" id="backupFile" accept=".json" style="margin-bottom: 10px;">
                <button class="btn btn-warning" onclick="restoreBackup()">⚠️ Restore Complete Backup</button>
            </div>
        </div>
        
        <hr style="border: 1px solid var(--border-color); margin: 30px 0;">
        
        <!-- Individual Data Export/Backup Section -->
        <div>
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">📊 Individual Data Export & Backup</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9em;">
                <strong>PDF</strong> = For viewing/printing/records | <strong>JSON</strong> = For backup/restore
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 15px;">
                
                <!-- Customers -->
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid #48bb78;">
                    <h4 style="color: #48bb78; margin-bottom: 10px;">👥 Customers</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-info btn-sm" onclick="exportCustomersPDF()">📄 Export PDF</button>
                        <button class="btn btn-success btn-sm" onclick="exportCustomersJSON()">💾 Backup (JSON)</button>
                    </div>
                    <div style="font-size: 0.85em;">
                        <input type="file" id="customersRestoreFile" accept=".json" style="font-size: 0.8em; margin-bottom: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="restoreCustomers()">⚠️ Restore</button>
                    </div>
                </div>
                
                <!-- Suppliers -->
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid #ed8936;">
                    <h4 style="color: #ed8936; margin-bottom: 10px;">🏭 Suppliers</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-info btn-sm" onclick="exportSuppliersPDF()">📄 Export PDF</button>
                        <button class="btn btn-success btn-sm" onclick="exportSuppliersJSON()">💾 Backup (JSON)</button>
                    </div>
                    <div style="font-size: 0.85em;">
                        <input type="file" id="suppliersRestoreFile" accept=".json" style="font-size: 0.8em; margin-bottom: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="restoreSuppliers()">⚠️ Restore</button>
                    </div>
                </div>
                
                <!-- Vehicles -->
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">🚛 Vehicles</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-info btn-sm" onclick="exportVehiclesPDF()">📄 Export PDF</button>
                        <button class="btn btn-success btn-sm" onclick="exportVehiclesJSON()">💾 Backup (JSON)</button>
                    </div>
                    <div style="font-size: 0.85em;">
                        <input type="file" id="vehiclesRestoreFile" accept=".json" style="font-size: 0.8em; margin-bottom: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="restoreVehicles()">⚠️ Restore</button>
                    </div>
                </div>
                
                <!-- Banks -->
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid #4299e1;">
                    <h4 style="color: #4299e1; margin-bottom: 10px;">🏦 Banks</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-info btn-sm" onclick="exportBanksPDF()">📄 Export PDF</button>
                        <button class="btn btn-success btn-sm" onclick="exportBanksJSON()">💾 Backup (JSON)</button>
                    </div>
                    <div style="font-size: 0.85em;">
                        <input type="file" id="banksRestoreFile" accept=".json" style="font-size: 0.8em; margin-bottom: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="restoreBanks()">⚠️ Restore</button>
                    </div>
                </div>
                
            </div>
            
            <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 12px; border-radius: 8px; margin-top: 20px;">
                <p style="color: #856404; font-size: 0.85em; margin: 0;">
                    <strong>⚠️ Note:</strong> Restoring individual data will REPLACE existing data of that type only. Other data stays safe!
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN SETTINGS MODAL -->
<div id="adminSettingsModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>⚙️ Admin Settings - User Management</h2>
            <button class="close-btn" onclick="closeModal('adminSettingsModal')">&times;</button>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">🔐 System Users</h3>
            <div class="user-management-grid" id="userManagementList">
                <!-- Users will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- JV VOUCHER MODAL -->
<div id="jvModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>📝 Journal Voucher (JV Entry)</h2>
            <button class="close-btn" onclick="closeModal('jvModal')">&times;</button>
        </div>
        <form onsubmit="saveJVVoucher(event)">
            <div class="form-group">
                <label>Date *</label>
                <input type="date" id="jvDate" required>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="jvDescription" required placeholder="Describe this journal entry..."></textarea>
            </div>
            
            <hr style="border: 1px solid var(--border-color); margin: 20px 0;">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- DEBIT SIDE -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 2px solid #ffc107;">
                    <h3 style="color: #856404; margin-bottom: 15px;">📤 DEBIT (Dr.)</h3>
                    <div class="form-group">
                        <label>Account Type *</label>
                        <select id="jvDebitType" onchange="updateJVDebitAccounts()" required>
                            <option value="">Select Type</option>
                            <option value="customer">Customer</option>
                            <option value="supplier">Supplier</option>
                            <option value="bank">Bank</option>
                            <option value="vehicle">Vehicle Owner</option>
                            <option value="expense">Expense</option>
                            <option value="other">Other Account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account *</label>
                        <select id="jvDebitAccount" required>
                            <option value="">Select Account</option>
                        </select>
                        <input type="text" id="jvDebitOther" placeholder="Account name" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Amount (Rs) *</label>
                        <input type="number" step="0.01" id="jvDebitAmount" oninput="validateJVAmounts()" required>
                    </div>
                </div>
                
                <!-- CREDIT SIDE -->
                <div style="background: #d4edda; padding: 15px; border-radius: 10px; border: 2px solid #28a745;">
                    <h3 style="color: #155724; margin-bottom: 15px;">📥 CREDIT (Cr.)</h3>
                    <div class="form-group">
                        <label>Account Type *</label>
                        <select id="jvCreditType" onchange="updateJVCreditAccounts()" required>
                            <option value="">Select Type</option>
                            <option value="customer">Customer</option>
                            <option value="supplier">Supplier</option>
                            <option value="bank">Bank</option>
                            <option value="vehicle">Vehicle Owner</option>
                            <option value="income">Income</option>
                            <option value="other">Other Account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account *</label>
                        <select id="jvCreditAccount" required>
                            <option value="">Select Account</option>
                        </select>
                        <input type="text" id="jvCreditOther" placeholder="Account name" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Amount (Rs) * <small style="color: #666;">(Auto-synced with Debit)</small></label>
                        <input type="number" step="0.01" id="jvCreditAmount" readonly required style="background: #e9ecef; cursor: not-allowed;">
                    </div>
                </div>
            </div>
            
            <div id="jvBalanceWarning" style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 8px; margin-top: 15px; display: none; text-align: center;">
                ⚠️ Debit and Credit amounts must be equal!
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 20px;">Save Journal Voucher</button>
        </form>
    </div>
</div>

<!-- VEHICLE INVOICE MODAL -->
<div id="invoiceModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>🧾 Generate Vehicle Invoice</h2>
            <button class="close-btn" onclick="closeModal('invoiceModal')">&times;</button>
        </div>
        
        <div class="form-group">
            <label>Select Vehicle *</label>
            <select id="invoiceVehicleId" onchange="loadVehicleInvoiceData()" required>
                <option value="">Choose Vehicle</option>
            </select>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>From Date *</label>
                <input type="date" id="invoiceFromDate" required>
            </div>
            <div class="form-group">
                <label>To Date *</label>
                <input type="date" id="invoiceToDate" required>
            </div>
        </div>
        
        <button class="btn btn-primary" onclick="generateVehicleInvoice()" style="width: 100%; margin-bottom: 20px;">📊 Generate Invoice</button>
        
        <div id="invoicePreview" style="background: var(--bg-primary); padding: 20px; border-radius: 10px; border: 2px solid var(--border-color); display: none;">
            <!-- Invoice will be generated here -->
        </div>
    </div>
</div>

<script>
// ==========================================
// SUPABASE CLOUD SYNC CONFIGURATION
// ==========================================
const SUPABASE_URL = 'https://druxbksscacocuclnzxs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRydXhia3NzY2Fjb2N1Y2xuenhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTMyOTQsImV4cCI6MjA3NzMyOTI5NH0._tlLjLoBVwI2hFKqpLFupERMN2ouvyDc-JG1rf574u0';
const TABLE_NAME = 'BOTs';

let supabaseClient = null;
let USE_SUPABASE = false;

// Initialize Supabase
if (typeof window.supabase !== 'undefined') {
    try {
        const { createClient } = window.supabase;
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        USE_SUPABASE = true;
        console.log('✅ Supabase initialized! Multi-device sync ACTIVE! 🚀');
    } catch (error) {
        console.error('❌ Supabase init failed:', error);
        USE_SUPABASE = false;
    }
} else {
    console.log('⚠️ Supabase SDK not loaded. Using localStorage only.');
}

// ==========================================
// DATA CLEANUP AND VALIDATION FUNCTION
// ==========================================
function safeLoadData(key, defaultValue = []) {
    try {
        const data = localStorage.getItem(key);
        if (!data || data === 'undefined' || data === 'null') {
            return defaultValue;
        }
        const parsed = JSON.parse(data);
        // Validate that it's an array
        if (!Array.isArray(parsed)) {
            console.warn(`Invalid data format for ${key}, resetting to default`);
            return defaultValue;
        }
        return parsed;
    } catch (error) {
        console.error(`Error loading ${key}:`, error);
        return defaultValue;
    }
}

// DATA STORAGE - SAFE LOADING
let customers = safeLoadData('customers', []);
let suppliers = safeLoadData('suppliers', []);
let transactions = safeLoadData('transactions', []);
let payments = safeLoadData('payments', []);
let expenses = safeLoadData('expenses', []);
let customerTransfers = safeLoadData('customerTransfers', []);
let vehicles = safeLoadData('vehicles', []);
let banks = safeLoadData('banks', []);
let bankTransactions = safeLoadData('bankTransactions', []);
let rateChangeLogs = safeLoadData('rateChangeLogs', []);
let ledgerEntries = safeLoadData('ledgerEntries', []);
let jvVouchers = safeLoadData('jvVouchers', []);
let currentUser = '';
let currentRole = 'admin';
let selectedRole = 'admin';

// User Management Storage - ALWAYS ensure default users exist!
const DEFAULT_USERS = [
    { id: 'user_1', username: 'admin', password: 'admin123', role: 'admin', createdAt: new Date().toISOString() },
    { id: 'user_2', username: 'manager', password: 'manager123', role: 'manager', createdAt: new Date().toISOString() },
    { id: 'user_3', username: 'accountant', password: 'accountant123', role: 'accountant', createdAt: new Date().toISOString() }
];

// Function to ensure default users always exist
function ensureDefaultUsers() {
    // If no users at all, use defaults
    if (!systemUsers || systemUsers.length === 0) {
        systemUsers = [...DEFAULT_USERS];
        return;
    }
    
    // Make sure each default user exists
    DEFAULT_USERS.forEach(defaultUser => {
        const exists = systemUsers.find(u => u.username === defaultUser.username);
        if (!exists) {
            systemUsers.push({...defaultUser});
        }
    });
}

let systemUsers = safeLoadData('systemUsers', []);
ensureDefaultUsers(); // Make sure defaults exist!

// Theme preference
let isDarkMode = localStorage.getItem('darkMode') === 'true';

// CLEAR ALL DATA FUNCTION
async function clearAllData() {
    const confirmMsg = '⚠️ WARNING! This will DELETE ALL DATA permanently!\n\n' +
                      'This includes:\n' +
                      '• All customers and suppliers\n' +
                      '• All transactions and payments\n' +
                      '• All vehicles and stock\n' +
                      '• All banks and ledgers\n' +
                      '• Everything from LOCAL and CLOUD!\n\n' +
                      'Type "DELETE ALL" to confirm:';
    
    const userInput = prompt(confirmMsg);
    
    if (userInput === 'DELETE ALL') {
        // Clear Supabase cloud data first
        if (USE_SUPABASE && supabaseClient) {
            try {
                await supabaseClient
                    .from(TABLE_NAME)
                    .delete()
                    .eq('id', 1);
                console.log('☁️ Cloud data deleted!');
            } catch (error) {
                console.error('Cloud delete error:', error);
            }
        }
        
        // Clear all localStorage
        localStorage.clear();
        
        // Show success message
        alert('✅ All data has been deleted from both local and cloud!\n\nThe page will reload with a fresh start.');
        
        // Reload page
        location.reload();
    } else {
        showNotification('❌ Data deletion cancelled. Nothing was deleted.', 'info');
    }
}

// Initialize vehicle stocks and owner info if not exists
vehicles.forEach(v => {
    if (!v.stockPMG) v.stockPMG = 0;
    if (!v.stockHSD) v.stockHSD = 0;
    if (!v.ownerName) v.ownerName = '';
    if (!v.ownerContact) v.ownerContact = '';
    if (!v.ownerBalance) v.ownerBalance = 0;
});

// LOGIN SYSTEM
function selectRole(role) {
    selectedRole = role;
    document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    // Check if user exists in systemUsers
    const user = systemUsers.find(u => u.username === username && u.password === password);
    
    if (user) {
        currentUser = username;
        currentRole = user.role;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userDisplay').textContent = username;
        document.getElementById('userRoleDisplay').textContent = user.role.toUpperCase();
        document.getElementById('userRoleDisplay').className = `user-role role-${user.role}`;
        initApp();
        showNotification('Welcome ' + username + '! 🎉', 'success');
    } else {
        showNotification('Invalid username or password!', 'error');
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        currentUser = '';
        showNotification('Logged out successfully', 'success');
    }
}

// INITIALIZATION
function initApp() {
    // Apply saved theme
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('themeIcon').textContent = '☀️';
    }
    
    // Show admin settings button only for admin
    if (currentRole === 'admin') {
        document.getElementById('adminSettingsBtn').style.display = 'inline-flex';
    } else {
        document.getElementById('adminSettingsBtn').style.display = 'none';
    }
    
    updateDashboard();
    renderCustomers();
    renderSuppliers();
    renderTransactions();
    renderPayments();
    renderExpenses();
    renderVehicles();
    renderBanks();
    renderBankTransactions();
    populateDropdowns();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('saleDate').value = today;
    document.getElementById('purchaseDate').value = today;
    document.getElementById('paymentDate').value = today;
    document.getElementById('expenseDate').value = today;
    document.getElementById('bankTransDate').value = today;
    document.getElementById('transferDate').value = today;
    
    // Set default dates for report filters
    if (document.getElementById('customerReportToDate')) {
        document.getElementById('customerReportToDate').value = today;
    }
    if (document.getElementById('vehicleReportToDate')) {
        document.getElementById('vehicleReportToDate').value = today;
    }
}

async function saveToStorage() {
    // Save to localStorage (local backup)
    localStorage.setItem('customers', JSON.stringify(customers));
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
    localStorage.setItem('transactions', JSON.stringify(transactions));
    localStorage.setItem('payments', JSON.stringify(payments));
    localStorage.setItem('expenses', JSON.stringify(expenses));
    localStorage.setItem('customerTransfers', JSON.stringify(customerTransfers));
    localStorage.setItem('vehicles', JSON.stringify(vehicles));
    localStorage.setItem('banks', JSON.stringify(banks));
    localStorage.setItem('bankTransactions', JSON.stringify(bankTransactions));
    localStorage.setItem('rateChangeLogs', JSON.stringify(rateChangeLogs));
    localStorage.setItem('ledgerEntries', JSON.stringify(ledgerEntries));
    localStorage.setItem('jvVouchers', JSON.stringify(jvVouchers));
    localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
    
    // Also save to Supabase cloud (for multi-device sync)
    if (USE_SUPABASE && supabaseClient) {
        try {
            const { error } = await supabaseClient
                .from(TABLE_NAME)
                .upsert({
                    id: 1,
                    customers, suppliers, transactions, payments, expenses,
                    customerTransfers, vehicles, banks, bankTransactions,
                    rateChangeLogs, ledgerEntries, jvVouchers, systemUsers,
                    last_updated: new Date().toISOString()
                });
            
            if (!error) {
                console.log('☁️ Data synced to cloud!');
            }
        } catch (error) {
            console.error('Cloud sync error:', error);
        }
    }
}

// Add ledger entry function
function addLedgerEntry(type, description, debitAccount, debitAmount, creditAccount, creditAmount, date) {
    const entry = {
        id: 'ledger_' + Date.now(),
        type: type,
        description: description,
        debitAccount: debitAccount,
        debitAmount: debitAmount,
        creditAccount: creditAccount,
        creditAmount: creditAmount,
        date: date || new Date().toISOString().split('T')[0],
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    ledgerEntries.push(entry);
    saveToStorage();
}

// CUSTOMER FUNCTIONS
function saveCustomer(e) {
    e.preventDefault();
    
    const openingBalance = parseFloat(document.getElementById('customerOpeningBalance').value) || 0;
    
    const customer = {
        id: document.getElementById('customerId').value || 'cust_' + Date.now(),
        name: document.getElementById('customerName').value,
        contact: document.getElementById('customerContact').value,
        cnic: document.getElementById('customerCnic').value,
        pmgRate: parseFloat(document.getElementById('customerPmgRate').value).toFixed(4),
        hsdRate: parseFloat(document.getElementById('customerHsdRate').value).toFixed(4),
        address: document.getElementById('customerAddress').value,
        notes: document.getElementById('customerNotes').value,
        balance: 0,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = customers.findIndex(c => c.id === customer.id);
    if (existingIndex >= 0) {
        // Editing existing customer - keep current balance
        customer.balance = customers[existingIndex].balance;
        customers[existingIndex] = customer;
        showNotification('Customer updated! ✅', 'success');
    } else {
        // New customer - set opening balance
        customer.balance = openingBalance;
        customers.push(customer);
        showNotification('Customer added! ✅' + (openingBalance !== 0 ? ` (Opening balance: Rs. ${openingBalance.toFixed(2)})` : ''), 'success');
    }
    
    saveToStorage();
    renderCustomers();
    closeModal('customerModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderCustomers() {
    const tbody = document.getElementById('customersBody');
    tbody.innerHTML = '';
    
    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    
    customers.forEach(customer => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${customer.name}</strong></td>
            <td>${customer.contact || '-'}</td>
            <td>${customer.cnic || '-'}</td>
            <td>Rs. ${parseFloat(customer.pmgRate).toFixed(4)}</td>
            <td>Rs. ${parseFloat(customer.hsdRate).toFixed(4)}</td>
            <td class="${customer.balance >= 0 ? 'balance-positive' : 'balance-negative'}">Rs. ${customer.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick='editCustomer(${JSON.stringify(customer).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer.id}')">Delete</button>
            </td>
        `;
        fragment.appendChild(row);
    });
    
    tbody.appendChild(fragment);
}

function editCustomer(customer) {
    document.getElementById('customerId').value = customer.id;
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerContact').value = customer.contact || '';
    document.getElementById('customerCnic').value = customer.cnic || '';
    document.getElementById('customerPmgRate').value = customer.pmgRate;
    document.getElementById('customerHsdRate').value = customer.hsdRate;
    document.getElementById('customerAddress').value = customer.address || '';
    document.getElementById('customerNotes').value = customer.notes || '';
    openModal('customerModal');
}

function deleteCustomer(id) {
    if (confirm('Are you sure?')) {
        customers = customers.filter(c => c.id !== id);
        saveToStorage();
        renderCustomers();
        updateDashboard();
        populateDropdowns();
        showNotification('Customer deleted!', 'success');
    }
}

// SUPPLIER FUNCTIONS
function saveSupplier(e) {
    e.preventDefault();
    
    const openingBalance = parseFloat(document.getElementById('supplierOpeningBalance').value) || 0;
    
    const supplier = {
        id: document.getElementById('supplierId').value || 'supp_' + Date.now(),
        name: document.getElementById('supplierName').value,
        contact: document.getElementById('supplierContact').value,
        cnic: document.getElementById('supplierCnic').value,
        pmgRate: parseFloat(document.getElementById('supplierPmgRate').value).toFixed(4),
        hsdRate: parseFloat(document.getElementById('supplierHsdRate').value).toFixed(4),
        address: document.getElementById('supplierAddress').value,
        notes: document.getElementById('supplierNotes').value,
        balance: 0,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = suppliers.findIndex(s => s.id === supplier.id);
    if (existingIndex >= 0) {
        // Editing - keep current balance
        supplier.balance = suppliers[existingIndex].balance;
        suppliers[existingIndex] = supplier;
        showNotification('Supplier updated! ✅', 'success');
    } else {
        // New supplier - set opening balance
        supplier.balance = openingBalance;
        suppliers.push(supplier);
        showNotification('Supplier added! ✅' + (openingBalance !== 0 ? ` (Opening balance: Rs. ${openingBalance.toFixed(2)})` : ''), 'success');
    }
    
    saveToStorage();
    renderSuppliers();
    closeModal('supplierModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderSuppliers() {
    const tbody = document.getElementById('suppliersBody');
    tbody.innerHTML = '';
    
    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    
    suppliers.forEach(supplier => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${supplier.name}</strong></td>
            <td>${supplier.contact || '-'}</td>
            <td>${supplier.cnic || '-'}</td>
            <td>Rs. ${parseFloat(supplier.pmgRate).toFixed(4)}</td>
            <td>Rs. ${parseFloat(supplier.hsdRate).toFixed(4)}</td>
            <td class="${supplier.balance >= 0 ? 'balance-positive' : 'balance-negative'}">Rs. ${supplier.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick='editSupplier(${JSON.stringify(supplier).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteSupplier('${supplier.id}')">Delete</button>
            </td>
        `;
        fragment.appendChild(row);
    });
    
    tbody.appendChild(fragment);
}

function editSupplier(supplier) {
    document.getElementById('supplierId').value = supplier.id;
    document.getElementById('supplierName').value = supplier.name;
    document.getElementById('supplierContact').value = supplier.contact || '';
    document.getElementById('supplierCnic').value = supplier.cnic || '';
    document.getElementById('supplierPmgRate').value = supplier.pmgRate;
    document.getElementById('supplierHsdRate').value = supplier.hsdRate;
    document.getElementById('supplierAddress').value = supplier.address || '';
    document.getElementById('supplierNotes').value = supplier.notes || '';
    openModal('supplierModal');
}

function deleteSupplier(id) {
    if (confirm('Are you sure?')) {
        suppliers = suppliers.filter(s => s.id !== id);
        saveToStorage();
        renderSuppliers();
        updateDashboard();
        populateDropdowns();
        showNotification('Supplier deleted!', 'success');
    }
}

// TRANSACTION FUNCTIONS
function saveSale(e) {
    e.preventDefault();
    
    const customerId = document.getElementById('saleCustomerId').value;
    const customer = customers.find(c => c.id === customerId);
    const fuelType = document.getElementById('saleFuelType').value;
    const quantity = parseFloat(document.getElementById('saleQuantity').value);
    const rate = parseFloat(document.getElementById('saleRate').value);
    const subtotal = parseFloat(document.getElementById('saleSubtotal').value);
    const amount = parseFloat(document.getElementById('saleAmount').value);
    const vehicleId = document.getElementById('saleVehicleId').value;
    const vehicle = vehicles.find(v => v.id === vehicleId);
    const date = document.getElementById('saleDate').value;
    
    // Get discount details
    const discountType = document.getElementById('saleDiscountType').value;
    const discountValue = parseFloat(document.getElementById('saleDiscountValue').value) || 0;
    const discountAmount = subtotal - amount;
    
    // Check if vehicle has enough stock
    if (fuelType === 'PMG' && vehicle.stockPMG < quantity/1000) {
        showNotification('Insufficient PMG stock in vehicle!', 'error');
        return;
    }
    if (fuelType === 'HSD' && vehicle.stockHSD < quantity/1000) {
        showNotification('Insufficient HSD stock in vehicle!', 'error');
        return;
    }
    
    const transaction = {
        id: 'trans_' + Date.now(),
        type: 'sale',
        partyId: customerId,
        partyName: customer.name,
        fuelType: fuelType,
        quantity: quantity,
        rate: rate,
        subtotal: subtotal,
        discountType: discountType,
        discountValue: discountValue,
        discountAmount: discountAmount,
        amount: amount,
        vehicleId: vehicleId,
        date: date,
        createdAt: new Date().toISOString()
    };
    
    // Add transaction first
    transactions.push(transaction);
    
    // Update customer balance
    customer.balance += amount;
    
    // Deduct from vehicle stock - CRITICAL: Update the actual vehicle object in the array
    const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
    if (fuelType === 'PMG') {
        vehicles[vehicleIndex].stockPMG -= quantity / 1000; // Convert liters to KL
    } else {
        vehicles[vehicleIndex].stockHSD -= quantity / 1000;
    }
    
    // Ledger entry
    addLedgerEntry('sale', `Sale to ${customer.name} - ${fuelType}`, 
        `Customer: ${customer.name}`, amount, 'Sales Revenue', amount, date);
    
    // CRITICAL: Force save to localStorage IMMEDIATELY
    saveToStorage();
    
    // CRITICAL: Force complete UI refresh
    renderTransactions();
    renderCustomers();
    renderVehicles();
    updateDashboard();
    populateDropdowns();
    
    // Close modal and reset form
    closeModal('saleModal');
    e.target.reset();
    calculateSaleAmount(); // Reset display
    
    // Success message
    let msg = '✅ Sale recorded successfully!';
    if (discountAmount > 0) {
        msg += ` (Discount: Rs. ${discountAmount.toFixed(2)})`;
    }
    showNotification(msg, 'success');
}

function savePurchase(e) {
    e.preventDefault();
    
    const supplierId = document.getElementById('purchaseSupplierId').value;
    const supplier = suppliers.find(s => s.id === supplierId);
    const fuelType = document.getElementById('purchaseFuelType').value;
    const quantity = parseFloat(document.getElementById('purchaseQuantity').value);
    const rate = parseFloat(document.getElementById('purchaseRate').value);
    const subtotal = parseFloat(document.getElementById('purchaseSubtotal').value);
    const amount = parseFloat(document.getElementById('purchaseAmount').value);
    const vehicleId = document.getElementById('purchaseVehicleId').value;
    const vehicle = vehicles.find(v => v.id === vehicleId);
    const date = document.getElementById('purchaseDate').value;
    
    // Get discount details
    const discountType = document.getElementById('purchaseDiscountType').value;
    const discountValue = parseFloat(document.getElementById('purchaseDiscountValue').value) || 0;
    const discountAmount = subtotal - amount;
    
    const transaction = {
        id: 'trans_' + Date.now(),
        type: 'purchase',
        partyId: supplierId,
        partyName: supplier.name,
        fuelType: fuelType,
        quantity: quantity,
        rate: rate,
        subtotal: subtotal,
        discountType: discountType,
        discountValue: discountValue,
        discountAmount: discountAmount,
        amount: amount,
        vehicleId: vehicleId,
        date: date,
        createdAt: new Date().toISOString()
    };
    
    transactions.push(transaction);
    supplier.balance += amount;
    
    // Add to vehicle stock
    if (fuelType === 'PMG') {
        vehicle.stockPMG += quantity / 1000; // Convert liters to KL
    } else {
        vehicle.stockHSD += quantity / 1000;
    }
    
    // Ledger entry
    addLedgerEntry('purchase', `Purchase from ${supplier.name} - ${fuelType}`, 
        'Inventory', amount, `Supplier: ${supplier.name}`, amount, date);
    
    saveToStorage();
    renderTransactions();
    renderSuppliers();
    renderVehicles();
    closeModal('purchaseModal');
    updateDashboard();
    
    let msg = 'Purchase recorded! Stock updated! ✅';
    if (discountAmount > 0) {
        msg += ` (Discount: Rs. ${discountAmount.toFixed(2)})`;
    }
    showNotification(msg, 'success');
    e.target.reset();
    calculatePurchaseAmount(); // Reset display
}

// Pagination variables
let transactionsPage = 1;
const transactionsPerPage = 50; // Show 50 at a time

function renderTransactions() {
    const tbody = document.getElementById('transactionsBody');
    tbody.innerHTML = '';
    
    // Show loading message for large datasets
    if (transactions.length > 100) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">⏳ Loading transactions...</td></tr>';
    }
    
    // Use setTimeout to prevent UI blocking for large datasets
    setTimeout(() => {
        const fragment = document.createDocumentFragment();
        
        // Get paginated transactions
        const startIndex = (transactionsPage - 1) * transactionsPerPage;
        const endIndex = startIndex + transactionsPerPage;
        const paginatedTransactions = transactions.slice().reverse().slice(startIndex, endIndex);
        
        paginatedTransactions.forEach(trans => {
            const vehicle = vehicles.find(v => v.id === trans.vehicleId);
            
            // Build discount display
            let discountDisplay = '';
            if (trans.discountAmount && trans.discountAmount > 0) {
                discountDisplay = `<br><small style="color: #28a745;">💰 Discount: Rs. ${trans.discountAmount.toFixed(2)}</small>`;
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(trans.date).toLocaleDateString()}</td>
                <td><span style="background: ${trans.type === 'sale' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${trans.type.toUpperCase()}</span></td>
                <td>${trans.partyName}</td>
                <td>${trans.fuelType}</td>
                <td>${trans.quantity.toFixed(2)} L</td>
                <td>Rs. ${trans.rate.toFixed(4)}</td>
                <td style="font-weight: 700;">Rs. ${trans.amount.toFixed(2)}${discountDisplay}</td>
                <td>${vehicle ? vehicle.number : '-'}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteTransaction('${trans.id}', '${trans.type}', '${trans.partyId}', '${trans.vehicleId}', '${trans.fuelType}', ${trans.quantity}, ${trans.amount})">Delete</button>
                </td>
            `;
            fragment.appendChild(row);
        });
        
        tbody.innerHTML = '';
        tbody.appendChild(fragment);
        
        // Show pagination info
        const totalPages = Math.ceil(transactions.length / transactionsPerPage);
        if (totalPages > 1) {
            const paginationRow = document.createElement('tr');
            paginationRow.innerHTML = `
                <td colspan="9" style="text-align: center; padding: 15px; background: var(--bg-secondary);">
                    <button class="btn btn-sm btn-secondary" onclick="changeTransactionsPage(-1)" ${transactionsPage === 1 ? 'disabled' : ''}>← Previous</button>
                    <span style="margin: 0 15px; font-weight: 700;">Page ${transactionsPage} of ${totalPages}</span>
                    <button class="btn btn-sm btn-secondary" onclick="changeTransactionsPage(1)" ${transactionsPage === totalPages ? 'disabled' : ''}>Next →</button>
                </td>
            `;
            tbody.appendChild(paginationRow);
        }
    }, 10); // Small delay to prevent UI blocking
}

function changeTransactionsPage(direction) {
    const totalPages = Math.ceil(transactions.length / transactionsPerPage);
    transactionsPage += direction;
    if (transactionsPage < 1) transactionsPage = 1;
    if (transactionsPage > totalPages) transactionsPage = totalPages;
    renderTransactions();
}

function deleteTransaction(transId, type, partyId, vehicleId, fuelType, quantity, amount) {
    if (!confirm('Are you sure you want to delete this transaction? This will reverse all changes made by this transaction.')) {
        return;
    }
    
    // Find the transaction
    const transIndex = transactions.findIndex(t => t.id === transId);
    if (transIndex === -1) {
        showNotification('Transaction not found!', 'error');
        return;
    }
    
    const transaction = transactions[transIndex];
    
    // Reverse the effects based on transaction type
    if (type === 'sale') {
        // Find customer and reduce their balance
        const customerIndex = customers.findIndex(c => c.id === partyId);
        if (customerIndex >= 0) {
            customers[customerIndex].balance -= amount;
        }
        
        // Add stock back to vehicle
        const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
        if (vehicleIndex >= 0) {
            if (fuelType === 'PMG') {
                vehicles[vehicleIndex].stockPMG += quantity / 1000; // Convert liters back to KL
            } else {
                vehicles[vehicleIndex].stockHSD += quantity / 1000;
            }
        }
    } else if (type === 'purchase') {
        // Find supplier and reduce their balance
        const supplierIndex = suppliers.findIndex(s => s.id === partyId);
        if (supplierIndex >= 0) {
            suppliers[supplierIndex].balance -= amount;
        }
        
        // Remove stock from vehicle
        const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
        if (vehicleIndex >= 0) {
            if (fuelType === 'PMG') {
                vehicles[vehicleIndex].stockPMG -= quantity / 1000; // Convert liters to KL
            } else {
                vehicles[vehicleIndex].stockHSD -= quantity / 1000;
            }
        }
    }
    
    // Remove the transaction
    transactions.splice(transIndex, 1);
    
    // CRITICAL: Force save and complete refresh
    saveToStorage();
    renderTransactions();
    renderCustomers();
    renderSuppliers();
    renderVehicles();
    updateDashboard();
    populateDropdowns();
    
    showNotification('✅ Transaction deleted successfully! All changes reversed.', 'success');
}

function updateSaleRate() {
    const customerId = document.getElementById('saleCustomerId').value;
    const fuelType = document.getElementById('saleFuelType').value;
    
    if (customerId && fuelType) {
        const customer = customers.find(c => c.id === customerId);
        const rate = fuelType === 'PMG' ? customer.pmgRate : customer.hsdRate;
        document.getElementById('saleRate').value = rate;
        calculateSaleAmount();
    }
}

function calculateSaleAmount() {
    const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
    const rate = parseFloat(document.getElementById('saleRate').value) || 0;
    const subtotal = quantity * rate;
    
    // Update subtotal
    document.getElementById('saleSubtotal').value = subtotal.toFixed(2);
    
    // Get discount details
    const discountType = document.getElementById('saleDiscountType').value;
    const discountValue = parseFloat(document.getElementById('saleDiscountValue').value) || 0;
    
    let discountAmount = 0;
    let finalAmount = subtotal;
    let discountInfo = '';
    
    if (discountType === 'percentage' && discountValue > 0) {
        discountAmount = (subtotal * discountValue) / 100;
        finalAmount = subtotal - discountAmount;
        discountInfo = `💰 Discount: ${discountValue}% = Rs. ${discountAmount.toFixed(2)}`;
    } else if (discountType === 'fixed' && discountValue > 0) {
        discountAmount = discountValue;
        finalAmount = subtotal - discountAmount;
        const percentageDiscount = ((discountAmount / subtotal) * 100).toFixed(2);
        discountInfo = `💰 Discount: Rs. ${discountAmount.toFixed(2)} (${percentageDiscount}%)`;
    } else if (discountType === 'perlitre' && discountValue > 0) {
        // Per Litre discount: discount_per_litre * quantity
        discountAmount = discountValue * quantity;
        finalAmount = subtotal - discountAmount;
        const percentageDiscount = ((discountAmount / subtotal) * 100).toFixed(2);
        discountInfo = `💰 Discount: Rs. ${discountValue}/L × ${quantity} L = Rs. ${discountAmount.toFixed(2)} (${percentageDiscount}%)`;
    } else {
        discountInfo = 'No discount applied';
    }
    
    // Update final amount and info
    document.getElementById('saleAmount').value = finalAmount.toFixed(2);
    document.getElementById('saleDiscountInfo').innerHTML = discountInfo;
}

function updatePurchaseRate() {
    const supplierId = document.getElementById('purchaseSupplierId').value;
    const fuelType = document.getElementById('purchaseFuelType').value;
    
    if (supplierId && fuelType) {
        const supplier = suppliers.find(s => s.id === supplierId);
        const rate = fuelType === 'PMG' ? supplier.pmgRate : supplier.hsdRate;
        document.getElementById('purchaseRate').value = rate;
        calculatePurchaseAmount();
    }
}

function calculatePurchaseAmount() {
    const quantity = parseFloat(document.getElementById('purchaseQuantity').value) || 0;
    const rate = parseFloat(document.getElementById('purchaseRate').value) || 0;
    const subtotal = quantity * rate;
    
    // Update subtotal
    document.getElementById('purchaseSubtotal').value = subtotal.toFixed(2);
    
    // Get discount details
    const discountType = document.getElementById('purchaseDiscountType').value;
    const discountValue = parseFloat(document.getElementById('purchaseDiscountValue').value) || 0;
    
    let discountAmount = 0;
    let finalAmount = subtotal;
    let discountInfo = '';
    
    if (discountType === 'percentage' && discountValue > 0) {
        discountAmount = (subtotal * discountValue) / 100;
        finalAmount = subtotal - discountAmount;
        discountInfo = `💰 Discount: ${discountValue}% = Rs. ${discountAmount.toFixed(2)}`;
    } else if (discountType === 'fixed' && discountValue > 0) {
        discountAmount = discountValue;
        finalAmount = subtotal - discountAmount;
        const percentageDiscount = ((discountAmount / subtotal) * 100).toFixed(2);
        discountInfo = `💰 Discount: Rs. ${discountAmount.toFixed(2)} (${percentageDiscount}%)`;
    } else if (discountType === 'perlitre' && discountValue > 0) {
        // Per Litre discount: discount_per_litre * quantity
        discountAmount = discountValue * quantity;
        finalAmount = subtotal - discountAmount;
        const percentageDiscount = ((discountAmount / subtotal) * 100).toFixed(2);
        discountInfo = `💰 Discount: Rs. ${discountValue}/L × ${quantity} L = Rs. ${discountAmount.toFixed(2)} (${percentageDiscount}%)`;
    } else {
        discountInfo = 'No discount applied';
    }
    
    // Update final amount and info
    document.getElementById('purchaseAmount').value = finalAmount.toFixed(2);
    document.getElementById('purchaseDiscountInfo').innerHTML = discountInfo;
}

// PAYMENT FUNCTIONS
function updatePaymentParties() {
    const type = document.getElementById('paymentType').value;
    const partySelect = document.getElementById('paymentPartyId');
    const label = document.getElementById('paymentPartyLabel');
    
    partySelect.innerHTML = '<option value="">Select Party</option>';
    
    if (type === 'received') {
        label.textContent = 'Customer *';
        customers.forEach(c => {
            partySelect.innerHTML += `<option value="${c.id}">${c.name} (Balance: Rs. ${c.balance.toFixed(2)})</option>`;
        });
    } else if (type === 'paid') {
        label.textContent = 'Supplier *';
        suppliers.forEach(s => {
            partySelect.innerHTML += `<option value="${s.id}">${s.name} (Balance: Rs. ${s.balance.toFixed(2)})</option>`;
        });
    }
}

function toggleBankField() {
    const method = document.getElementById('paymentMethod').value;
    const bankGroup = document.getElementById('paymentBankGroup');
    
    if (method === 'bank' || method === 'cheque') {
        bankGroup.style.display = 'block';
    } else {
        bankGroup.style.display = 'none';
    }
}

function savePayment(e) {
    e.preventDefault();
    
    const type = document.getElementById('paymentType').value;
    const partyId = document.getElementById('paymentPartyId').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const method = document.getElementById('paymentMethod').value;
    const bankId = document.getElementById('paymentBankId').value;
    const date = document.getElementById('paymentDate').value;
    const notes = document.getElementById('paymentNotes').value;
    
    let party, partyName;
    
    if (type === 'received') {
        party = customers.find(c => c.id === partyId);
        partyName = party.name;
        party.balance -= amount;
        
        // Ledger entry
        addLedgerEntry('payment_received', `Payment from ${partyName}`, 
            bankId ? 'Bank' : 'Cash', amount, `Customer: ${partyName}`, amount, date);
    } else {
        party = suppliers.find(s => s.id === partyId);
        partyName = party.name;
        party.balance -= amount;
        
        // Ledger entry
        addLedgerEntry('payment_made', `Payment to ${partyName}`, 
            `Supplier: ${partyName}`, amount, bankId ? 'Bank' : 'Cash', amount, date);
    }
    
    const payment = {
        id: 'pay_' + Date.now(),
        type: type,
        partyId: partyId,
        partyName: partyName,
        amount: amount,
        method: method,
        bankId: bankId,
        date: date,
        notes: notes,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    payments.push(payment);
    
    // Update bank balance
    if (bankId && (method === 'bank' || method === 'cheque')) {
        const bank = banks.find(b => b.id === bankId);
        if (type === 'received') {
            bank.balance += amount;
        } else {
            bank.balance -= amount;
        }
    }
    
    saveToStorage();
    renderPayments();
    renderCustomers();
    renderSuppliers();
    renderBanks();
    closeModal('paymentModal');
    updateDashboard();
    showNotification('Payment recorded! 💰', 'success');
    e.target.reset();
}

function renderPayments() {
    const tbody = document.getElementById('paymentsBody');
    tbody.innerHTML = '';
    
    payments.slice().reverse().forEach(payment => {
        const bank = banks.find(b => b.id === payment.bankId);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(payment.date).toLocaleDateString()}</td>
            <td>${payment.partyName}</td>
            <td><span style="background: ${payment.type === 'received' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${payment.type === 'received' ? 'RECEIVED' : 'PAID'}</span></td>
            <td style="font-weight: 700;">Rs. ${payment.amount.toFixed(2)}</td>
            <td>${payment.method.toUpperCase()}</td>
            <td>${bank ? bank.name : '-'}</td>
            <td>${payment.notes || '-'}</td>
        `;
    });
}

// CUSTOMER TRANSFER FUNCTIONS (NEW)
function saveCustomerTransfer(e) {
    e.preventDefault();
    
    const fromId = document.getElementById('transferFromCustomerId').value;
    const toId = document.getElementById('transferToCustomerId').value;
    const amount = parseFloat(document.getElementById('transferAmount').value);
    const date = document.getElementById('transferDate').value;
    const notes = document.getElementById('transferNotes').value;
    
    if (fromId === toId) {
        showNotification('Cannot transfer to same customer!', 'error');
        return;
    }
    
    const fromCustomer = customers.find(c => c.id === fromId);
    const toCustomer = customers.find(c => c.id === toId);
    
    const transfer = {
        id: 'transfer_' + Date.now(),
        fromCustomerId: fromId,
        fromCustomerName: fromCustomer.name,
        toCustomerId: toId,
        toCustomerName: toCustomer.name,
        amount: amount,
        date: date,
        notes: notes,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    // Update balances
    fromCustomer.balance += amount; // Debit (paying customer's balance increases)
    toCustomer.balance -= amount;   // Credit (receiving customer's balance decreases)
    
    customerTransfers.push(transfer);
    
    // Ledger entry
    addLedgerEntry('customer_transfer', `Transfer: ${fromCustomer.name} paid for ${toCustomer.name}`, 
        `Customer: ${fromCustomer.name}`, amount, `Customer: ${toCustomer.name}`, amount, date);
    
    saveToStorage();
    renderCustomers();
    closeModal('customerTransferModal');
    updateDashboard();
    showNotification('Customer transfer recorded! 🔄', 'success');
    e.target.reset();
}

// EXPENSE FUNCTIONS (UPDATED)
function toggleExpenseSourceField() {
    const source = document.getElementById('expenseSource').value;
    const bankGroup = document.getElementById('expenseBankGroup');
    const customerGroup = document.getElementById('expenseCustomerGroup');
    
    bankGroup.style.display = 'none';
    customerGroup.style.display = 'none';
    
    if (source === 'bank') {
        bankGroup.style.display = 'block';
    } else if (source === 'customer') {
        customerGroup.style.display = 'block';
    }
}

function saveExpense(e) {
    e.preventDefault();
    
    const expense = {
        id: document.getElementById('expenseId').value || 'exp_' + Date.now(),
        category: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        source: document.getElementById('expenseSource').value,
        bankId: document.getElementById('expenseBankId').value,
        customerId: document.getElementById('expenseCustomerId').value,
        method: document.getElementById('expenseMethod').value,
        date: document.getElementById('expenseDate').value,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = expenses.findIndex(e => e.id === expense.id);
    if (existingIndex >= 0) {
        expenses[existingIndex] = expense;
        showNotification('Expense updated! ✅', 'success');
    } else {
        expenses.push(expense);
        
        // Update balance based on source
        if (expense.source === 'bank' && expense.bankId) {
            const bank = banks.find(b => b.id === expense.bankId);
            if (bank) bank.balance -= expense.amount;
        } else if (expense.source === 'customer' && expense.customerId) {
            const customer = customers.find(c => c.id === expense.customerId);
            if (customer) customer.balance -= expense.amount;
        }
        
        // Ledger entry
        const sourceAccount = expense.source === 'bank' ? 'Bank' : 
                             expense.source === 'customer' ? 'Customer' : 'Cash';
        addLedgerEntry('expense', `Expense: ${expense.category} - ${expense.description}`, 
            expense.category, expense.amount, sourceAccount, expense.amount, expense.date);
        
        showNotification('Expense added! 💸', 'success');
    }
    
    saveToStorage();
    renderExpenses();
    renderBanks();
    renderCustomers();
    closeModal('expenseModal');
    updateDashboard();
    e.target.reset();
}

function renderExpenses() {
    const tbody = document.getElementById('expensesBody');
    tbody.innerHTML = '';
    
    expenses.slice().reverse().forEach(expense => {
        let paidFrom = '';
        if (expense.source === 'bank' && expense.bankId) {
            const bank = banks.find(b => b.id === expense.bankId);
            paidFrom = bank ? bank.name : 'Bank';
        } else if (expense.source === 'customer' && expense.customerId) {
            const customer = customers.find(c => c.id === expense.customerId);
            paidFrom = customer ? customer.name : 'Customer';
        } else {
            paidFrom = 'Cash';
        }
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(expense.date).toLocaleDateString()}</td>
            <td><span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${expense.category}</span></td>
            <td>${expense.description}</td>
            <td style="color: #f56565; font-weight: 700;">Rs. ${expense.amount.toFixed(2)}</td>
            <td>${paidFrom}</td>
            <td>${expense.method.toUpperCase()}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteExpense('${expense.id}')">Delete</button>
            </td>
        `;
    });
}

function deleteExpense(id) {
    if (confirm('Are you sure?')) {
        expenses = expenses.filter(e => e.id !== id);
        saveToStorage();
        renderExpenses();
        updateDashboard();
        showNotification('Expense deleted!', 'success');
    }
}

// BANK FUNCTIONS
function saveBank(e) {
    e.preventDefault();
    
    const bank = {
        id: document.getElementById('bankId').value || 'bank_' + Date.now(),
        name: document.getElementById('bankName').value,
        accountNumber: document.getElementById('bankAccount').value,
        balance: parseFloat(document.getElementById('bankBalance').value),
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = banks.findIndex(b => b.id === bank.id);
    if (existingIndex >= 0) {
        banks[existingIndex] = bank;
        showNotification('Bank updated! ✅', 'success');
    } else {
        banks.push(bank);
        showNotification('Bank added! ✅', 'success');
    }
    
    saveToStorage();
    renderBanks();
    closeModal('bankModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderBanks() {
    const tbody = document.getElementById('banksBody');
    tbody.innerHTML = '';
    
    banks.forEach(bank => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${bank.name}</strong></td>
            <td>${bank.accountNumber}</td>
            <td class="${bank.balance >= 0 ? 'balance-positive' : 'balance-negative'}" style="font-weight: 700;">Rs. ${bank.balance.toFixed(2)}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick='editBank(${JSON.stringify(bank).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteBank('${bank.id}')">Delete</button>
            </td>
        `;
    });
}

function editBank(bank) {
    document.getElementById('bankId').value = bank.id;
    document.getElementById('bankName').value = bank.name;
    document.getElementById('bankAccount').value = bank.accountNumber;
    document.getElementById('bankBalance').value = bank.balance;
    openModal('bankModal');
}

function deleteBank(id) {
    if (confirm('Are you sure?')) {
        banks = banks.filter(b => b.id !== id);
        saveToStorage();
        renderBanks();
        updateDashboard();
        populateDropdowns();
        showNotification('Bank deleted!', 'success');
    }
}

// BANK TRANSACTION FUNCTIONS
function saveBankTransaction(e) {
    e.preventDefault();
    
    const bankId = document.getElementById('bankTransBankId').value;
    const type = document.getElementById('bankTransType').value;
    const amount = parseFloat(document.getElementById('bankTransAmount').value);
    const description = document.getElementById('bankTransDescription').value;
    const date = document.getElementById('bankTransDate').value;
    
    const bank = banks.find(b => b.id === bankId);
    
    if (type === 'deposit') {
        bank.balance += amount;
    } else {
        bank.balance -= amount;
    }
    
    const transaction = {
        id: 'banktrans_' + Date.now(),
        bankId: bankId,
        bankName: bank.name,
        type: type,
        amount: amount,
        description: description,
        date: date,
        balanceAfter: bank.balance,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    bankTransactions.push(transaction);
    
    // Ledger entry
    if (type === 'deposit') {
        addLedgerEntry('bank_deposit', description || 'Bank Deposit', 
            'Bank', amount, 'Cash/Revenue', amount, date);
    } else {
        addLedgerEntry('bank_withdrawal', description || 'Bank Withdrawal', 
            'Cash/Expense', amount, 'Bank', amount, date);
    }
    
    saveToStorage();
    renderBankTransactions();
    renderBanks();
    closeModal('bankTransModal');
    updateDashboard();
    showNotification('Bank transaction recorded! 🏦', 'success');
    e.target.reset();
}

function renderBankTransactions() {
    const tbody = document.getElementById('bankTransactionsBody');
    tbody.innerHTML = '';
    
    bankTransactions.slice().reverse().slice(0, 20).forEach(trans => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(trans.date).toLocaleDateString()}</td>
            <td>${trans.bankName}</td>
            <td><span style="background: ${trans.type === 'deposit' ? '#48bb78' : '#f56565'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${trans.type.toUpperCase()}</span></td>
            <td style="font-weight: 700;">Rs. ${trans.amount.toFixed(2)}</td>
            <td>${trans.description || '-'}</td>
            <td style="font-weight: 600;">Rs. ${trans.balanceAfter.toFixed(2)}</td>
        `;
    });
}

// VEHICLE FUNCTIONS
function saveVehicle(e) {
    e.preventDefault();
    
    const vehicle = {
        id: document.getElementById('vehicleId').value || 'veh_' + Date.now(),
        number: document.getElementById('vehicleNumber').value,
        driver: document.getElementById('vehicleDriver').value,
        driverName: document.getElementById('vehicleDriver').value, // Keep both for compatibility
        contact: document.getElementById('vehicleContact').value,
        ownerName: document.getElementById('vehicleOwnerName').value,
        ownerContact: document.getElementById('vehicleOwnerContact').value,
        ownerBalance: 0,
        status: document.getElementById('vehicleStatus').value,
        stockPMG: 0,
        stockHSD: 0,
        createdAt: new Date().toISOString()
    };
    
    const existingIndex = vehicles.findIndex(v => v.id === vehicle.id);
    if (existingIndex >= 0) {
        // Editing - keep stock and owner balance
        vehicle.stockPMG = vehicles[existingIndex].stockPMG;
        vehicle.stockHSD = vehicles[existingIndex].stockHSD;
        vehicle.ownerBalance = vehicles[existingIndex].ownerBalance || 0;
        vehicles[existingIndex] = vehicle;
        showNotification('Vehicle updated! ✅', 'success');
    } else {
        // New vehicle - set opening balance
        const openingBalance = parseFloat(document.getElementById('vehicleOwnerBalance').value) || 0;
        vehicle.ownerBalance = openingBalance;
        vehicles.push(vehicle);
        showNotification('Vehicle added! ✅' + (openingBalance !== 0 ? ` (Owner balance: Rs. ${openingBalance.toFixed(2)})` : ''), 'success');
    }
    
    saveToStorage();
    renderVehicles();
    closeModal('vehicleModal');
    updateDashboard();
    populateDropdowns();
    e.target.reset();
}

function renderVehicles() {
    const tbody = document.getElementById('vehiclesBody');
    tbody.innerHTML = '';
    
    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    
    vehicles.forEach(vehicle => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${vehicle.number}</strong></td>
            <td>${vehicle.driverName}</td>
            <td>${vehicle.contact || '-'}</td>
            <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
            <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
            <td><span style="background: ${vehicle.status === 'Active' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${vehicle.status}</span></td>
            <td>
                <button class="btn btn-info btn-sm" onclick='editVehicle(${JSON.stringify(vehicle).replace(/'/g, "&#39;")})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteVehicle('${vehicle.id}')">Delete</button>
            </td>
        `;
        fragment.appendChild(row);
    });
    
    tbody.appendChild(fragment);
}

function editVehicle(vehicle) {
    document.getElementById('vehicleId').value = vehicle.id;
    document.getElementById('vehicleNumber').value = vehicle.number;
    document.getElementById('vehicleDriver').value = vehicle.driverName;
    document.getElementById('vehicleContact').value = vehicle.contact || '';
    document.getElementById('vehicleStatus').value = vehicle.status;
    openModal('vehicleModal');
}

function deleteVehicle(id) {
    if (confirm('Are you sure?')) {
        vehicles = vehicles.filter(v => v.id !== id);
        saveToStorage();
        renderVehicles();
        updateDashboard();
        populateDropdowns();
        showNotification('Vehicle deleted!', 'success');
    }
}

// LEDGER FUNCTIONS (NEW)
function generateLedger() {
    let html = '<div class="card"><h2>📒 Customer Ledger</h2>';
    
    if (customers.length === 0) {
        html += '<p style="text-align: center; color: #718096; padding: 20px;">No customers found</p></div>';
        document.getElementById('ledgerOutput').innerHTML = html;
        return;
    }
    
    customers.forEach(customer => {
        // Get all transactions for this customer
        const customerSales = transactions.filter(t => t.partyId === customer.id && t.type === 'sale');
        const customerPayments = payments.filter(p => p.partyId === customer.id && p.type === 'received');
        
        // EXPENSES with robust checks
        const customerExpenses = expenses.filter(e => 
            e.source === 'customer' && 
            e.customerId && 
            e.customerId === customer.id
        );
        
        // TRANSFERS with robust checks
        const transfersFrom = customerTransfers.filter(t => 
            t.fromCustomerId && 
            t.fromCustomerId === customer.id
        );
        const transfersTo = customerTransfers.filter(t => 
            t.toCustomerId && 
            t.toCustomerId === customer.id
        );
        
        // JV ENTRIES with robust checks
        const jvDebits = jvVouchers.filter(jv => {
            if (jv.debitType === 'customer' && jv.debitAccount) {
                return jv.debitAccount === customer.id || 
                       jv.debitAccount === 'customer_' + customer.id ||
                       jv.debitAccount.includes(customer.id);
            }
            return false;
        });
        const jvCredits = jvVouchers.filter(jv => {
            if (jv.creditType === 'customer' && jv.creditAccount) {
                return jv.creditAccount === customer.id || 
                       jv.creditAccount === 'customer_' + customer.id ||
                       jv.creditAccount.includes(customer.id);
            }
            return false;
        });
        
        // Calculate totals
        const totalSales = customerSales.reduce((sum, t) => sum + t.amount, 0);
        const totalPayments = customerPayments.reduce((sum, p) => sum + p.amount, 0);
        const totalExpenses = customerExpenses.reduce((sum, e) => sum + e.amount, 0);
        const totalTransfersFrom = transfersFrom.reduce((sum, t) => sum + t.amount, 0);
        const totalTransfersTo = transfersTo.reduce((sum, t) => sum + t.amount, 0);
        const totalJVDebits = jvDebits.reduce((sum, jv) => sum + jv.debitAmount, 0);
        const totalJVCredits = jvCredits.reduce((sum, jv) => sum + jv.creditAmount, 0);
        const balance = customer.balance;
        
        html += `
            <div style="border: 2px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; background: #f7fafc;">
                <h3 style="color: #667eea; margin-bottom: 10px; font-size: 1.2em;">
                    ${customer.name}
                    <span style="float: right; color: ${balance >= 0 ? '#48bb78' : '#f56565'}; font-size: 0.9em;">
                        Balance: Rs. ${balance.toFixed(2)}
                    </span>
                </h3>
                <p style="color: #718096; font-size: 0.9em; margin-bottom: 15px;">
                    Contact: ${customer.contact || 'N/A'} | CNIC: ${customer.cnic || 'N/A'}
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-bottom: 15px;">
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Sales</div>
                        <div style="color: #48bb78; font-weight: 700; font-size: 0.95em;">Rs. ${totalSales.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Payments</div>
                        <div style="color: #4299e1; font-weight: 700; font-size: 0.95em;">Rs. ${totalPayments.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Expenses</div>
                        <div style="color: #f56565; font-weight: 700; font-size: 0.95em;">Rs. ${totalExpenses.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Paid For</div>
                        <div style="color: #9f7aea; font-weight: 700; font-size: 0.95em;">Rs. ${totalTransfersFrom.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Received</div>
                        <div style="color: #38b2ac; font-weight: 700; font-size: 0.95em;">Rs. ${totalTransfersTo.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">JV Dr</div>
                        <div style="color: #ed8936; font-weight: 700; font-size: 0.95em;">Rs. ${totalJVDebits.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">JV Cr</div>
                        <div style="color: #f687b3; font-weight: 700; font-size: 0.95em;">Rs. ${totalJVCredits.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="color: #718096; font-size: 0.7em;">Balance</div>
                        <div style="color: ${balance >= 0 ? '#e53e3e' : '#38a169'}; font-weight: 700; font-size: 0.95em;">Rs. ${balance.toFixed(2)}</div>
                    </div>
                </div>
                
                ${customerSales.length > 0 || customerPayments.length > 0 || customerExpenses.length > 0 || 
                  transfersFrom.length > 0 || transfersTo.length > 0 || jvDebits.length > 0 || jvCredits.length > 0 ? `
                <table style="width: 100%; font-size: 0.85em; background: white; border-radius: 8px;">
                    <thead style="background: #667eea; color: white;">
                        <tr>
                            <th style="padding: 8px; text-align: left;">Date</th>
                            <th style="padding: 8px; text-align: left;">Type</th>
                            <th style="padding: 8px; text-align: left;">Details</th>
                            <th style="padding: 8px; text-align: right;">Debit (Sales)</th>
                            <th style="padding: 8px; text-align: right;">Credit (Payment)</th>
                        </tr>
                    </thead>
                    <tbody>
        ` : '<p style="text-align: center; color: #718096; padding: 10px;">No transactions yet</p>'}
        `;
        
        // Combine and sort all entries by date
        const allEntries = [
            ...customerSales.map(t => ({
                date: t.date,
                type: 'Sale',
                details: `${t.fuelType} - ${t.quantity.toFixed(2)} L @ Rs. ${t.rate.toFixed(4)}`,
                debit: t.amount,
                credit: 0
            })),
            ...customerPayments.map(p => ({
                date: p.date,
                type: 'Payment',
                details: `${p.method} - ${p.notes || 'Payment received'}`,
                debit: 0,
                credit: p.amount
            })),
            ...customerExpenses.map(e => ({
                date: e.date,
                type: 'Expense',
                details: `${e.category || 'Expense'} - ${e.description || ''}`,
                debit: 0,
                credit: e.amount
            })),
            ...transfersFrom.map(t => ({
                date: t.date,
                type: 'Transfer Out',
                details: `Paid for ${t.toCustomerName || 'Customer'}`,
                debit: t.amount,
                credit: 0
            })),
            ...transfersTo.map(t => ({
                date: t.date,
                type: 'Transfer In',
                details: `${t.fromCustomerName || 'Customer'} paid`,
                debit: 0,
                credit: t.amount
            })),
            ...jvDebits.map(jv => ({
                date: jv.date,
                type: 'JV Dr',
                details: jv.description || 'Journal Entry',
                debit: jv.debitAmount || 0,
                credit: 0
            })),
            ...jvCredits.map(jv => ({
                date: jv.date,
                type: 'JV Cr',
                details: jv.description || 'Journal Entry',
                debit: 0,
                credit: jv.creditAmount || 0
            }))
        ].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        allEntries.slice(0, 10).forEach(entry => {
            html += `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 8px;">${new Date(entry.date).toLocaleDateString()}</td>
                    <td style="padding: 8px;">
                        <span style="background: ${
                            entry.type === 'Sale' ? '#48bb78' : 
                            entry.type === 'Payment' ? '#4299e1' : 
                            entry.type === 'Expense' ? '#f56565' :
                            entry.type === 'Transfer Out' ? '#9f7aea' :
                            entry.type === 'Transfer In' ? '#38b2ac' :
                            entry.type === 'JV Dr' ? '#ed8936' :
                            entry.type === 'JV Cr' ? '#f687b3' : '#718096'
                        }; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600;">
                            ${entry.type}
                        </span>
                    </td>
                    <td style="padding: 8px;">${entry.details}</td>
                    <td style="padding: 8px; text-align: right; color: #f56565; font-weight: 600;">
                        ${entry.debit > 0 ? 'Rs. ' + entry.debit.toFixed(2) : '-'}
                    </td>
                    <td style="padding: 8px; text-align: right; color: #48bb78; font-weight: 600;">
                        ${entry.credit > 0 ? 'Rs. ' + entry.credit.toFixed(2) : '-'}
                    </td>
                </tr>
            `;
        });
        
        if (customerSales.length > 0 || customerPayments.length > 0 || customerExpenses.length > 0 || 
            transfersFrom.length > 0 || transfersTo.length > 0 || jvDebits.length > 0 || jvCredits.length > 0) {
            html += `
                    </tbody>
                </table>
                ${allEntries.length > 10 ? `<p style="text-align: center; color: #718096; margin-top: 10px; font-size: 0.85em;">Showing last 10 transactions</p>` : ''}
            `;
        }
        
        html += '</div>';
    });
    
    html += '</div>';
    document.getElementById('ledgerOutput').innerHTML = html;
    showNotification('Customer ledger generated! 📒', 'success');
}

function checkBalance() {
    const today = new Date().toISOString().split('T')[0];
    const todayEntries = ledgerEntries.filter(e => e.date === today);
    
    let totalDebits = 0;
    let totalCredits = 0;
    
    todayEntries.forEach(entry => {
        totalDebits += entry.debitAmount;
        totalCredits += entry.creditAmount;
    });
    
    const balanced = Math.abs(totalDebits - totalCredits) < 0.01;
    
    let html = `
        <div class="card">
            <h2>⚖️ Balance Check for ${new Date().toLocaleDateString()}</h2>
            <div class="profit-loss-section">
                <div class="profit-loss-item">
                    <span>Total Debits</span>
                    <span style="color: #f56565; font-weight: 700;">Rs. ${totalDebits.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Credits</span>
                    <span style="color: #48bb78; font-weight: 700;">Rs. ${totalCredits.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item total">
                    <span>Difference</span>
                    <span style="color: ${balanced ? '#48bb78' : '#f56565'};">Rs. ${Math.abs(totalDebits - totalCredits).toFixed(2)}</span>
                </div>
                <div class="profit-loss-item" style="background: ${balanced ? '#48bb78' : '#f56565'}; color: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <span style="font-size: 1.2em;">${balanced ? '✅ Books are BALANCED!' : '⚠️ Books are NOT balanced!'}</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('ledgerOutput').innerHTML = html;
    
    if (balanced) {
        showNotification('Books are perfectly balanced! ✅', 'success');
    } else {
        showNotification('Warning: Books are not balanced! ⚠️', 'warning');
    }
}

// GOV RATE CHANGE
function roundRate(rate) {
    return Math.round(rate * 10000) / 10000;
}

function previewGovRateChange() {
    const updatePmg = document.getElementById('updatePmg').checked;
    const updateHsd = document.getElementById('updateHsd').checked;
    const changeType = document.getElementById('changeType').value;
    const changeSign = parseInt(document.getElementById('changeSign').value);
    const changeAmount = parseFloat(document.getElementById('changeAmount').value);
    const scope = document.getElementById('changeScope').value;
    
    if (!updatePmg && !updateHsd) {
        showNotification('Select at least one fuel type!', 'error');
        return;
    }
    
    let affectedParties = [];
    if (scope === 'all' || scope === 'customers') affectedParties = affectedParties.concat(customers);
    if (scope === 'all' || scope === 'suppliers') affectedParties = affectedParties.concat(suppliers);
    
    let html = '<table style="width:100%; font-size:0.85em;"><thead><tr><th>Name</th><th>Old PMG</th><th>New PMG</th><th>Old HSD</th><th>New HSD</th></tr></thead><tbody>';
    
    affectedParties.slice(0, 5).forEach(party => {
        const oldPmg = parseFloat(party.pmgRate);
        const oldHsd = parseFloat(party.hsdRate);
        
        let newPmg, newHsd;
        if (changeType === 'absolute') {
            newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
            newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
        } else {
            newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
            newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
        }
        
        html += `
            <tr>
                <td><strong>${party.name}</strong></td>
                <td>Rs. ${oldPmg.toFixed(4)}</td>
                <td style="color:${newPmg > oldPmg ? '#48bb78' : newPmg < oldPmg ? '#f56565' : '#718096'};">Rs. ${newPmg.toFixed(4)}</td>
                <td>Rs. ${oldHsd.toFixed(4)}</td>
                <td style="color:${newHsd > oldHsd ? '#48bb78' : newHsd < oldHsd ? '#f56565' : '#718096'};">Rs. ${newHsd.toFixed(4)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    if (affectedParties.length > 5) {
        html += `<p style="text-align:center; margin-top:10px; color:#718096;">... and ${affectedParties.length - 5} more</p>`;
    }
    html += `<p style="text-align:center; margin-top:15px; font-weight:700; color:#667eea;">Total: ${affectedParties.length} parties</p>`;
    
    document.getElementById('previewContent').innerHTML = html;
    document.getElementById('rateChangePreview').style.display = 'block';
}

function applyGovRateChange(e) {
    e.preventDefault();
    
    const updatePmg = document.getElementById('updatePmg').checked;
    const updateHsd = document.getElementById('updateHsd').checked;
    const changeType = document.getElementById('changeType').value;
    const changeSign = parseInt(document.getElementById('changeSign').value);
    const changeAmount = parseFloat(document.getElementById('changeAmount').value);
    const scope = document.getElementById('changeScope').value;
    
    if (!updatePmg && !updateHsd) {
        showNotification('Select at least one fuel type!', 'error');
        return;
    }
    
    if (!confirm(`Apply rate change?\nType: ${changeType}\nAmount: ${changeSign > 0 ? '+' : ''}${changeAmount}\nScope: ${scope}`)) {
        return;
    }
    
    const logEntry = {
        id: 'log_' + Date.now(),
        updatePmg,
        updateHsd,
        changeType,
        changeSign,
        changeAmount,
        scope,
        appliedBy: currentUser,
        appliedAt: new Date().toISOString(),
        changes: []
    };
    
    if (scope === 'all' || scope === 'customers') {
        customers.forEach(customer => {
            const oldPmg = parseFloat(customer.pmgRate);
            const oldHsd = parseFloat(customer.hsdRate);
            
            let newPmg, newHsd;
            if (changeType === 'absolute') {
                newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
            } else {
                newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
            }
            
            logEntry.changes.push({
                partyId: customer.id,
                partyName: customer.name,
                partyType: 'customer',
                oldPmgRate: oldPmg,
                newPmgRate: newPmg,
                oldHsdRate: oldHsd,
                newHsdRate: newHsd
            });
            
            customer.pmgRate = newPmg.toFixed(4);
            customer.hsdRate = newHsd.toFixed(4);
        });
    }
    
    if (scope === 'all' || scope === 'suppliers') {
        suppliers.forEach(supplier => {
            const oldPmg = parseFloat(supplier.pmgRate);
            const oldHsd = parseFloat(supplier.hsdRate);
            
            let newPmg, newHsd;
            if (changeType === 'absolute') {
                newPmg = updatePmg ? roundRate(oldPmg + (changeSign * changeAmount)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd + (changeSign * changeAmount)) : oldHsd;
            } else {
                newPmg = updatePmg ? roundRate(oldPmg * (1 + changeSign * changeAmount / 100)) : oldPmg;
                newHsd = updateHsd ? roundRate(oldHsd * (1 + changeSign * changeAmount / 100)) : oldHsd;
            }
            
            logEntry.changes.push({
                partyId: supplier.id,
                partyName: supplier.name,
                partyType: 'supplier',
                oldPmgRate: oldPmg,
                newPmgRate: newPmg,
                oldHsdRate: oldHsd,
                newHsdRate: newHsd
            });
            
            supplier.pmgRate = newPmg.toFixed(4);
            supplier.hsdRate = newHsd.toFixed(4);
        });
    }
    
    rateChangeLogs.push(logEntry);
    saveToStorage();
    
    showNotification(`🎉 Rate change applied to ${logEntry.changes.length} parties!`, 'success');
    closeModal('govRateModal');
    renderCustomers();
    renderSuppliers();
    document.getElementById('rateChangePreview').style.display = 'none';
    document.getElementById('changeAmount').value = '';
}

// REPORT FUNCTIONS
function generateCustomerLedgerReport() {
    const customerId = document.getElementById('customerReportSelect').value;
    const fromDate = document.getElementById('customerReportFromDate').value;
    const toDate = document.getElementById('customerReportToDate').value;
    
    if (!customerId) {
        showNotification('Please select a customer!', 'error');
        return;
    }
    
    const customer = customers.find(c => c.id === customerId);
    if (!customer) {
        showNotification('Customer not found!', 'error');
        return;
    }
    
    // Filter transactions by date if dates are provided
    let customerSales = transactions.filter(t => t.partyId === customerId && t.type === 'sale');
    let customerPayments = payments.filter(p => p.partyId === customerId && p.type === 'received');
    
    // EXPENSES - Check if customerId field exists and matches, AND source is 'customer'
    let customerExpenses = expenses.filter(e => 
        e.source === 'customer' && 
        e.customerId && 
        e.customerId === customerId
    );
    
    // TRANSFERS FROM - this customer paid for others
    let transfersFrom = customerTransfers.filter(t => 
        t.fromCustomerId && 
        t.fromCustomerId === customerId
    );
    
    // TRANSFERS TO - others paid for this customer  
    let transfersTo = customerTransfers.filter(t => 
        t.toCustomerId && 
        t.toCustomerId === customerId
    );
    
    // JV DEBITS - customer on debit side
    // Account format can be: "customer_cust_123" or just the ID
    let jvDebits = jvVouchers.filter(jv => {
        if (jv.debitType === 'customer' && jv.debitAccount) {
            // Check if account matches customer ID directly or with prefix
            return jv.debitAccount === customerId || 
                   jv.debitAccount === 'customer_' + customerId ||
                   jv.debitAccount.includes(customerId);
        }
        return false;
    });
    
    // JV CREDITS - customer on credit side
    let jvCredits = jvVouchers.filter(jv => {
        if (jv.creditType === 'customer' && jv.creditAccount) {
            return jv.creditAccount === customerId || 
                   jv.creditAccount === 'customer_' + customerId ||
                   jv.creditAccount.includes(customerId);
        }
        return false;
    });
    
    // Apply date filters
    if (fromDate) {
        customerSales = customerSales.filter(t => t.date >= fromDate);
        customerPayments = customerPayments.filter(p => p.date >= fromDate);
        customerExpenses = customerExpenses.filter(e => e.date >= fromDate);
        transfersFrom = transfersFrom.filter(t => t.date >= fromDate);
        transfersTo = transfersTo.filter(t => t.date >= fromDate);
        jvDebits = jvDebits.filter(jv => jv.date >= fromDate);
        jvCredits = jvCredits.filter(jv => jv.date >= fromDate);
    }
    if (toDate) {
        customerSales = customerSales.filter(t => t.date <= toDate);
        customerPayments = customerPayments.filter(p => p.date <= toDate);
        customerExpenses = customerExpenses.filter(e => e.date <= toDate);
        transfersFrom = transfersFrom.filter(t => t.date <= toDate);
        transfersTo = transfersTo.filter(t => t.date <= toDate);
        jvDebits = jvDebits.filter(jv => jv.date <= toDate);
        jvCredits = jvCredits.filter(jv => jv.date <= toDate);
    }
    
    // Calculate totals
    const totalSales = customerSales.reduce((sum, t) => sum + t.amount, 0);
    const totalPayments = customerPayments.reduce((sum, p) => sum + p.amount, 0);
    const totalExpenses = customerExpenses.reduce((sum, e) => sum + e.amount, 0);
    const totalTransfersFrom = transfersFrom.reduce((sum, t) => sum + t.amount, 0);
    const totalTransfersTo = transfersTo.reduce((sum, t) => sum + t.amount, 0);
    const totalJVDebits = jvDebits.reduce((sum, jv) => sum + jv.debitAmount, 0);
    const totalJVCredits = jvCredits.reduce((sum, jv) => sum + jv.creditAmount, 0);
    const balance = customer.balance;
    
    let html = `
        <div class="card">
            <h2>📒 Customer Ledger Report</h2>
            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">${customer.name}</h3>
                        <p style="margin: 5px 0;"><strong>Contact:</strong> ${customer.contact || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>CNIC:</strong> ${customer.cnic || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>Address:</strong> ${customer.address || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="margin: 5px 0;"><strong>PMG Rate:</strong> Rs. ${customer.pmgRate}</p>
                        <p style="margin: 5px 0;"><strong>HSD Rate:</strong> Rs. ${customer.hsdRate}</p>
                        <p style="margin: 5px 0;"><strong>Report Period:</strong> ${fromDate || 'Start'} to ${toDate || 'Today'}</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                <div style="background: #48bb78; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Sales</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalSales.toFixed(2)}</div>
                </div>
                <div style="background: #4299e1; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Payments</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalPayments.toFixed(2)}</div>
                </div>
                <div style="background: #f56565; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Expenses</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalExpenses.toFixed(2)}</div>
                </div>
                <div style="background: #9f7aea; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Paid For Others</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalTransfersFrom.toFixed(2)}</div>
                </div>
                <div style="background: #38b2ac; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Others Paid</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalTransfersTo.toFixed(2)}</div>
                </div>
                <div style="background: #ed8936; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">JV Debits</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalJVDebits.toFixed(2)}</div>
                </div>
                <div style="background: #f687b3; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">JV Credits</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${totalJVCredits.toFixed(2)}</div>
                </div>
                <div style="background: ${balance >= 0 ? '#e53e3e' : '#38a169'}; color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75em; opacity: 0.9;">Balance</div>
                    <div style="font-size: 1.3em; font-weight: 700;">Rs. ${balance.toFixed(2)}</div>
                </div>
            </div>
            
            ${customerSales.length > 0 || customerPayments.length > 0 || customerExpenses.length > 0 || transfersFrom.length > 0 || transfersTo.length > 0 || jvDebits.length > 0 || jvCredits.length > 0 ? `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Debit (Sales)</th>
                            <th>Credit (Payment)</th>
                            <th>Running Balance</th>
                        </tr>
                    </thead>
                    <tbody>
            ` : '<p style="text-align: center; color: #718096; padding: 20px;">No transactions in selected period</p>'}
    `;
    
    // Combine and sort all entries by date
    const allEntries = [
        ...customerSales.map(t => ({
            date: t.date,
            type: 'Sale',
            details: `${t.fuelType} - ${t.quantity.toFixed(2)} L @ Rs. ${t.rate.toFixed(4)}`,
            debit: t.amount,
            credit: 0
        })),
        ...customerPayments.map(p => ({
            date: p.date,
            type: 'Payment',
            details: `${p.method} - ${p.notes || 'Payment received'}`,
            debit: 0,
            credit: p.amount
        })),
        ...customerExpenses.map(e => ({
            date: e.date,
            type: 'Expense',
            details: `${e.category || 'Expense'} - ${e.description || ''}`,
            debit: 0,
            credit: e.amount
        })),
        ...transfersFrom.map(t => ({
            date: t.date,
            type: 'Transfer Out',
            details: `Paid for ${t.toCustomerName || 'Customer'} - ${t.notes || ''}`,
            debit: t.amount,
            credit: 0
        })),
        ...transfersTo.map(t => ({
            date: t.date,
            type: 'Transfer In',
            details: `${t.fromCustomerName || 'Customer'} paid for this - ${t.notes || ''}`,
            debit: 0,
            credit: t.amount
        })),
        ...jvDebits.map(jv => ({
            date: jv.date,
            type: 'JV Debit',
            details: `${jv.description || 'Journal Entry'} (Dr: ${jv.debitAccount || ''})`,
            debit: jv.debitAmount || 0,
            credit: 0
        })),
        ...jvCredits.map(jv => ({
            date: jv.date,
            type: 'JV Credit',
            details: `${jv.description || 'Journal Entry'} (Cr: ${jv.creditAccount || ''})`,
            debit: 0,
            credit: jv.creditAmount || 0
        }))
    ].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    let runningBalance = 0;
    allEntries.forEach(entry => {
        runningBalance += entry.debit - entry.credit;
        html += `
            <tr>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td>
                    <span style="background: ${
                        entry.type === 'Sale' ? '#48bb78' : 
                        entry.type === 'Payment' ? '#4299e1' : 
                        entry.type === 'Expense' ? '#f56565' :
                        entry.type === 'Transfer Out' ? '#9f7aea' :
                        entry.type === 'Transfer In' ? '#38b2ac' :
                        entry.type === 'JV Debit' ? '#ed8936' :
                        entry.type === 'JV Credit' ? '#f687b3' : '#718096'
                    }; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8em; font-weight: 600;">
                        ${entry.type}
                    </span>
                </td>
                <td>${entry.details}</td>
                <td style="color: #f56565; font-weight: 600;">
                    ${entry.debit > 0 ? 'Rs. ' + entry.debit.toFixed(2) : '-'}
                </td>
                <td style="color: #48bb78; font-weight: 600;">
                    ${entry.credit > 0 ? 'Rs. ' + entry.credit.toFixed(2) : '-'}
                </td>
                <td style="font-weight: 700; color: ${runningBalance >= 0 ? '#ed8936' : '#48bb78'};">
                    Rs. ${runningBalance.toFixed(2)}
                </td>
            </tr>
        `;
    });
    
    if (customerSales.length > 0 || customerPayments.length > 0 || customerExpenses.length > 0 || 
        transfersFrom.length > 0 || transfersTo.length > 0 || jvDebits.length > 0 || jvCredits.length > 0) {
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    html += '</div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Customer ledger report generated! 📒', 'success');
}

function generateSingleVehicleReport() {
    const vehicleId = document.getElementById('vehicleReportSelect').value;
    const fromDate = document.getElementById('vehicleReportFromDate').value;
    const toDate = document.getElementById('vehicleReportToDate').value;
    
    if (!vehicleId) {
        showNotification('Please select a vehicle!', 'error');
        return;
    }
    
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
        showNotification('Vehicle not found!', 'error');
        return;
    }
    
    // Filter transactions by date if dates are provided
    let vehicleSales = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'sale');
    let vehiclePurchases = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'purchase');
    
    if (fromDate) {
        vehicleSales = vehicleSales.filter(t => t.date >= fromDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date >= fromDate);
    }
    if (toDate) {
        vehicleSales = vehicleSales.filter(t => t.date <= toDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date <= toDate);
    }
    
    const totalSales = vehicleSales.reduce((sum, t) => sum + t.amount, 0);
    const totalPurchases = vehiclePurchases.reduce((sum, t) => sum + t.amount, 0);
    const profit = totalSales - totalPurchases;
    
    // Calculate fuel-wise breakdown
    const pmgSales = vehicleSales.filter(t => t.fuelType === 'PMG').reduce((sum, t) => sum + t.amount, 0);
    const hsdSales = vehicleSales.filter(t => t.fuelType === 'HSD').reduce((sum, t) => sum + t.amount, 0);
    const pmgPurchases = vehiclePurchases.filter(t => t.fuelType === 'PMG').reduce((sum, t) => sum + t.amount, 0);
    const hsdPurchases = vehiclePurchases.filter(t => t.fuelType === 'HSD').reduce((sum, t) => sum + t.amount, 0);
    
    let html = `
        <div class="card">
            <h2>🚛 Vehicle Profit Report</h2>
            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">${vehicle.number}</h3>
                        <p style="margin: 5px 0;"><strong>Driver:</strong> ${vehicle.driverName}</p>
                        <p style="margin: 5px 0;"><strong>Contact:</strong> ${vehicle.contact || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: ${vehicle.status === 'Active' ? '#48bb78' : '#ed8936'};">${vehicle.status}</span></p>
                    </div>
                    <div>
                        <p style="margin: 5px 0;"><strong>Current PMG Stock:</strong> ${vehicle.stockPMG.toFixed(2)} KL</p>
                        <p style="margin: 5px 0;"><strong>Current HSD Stock:</strong> ${vehicle.stockHSD.toFixed(2)} KL</p>
                        <p style="margin: 5px 0;"><strong>Report Period:</strong> ${fromDate || 'Start'} to ${toDate || 'Today'}</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: #48bb78; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Total Sales</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${totalSales.toFixed(2)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${vehicleSales.length} transactions</div>
                </div>
                <div style="background: #ed8936; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Total Purchases</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${totalPurchases.toFixed(2)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${vehiclePurchases.length} transactions</div>
                </div>
                <div style="background: ${profit >= 0 ? '#667eea' : '#f56565'}; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Profit/Loss</div>
                    <div style="font-size: 1.8em; font-weight: 700;">Rs. ${profit.toFixed(2)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${profit >= 0 ? 'Profit ✅' : 'Loss ⚠️'}</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">PMG (Petrol)</h4>
                    <p style="margin: 5px 0;"><strong>Sales:</strong> Rs. ${pmgSales.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Purchases:</strong> Rs. ${pmgPurchases.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Profit:</strong> <span style="color: ${(pmgSales - pmgPurchases) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700;">Rs. ${(pmgSales - pmgPurchases).toFixed(2)}</span></p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #ed8936;">
                    <h4 style="color: #ed8936; margin-bottom: 10px;">HSD (Diesel)</h4>
                    <p style="margin: 5px 0;"><strong>Sales:</strong> Rs. ${hsdSales.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Purchases:</strong> Rs. ${hsdPurchases.toFixed(2)}</p>
                    <p style="margin: 5px 0;"><strong>Profit:</strong> <span style="color: ${(hsdSales - hsdPurchases) >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700;">Rs. ${(hsdSales - hsdPurchases).toFixed(2)}</span></p>
                </div>
            </div>
            
            ${vehicleSales.length > 0 || vehiclePurchases.length > 0 ? `
            <h3 style="color: #667eea; margin-bottom: 10px;">Transaction Details</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Party</th>
                            <th>Fuel</th>
                            <th>Quantity (L)</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            ` : '<p style="text-align: center; color: #718096; padding: 20px;">No transactions in selected period</p>'}
    `;
    
    // Combine all transactions and sort by date
    const allTransactions = [...vehicleSales, ...vehiclePurchases].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    allTransactions.forEach(trans => {
        html += `
            <tr>
                <td>${new Date(trans.date).toLocaleDateString()}</td>
                <td>
                    <span style="background: ${trans.type === 'sale' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8em;">
                        ${trans.type.toUpperCase()}
                    </span>
                </td>
                <td>${trans.partyName}</td>
                <td><span style="background: ${trans.fuelType === 'PMG' ? '#667eea' : '#ed8936'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">${trans.fuelType}</span></td>
                <td>${trans.quantity.toFixed(2)}</td>
                <td>Rs. ${trans.rate.toFixed(4)}</td>
                <td style="font-weight: 700; color: ${trans.type === 'sale' ? '#48bb78' : '#ed8936'};">Rs. ${trans.amount.toFixed(2)}</td>
            </tr>
        `;
    });
    
    if (vehicleSales.length > 0 || vehiclePurchases.length > 0) {
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    html += '</div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Vehicle report generated! 🚛', 'success');
}

function generateAllPartiesReport() {
    let html = `
        <div class="card">
            <h2>📋 All Parties Balance Report</h2>
            <p style="color: #718096; margin-bottom: 20px;">Complete overview of all balances as of ${new Date().toLocaleDateString()}</p>
            
            <!-- Customers Section -->
            <h3 style="color: #48bb78; margin-top: 20px; margin-bottom: 10px;">👥 Customers (Receivables)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>PMG Rate</th>
                            <th>HSD Rate</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalReceivables = 0;
    customers.forEach(customer => {
        totalReceivables += customer.balance > 0 ? customer.balance : 0;
        html += `
            <tr>
                <td><strong>${customer.name}</strong></td>
                <td>${customer.contact || 'N/A'}</td>
                <td>Rs. ${customer.pmgRate}</td>
                <td>Rs. ${customer.hsdRate}</td>
                <td style="font-weight: 700; color: ${customer.balance > 0 ? '#ed8936' : '#48bb78'};">
                    Rs. ${customer.balance.toFixed(2)}
                </td>
                <td>
                    ${customer.balance > 0 ? '<span style="background: #ed8936; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">PENDING</span>' : '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">CLEAR</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #48bb78;">
                            <td colspan="4"><strong>TOTAL RECEIVABLES</strong></td>
                            <td style="color: #ed8936; font-size: 1.2em;">Rs. ${totalReceivables.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Suppliers Section -->
            <h3 style="color: #ed8936; margin-top: 30px; margin-bottom: 10px;">🏭 Suppliers (Payables)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>PMG Rate</th>
                            <th>HSD Rate</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalPayables = 0;
    suppliers.forEach(supplier => {
        totalPayables += supplier.balance > 0 ? supplier.balance : 0;
        html += `
            <tr>
                <td><strong>${supplier.name}</strong></td>
                <td>${supplier.contact || 'N/A'}</td>
                <td>Rs. ${supplier.pmgRate}</td>
                <td>Rs. ${supplier.hsdRate}</td>
                <td style="font-weight: 700; color: ${supplier.balance > 0 ? '#f56565' : '#48bb78'};">
                    Rs. ${supplier.balance.toFixed(2)}
                </td>
                <td>
                    ${supplier.balance > 0 ? '<span style="background: #f56565; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">TO PAY</span>' : '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">CLEAR</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #ed8936;">
                            <td colspan="4"><strong>TOTAL PAYABLES</strong></td>
                            <td style="color: #f56565; font-size: 1.2em;">Rs. ${totalPayables.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Banks Section -->
            <h3 style="color: #4299e1; margin-top: 30px; margin-bottom: 10px;">🏦 Bank Accounts</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Bank Name</th>
                            <th>Account Number</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalBankBalance = 0;
    banks.forEach(bank => {
        totalBankBalance += bank.balance;
        html += `
            <tr>
                <td><strong>${bank.name}</strong></td>
                <td>${bank.accountNumber}</td>
                <td style="font-weight: 700; color: ${bank.balance >= 0 ? '#48bb78' : '#f56565'};">
                    Rs. ${bank.balance.toFixed(2)}
                </td>
                <td>
                    ${bank.balance >= 0 ? '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">POSITIVE</span>' : '<span style="background: #f56565; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">NEGATIVE</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #4299e1;">
                            <td colspan="2"><strong>TOTAL BANK BALANCE</strong></td>
                            <td style="color: #4299e1; font-size: 1.2em;">Rs. ${totalBankBalance.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Vehicles Section -->
            <h3 style="color: #805ad5; margin-top: 30px; margin-bottom: 10px;">🚛 Vehicles & Stock</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Vehicle Number</th>
                            <th>Driver</th>
                            <th>PMG Stock (KL)</th>
                            <th>HSD Stock (KL)</th>
                            <th>Total Stock (KL)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let totalStock = 0;
    vehicles.forEach(vehicle => {
        const vehicleStock = vehicle.stockPMG + vehicle.stockHSD;
        totalStock += vehicleStock;
        html += `
            <tr>
                <td><strong>${vehicle.number}</strong></td>
                <td>${vehicle.driverName}</td>
                <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
                <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
                <td style="font-weight: 700;">${vehicleStock.toFixed(2)} KL</td>
                <td>
                    <span style="background: ${vehicle.status === 'Active' ? '#48bb78' : '#ed8936'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">${vehicle.status}</span>
                </td>
            </tr>
        `;
    });
    
    html += `
                        <tr style="background: #f7fafc; font-weight: 700; border-top: 3px solid #805ad5;">
                            <td colspan="4"><strong>TOTAL STOCK</strong></td>
                            <td style="color: #805ad5; font-size: 1.2em;">${totalStock.toFixed(2)} KL</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Summary -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-top: 30px;">
                <h3 style="color: white; margin-bottom: 15px; text-align: center;">📊 Financial Summary</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Total Receivables</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalReceivables.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Total Payables</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalPayables.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Bank Balance</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${totalBankBalance.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="opacity: 0.9; font-size: 0.9em;">Net Position</div>
                        <div style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">Rs. ${(totalReceivables - totalPayables + totalBankBalance).toFixed(2)}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('All parties report generated! 📋', 'success');
}

function generateProfitLossReport() {
    const totalSales = transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
    const totalPurchases = transactions.filter(t => t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
    const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
    const grossProfit = totalSales - totalPurchases;
    const netProfit = grossProfit - totalExpenses;
    
    const html = `
        <div class="card">
            <h2>📊 Profit & Loss Statement</h2>
            <div class="profit-loss-section">
                <div class="profit-loss-item">
                    <span>Total Sales</span>
                    <span style="color: #48bb78; font-weight: 600;">Rs. ${totalSales.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Purchases</span>
                    <span style="color: #f56565; font-weight: 600;">Rs. ${totalPurchases.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Gross Profit</span>
                    <span style="font-weight: 600;">Rs. ${grossProfit.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Expenses</span>
                    <span style="color: #ed8936; font-weight: 600;">Rs. ${totalExpenses.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item total">
                    <span>Net Profit</span>
                    <span style="color: ${netProfit >= 0 ? '#48bb78' : '#f56565'};">Rs. ${netProfit.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Profit & Loss generated!', 'success');
}

function generateMonthlyReport() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    const monthlyTransactions = transactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
    });
    
    const monthlyExpenses = expenses.filter(e => {
        const eDate = new Date(e.date);
        return eDate.getMonth() === currentMonth && eDate.getFullYear() === currentYear;
    }).reduce((sum, e) => sum + e.amount, 0);
    
    const monthlySales = monthlyTransactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
    const monthlyPurchases = monthlyTransactions.filter(t => t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
    const monthlyProfit = monthlySales - monthlyPurchases - monthlyExpenses;
    
    const html = `
        <div class="card">
            <h2>📅 Monthly Report - ${now.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
            <div class="profit-loss-section">
                <div class="profit-loss-item">
                    <span>Monthly Sales</span>
                    <span style="color: #48bb78; font-weight: 600;">Rs. ${monthlySales.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Monthly Purchases</span>
                    <span style="color: #f56565; font-weight: 600;">Rs. ${monthlyPurchases.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Monthly Expenses</span>
                    <span style="color: #ed8936; font-weight: 600;">Rs. ${monthlyExpenses.toFixed(2)}</span>
                </div>
                <div class="profit-loss-item">
                    <span>Total Transactions</span>
                    <span style="font-weight: 600;">${monthlyTransactions.length}</span>
                </div>
                <div class="profit-loss-item total">
                    <span>Monthly Net Profit</span>
                    <span style="color: ${monthlyProfit >= 0 ? '#48bb78' : '#f56565'};">Rs. ${monthlyProfit.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Monthly report generated!', 'success');
}

function generateVehicleProfitReport() {
    let html = '<div class="card"><h2>🚛 Vehicle-wise Profit Analysis</h2><div class="table-container"><table><thead><tr><th>Vehicle</th><th>Driver</th><th>Total Sales</th><th>Total Purchases</th><th>Profit/Loss</th><th>PMG Stock</th><th>HSD Stock</th><th>Deliveries</th></tr></thead><tbody>';
    
    let totalSalesAll = 0;
    let totalPurchasesAll = 0;
    let totalProfitAll = 0;
    
    vehicles.forEach(vehicle => {
        // Calculate ACTUAL sales from this vehicle
        const vehicleSales = transactions.filter(t => t.vehicleId === vehicle.id && t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
        
        // Calculate ACTUAL purchases into this vehicle
        const vehiclePurchases = transactions.filter(t => t.vehicleId === vehicle.id && t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
        
        // Calculate REAL profit = Sales - Purchases
        const actualProfit = vehicleSales - vehiclePurchases;
        
        // Count deliveries
        const deliveryCount = transactions.filter(t => t.vehicleId === vehicle.id).length;
        
        totalSalesAll += vehicleSales;
        totalPurchasesAll += vehiclePurchases;
        totalProfitAll += actualProfit;
        
        html += `
            <tr>
                <td><strong>${vehicle.number}</strong></td>
                <td>${vehicle.driverName}</td>
                <td style="color: #48bb78; font-weight: 700;">Rs. ${vehicleSales.toFixed(2)}</td>
                <td style="color: #ed8936; font-weight: 700;">Rs. ${vehiclePurchases.toFixed(2)}</td>
                <td style="color: ${actualProfit >= 0 ? '#667eea' : '#f56565'}; font-weight: 700; font-size: 1.1em;">
                    Rs. ${actualProfit.toFixed(2)}
                    ${actualProfit >= 0 ? '✅' : '⚠️'}
                </td>
                <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
                <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
                <td>${deliveryCount}</td>
            </tr>
        `;
    });
    
    // Add totals row
    html += `
        <tr style="background: #f7fafc; font-weight: 700; font-size: 1.1em; border-top: 3px solid #667eea;">
            <td colspan="2"><strong>TOTAL</strong></td>
            <td style="color: #48bb78;">Rs. ${totalSalesAll.toFixed(2)}</td>
            <td style="color: #ed8936;">Rs. ${totalPurchasesAll.toFixed(2)}</td>
            <td style="color: ${totalProfitAll >= 0 ? '#667eea' : '#f56565'}; font-size: 1.2em;">
                Rs. ${totalProfitAll.toFixed(2)}
                ${totalProfitAll >= 0 ? '🎉' : '⚠️'}
            </td>
            <td colspan="3"></td>
        </tr>
    `;
    
    html += '</tbody></table></div>';
    
    // Add summary section
    html += `
        <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 10px; border-left: 4px solid #667eea;">
            <h3 style="color: #667eea; margin-bottom: 10px;">📊 Summary</h3>
            <p style="margin: 5px 0;"><strong>Total Sales:</strong> Rs. ${totalSalesAll.toFixed(2)}</p>
            <p style="margin: 5px 0;"><strong>Total Purchases:</strong> Rs. ${totalPurchasesAll.toFixed(2)}</p>
            <p style="margin: 5px 0;"><strong>Overall Profit:</strong> <span style="color: ${totalProfitAll >= 0 ? '#48bb78' : '#f56565'}; font-weight: 700; font-size: 1.2em;">Rs. ${totalProfitAll.toFixed(2)}</span></p>
            <p style="margin: 5px 0; color: #718096; font-size: 0.9em;"><em>Note: This shows actual profit (Sales - Purchases) for each vehicle</em></p>
        </div>
    `;
    
    html += '</div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Vehicle profit report generated! 🚛', 'success');
}

function generateStockReport() {
    let totalPMG = 0;
    let totalHSD = 0;
    
    let html = '<div class="card"><h2>📦 Stock Report</h2><div class="table-container"><table><thead><tr><th>Vehicle</th><th>PMG Stock (KL)</th><th>HSD Stock (KL)</th><th>Total Stock (KL)</th></tr></thead><tbody>';
    
    vehicles.forEach(vehicle => {
        const totalStock = vehicle.stockPMG + vehicle.stockHSD;
        totalPMG += vehicle.stockPMG;
        totalHSD += vehicle.stockHSD;
        
        html += `
            <tr>
                <td><strong>${vehicle.number}</strong></td>
                <td><span class="stock-badge stock-pmg">${vehicle.stockPMG.toFixed(2)} KL</span></td>
                <td><span class="stock-badge stock-hsd">${vehicle.stockHSD.toFixed(2)} KL</span></td>
                <td style="font-weight: 700;">${totalStock.toFixed(2)} KL</td>
            </tr>
        `;
    });
    
    html += `
        <tr style="background: #f7fafc; font-weight: 700;">
            <td>TOTAL</td>
            <td><span class="stock-badge stock-pmg">${totalPMG.toFixed(2)} KL</span></td>
            <td><span class="stock-badge stock-hsd">${totalHSD.toFixed(2)} KL</span></td>
            <td style="color: #667eea; font-size: 1.2em;">${(totalPMG + totalHSD).toFixed(2)} KL</td>
        </tr>
    `;
    
    html += '</tbody></table></div></div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Stock report generated!', 'success');
}

function generateExpenseReport() {
    const expensesByCategory = {};
    expenses.forEach(e => {
        if (!expensesByCategory[e.category]) {
            expensesByCategory[e.category] = 0;
        }
        expensesByCategory[e.category] += e.amount;
    });
    
    let html = '<div class="card"><h2>💸 Expense Report by Category</h2><div class="table-container"><table><thead><tr><th>Category</th><th>Total Amount</th><th>Count</th></tr></thead><tbody>';
    
    Object.keys(expensesByCategory).forEach(category => {
        const count = expenses.filter(e => e.category === category).length;
        html += `
            <tr>
                <td><strong>${category}</strong></td>
                <td style="color: #f56565; font-weight: 700;">Rs. ${expensesByCategory[category].toFixed(2)}</td>
                <td>${count}</td>
            </tr>
        `;
    });
    
    const totalExpenses = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);
    html += `
        <tr style="background: #f7fafc; font-weight: 700;">
            <td>TOTAL</td>
            <td style="color: #f56565;">Rs. ${totalExpenses.toFixed(2)}</td>
            <td>${expenses.length}</td>
        </tr>
    `;
    
    html += '</tbody></table></div></div>';
    document.getElementById('reportOutput').innerHTML = html;
    showNotification('Expense report generated!', 'success');
}

// EXPORT FUNCTIONS
function exportVehicleProfitPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Vehicle-wise Profit & Stock Analysis', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 32, { align: 'center' });
    doc.text(`Generated by: ${currentUser}`, 105, 38, { align: 'center' });
    
    const tableData = vehicles.map(v => {
        const vehicleSales = transactions.filter(t => t.vehicleId === v.id && t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
        const vehiclePurchases = transactions.filter(t => t.vehicleId === v.id && t.type === 'purchase').reduce((sum, t) => sum + t.amount, 0);
        const actualProfit = vehicleSales - vehiclePurchases;
        
        return [
            v.number,
            v.driverName,
            `Rs. ${vehicleSales.toFixed(2)}`,
            `Rs. ${vehiclePurchases.toFixed(2)}`,
            `Rs. ${actualProfit.toFixed(2)}`,
            `${v.stockPMG.toFixed(2)} KL`,
            `${v.stockHSD.toFixed(2)} KL`
        ];
    });
    
    doc.autoTable({
        startY: 45,
        head: [['Vehicle', 'Driver', 'Sales', 'Purchases', 'Actual Profit', 'PMG Stock', 'HSD Stock']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`vehicle-profit-report-${Date.now()}.pdf`);
    showNotification('PDF exported! 📄', 'success');
}

function exportCustomerLedgerPDF() {
    const customerId = document.getElementById('customerReportSelect').value;
    const fromDate = document.getElementById('customerReportFromDate').value;
    const toDate = document.getElementById('customerReportToDate').value;
    
    if (!customerId) {
        showNotification('Please select a customer first!', 'error');
        return;
    }
    
    const customer = customers.find(c => c.id === customerId);
    if (!customer) {
        showNotification('Customer not found!', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Customer Ledger Report', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Period: ${fromDate || 'Start'} to ${toDate || 'Today'}`, 105, 32, { align: 'center' });
    
    // Customer info
    doc.setFontSize(11);
    doc.text(`Customer: ${customer.name}`, 20, 45);
    doc.text(`Contact: ${customer.contact || 'N/A'}`, 20, 52);
    doc.text(`Balance: Rs. ${customer.balance.toFixed(2)}`, 20, 59);
    
    // Filter transactions
    let customerSales = transactions.filter(t => t.partyId === customerId && t.type === 'sale');
    let customerPayments = payments.filter(p => p.partyId === customerId && p.type === 'received');
    
    if (fromDate) {
        customerSales = customerSales.filter(t => t.date >= fromDate);
        customerPayments = customerPayments.filter(p => p.date >= fromDate);
    }
    if (toDate) {
        customerSales = customerSales.filter(t => t.date <= toDate);
        customerPayments = customerPayments.filter(p => p.date <= toDate);
    }
    
    const allEntries = [
        ...customerSales.map(t => ({
            date: t.date,
            type: 'Sale',
            details: `${t.fuelType} - ${t.quantity.toFixed(2)}L`,
            debit: t.amount,
            credit: 0
        })),
        ...customerPayments.map(p => ({
            date: p.date,
            type: 'Payment',
            details: p.method,
            debit: 0,
            credit: p.amount
        }))
    ].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const tableData = allEntries.map(entry => [
        new Date(entry.date).toLocaleDateString(),
        entry.type,
        entry.details,
        entry.debit > 0 ? `Rs. ${entry.debit.toFixed(2)}` : '-',
        entry.credit > 0 ? `Rs. ${entry.credit.toFixed(2)}` : '-'
    ]);
    
    doc.autoTable({
        startY: 70,
        head: [['Date', 'Type', 'Details', 'Debit (Sales)', 'Credit (Payment)']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`customer-ledger-${customer.name}-${Date.now()}.pdf`);
    showNotification('Customer ledger PDF exported! 📄', 'success');
}

function exportSingleVehiclePDF() {
    const vehicleId = document.getElementById('vehicleReportSelect').value;
    const fromDate = document.getElementById('vehicleReportFromDate').value;
    const toDate = document.getElementById('vehicleReportToDate').value;
    
    if (!vehicleId) {
        showNotification('Please select a vehicle first!', 'error');
        return;
    }
    
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
        showNotification('Vehicle not found!', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Vehicle Profit Report', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Period: ${fromDate || 'Start'} to ${toDate || 'Today'}`, 105, 32, { align: 'center' });
    
    // Vehicle info
    let vehicleSales = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'sale');
    let vehiclePurchases = transactions.filter(t => t.vehicleId === vehicleId && t.type === 'purchase');
    
    if (fromDate) {
        vehicleSales = vehicleSales.filter(t => t.date >= fromDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date >= fromDate);
    }
    if (toDate) {
        vehicleSales = vehicleSales.filter(t => t.date <= toDate);
        vehiclePurchases = vehiclePurchases.filter(t => t.date <= toDate);
    }
    
    const totalSales = vehicleSales.reduce((sum, t) => sum + t.amount, 0);
    const totalPurchases = vehiclePurchases.reduce((sum, t) => sum + t.amount, 0);
    const profit = totalSales - totalPurchases;
    
    doc.setFontSize(11);
    doc.text(`Vehicle: ${vehicle.number}`, 20, 45);
    doc.text(`Driver: ${vehicle.driverName}`, 20, 52);
    doc.text(`Sales: Rs. ${totalSales.toFixed(2)}`, 20, 59);
    doc.text(`Purchases: Rs. ${totalPurchases.toFixed(2)}`, 20, 66);
    doc.text(`Profit: Rs. ${profit.toFixed(2)}`, 20, 73);
    
    const allTransactions = [...vehicleSales, ...vehiclePurchases].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tableData = allTransactions.map(trans => [
        new Date(trans.date).toLocaleDateString(),
        trans.type.toUpperCase(),
        trans.partyName,
        trans.fuelType,
        `${trans.quantity.toFixed(2)}L`,
        `Rs. ${trans.amount.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: 82,
        head: [['Date', 'Type', 'Party', 'Fuel', 'Quantity', 'Amount']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`vehicle-report-${vehicle.number}-${Date.now()}.pdf`);
    showNotification('Vehicle report PDF exported! 📄', 'success');
}

function exportAllPartiesPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text('Baghoor Oil Traders', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('All Parties Balance Report', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 32, { align: 'center' });
    doc.text(`Generated by: ${currentUser}`, 105, 38, { align: 'center' });
    
    let startY = 48;
    
    // Customers
    doc.setFontSize(11);
    doc.text('CUSTOMERS (Receivables)', 20, startY);
    const customerData = customers.map(c => [
        c.name,
        c.contact || 'N/A',
        `Rs. ${c.balance.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: startY + 5,
        head: [['Name', 'Contact', 'Balance']],
        body: customerData,
        theme: 'striped',
        headStyles: { fillColor: [72, 187, 120] }
    });
    
    startY = doc.lastAutoTable.finalY + 15;
    
    // Suppliers
    doc.text('SUPPLIERS (Payables)', 20, startY);
    const supplierData = suppliers.map(s => [
        s.name,
        s.contact || 'N/A',
        `Rs. ${s.balance.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: startY + 5,
        head: [['Name', 'Contact', 'Balance']],
        body: supplierData,
        theme: 'striped',
        headStyles: { fillColor: [237, 137, 54] }
    });
    
    startY = doc.lastAutoTable.finalY + 15;
    
    // Banks
    if (startY > 250) {
        doc.addPage();
        startY = 20;
    }
    
    doc.text('BANK ACCOUNTS', 20, startY);
    const bankData = banks.map(b => [
        b.name,
        b.accountNumber,
        `Rs. ${b.balance.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: startY + 5,
        head: [['Bank Name', 'Account Number', 'Balance']],
        body: bankData,
        theme: 'striped',
        headStyles: { fillColor: [66, 153, 225] }
    });
    
    doc.save(`all-parties-balance-${Date.now()}.pdf`);
    showNotification('All parties report PDF exported! 📄', 'success');
}

function exportAllDataExcel() {
    const wb = XLSX.utils.book_new();
    
    // Customers
    const customersData = customers.map(c => ({
        Name: c.name,
        Contact: c.contact,
        CNIC: c.cnic,
        'PMG Rate': c.pmgRate,
        'HSD Rate': c.hsdRate,
        Balance: c.balance,
        Address: c.address
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(customersData), 'Customers');
    
    // Suppliers
    const suppliersData = suppliers.map(s => ({
        Name: s.name,
        Contact: s.contact,
        CNIC: s.cnic,
        'PMG Rate': s.pmgRate,
        'HSD Rate': s.hsdRate,
        Balance: s.balance,
        Address: s.address
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(suppliersData), 'Suppliers');
    
    // Transactions
    const transData = transactions.map(t => ({
        Date: t.date,
        Type: t.type,
        Party: t.partyName,
        'Fuel Type': t.fuelType,
        Quantity: t.quantity,
        Rate: t.rate,
        Amount: t.amount
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transData), 'Transactions');
    
    // Payments
    const paymentsData = payments.map(p => ({
        Date: p.date,
        Type: p.type,
        Party: p.partyName,
        Amount: p.amount,
        Method: p.method,
        Notes: p.notes
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(paymentsData), 'Payments');
    
    // Expenses
    const expensesData = expenses.map(e => ({
        Date: e.date,
        Category: e.category,
        Description: e.description,
        Amount: e.amount,
        Source: e.source,
        Method: e.method
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expensesData), 'Expenses');
    
    // Vehicles with Stock
    const vehiclesData = vehicles.map(v => ({
        'Vehicle Number': v.number,
        Driver: v.driverName,
        Contact: v.contact,
        Status: v.status,
        'PMG Stock (KL)': v.stockPMG.toFixed(2),
        'HSD Stock (KL)': v.stockHSD.toFixed(2)
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(vehiclesData), 'Vehicles');
    
    // Banks
    const banksData = banks.map(b => ({
        'Bank Name': b.name,
        'Account Number': b.accountNumber,
        Balance: b.balance
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(banksData), 'Banks');
    
    // Ledger
    const ledgerData = ledgerEntries.map(l => ({
        Date: l.date,
        Type: l.type,
        Description: l.description,
        'Debit Account': l.debitAccount,
        'Debit Amount': l.debitAmount,
        'Credit Account': l.creditAccount,
        'Credit Amount': l.creditAmount
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ledgerData), 'Ledger');
    
    XLSX.writeFile(wb, `baghoor-complete-${Date.now()}.xlsx`);
    showNotification('Excel exported! 📊', 'success');
}

// BACKUP FUNCTIONS
function createBackup() {
    const backup = {
        version: '4.0',
        timestamp: new Date().toISOString(),
        createdBy: currentUser,
        data: {
            customers,
            suppliers,
            vehicles,
            banks,
            transactions,
            payments,
            expenses,
            customerTransfers,
            bankTransactions,
            rateChangeLogs,
            ledgerEntries
        }
    };
    
    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `baghoor-backup-${Date.now()}.json`;
    link.click();
    
    showNotification('Backup downloaded! 💾', 'success');
}

function restoreBackup() {
    const fileInput = document.getElementById('backupFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('Please select a backup file!', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (backup.data) {
                customers = backup.data.customers || [];
                suppliers = backup.data.suppliers || [];
                vehicles = backup.data.vehicles || [];
                banks = backup.data.banks || [];
                transactions = backup.data.transactions || [];
                payments = backup.data.payments || [];
                expenses = backup.data.expenses || [];
                customerTransfers = backup.data.customerTransfers || [];
                bankTransactions = backup.data.bankTransactions || [];
                rateChangeLogs = backup.data.rateChangeLogs || [];
                ledgerEntries = backup.data.ledgerEntries || [];
                
                saveToStorage();
                initApp();
                closeModal('backupModal');
                showNotification('Backup restored! 🎉', 'success');
            } else {
                showNotification('Invalid backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading backup!', 'error');
        }
    };
    reader.readAsText(file);
}

// INDIVIDUAL DATA EXPORT & RESTORE FUNCTIONS

// ===== CUSTOMERS =====
function exportCustomersPDF() {
    window.print(); // Simple print for now - in production, use jsPDF
    showNotification('Use Print dialog to save as PDF', 'success');
}

function exportCustomersJSON() {
    const data = { customers: customers };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'customers-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    showNotification('Customers backup downloaded! 💾', 'success');
}

function restoreCustomers() {
    const file = document.getElementById('customersRestoreFile').files[0];
    if (!file) {
        showNotification('Please select a file!', 'error');
        return;
    }
    
    if (!confirm('This will REPLACE all existing customers! Continue?')) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            if (backup.customers) {
                customers = backup.customers;
                saveToStorage();
                renderCustomers();
                updateDashboard();
                showNotification('Customers restored! ✅', 'success');
            } else {
                showNotification('Invalid customers backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading file!', 'error');
        }
    };
    reader.readAsText(file);
}

// ===== SUPPLIERS =====
function exportSuppliersPDF() {
    window.print();
    showNotification('Use Print dialog to save as PDF', 'success');
}

function exportSuppliersJSON() {
    const data = { suppliers: suppliers };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'suppliers-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    showNotification('Suppliers backup downloaded! 💾', 'success');
}

function restoreSuppliers() {
    const file = document.getElementById('suppliersRestoreFile').files[0];
    if (!file) {
        showNotification('Please select a file!', 'error');
        return;
    }
    
    if (!confirm('This will REPLACE all existing suppliers! Continue?')) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            if (backup.suppliers) {
                suppliers = backup.suppliers;
                saveToStorage();
                renderSuppliers();
                updateDashboard();
                showNotification('Suppliers restored! ✅', 'success');
            } else {
                showNotification('Invalid suppliers backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading file!', 'error');
        }
    };
    reader.readAsText(file);
}

// ===== VEHICLES =====
function exportVehiclesPDF() {
    window.print();
    showNotification('Use Print dialog to save as PDF', 'success');
}

function exportVehiclesJSON() {
    const data = { vehicles: vehicles };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'vehicles-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    showNotification('Vehicles backup downloaded! 💾', 'success');
}

function restoreVehicles() {
    const file = document.getElementById('vehiclesRestoreFile').files[0];
    if (!file) {
        showNotification('Please select a file!', 'error');
        return;
    }
    
    if (!confirm('This will REPLACE all existing vehicles! Continue?')) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            if (backup.vehicles) {
                vehicles = backup.vehicles;
                saveToStorage();
                renderVehicles();
                updateDashboard();
                showNotification('Vehicles restored! ✅', 'success');
            } else {
                showNotification('Invalid vehicles backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading file!', 'error');
        }
    };
    reader.readAsText(file);
}

// ===== BANKS =====
function exportBanksPDF() {
    window.print();
    showNotification('Use Print dialog to save as PDF', 'success');
}

function exportBanksJSON() {
    const data = { banks: banks, bankTransactions: bankTransactions };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'banks-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    showNotification('Banks backup downloaded! 💾', 'success');
}

function restoreBanks() {
    const file = document.getElementById('banksRestoreFile').files[0];
    if (!file) {
        showNotification('Please select a file!', 'error');
        return;
    }
    
    if (!confirm('This will REPLACE all existing banks and bank transactions! Continue?')) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            if (backup.banks) {
                banks = backup.banks;
                bankTransactions = backup.bankTransactions || [];
                saveToStorage();
                renderBanks();
                renderBankTransactions();
                updateDashboard();
                showNotification('Banks restored! ✅', 'success');
            } else {
                showNotification('Invalid banks backup file!', 'error');
            }
        } catch (err) {
            showNotification('Error reading file!', 'error');
        }
    };
    reader.readAsText(file);
}

// UI HELPER FUNCTIONS
function updateDashboard() {
    document.getElementById('totalCustomers').textContent = customers.length;
    document.getElementById('totalSuppliers').textContent = suppliers.length;
    document.getElementById('totalVehicles').textContent = vehicles.length;
    document.getElementById('totalBanks').textContent = banks.length;
    
    const totalReceivables = customers.reduce((sum, c) => sum + (c.balance > 0 ? c.balance : 0), 0);
    document.getElementById('totalReceivables').textContent = 'Rs. ' + totalReceivables.toFixed(2);
    
    const totalPayables = suppliers.reduce((sum, s) => sum + (s.balance > 0 ? s.balance : 0), 0);
    document.getElementById('totalPayables').textContent = 'Rs. ' + totalPayables.toFixed(2);
    
    const totalBankBalance = banks.reduce((sum, b) => sum + b.balance, 0);
    document.getElementById('totalBankBalance').textContent = 'Rs. ' + totalBankBalance.toFixed(2);
    
    const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('totalExpenses').textContent = 'Rs. ' + totalExpenses.toFixed(2);
    
    const totalStock = vehicles.reduce((sum, v) => sum + v.stockPMG + v.stockHSD, 0);
    document.getElementById('totalStock').textContent = totalStock.toFixed(2) + ' KL';
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
    
    if (tabName === 'ledger') {
        generateLedger();
    }
}

function openModal(modalId) {
    // Special handling for admin settings modal
    if (modalId === 'adminSettingsModal') {
        if (currentRole !== 'admin') {
            showNotification('Only admin can access this!', 'error');
            return;
        }
        renderUserManagement();
    }
    
    // Clear supplier form when opening to add new
    if (modalId === 'supplierModal') {
        document.getElementById('supplierId').value = '';
        document.getElementById('supplierName').value = '';
        document.getElementById('supplierContact').value = '';
        document.getElementById('supplierCnic').value = '';
        document.getElementById('supplierPmgRate').value = '';
        document.getElementById('supplierHsdRate').value = '';
        document.getElementById('supplierAddress').value = '';
        document.getElementById('supplierNotes').value = '';
        document.getElementById('supplierOpeningBalance').value = '0';
    }
    
    // Clear customer form when opening to add new
    if (modalId === 'customerModal') {
        document.getElementById('customerId').value = '';
        document.getElementById('customerName').value = '';
        document.getElementById('customerContact').value = '';
        document.getElementById('customerCnic').value = '';
        document.getElementById('customerPmgRate').value = '';
        document.getElementById('customerHsdRate').value = '';
        document.getElementById('customerAddress').value = '';
        document.getElementById('customerNotes').value = '';
        document.getElementById('customerOpeningBalance').value = '0';
    }
    
    // Clear vehicle form when opening to add new
    if (modalId === 'vehicleModal') {
        document.getElementById('vehicleId').value = '';
        document.getElementById('vehicleNumber').value = '';
        document.getElementById('vehicleDriver').value = '';
        document.getElementById('vehicleContact').value = '';
        document.getElementById('vehicleStatus').value = 'Active';
    }
    
    // Initialize JV modal
    if (modalId === 'jvModal') {
        initJVModal();
    }
    
    // Initialize invoice modal
    if (modalId === 'invoiceModal') {
        initInvoiceModal();
    }
    
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function populateDropdowns() {
    // Customers
    const customerSelects = [
        document.getElementById('saleCustomerId'),
        document.getElementById('transferFromCustomerId'),
        document.getElementById('transferToCustomerId'),
        document.getElementById('expenseCustomerId')
    ];
    
    customerSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }
    });
    
    // Customer Report Dropdown
    const customerReportSelect = document.getElementById('customerReportSelect');
    if (customerReportSelect) {
        customerReportSelect.innerHTML = '<option value="">Choose Customer</option>';
        customers.forEach(c => {
            customerReportSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
    }
    
    // Suppliers
    const supplierSelect = document.getElementById('purchaseSupplierId');
    supplierSelect.innerHTML = '<option value="">Select Supplier</option>';
    suppliers.forEach(s => {
        supplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
    });
    
    // Vehicles
    const vehicleSelects = [
        document.getElementById('saleVehicleId'),
        document.getElementById('purchaseVehicleId')
    ];
    
    vehicleSelects.forEach(select => {
        select.innerHTML = '<option value="">Select Vehicle</option>';
        vehicles.forEach(v => {
            select.innerHTML += `<option value="${v.id}">${v.number} - ${v.driverName} (PMG: ${v.stockPMG.toFixed(2)}KL, HSD: ${v.stockHSD.toFixed(2)}KL)</option>`;
        });
    });
    
    // Vehicle Report Dropdown
    const vehicleReportSelect = document.getElementById('vehicleReportSelect');
    if (vehicleReportSelect) {
        vehicleReportSelect.innerHTML = '<option value="">Choose Vehicle</option>';
        vehicles.forEach(v => {
            vehicleReportSelect.innerHTML += `<option value="${v.id}">${v.number} - ${v.driverName}</option>`;
        });
    }
    
    // Banks
    const bankSelects = [
        document.getElementById('paymentBankId'),
        document.getElementById('expenseBankId'),
        document.getElementById('bankTransBankId')
    ];
    
    bankSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Bank</option>';
            banks.forEach(b => {
                select.innerHTML += `<option value="${b.id}">${b.name} - ${b.accountNumber}</option>`;
            });
        }
    });
}

// JV VOUCHER FUNCTIONS
function updateJVDebitAccounts() {
    const type = document.getElementById('jvDebitType').value;
    const accountSelect = document.getElementById('jvDebitAccount');
    const otherInput = document.getElementById('jvDebitOther');
    
    accountSelect.innerHTML = '<option value="">Select Account</option>';
    otherInput.style.display = 'none';
    
    if (type === 'customer') {
        customers.forEach(c => accountSelect.innerHTML += `<option value="customer_${c.id}">${c.name}</option>`);
    } else if (type === 'supplier') {
        suppliers.forEach(s => accountSelect.innerHTML += `<option value="supplier_${s.id}">${s.name}</option>`);
    } else if (type === 'bank') {
        banks.forEach(b => accountSelect.innerHTML += `<option value="bank_${b.id}">${b.name}</option>`);
    } else if (type === 'vehicle') {
        vehicles.forEach(v => accountSelect.innerHTML += `<option value="vehicle_${v.id}">${v.number} - ${v.ownerName || 'Owner'}</option>`);
    } else if (type === 'other') {
        otherInput.style.display = 'block';
    }
}

function updateJVCreditAccounts() {
    const type = document.getElementById('jvCreditType').value;
    const accountSelect = document.getElementById('jvCreditAccount');
    const otherInput = document.getElementById('jvCreditOther');
    
    accountSelect.innerHTML = '<option value="">Select Account</option>';
    otherInput.style.display = 'none';
    
    if (type === 'customer') {
        customers.forEach(c => accountSelect.innerHTML += `<option value="customer_${c.id}">${c.name}</option>`);
    } else if (type === 'supplier') {
        suppliers.forEach(s => accountSelect.innerHTML += `<option value="supplier_${s.id}">${s.name}</option>`);
    } else if (type === 'bank') {
        banks.forEach(b => accountSelect.innerHTML += `<option value="bank_${b.id}">${b.name}</option>`);
    } else if (type === 'vehicle') {
        vehicles.forEach(v => accountSelect.innerHTML += `<option value="vehicle_${v.id}">${v.number} - ${v.ownerName || 'Owner'}</option>`);
    } else if (type === 'other') {
        otherInput.style.display = 'block';
    }
}

function validateJVAmounts() {
    const debitInput = document.getElementById('jvDebitAmount');
    const creditInput = document.getElementById('jvCreditAmount');
    const debit = parseFloat(debitInput.value) || 0;
    const warning = document.getElementById('jvBalanceWarning');
    
    // AUTO-SYNC: When debit amount changes, automatically update credit amount
    if (debit > 0) {
        creditInput.value = debit.toFixed(2);
        warning.style.display = 'none';
    } else {
        warning.style.display = 'none';
    }
}

function saveJVVoucher(e) {
    e.preventDefault();
    
    const debit = parseFloat(document.getElementById('jvDebitAmount').value);
    const credit = parseFloat(document.getElementById('jvCreditAmount').value);
    
    if (debit !== credit) {
        showNotification('Debit and Credit must be equal!', 'error');
        return;
    }
    
    const jv = {
        id: 'jv_' + Date.now(),
        date: document.getElementById('jvDate').value,
        description: document.getElementById('jvDescription').value,
        debitType: document.getElementById('jvDebitType').value,
        debitAccount: document.getElementById('jvDebitType').value === 'other' ? 
            document.getElementById('jvDebitOther').value : 
            document.getElementById('jvDebitAccount').value,
        debitAmount: debit,
        creditType: document.getElementById('jvCreditType').value,
        creditAccount: document.getElementById('jvCreditType').value === 'other' ? 
            document.getElementById('jvCreditOther').value : 
            document.getElementById('jvCreditAccount').value,
        creditAmount: credit,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    jvVouchers.push(jv);
    
    // Update accounts
    updateAccountFromJV(jv.debitType, jv.debitAccount, debit, 'debit');
    updateAccountFromJV(jv.creditType, jv.creditAccount, credit, 'credit');
    
    saveToStorage();
    showNotification('JV Voucher saved! ✅', 'success');
    closeModal('jvModal');
    e.target.reset();
}

function updateAccountFromJV(type, account, amount, side) {
    if (type === 'customer') {
        const custId = account.replace('customer_', '');
        const cust = customers.find(c => c.id === custId);
        if (cust) {
            cust.balance += side === 'debit' ? amount : -amount;
        }
    } else if (type === 'supplier') {
        const suppId = account.replace('supplier_', '');
        const supp = suppliers.find(s => s.id === suppId);
        if (supp) {
            supp.balance += side === 'credit' ? amount : -amount;
        }
    } else if (type === 'bank') {
        const bankId = account.replace('bank_', '');
        const bank = banks.find(b => b.id === bankId);
        if (bank) {
            bank.balance += side === 'debit' ? amount : -amount;
        }
    } else if (type === 'vehicle') {
        const vehId = account.replace('vehicle_', '');
        const veh = vehicles.find(v => v.id === vehId);
        if (veh) {
            veh.ownerBalance += side === 'credit' ? amount : -amount;
        }
    }
}

// VEHICLE INVOICE FUNCTIONS
function loadVehicleInvoiceData() {
    const select = document.getElementById('invoiceVehicleId');
    select.innerHTML = '<option value="">Choose Vehicle</option>';
    vehicles.forEach(v => {
        select.innerHTML += `<option value="${v.id}">${v.number} - ${v.driver}</option>`;
    });
}

function generateVehicleInvoice() {
    const vehicleId = document.getElementById('invoiceVehicleId').value;
    const fromDate = document.getElementById('invoiceFromDate').value;
    const toDate = document.getElementById('invoiceToDate').value;
    
    if (!vehicleId || !fromDate || !toDate) {
        showNotification('Please fill all fields!', 'error');
        return;
    }
    
    const vehicle = vehicles.find(v => v.id === vehicleId);
    const vehicleTrans = transactions.filter(t => 
        t.vehicleId === vehicleId && 
        t.date >= fromDate && 
        t.date <= toDate
    );
    
    if (vehicleTrans.length === 0) {
        showNotification('No transactions found for this period!', 'warning');
        return;
    }
    
    let html = `
        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px;">
            <h2 style="color: var(--primary-color); margin-bottom: 5px;">🛢️ Baghoor Oil Traders</h2>
            <h3 style="color: var(--text-secondary); font-size: 1.1em;">Vehicle Invoice</h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <p><strong>Vehicle Number:</strong> ${vehicle.number}</p>
                <p><strong>Driver:</strong> ${vehicle.driver}</p>
                ${vehicle.ownerName ? `<p><strong>Owner:</strong> ${vehicle.ownerName}</p>` : ''}
            </div>
            <div style="text-align: right;">
                <p><strong>Invoice Date:</strong> ${new Date().toLocaleDateString()}</p>
                <p><strong>Period:</strong> ${new Date(fromDate).toLocaleDateString()} to ${new Date(toDate).toLocaleDateString()}</p>
            </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead style="background: var(--primary-color); color: white;">
                <tr>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Date</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Type</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Party</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Fuel</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Qty (L)</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Rate</th>
                    <th style="padding: 10px; border: 1px solid var(--border-color);">Amount</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalSales = 0;
    let totalPurchases = 0;
    
    vehicleTrans.forEach(t => {
        html += `
            <tr>
                <td style="padding: 8px; border: 1px solid var(--border-color);">${new Date(t.date).toLocaleDateString()}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color);"><span style="background: ${t.type === 'sale' ? '#48bb78' : '#ed8936'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">${t.type.toUpperCase()}</span></td>
                <td style="padding: 8px; border: 1px solid var(--border-color);">${t.partyName}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color);">${t.fuelType}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color); text-align: right;">${t.quantity.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color); text-align: right;">Rs. ${t.rate.toFixed(4)}</td>
                <td style="padding: 8px; border: 1px solid var(--border-color); text-align: right;"><strong>Rs. ${t.amount.toFixed(2)}</strong></td>
            </tr>
        `;
        
        if (t.type === 'sale') totalSales += t.amount;
        else totalPurchases += t.amount;
    });
    
    const profit = totalSales - totalPurchases;
    
    html += `
            </tbody>
            <tfoot style="background: var(--bg-secondary); font-weight: bold;">
                <tr>
                    <td colspan="6" style="padding: 10px; border: 1px solid var(--border-color); text-align: right;">Total Sales:</td>
                    <td style="padding: 10px; border: 1px solid var(--border-color); text-align: right; color: #48bb78;">Rs. ${totalSales.toFixed(2)}</td>
                </tr>
                <tr>
                    <td colspan="6" style="padding: 10px; border: 1px solid var(--border-color); text-align: right;">Total Purchases:</td>
                    <td style="padding: 10px; border: 1px solid var(--border-color); text-align: right; color: #ed8936;">Rs. ${totalPurchases.toFixed(2)}</td>
                </tr>
                <tr style="background: ${profit >= 0 ? '#d4edda' : '#f8d7da'};">
                    <td colspan="6" style="padding: 12px; border: 1px solid var(--border-color); text-align: right; font-size: 1.1em;">NET PROFIT:</td>
                    <td style="padding: 12px; border: 1px solid var(--border-color); text-align: right; font-size: 1.2em; color: ${profit >= 0 ? '#155724' : '#721c24'};">Rs. ${profit.toFixed(2)}</td>
                </tr>
            </tfoot>
        </table>
        
        <div style="margin-top: 30px; text-align: center; color: var(--text-secondary); font-size: 0.9em;">
            <p>This is a computer-generated invoice</p>
            <button class="btn btn-success" onclick="window.print()" style="margin-top: 15px;">🖨️ Print Invoice</button>
        </div>
    `;
    
    document.getElementById('invoicePreview').innerHTML = html;
    document.getElementById('invoicePreview').style.display = 'block';
    showNotification('Invoice generated! ✅', 'success');
}

// Initialize invoice dropdowns when modal opens
function initInvoiceModal() {
    loadVehicleInvoiceData();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoiceToDate').value = today;
    const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('invoiceFromDate').value = firstDay;
}

// Initialize JV modal date
function initJVModal() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('jvDate').value = today;
}

// THEME TOGGLE FUNCTIONS
function toggleTheme() {
    isDarkMode = !isDarkMode;
    localStorage.setItem('darkMode', isDarkMode);
    
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('themeIcon').textContent = '☀️';
        showNotification('Dark mode enabled 🌙', 'success');
    } else {
        document.body.classList.remove('dark-mode');
        document.getElementById('themeIcon').textContent = '🌙';
        showNotification('Light mode enabled ☀️', 'success');
    }
}

// USER MANAGEMENT FUNCTIONS
function openAdminSettings() {
    if (currentRole !== 'admin') {
        showNotification('Only admin can access this!', 'error');
        return;
    }
    renderUserManagement();
    openModal('adminSettingsModal');
}

function renderUserManagement() {
    const container = document.getElementById('userManagementList');
    container.innerHTML = '';
    
    systemUsers.forEach(user => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        userCard.innerHTML = `
            <div class="user-card-info">
                <h4>${user.username}</h4>
                <p><strong>Role:</strong> <span style="color: var(--primary-color); text-transform: capitalize;">${user.role}</span></p>
                <p style="font-size: 0.8em; color: var(--text-secondary);">Created: ${new Date(user.createdAt).toLocaleDateString()}</p>
            </div>
            <div class="user-card-actions">
                <button class="btn btn-info btn-sm" onclick="changeUserPassword('${user.id}')">🔐 Change Password</button>
                <button class="btn btn-warning btn-sm" onclick="changeUserRole('${user.id}')">👤 Change Role</button>
                ${user.username !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Delete</button>` : ''}
            </div>
        `;
        container.appendChild(userCard);
    });
    
    // Add "Add New User" button
    const addUserBtn = document.createElement('div');
    addUserBtn.style.textAlign = 'center';
    addUserBtn.style.marginTop = '20px';
    addUserBtn.innerHTML = '<button class="btn btn-success" onclick="addNewUser()">➕ Add New User</button>';
    container.appendChild(addUserBtn);
}

function changeUserPassword(userId) {
    const user = systemUsers.find(u => u.id === userId);
    if (!user) {
        showNotification('User not found!', 'error');
        return;
    }
    
    const newPassword = prompt(`Enter new password for ${user.username}:`);
    if (newPassword && newPassword.length >= 4) {
        user.password = newPassword;
        saveToStorage();
        showNotification(`Password changed for ${user.username}! ✅`, 'success');
        renderUserManagement();
    } else if (newPassword !== null) {
        showNotification('Password must be at least 4 characters!', 'error');
    }
}

function changeUserRole(userId) {
    const user = systemUsers.find(u => u.id === userId);
    if (!user) {
        showNotification('User not found!', 'error');
        return;
    }
    
    if (user.username === 'admin') {
        showNotification('Cannot change admin role!', 'error');
        return;
    }
    
    const roles = ['admin', 'manager', 'accountant'];
    const currentIndex = roles.indexOf(user.role);
    const roleOptions = roles.map((r, i) => `${i + 1}. ${r.toUpperCase()}`).join('\n');
    
    const choice = prompt(`Select new role for ${user.username}:\n\n${roleOptions}\n\nCurrent role: ${user.role.toUpperCase()}\n\nEnter number (1-3):`);
    
    if (choice && ['1', '2', '3'].includes(choice)) {
        const newRole = roles[parseInt(choice) - 1];
        user.role = newRole;
        saveToStorage();
        showNotification(`Role changed to ${newRole.toUpperCase()} for ${user.username}! ✅`, 'success');
        renderUserManagement();
    }
}

function deleteUser(userId) {
    const user = systemUsers.find(u => u.id === userId);
    if (!user) {
        showNotification('User not found!', 'error');
        return;
    }
    
    if (confirm(`Are you sure you want to delete user "${user.username}"?\n\nThis action cannot be undone!`)) {
        systemUsers = systemUsers.filter(u => u.id !== userId);
        saveToStorage();
        showNotification(`User ${user.username} deleted! ✅`, 'success');
        renderUserManagement();
    }
}

function addNewUser() {
    const username = prompt('Enter username for new user:');
    if (!username) return;
    
    // Check if username already exists
    if (systemUsers.find(u => u.username === username)) {
        showNotification('Username already exists!', 'error');
        return;
    }
    
    const password = prompt('Enter password (min 4 characters):');
    if (!password || password.length < 4) {
        showNotification('Password must be at least 4 characters!', 'error');
        return;
    }
    
    const roles = ['admin', 'manager', 'accountant'];
    const roleOptions = roles.map((r, i) => `${i + 1}. ${r.toUpperCase()}`).join('\n');
    const roleChoice = prompt(`Select role:\n\n${roleOptions}\n\nEnter number (1-3):`);
    
    if (!roleChoice || !['1', '2', '3'].includes(roleChoice)) {
        showNotification('Invalid role selection!', 'error');
        return;
    }
    
    const role = roles[parseInt(roleChoice) - 1];
    
    const newUser = {
        id: 'user_' + Date.now(),
        username: username,
        password: password,
        role: role,
        createdAt: new Date().toISOString()
    };
    
    systemUsers.push(newUser);
    saveToStorage();
    showNotification(`User ${username} created successfully! ✅`, 'success');
    renderUserManagement();
}

// Initialize
window.addEventListener('load', async () => {
    console.log('🚀 Baghoor Oil Traders - Complete Professional System Loaded!');
    
    // Clean up any corrupted data on load
    try {
        // Remove null/undefined entries
        customers = customers.filter(c => c && c.id);
        suppliers = suppliers.filter(s => s && s.id);
        transactions = transactions.filter(t => t && t.id);
        vehicles = vehicles.filter(v => v && v.id);
        banks = banks.filter(b => b && b.id);
        
        // Fix any missing properties
        vehicles.forEach(v => {
            if (!v.stockPMG) v.stockPMG = 0;
            if (!v.stockHSD) v.stockHSD = 0;
            if (!v.ownerName) v.ownerName = '';
            if (!v.ownerContact) v.ownerContact = '';
            if (!v.ownerBalance) v.ownerBalance = 0;
        });
        
        console.log('✅ Data validation complete');
        console.log(`📊 Local: ${customers.length} customers, ${transactions.length} transactions`);
    } catch (error) {
        console.error('⚠️ Error during data cleanup:', error);
    }
    
    // Load data from Supabase cloud and set up real-time sync
    if (USE_SUPABASE && supabaseClient) {
        try {
            console.log('🔄 Loading data from cloud...');
            
            // Load data from Supabase
            const { data, error } = await supabaseClient
                .from(TABLE_NAME)
                .select('*')
                .eq('id', 1)
                .maybeSingle();
            
            if (data) {
                console.log('📥 Cloud data loaded!');
                
                // Update arrays with cloud data
                if (data.customers) customers = data.customers;
                if (data.suppliers) suppliers = data.suppliers;
                if (data.transactions) transactions = data.transactions;
                if (data.payments) payments = data.payments;
                if (data.expenses) expenses = data.expenses;
                if (data.customerTransfers) customerTransfers = data.customerTransfers;
                if (data.vehicles) vehicles = data.vehicles;
                if (data.banks) banks = data.banks;
                if (data.bankTransactions) bankTransactions = data.bankTransactions;
                if (data.rateChangeLogs) rateChangeLogs = data.rateChangeLogs;
                if (data.ledgerEntries) ledgerEntries = data.ledgerEntries;
                if (data.jvVouchers) jvVouchers = data.jvVouchers;
                if (data.systemUsers && data.systemUsers.length > 0) systemUsers = data.systemUsers;
                
                // CRITICAL: Always ensure default users exist!
                ensureDefaultUsers();
                
                // Save to localStorage as backup
                localStorage.setItem('customers', JSON.stringify(customers));
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('payments', JSON.stringify(payments));
                localStorage.setItem('expenses', JSON.stringify(expenses));
                localStorage.setItem('customerTransfers', JSON.stringify(customerTransfers));
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                localStorage.setItem('banks', JSON.stringify(banks));
                localStorage.setItem('bankTransactions', JSON.stringify(bankTransactions));
                localStorage.setItem('rateChangeLogs', JSON.stringify(rateChangeLogs));
                localStorage.setItem('ledgerEntries', JSON.stringify(ledgerEntries));
                localStorage.setItem('jvVouchers', JSON.stringify(jvVouchers));
                localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                
                console.log(`✅ Synced: ${customers.length} customers, ${transactions.length} transactions`);
                console.log(`👥 Users available: ${systemUsers.length} (including defaults)`);
            } else if (!error || error.code === 'PGRST116') {
                console.log('📝 First time! Uploading local data...');
                ensureDefaultUsers(); // Make sure defaults exist before first upload!
                await saveToStorage();
            }
            
            // Set up real-time sync
            console.log('🔄 Setting up real-time sync...');
            supabaseClient
                .channel('BOTs_realtime')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: TABLE_NAME },
                    (payload) => {
                        console.log('📡 Update received!');
                        if (payload.new) {
                            const data = payload.new;
                            if (data.customers) customers = data.customers;
                            if (data.suppliers) suppliers = data.suppliers;
                            if (data.transactions) transactions = data.transactions;
                            if (data.payments) payments = data.payments;
                            if (data.expenses) expenses = data.expenses;
                            if (data.customerTransfers) customerTransfers = data.customerTransfers;
                            if (data.vehicles) vehicles = data.vehicles;
                            if (data.banks) banks = data.banks;
                            if (data.bankTransactions) bankTransactions = data.bankTransactions;
                            if (data.rateChangeLogs) rateChangeLogs = data.rateChangeLogs;
                            if (data.ledgerEntries) ledgerEntries = data.ledgerEntries;
                            if (data.jvVouchers) jvVouchers = data.jvVouchers;
                            if (data.systemUsers && data.systemUsers.length > 0) systemUsers = data.systemUsers;
                            
                            // CRITICAL: Always ensure default users exist!
                            ensureDefaultUsers();
                            
                            // Refresh displays if logged in
                            try {
                                if (typeof renderTransactions === 'function') renderTransactions();
                                if (typeof renderCustomers === 'function') renderCustomers();
                                if (typeof renderSuppliers === 'function') renderSuppliers();
                                if (typeof renderVehicles === 'function') renderVehicles();
                                if (typeof updateDashboard === 'function') updateDashboard();
                                console.log('✅ Display updated!');
                            } catch (e) {}
                        }
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('✅ Real-time sync active! 🎉');
                    }
                });
        } catch (error) {
            console.error('⚠️ Cloud sync error:', error);
            console.log('Using local data only');
        }
    } else {
        console.log('💾 Local mode only');
    }
});
</script>

</body>
</html>
